USE [TransvalvenProduccion]
GO
/****** Object:  StoredProcedure [dbo].[Abrir_Cartaporte]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 05-10-2010 
-- Description:  Abrir envase de cartaporte
-- ============================================= 
create PROCEDURE [dbo].[Abrir_Cartaporte] 
	@CartaporteID varchar(13)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

		
	
		/**** Abre el cartaporte ****/ 
		  BEGIN TRY 
			  UPDATE CartaPorte
			  SET    Cerrado = 0,
					 LoginCerrado = '',
					 FechaCerrado = ''
			  WHERE	 CartaPorteID = @CartaporteID

		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION envase 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage'  
			  RETURN
		  END CATCH 
		
      

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage'
  END

GO
/****** Object:  StoredProcedure [dbo].[Abrir_Envase_Conteo]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 05-10-2010 
-- Description:  Abrir envase de cartaporte
-- ============================================= 
CREATE PROCEDURE [dbo].[Abrir_Envase_Conteo] 
	@EnvaseID INT,
	@Login varchar(30),
	@Monto decimal(18,3),
	@NroPlomo varchar(20) = null
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

		IF @Monto = 0
		BEGIN
			/**** Abre el envase ****/ 
			  BEGIN TRY 
			  IF @NroPlomo <> NULL
			  BEGIN
				UPDATE Envase
				SET    EstaAbierto = 1,
						 LoginAbierto = @Login,
						 FechaAbierto = GETDATE(),
						 NroPlomo = @NroPlomo
				  WHERE	 EnvaseID = @EnvaseID
				  
				  END
			  ELSE
				  UPDATE Envase
				  SET    EstaAbierto = 1,
						 LoginAbierto = @Login,
						 FechaAbierto = GETDATE()
				  WHERE	 EnvaseID = @EnvaseID
				
			  END TRY 
			  BEGIN CATCH 
				  ROLLBACK TRANSACTION envase 
				  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
						 @NUMERRORS = @NUMERRORS + 1
				  SELECT @NUMERRORS     AS 'ErrorCount',
						 @ERRORMESSAGE  AS 'ErrorMessage'  
				  RETURN
			  END CATCH 
		END
		ELSE
			BEGIN TRY 
				  UPDATE Envase
				  SET    EstaAbierto = 1,
						 LoginAbierto = @Login,
						 FechaAbierto = GETDATE() ,
						 Monto = @Monto,
						 NroPlomo = @NroPlomo
				  WHERE	 EnvaseID = @EnvaseID

			  END TRY 
			  BEGIN CATCH 
				  ROLLBACK TRANSACTION envase 
				  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
						 @NUMERRORS = @NUMERRORS + 1
				  SELECT @NUMERRORS     AS 'ErrorCount',
						 @ERRORMESSAGE  AS 'ErrorMessage'  
				  RETURN
			  END CATCH 
      

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase 
      ELSE 
        COMMIT TRANSACTION envase 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @EnvaseID AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Acta_Cartaporte_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Acta_Cartaporte_INSERT] 
    @CartaporteID VARCHAR(13),
	@ActaID INT
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION acta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	  IF NOT EXISTS(SELECT * FROM cartaporte WHERE CartaporteID = @CartaporteID)
	  BEGIN 
			/***********************    INSERT:[acta]    ***********************/
		ROLLBACK TRANSACTION bolsa 
			  SELECT @ERRORMESSAGE = 'Error: No puede crear el acta con el cartaporte Nro' + @CartaporteID +  ', ya que no existe.',
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
			  RETURN

	  END
		
	/***********************    INSERT:[acta]    ***********************/
		  BEGIN TRY 
			  INSERT INTO Acta_Cartaporte 
						  (CartaporteID, 
						   ActaID) 
			  VALUES      (@CartaporteID, 
						   @ActaID) 
		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION acta 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
			  RETURN
		  END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION acta 
      ELSE 
        COMMIT TRANSACTION acta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @ActaID    AS 'ExtraValue'
	
  END










GO
/****** Object:  StoredProcedure [dbo].[Acta_Envase_Efectivo_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



create PROCEDURE [dbo].[Acta_Envase_Efectivo_INSERT] 
	@EnvaseID	INT,
	@EfectivoID VARCHAR(5),
	@Piezas		INT,
	@Monto		DECIMAL(18,3)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase_efectivo 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @CartaPorteID VARCHAR(13),
			  @BovedaID     INT,
			  @EstaAbierto  BIT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


	
	  BEGIN
		  IF NOT EXISTS(SELECT *
					    FROM   Acta_Envase_Efectivo
					    WHERE  EfectivoID = @EfectivoID
					    AND    EnvaseID = @EnvaseID)
		  BEGIN
			  /**** Crea los efectivos  ****/ 
			  BEGIN TRY 
				  INSERT INTO Acta_Envase_Efectivo
							  (EnvaseID, 
							   EfectivoID, 
							   Piezas,
							   Monto) 
				  VALUES      (@EnvaseID, 
							   @EfectivoID, 
							   @Piezas,
							   @Monto)
			  END TRY 
			  BEGIN CATCH 
				  ROLLBACK TRANSACTION envase_efectivo 
				  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
						 @NUMERRORS = @NUMERRORS + 1
				  SELECT @NUMERRORS     AS 'ErrorCount',
						 @ERRORMESSAGE  AS 'ErrorMessage'   
				  RETURN
			  END CATCH 
		  END
	  END



      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase_efectivo 
      ELSE 
        COMMIT TRANSACTION envase_efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END

GO
/****** Object:  StoredProcedure [dbo].[Acta_Envase_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[Acta_Envase_INSERT] 
	@NroPlomo VARCHAR(50) = NULL,
	@CartaPorteID VARCHAR(13),
	@Defectuoso BIT,
	@Observacion varchar(500)= NULL,
	@ActaID INT
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @EnvaseID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 



      /**** Crea el envase ****/ 
      BEGIN TRY 
          INSERT INTO Acta_Envase
                      (NroPlomo, 
					   CartaPorteID,
					   Defectuoso,
					   Observacion,
						ActaID) 
          VALUES      (ISNULL(@NroPlomo, 'N/A'),
					   @CartaPorteID,
					   @Defectuoso,
					   @Observacion,
					   @ActaID)
		  SET @EnvaseID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION envase 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase 
      ELSE 
        COMMIT TRANSACTION envase 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @EnvaseID AS 'Identity'
  END



GO
/****** Object:  StoredProcedure [dbo].[Acta_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Acta_INSERT] 
    @NumeroCartaporte VARCHAR(13),
	@FechaCartaporte varchar(10),
	@NumeroPlomo varchar(50),
	@FechaRuta varchar(10),
	@RazonID int,
	@BovedaID int,
	@OrigenID int,
	@Usuario varchar(50),
	@LoginCreado varchar(50),
	@Observacion varchar(500),
	@FechaSuceso varchar(10),
	@MontoCartaporte decimal(18,3)

AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION acta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
				@ActaID int

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	  
		
	/***********************    INSERT:[acta]    ***********************/
		  BEGIN TRY 
			  INSERT INTO Acta
						  (MontoCartaporte, 
						    FechaCartaporte,
							NumeroCartaporte,
							NumeroPlomo,
							FechaRuta,
							RazonID,
							BovedaID,
							OrigenID,
							Usuario,
							Observacion,
							FechaSuceso,
							LoginCreado) 
			  VALUES      (@MontoCartaporte,
							@FechaCartaporte,
							@NumeroCartaporte,
							@NumeroPlomo,
							@FechaRuta,
							@RazonID,
							@BovedaID,
							@OrigenID,
							@Usuario,
							@Observacion,
							@FechaSuceso,
							@LoginCreado)  
				SET @ActaID = SCOPE_IDENTITY()
		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION acta 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
			  RETURN
		  END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION acta 
      ELSE 
        COMMIT TRANSACTION acta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @ActaID    AS 'ExtraValue'
	
  END










GO
/****** Object:  StoredProcedure [dbo].[Acta_Ruta_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Acta_Ruta_INSERT] 
    @ActaID INT,
	@RutaID INT
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION acta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	 
		
	/***********************    INSERT:[Acta]    ***********************/
		  BEGIN TRY 
			  INSERT INTO Acta_Ruta 
						  (ActaID, 
						   RutaID) 
			  VALUES      (@ActaID, 
						   @RutaID) 
		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION acta 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
			  RETURN
		  END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION acta 
      ELSE 
        COMMIT TRANSACTION acta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @ActaID    AS 'ExtraValue'
	
  END










GO
/****** Object:  StoredProcedure [dbo].[Actualizar_Envase]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[Actualizar_Envase] 
	@EnvaseID INT,
    @NroPlomo varchar(20)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cliente 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[PUNTO]    ***********************/

	  BEGIN TRY 
          UPDATE Envase 
		  SET    NroPlomo = @NroPlomo
				 
				
		  WHERE  EnvaseID = @EnvaseID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cliente 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cliente 
      ELSE 
        COMMIT TRANSACTION cliente 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Arqueo_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Crear cartaporte	
-- ============================================= 
CREATE PROCEDURE [dbo].[Arqueo_INSERT] 
    @ArqueoID VARCHAR(13) = NULL,
	@CuentaID INT,
	@StatusID INT,
	@SolicitudID INT,
    @RubroID INT,
	@BovedaID INT, 
	@Monto DECIMAL(18,3),
	@LoginCreado VARCHAR(30), 
	@ConsignadorID INT,
	@ConsignatarioID INT,
	@ConsignadorFecha VARCHAR(10), 
	@ConsignatarioFecha  VARCHAR(10) = NULL
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION arqueo 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @PorSistema BIT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	  SET @PorSistema = 1

	  IF(@ArqueoID IS NULL)
	  BEGIN
		  SET @PorSistema = 1
		  SET @ArqueoID = 'ATV' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (ArqueoID, 4, LEN(ArqueoID) -3)))
												   FROM   arqueo
												   WHERE  porsistema = 1),0) + 1 AS VARCHAR)
	  END
	  ELSE 
	  BEGIN
		  SET @PorSistema = 0
		  IF(SUBSTRING(@ArqueoID,1,3) = 'ATV')
			BEGIN 
			   ROLLBACK TRANSACTION cartaporte 
			   SELECT @ERRORMESSAGE = 'Error: No puede crear un Arqueo con el prefijo ATVV, ya que esta reservado.',
					  @NUMERRORS = @NUMERRORS + 1
			   SELECT @NUMERRORS     AS 'ErrorCount', 
					  @ERRORMESSAGE AS 'ErrorMessage'
			   RETURN
			END 

	  END


/***********************    VALIDACIONES:[NRO DE CARTAS DE PORTE]    ***********************/

	  IF EXISTS(SELECT * 
			    FROM   Arqueo
				WHERE  ArqueoID =  @ArqueoID)
        BEGIN 
		   ROLLBACK TRANSACTION cartaporte 
		   SELECT @ERRORMESSAGE = 'Error: Ya existe un Arqueo con el Nro. ' + CONVERT (VARCHAR, @ArqueoID),
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
        END 




/***********************    INSERT:[Arqueo]    ***********************/

	  BEGIN TRY 
          INSERT INTO arqueo 
					  (ArqueoID, 
					   CuentaID,
					   StatusID,
					   RubroID, 
					   BovedaID, 
					   Monto, 
					   FechaCreado, 
					   LoginCreado,
					   PorSistema) 
          VALUES      (@ArqueoID, 
					   @CuentaID, 
					   @StatusID,
					   @RubroID,
					   @BovedaID, 
					   @Monto, 
					   GetDate(), 
					   UPPER(@LoginCreado),
					   @PorSistema) 
					   
	       
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION arqueo 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    INSERT:[CONSIGNADOR]    ***********************/

	  BEGIN TRY 
          INSERT INTO Arqueo_Punto 
					  (ArqueoID, 
					   PuntoID, 
					   Tipo,
					   Fecha) 
          VALUES      (@ArqueoID, 
					   @ConsignadorID, 
					   1,
					   @ConsignadorFecha) 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 




/***********************    INSERT:[CONSIGNATARIO]    ***********************/

	  BEGIN TRY 
          INSERT INTO Arqueo_Punto 
					  (ArqueoID, 
					   PuntoID, 
					   Tipo,
					   Fecha) 
          VALUES      (@ArqueoID, 
					   @ConsignatarioID, 
					   2,
					   @ConsignatarioFecha) 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION arqueo 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION arqueo 
      ELSE 
        COMMIT TRANSACTION arqueo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @ArqueoID    AS 'ExtraValue'
  END

GO
/****** Object:  StoredProcedure [dbo].[Banco_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[Banco_Get]
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT BancoID, 
		   DESCRIPCION
	FROM   BANCO
	
END


GO
/****** Object:  StoredProcedure [dbo].[Banco_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
create PROCEDURE [dbo].[Banco_INSERT] 
	@Descripcion VARCHAR(50)
	
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION banco 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @BancoID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	
	  
	

      /**** Crea el banco ****/ 
      BEGIN TRY 
          INSERT INTO Banco
                      (Descripcion) 
          VALUES      (@Descripcion)
		SET @BancoID = SCOPE_IDENTITY()
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION banco 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION banco 
      ELSE 
        COMMIT TRANSACTION banco 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @BancoID AS 'Identity'
  END






GO
/****** Object:  StoredProcedure [dbo].[Banco_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Banco_UPDATE] 
	@Descripcion VARCHAR(200),
	@BancoID INT
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION banco 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[OFICIAL]    ***********************/

	  BEGIN TRY 
          UPDATE banco 
		  SET    descripcion = @Descripcion
				
		  WHERE  BancoID = @BancoID

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION banco 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION banco 
      ELSE 
        COMMIT TRANSACTION banco 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Biblia_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[Biblia_Get] 

AS
BEGIN

	SET NOCOUNT ON

	SELECT  Punto.Nombre AS Estacion,
			LUN_0_10, 
			LUN_0_50, 
			LUN_1, 
			MAR_0_10, 
			MAR_0_50, 
			MAR_1, 
			MIE_0_10, 
			MIE_0_50, 
			MIE_1, 
			JUE_0_10, 
			JUE_0_50, 
			JUE_1, 
			VIE_0_10, 
			VIE_0_50, 
			VIE_1, 
			SAB_0_10, 
			SAB_0_50, 
			SAB_1, 
			DOM_0_10, 
			DOM_0_50, 
			DOM_1
	FROM    Biblia
	JOIN    Punto
	ON		Biblia.PuntoID = Punto.PuntoID
END


GO
/****** Object:  StoredProcedure [dbo].[Biblia_GetBy_Dia_Ruta]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





 

CREATE PROCEDURE [dbo].[Biblia_GetBy_Dia_Ruta] 
	@Dia  CHAR(3),	
	@Ruta VARCHAR (10)
AS
BEGIN

	SET NOCOUNT ON
	IF(@Dia IN ('LUN','MON'))
	BEGIN
		SELECT  Ruta,
				Punto.PuntoID,
				Punto.Nombre AS Estacion,
				LUN_0_10 AS '0_10', 
				LUN_0_50 AS '0_50',
				LUN_1 AS '1',
				LUN_5 AS '5',
				LUN_2 AS '2',
				LUN_10 AS '_10', 
				LUN_50 AS '_50',
				LUN_100 AS '_100',
				LUN_500 AS '_500',
				LUN_1000 AS '_1000',
				LUN_2000 AS '_2000',
				LUN_5000 AS '_5000', 
				LUN_10000 AS '_10000',
				LUN_20000 AS '_20000'
		FROM    Biblia
		JOIN    Punto
		ON		Biblia.PuntoID = Punto.PuntoID
	    WHERE   Ruta = @Ruta 
	END
	IF(@Dia IN('MAR','TUE'))
	BEGIN
		SELECT  Ruta,
				Punto.PuntoID,
				Punto.Nombre AS Estacion,
				MAR_0_10 AS '0_10', 
				MAR_0_50 AS '0_50',
				MAR_1 AS '1',
				MAR_5 AS '5',
				MAR_2 AS '2',
				MAR_10 AS '_10', 
				MAR_50 AS '_50',
				MAR_100 AS '_100',
				MAR_500 AS '_500',
				MAR_1000 AS '_1000',
				MAR_2000 AS '_2000',
				MAR_5000 AS '_5000', 
				MAR_10000 AS '_10000',
				MAR_20000 AS '_20000'
		FROM    Biblia
		JOIN    Punto
		ON		Biblia.PuntoID = Punto.PuntoID
	    WHERE   Ruta = @Ruta
	END
	IF(@Dia IN ('MIE','WED'))
	BEGIN
		SELECT  Ruta,
				Punto.PuntoID,
				Punto.Nombre AS Estacion,
				MIE_0_10 AS '0_10', 
				MIE_0_50 AS '0_50',
				MIE_1 AS '1',
				MIE_5 AS '5',
				MIE_2 AS '2',
				MIE_10 AS '_10', 
				MIE_50 AS '_50',
				MIE_100 AS '_100',
				MIE_500 AS '_500',
				MIE_1000 AS '_1000',
				MIE_2000 AS '_2000',
				MIE_5000 AS '_5000', 
				MIE_10000 AS '_10000',
				MIE_20000 AS '_20000'
		FROM    Biblia
		JOIN    Punto
		ON		Biblia.PuntoID = Punto.PuntoID
	    WHERE   Ruta = @Ruta
	END
	IF(@Dia IN ('JUE','THU'))
	BEGIN
		SELECT  Ruta,
				Punto.PuntoID,
				Punto.Nombre AS Estacion,
				JUE_0_10 AS '0_10', 
				JUE_0_50 AS '0_50',
				JUE_1 AS '1',
				JUE_5 AS '5',
				JUE_2 AS '2',
				JUE_10 AS '_10', 
				JUE_50 AS '_50',
				JUE_100 AS '_100',
				JUE_500 AS '_500',
				JUE_1000 AS '_1000',
				JUE_2000 AS '_2000',
				JUE_5000 AS '_5000', 
				JUE_10000 AS '_10000',
				JUE_20000 AS '_20000'
		FROM    Biblia
		JOIN    Punto
		ON		Biblia.PuntoID = Punto.PuntoID
	    WHERE   Ruta = @Ruta
	END
	IF(@Dia IN ('VIE','FRI'))
	BEGIN
		SELECT  Ruta,
				Punto.PuntoID,
				Punto.Nombre AS Estacion,
				VIE_0_10 AS '0_10', 
				VIE_0_50 AS '0_50',
				VIE_1 AS '1',
				VIE_5 AS '5',
				VIE_2 AS '2',
				VIE_10 AS '_10', 
				VIE_50 AS '_50',
				VIE_100 AS '_100',
				VIE_500 AS '_500',
				VIE_1000 AS '_1000',
				VIE_2000 AS '_2000',
				VIE_5000 AS '_5000', 
				VIE_10000 AS '_10000',
				VIE_20000 AS '_20000'
		FROM    Biblia
		JOIN    Punto
		ON		Biblia.PuntoID = Punto.PuntoID
	    WHERE   Ruta = @Ruta
	END
	IF(@Dia IN ('SAB','SAT'))
	BEGIN
		SELECT  Ruta,
				Punto.PuntoID,
				Punto.Nombre AS Estacion,
				SAB_0_10 AS '0_10', 
				SAB_0_50 AS '0_50',
				SAB_1 AS '1',
				SAB_5 AS '5',
				SAB_2 AS '2',
				SAB_10 AS '_10', 
				SAB_50 AS '_50',
				SAB_100 AS '_100',
				SAB_500 AS '_500',
				SAB_1000 AS '_1000',
				SAB_2000 AS '_2000',
				SAB_5000 AS '_5000', 
				SAB_10000 AS '_10000',
				SAB_20000 AS '_20000'
		FROM    Biblia
		JOIN    Punto
		ON		Biblia.PuntoID = Punto.PuntoID
	    WHERE   Ruta = @Ruta
	END
	IF(@Dia IN ('DOM','SUN'))
	BEGIN
		SELECT  Ruta,
				Punto.PuntoID,
				Punto.Nombre AS Estacion,
				DOM_0_10 AS '0_10', 
				DOM_0_50 AS '0_50',
				DOM_1 AS '1',
				DOM_5 AS '5',
				DOM_2 AS '2',
				DOM_10 AS '_10', 
				DOM_50 AS '_50',
				DOM_100 AS '_100',
				DOM_500 AS '_500',
				DOM_1000 AS '_1000',
				DOM_2000 AS '_2000',
				DOM_5000 AS '_5000', 
				DOM_10000 AS '_10000',
				DOM_20000 AS '_20000'
		FROM    Biblia
		JOIN    Punto
		ON		Biblia.PuntoID = Punto.PuntoID
	    WHERE   Ruta = @Ruta
	END
END



GO
/****** Object:  StoredProcedure [dbo].[Biblia_Metro_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[Biblia_Metro_Get] 

AS
BEGIN

	SET NOCOUNT ON

	SELECT  Punto.PuntoID,
			Punto.Nombre AS Estacion,
			LUN_0_10, 
			LUN_0_50, 
			LUN_1, 
			MAR_0_10, 
			MAR_0_50, 
			MAR_1, 
			MIE_0_10, 
			MIE_0_50, 
			MIE_1, 
			JUE_0_10, 
			JUE_0_50, 
			JUE_1, 
			VIE_0_10, 
			VIE_0_50, 
			VIE_1, 
			SAB_0_10, 
			SAB_0_50, 
			SAB_1, 
			DOM_0_10, 
			DOM_0_50, 
			DOM_1,			
			LUN_5, 
			LUN_2, 		 
			MAR_5, 
			MAR_2, 
			MIE_5, 
			MIE_2, 			 
			JUE_5, 
			JUE_2, 			
			VIE_5, 
			VIE_2, 			 
			SAB_5, 
			SAB_2, 			 
			DOM_5, 
			DOM_2
	FROM    Biblia
	JOIN    Punto
	ON		Biblia.PuntoID = Punto.PuntoID
	AND     Biblia.Tipo = 'Metro'
	ORDER BY RUTA
END



GO
/****** Object:  StoredProcedure [dbo].[Biblia_MTB_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[Biblia_MTB_Get] 

AS
BEGIN

	SET NOCOUNT ON

	SELECT  Punto.PuntoID,
			Punto.Nombre AS Estacion,
			LUN_0_10, 
			LUN_0_50, 
			LUN_1, 
			MAR_0_10, 
			MAR_0_50, 
			MAR_1, 
			MIE_0_10, 
			MIE_0_50, 
			MIE_1, 
			JUE_0_10, 
			JUE_0_50, 
			JUE_1, 
			VIE_0_10, 
			VIE_0_50, 
			VIE_1, 
			SAB_0_10, 
			SAB_0_50, 
			SAB_1, 
			DOM_0_10, 
			DOM_0_50, 
			DOM_1,			
			LUN_5, 
			LUN_2, 		 
			MAR_5, 
			MAR_2, 
			MIE_5, 
			MIE_2, 			 
			JUE_5, 
			JUE_2, 			
			VIE_5, 
			VIE_2, 			 
			SAB_5, 
			SAB_2, 			 
			DOM_5, 
			DOM_2
	FROM    Biblia
	JOIN    Punto
	ON		Biblia.PuntoID = Punto.PuntoID
	AND     Biblia.Tipo = 'metroMTB'
	ORDER BY RUTA
END



GO
/****** Object:  StoredProcedure [dbo].[Biblia_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Actualizar biblia
-- ============================================= 
CREATE PROCEDURE [dbo].[Biblia_UPDATE] 
	@PuntoID	INT,
	@LUN_0_10	INT, 
	@LUN_0_50	INT, 
	@LUN_1		INT, 
	@LUN_5	INT, 
	@LUN_2	INT,
	@MAR_0_10	INT, 
	@MAR_0_50	INT, 
	@MAR_1		INT,
	@MAR_5	INT, 
	@MAR_2	INT, 
	@MIE_0_10	INT, 
	@MIE_0_50	INT, 
	@MIE_1		INT,
	@MIE_5	INT, 
	@MIE_2	INT, 
	@JUE_0_10	INT, 
	@JUE_0_50	INT, 
	@JUE_1		INT,
	@JUE_5	INT, 
	@JUE_2	INT, 
	@VIE_0_10	INT, 
	@VIE_0_50	INT, 
	@VIE_1		INT,
	@VIE_5	INT, 
	@VIE_2	INT, 
	@SAB_0_10	INT, 
	@SAB_0_50	INT, 
	@SAB_1		INT, 
	@SAB_5	INT, 
	@SAB_2	INT,
	@DOM_0_10	INT, 
	@DOM_0_50	INT, 
	@DOM_1		INT,
	@DOM_5	INT, 
	@DOM_2	INT
AS 
  BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION biblia 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

/***********************    UPDATE:[BIBLIA]    ***********************/

	  BEGIN TRY 
          UPDATE Biblia
		  SET	 LUN_0_10 = @LUN_0_10,
				 LUN_0_50 = @LUN_0_50, 
				 LUN_1 = @LUN_1,
				 LUN_5 = @LUN_5,
				 LUN_2 = @LUN_2, 
				 MAR_0_10 = @MAR_0_10, 
				 MAR_0_50 = @MAR_0_50, 
				 MAR_1 = @MAR_1, 
				 MAR_5 = @MAR_5, 
				 MAR_2 = @MAR_2,
				 MIE_0_10 = @MIE_0_10, 
				 MIE_0_50 = @MIE_0_50, 
				 MIE_1 = @MIE_1, 
				 MIE_5 = @MIE_5, 
				 MIE_2 = @MIE_2, 
				 JUE_0_10 = @JUE_0_10, 
				 JUE_0_50 = @JUE_0_50, 
				 JUE_1 = @JUE_1, 
				 JUE_5 = @JUE_5, 
				 JUE_2 = @JUE_2,
				 VIE_0_10 = @VIE_0_10, 
				 VIE_0_50 = @VIE_0_50, 
				 VIE_1 = @VIE_1, 
				 VIE_5 = @VIE_5, 
				 VIE_2 = @VIE_2, 
				 SAB_0_10 = @SAB_0_10, 
				 SAB_0_50 = @SAB_0_50, 
				 SAB_1 = @SAB_1,
				 SAB_5 = @SAB_5, 
				 SAB_2 = @SAB_2, 
				 DOM_0_10 = @DOM_0_10, 
				 DOM_0_50 = @DOM_0_50, 
				 DOM_1 = @DOM_1,
				 DOM_5 = @DOM_5, 
				 DOM_2 = @DOM_2 
		  WHERE  PuntoID = @PuntoID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION biblia 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION biblia 
      ELSE 
        COMMIT TRANSACTION biblia 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END  
































GO
/****** Object:  StoredProcedure [dbo].[Bloque_CERRAR]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Bloque_CERRAR] 
	@BloqueID VARCHAR (50),
	@LoginAbierto VARCHAR(13)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION bloque 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[BOLSA]    ***********************/

	  BEGIN TRY 
          UPDATE Bloque 
		  SET    EstaAbierto = 'true',
				 LoginAbierto = @LoginAbierto
				
		  WHERE  BloqueID = @BloqueID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION bloque 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION bloque 
      ELSE 
        COMMIT TRANSACTION bloque 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Bloque_Disponibles_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Bloque_Disponibles_GetBy_Boveda]
	@BovedaID INT
AS
BEGIN
	SET DATEFORMAT DMY
	
	
		SELECT  Efectivo.Denominacion as denominacion,
				Bloque.BovedaID AS BovedaID,			 
			   Bloque.BloqueID,
			   Bloque_Efectivo.Monto as monto,
			   Bloque.LoginCreado,
	   		   Bloque.FechaCreado
			   
		FROM   Bloque	
		JOIN   Bloque_Efectivo
		ON     Bloque_Efectivo.BloqueID = Bloque.BloqueID
		JOIN Efectivo
		ON Efectivo.EfectivoID = Bloque_Efectivo.EfectivoID
		WHERE  Bloque.BovedaID = @BovedaID 
		AND    Bloque.EstaAbierto = 'FALSE'
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_Bloque
						  ON     Traspaso.TraspasoID = Traspaso_Bloque.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_Bloque.BloqueID = Bloque.BloqueID )
	     and    NOT EXISTS(SELECT * 
						  FROM   Bloque
						  JOIN   CartaPorte
						  ON     CartaPorte.CartaPorteID = Bloque.CartaporteID
						  WHERE  Bloque.CartaporteID = Bloque.BloqueID )
	order by Efectivo.Denominacion
END





GO
/****** Object:  StoredProcedure [dbo].[Bloque_DisponiblesByID_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Bloque_DisponiblesByID_GetBy_Boveda]
	@BovedaID INT,
	@denominacionID varchar(5),
    @Cantidad int
AS
BEGIN
	SET DATEFORMAT DMY
	
	
		SELECT 	TOP (@Cantidad) Bloque.BovedaID AS BovedaID,			 
			   Bloque.BloqueID,
			   Bloque_Efectivo.Monto as monto,
			   Bloque.LoginCreado,
	   		   Bloque.FechaCreado,
			 Efectivo.Denominacion as denominacion
		FROM   Bloque	

		JOIN   Bloque_Efectivo
		ON     Bloque_Efectivo.BloqueID = Bloque.BloqueID
		JOIN Efectivo
	ON Efectivo.EfectivoID = Bloque_Efectivo.EfectivoID
		WHERE  Bloque.BovedaID = @BovedaID 
		AND    Bloque.EstaAbierto = 'FALSE'
AND Efectivo.EfectivoID = @denominacionID

		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_Bloque
						  ON     Traspaso.TraspasoID = Traspaso_Bloque.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_Bloque.BloqueID = Bloque.BloqueID )
	 and    NOT EXISTS(SELECT * 
						  FROM   Bloque
						  JOIN   CartaPorte
						  ON     CartaPorte.CartaPorteID = Bloque.CartaporteID
						  WHERE  Bloque.CartaporteID = Bloque.BloqueID )
END





GO
/****** Object:  StoredProcedure [dbo].[Bloque_Efectivo_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Bloque_Efectivo_Get]
	@BloqueID varchar(50)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT Bloque_Efectivo.BloqueID, 
		   Bloque_Efectivo.EfectivoID,
		   Bloque_Efectivo.Piezas, 
		   Bloque_Efectivo.Monto,
		   Efectivo.EfectivoTipoID,  
		   Efectivo.Denominacion,  
		   Efectivo.ImagePath,  
		   Efectivo.EstaActivo
	FROM   Bloque_Efectivo
	JOIN   Efectivo
	ON     Bloque_Efectivo.EfectivoID = Efectivo.EfectivoID
	WHERE  Bloque_Efectivo.BloqueID = @BloqueID
	
END
GO
/****** Object:  StoredProcedure [dbo].[Bloque_Efectivo_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Bloque_Efectivo_INSERT] 
	@BloqueID	varchar(50),
	@EfectivoID VARCHAR(5),
	@Piezas		INT,
	@Monto		DECIMAL(18,3)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION bloque_efectivo 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @BovedaID     INT,
			  @EstaAbierto  BIT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''




	  SELECT @BloqueID = Bloque.BloqueID,
			 @BovedaID     = BLoque.BovedaID,
			 @EstaAbierto  = EstaAbierto
      FROM   Bloque

	  WHERE  Bloque.BloqueID = @BloqueID

-- DESCOMENTAR PARA EL CUADRE
	  
	  BEGIN
		  IF ISNULL((SELECT MontoDisponible
			  FROM   vw_Efectivo
			  WHERE  EfectivoID = @EfectivoID
			  AND    BovedaID = @BovedaID),0) < @Monto
		  BEGIN
			  ROLLBACK TRANSACTION bloque_efectivo 

		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto +  b.Monto,
			   Piezas = Boveda_Efectivo.Piezas +  b.Piezas
		FROM   (SELECT Bloque_Efectivo.EfectivoID,
					   SUM(Bloque_Efectivo.Monto) AS Monto,
					   SUM(Bloque_Efectivo.Piezas) AS Piezas

				FROM   Boveda_Efectivo
				JOIN   Bloque_Efectivo
				ON     Boveda_Efectivo.EfectivoID = Bloque_Efectivo.EfectivoID
				JOIN   Bloque
				ON     Bloque_Efectivo.BloqueID = Bloque.BloqueID
				WHERE  Boveda_Efectivo.BovedaID = @BovedaID
				AND    Bloque.BloqueID = @BloqueID
				GROUP  BY Bloque_Efectivo.EfectivoID) b
		WHERE   Boveda_Efectivo.BovedaID =  @BovedaID
		AND     Boveda_Efectivo.EfectivoID = b.EfectivoID

		INSERT INTO Boveda_Efectivo
			 (BovedaID, 
			  EfectivoID, 
			  Piezas, 
			  Monto)
		SELECT @BovedaID AS BovedaID,
			   Bloque_Efectivo.EfectivoID, 
			   SUM(Bloque_Efectivo.Piezas), 
			   SUM(Bloque_Efectivo.Monto)
		FROM   Bloque_Efectivo
		JOIN   Bloque
		ON     Bloque_Efectivo.BloqueID = Bloque.BloqueID
		WHERE  NOT EXISTS (SELECT *
							FROM   Boveda_Efectivo
							WHERE  BovedaID = @BovedaID								
							AND    Boveda_Efectivo.EfectivoID <> Bloque_Efectivo.EfectivoID)
        AND    Bloque.BloqueID = @BloqueID
		GROUP  BY Bloque_Efectivo.EfectivoID

			 
			  SELECT @ERRORMESSAGE = 'Error: No tiene efectivo de ' 
									 + CAST ((SELECT Denominacion 
									          FROM   Efectivo			  
											  WHERE  EfectivoID = @EfectivoID) AS VARCHAR)  
								     + ' suficiente para crear el bloque  Nro. ' 
									 + CAST (@BloqueID AS VARCHAR),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @ERRORMESSAGE AS 'ErrorMessage',
					 @NUMERRORS    AS 'ErrorCount'
		  END
	   

	  
	  BEGIN
		  /**** Crea los efectivos  ****/ 
		  BEGIN TRY 
			  INSERT INTO Bloque_Efectivo
						  (BloqueID, 
						   EfectivoID, 
						   Piezas,
						   Monto) 
			  VALUES      (@BloqueID, 
						   @EfectivoID, 
						   @Piezas,
						   @Monto)
		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION bloque_efectivo 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage'   
			  RETURN
		  END CATCH     
	  END 
	  
	  END

-- DESCOMENTAR PARA EL CUADRE
--      /**** Actualiza la boveda  ****/
	  IF (@EstaAbierto = 0)
	  BEGIN
 		  UPDATE Boveda_Efectivo
		  SET    Monto = Boveda_Efectivo.Monto -  @Monto,
				 Piezas = Boveda_Efectivo.Piezas -  @Piezas
		  WHERE  EfectivoID  = @EfectivoID
		  AND    BovedaID = @BovedaID
	  END

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION bloque_efectivo 
      ELSE 
        COMMIT TRANSACTION bloque_efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END




GO
/****** Object:  StoredProcedure [dbo].[Bloque_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Bloque_Get]
	@BloqueID VARCHAR(50)
AS
BEGIN
	SET DATEFORMAT DMY

	SELECT Bloque.BovedaID AS BovedaID,
		   Bloque.BloqueID,
		   Bloque_Efectivo.Monto as monto,
			Efectivo.Denominacion as denominacion,
		   Bloque.LoginCreado,
   		   Bloque.FechaCreado
		  
	FROM   Bloque	
	JOIN  Bloque_Efectivo
	ON   Bloque_Efectivo.BloqueID = Bloque.BloqueID 
	JOIN Efectivo
	ON Efectivo.EfectivoID = Bloque_Efectivo.EfectivoID
	
	WHERE  Bloque.BloqueID = @BloqueID

END
GO
/****** Object:  StoredProcedure [dbo].[Bloque_GetBy_Bloque]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Bloque_GetBy_Bloque]
	@BloqueID VARCHAR(50)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT  Bloque.BloqueID,
		Bloque.BloqueID,
		Bloque_Efectivo.Piezas,
		Bloque_Efectivo.Monto,
		Efectivo.Denominacion
	FROM   Bloque
	JOIN   Bloque_Efectivo
	ON     Bloque_Efectivo.BloqueID = Bloque.BloqueID
	JOIN   Efectivo
	ON     Efectivo.EfectivoID = Bloque_Efectivo.EfectivoID
	WHERE  Bloque.BloqueID = @BloqueID
	
END













GO
/****** Object:  StoredProcedure [dbo].[Bloque_GetBy_Bolsa]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Bloque_GetBy_Bolsa]
	@BloqueID VARCHAR(50)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT  Bloque.BloqueID,
		Bloque.BloqueID,
		Bloque_Efectivo.Piezas,
		Bloque_Efectivo.Monto,
		Efectivo.Denominacion
	FROM   Bloque
	JOIN   Bloque_Efectivo
	ON     Bloque_Efectivo.BloqueID = Bloque.BloqueID
	JOIN   Efectivo
	ON     Efectivo.EfectivoID = Bloque_Efectivo.EfectivoID
	WHERE  Bloque.BloqueID = @BloqueID
	
END
















GO
/****** Object:  StoredProcedure [dbo].[Bloque_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Bloque_GetBy_Boveda]
	@BovedaID INT
	
AS
BEGIN
	SET DATEFORMAT DMY
	
		SELECT Bloque.BovedaID AS BovedaID,
			   Bloque.BloqueID,
			   Bloque_Efectivo.Monto as monto,
			   Bloque.LoginCreado,	
	   		   Bloque.FechaCreado,
			   Efectivo.Denominacion as denominacion
		FROM   Bloque	
		JOIN   Bloque_Efectivo
		ON     Bloque_Efectivo.BloqueID = Bloque.BloqueID
		JOIN   Efectivo
		ON     Efectivo.EfectivoID = Bloque_Efectivo.EfectivoID
		WHERE  Bloque.BovedaID = @BovedaID 
		AND    Bloque.EstaAbierto = 'FALSE'

	
END























GO
/****** Object:  StoredProcedure [dbo].[Bloque_GetBy_Traspaso]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Bloque_GetBy_Traspaso]
	@TraspasoID INT
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT Bloque.BovedaID AS BovedaID,
		   Bloque.BloqueID,
		   Bloque_Efectivo.Monto,
		   Bloque.LoginCreado,
	   	   Bloque.FechaCreado,
		   Bloque.EstaAbierto,
			Efectivo.Denominacion
	FROM   Bloque	
	JOIN   Bloque_Efectivo
	ON     Bloque.BloqueID = Bloque_Efectivo.BloqueID
	JOIN   Efectivo
	ON     Efectivo.EfectivoID = Bloque_Efectivo.EfectivoID
	JOIN   Traspaso_Bloque
	ON     Bloque.BloqueID = Traspaso_Bloque.BloqueId --traspaso
	JOIN   Traspaso traspaso
	ON     Traspaso_Bloque.TraspasoID = Traspaso.TraspasoId --traspaso
	WHERE  traspaso.TraspasoID = @TraspasoID 

	
END
GO
/****** Object:  StoredProcedure [dbo].[Bloque_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Bloque_INSERT] 
	@BovedaID INT,
	@EfectivoID VARCHAR(5),
	@LoginCreado VARCHAR(50)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION bloque 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @BloqueID		 VARCHAR(50)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	
	  
	IF(@EfectivoID = 'BF2')
	BEGIN
	  SET @BloqueID = '50N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	
	
	IF(@EfectivoID = 'BF20')
	BEGIN
	  SET @BloqueID = '02N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

	IF(@EfectivoID = 'BF21')
	BEGIN
	  SET @BloqueID = '05N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

	IF(@EfectivoID = 'BF22')
	BEGIN
	  SET @BloqueID = '10N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

	IF(@EfectivoID = 'BF23')
	BEGIN
	  SET @BloqueID = '20N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

	IF(@EfectivoID = 'BF5')
	BEGIN
	  SET @BloqueID = '100' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

	

	IF(@EfectivoID = 'B001')
	BEGIN
	  SET @BloqueID = 'B001N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	
	
	IF(@EfectivoID = 'B002')
	BEGIN
	  SET @BloqueID = 'B002N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

	IF(@EfectivoID = 'B003')
	BEGIN
	  SET @BloqueID = 'B003N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

	IF(@EfectivoID = 'B004')
	BEGIN
	  SET @BloqueID = 'B004N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

	IF(@EfectivoID = 'B005')
	BEGIN
	  SET @BloqueID = 'B005N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

	IF(@EfectivoID = 'B006')
	BEGIN
	  SET @BloqueID = 'B006N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	
	IF(@EfectivoID = 'B007')
	BEGIN
	  SET @BloqueID = 'B007N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	
	IF(@EfectivoID = 'B008')
	BEGIN
	  SET @BloqueID = 'B008N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	
	IF(@EfectivoID = 'B009')
	BEGIN
	  SET @BloqueID = 'B009N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	
	IF(@EfectivoID = 'B012')
	BEGIN
	  SET @BloqueID = 'B012N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	
	IF(@EfectivoID = 'B013')
	BEGIN
	  SET @BloqueID = 'B013N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	
	IF(@EfectivoID = 'B014')
	BEGIN
	  SET @BloqueID = 'B014N' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (BloqueID, 4, LEN(BloqueID) -3)))
										   FROM   bloque),0) + 1 AS VARCHAR)
	END	

      /**** Crea el bloque ****/ 
      BEGIN TRY 
          INSERT INTO Bloque
                      (BovedaID,
					   BloqueID,
					   FechaCreado,
						LoginCreado,CartaporteID) 
          VALUES      (@BovedaID,
					   @BloqueID,
					   getdate(),
					@LoginCreado,'NOCOMPRO')
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION bloque 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION bloque 
      ELSE 
        COMMIT TRANSACTION bloque 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @BloqueID AS 'ExtraValue'
  END

GO
/****** Object:  StoredProcedure [dbo].[Bolsa_CERRAR]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
CREATE PROCEDURE [dbo].[Bolsa_CERRAR] 
	@BolsaID VARCHAR (50),
	@CartaporteID VARCHAR (13),
	@LoginCerrado VARCHAR(13)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION bolsa 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[BOLSA]    ***********************/

	  BEGIN TRY 
          UPDATE Bolsa 
		  SET    Cerrado = 1,
				 LoginCerrado = @LoginCerrado
				
		  WHERE  BolsaID = @BolsaID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION bolsa 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    UPDATE:[CARTAPORTE]    ***********************/

IF NOT EXISTS(SELECT CartaporteID 
			FROM cartaporte 
			WHERE CartaporteID = @CartaporteID)

	BEGIN
		ROLLBACK TRANSACTION bolsa 
	      SELECT @ERRORMESSAGE = 'Error: No existe ningun Cartaporte con ese Numero',
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
		
	END
	ELSE
		BEGIN TRY
		UPDATE Cartaporte
		SET    BolsaID = @BolsaID
		WHERE  CartaporteID = @CartaporteID
		 END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 
/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION bolsa 
      ELSE 
        COMMIT TRANSACTION bolsa 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  








GO
/****** Object:  StoredProcedure [dbo].[Bolsa_Disponibles_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Bolsa_Disponibles_GetBy_Boveda]
	@BovedaID INT
AS
BEGIN
	SET DATEFORMAT DMY
	
	
		SELECT Bolsa.BovedaID AS BovedaID,			 
			   Bolsa.BolsaID,
			   Monto,
			   Bolsa.LoginCreado,
	   		   Bolsa.FechaCreado
			 
		FROM   Bolsa	
		
		WHERE  Bolsa.BovedaID = @BovedaID 
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_Bolsa
						  ON     Traspaso.TraspasoID = Traspaso_Bolsa.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_Bolsa.BolsaID = Bolsa.BolsaID )
END






GO
/****** Object:  StoredProcedure [dbo].[Bolsa_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Bolsa_Get]
	@BolsaID VARCHAR(50)
AS
BEGIN
	SET DATEFORMAT DMY

	SELECT Bolsa.BovedaID AS BovedaID,
		   Bolsa.BolsaID,
		   Monto,
		   Bolsa.LoginCreado,
   		   Bolsa.FechaCreado
		  
	FROM   Bolsa	
	
	WHERE  Bolsa.BolsaID = @BolsaID

END





GO
/****** Object:  StoredProcedure [dbo].[Bolsa_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Bolsa_GetBy_Boveda]
	@BovedaID INT
	
AS
BEGIN
	SET DATEFORMAT DMY
	
		SELECT Bolsa.BovedaID AS BovedaID,
			   Bolsa.BolsaID,
			   Monto,
			   Bolsa.LoginCreado,	
	   		   Bolsa.FechaCreado
		FROM   Bolsa	
		
		WHERE  Bolsa.BovedaID = @BovedaID 
		AND    Bolsa.Cerrado = 2 

	
END







GO
/****** Object:  StoredProcedure [dbo].[Bolsa_GetBy_Traspaso]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cartaporte Traspaso
-- =============================================
CREATE PROCEDURE [dbo].[Bolsa_GetBy_Traspaso]
	@TraspasoID INT
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT Bolsa.BovedaID AS BovedaID,
		   Bolsa.BolsaID,
		   Monto,
		   Bolsa.LoginCreado,
	   	   Bolsa.FechaCreado,
		   Bolsa.Cerrado
	FROM   Bolsa	
	JOIN   Traspaso_Bolsa
	ON     Bolsa.BolsaID = Traspaso_Bolsa.BolsaId --traspaso
	JOIN   Traspaso traspaso
	ON     Traspaso_Bolsa.TraspasoID = Traspaso.TraspasoId --traspaso
	WHERE  traspaso.TraspasoID = @TraspasoID 

	
END







GO
/****** Object:  StoredProcedure [dbo].[Bolsa_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Bolsa_INSERT] 
    @BolsaID VARCHAR(50),
	@BovedaID INT, 
	@Monto DECIMAL(18,3),
	@LoginCreado VARCHAR(30)
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION bolsa 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	  IF EXISTS(SELECT * FROM bolsa WHERE BolsaID = @BolsaID)
	  BEGIN 
			/***********************    INSERT:[BOLSA]    ***********************/
		ROLLBACK TRANSACTION bolsa 
			  SELECT @ERRORMESSAGE = 'Error: No puede crear una bolsa con el numero ' + @BolsaID +  ', ya que esta reservado.',
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
			  RETURN

	  END
		
	/***********************    INSERT:[BOLSA]    ***********************/
		  BEGIN TRY 
			  INSERT INTO bolsa 
						  (BolsaID, 
						   BovedaID, 
						   Monto, 
						   FechaCreado, 
						   LoginCreado) 
			  VALUES      (@BolsaID, 
						   @BovedaID, 
						   @Monto, 
						   GetDate(), 
						   UPPER(@LoginCreado)) 
		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION bolsa 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
			  RETURN
		  END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION bolsa 
      ELSE 
        COMMIT TRANSACTION bolsa 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @BolsaID    AS 'ExtraValue'
	
  END










GO
/****** Object:  StoredProcedure [dbo].[Boveda_Efectivo_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Boveda_Efectivo_INSERT]  
	@EfectivoID  VARCHAR(5),
	@BovedaID  INT
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION caja 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)
			 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 




/***********************    INSERT:[EFECTIVOS]    ***********************/

	  BEGIN TRY 
		
         INSERT INTO boveda_efectivo 
					  (BovedaID,EfectivoID,Piezas,Monto) 
         VALUES      (@BovedaID,@EfectivoID,0,0) 

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION caja 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION caja 
      ELSE 
        COMMIT TRANSACTION caja 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END


GO
/****** Object:  StoredProcedure [dbo].[Boveda_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Boveda_INSERT] 
	@nombre VARCHAR(30)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION boveda 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @BovedaID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	


      /**** Crea el boveda ****/ 
      BEGIN TRY 
          INSERT INTO Boveda
                      (nombre)
          VALUES      (@Nombre)
		  set @BovedaID =  SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION boveda 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION boveda 
      ELSE 
        COMMIT TRANSACTION boveda 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @BovedaID AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Caja_Efectivo_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Caja_Efectivo_INSERT]  
	@EfectivoID  VARCHAR(5),
	@CajaID  INT
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION caja 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)
			 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 




/***********************    INSERT:[EFECTIVOS]    ***********************/

	  BEGIN TRY 
		
         INSERT INTO caja_efectivo 
					  (CajaID,EfectivoID,Piezas,Monto) 
         VALUES      (@CajaID,@EfectivoID,0,0) 

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION caja 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION caja 
      ELSE 
        COMMIT TRANSACTION caja 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END



GO
/****** Object:  StoredProcedure [dbo].[Caja_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Crear cartaporte	
-- ============================================= 
CREATE PROCEDURE [dbo].[Caja_INSERT]  
	@Nombre  VARCHAR(200),
	@Tipo  INT
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION caja 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @ID INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 




/***********************    INSERT:[PLACA]    ***********************/

	  BEGIN TRY 
          INSERT INTO caja 
					  (Nombre,tipo) 
          VALUES      (@Nombre,@Tipo) 
		 SET @ID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION caja 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION caja 
      ELSE 
        COMMIT TRANSACTION caja 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @ID			AS 'Identity'
  END


GO
/****** Object:  StoredProcedure [dbo].[Caja_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Caja_UPDATE] 
	@Nombre VARCHAR(200),
	@CajaID INT
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION caja 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[OFICIAL]    ***********************/

	  BEGIN TRY 
          UPDATE Caja 
		  SET    Nombre = @Nombre
				
		  WHERE  CajaID = @CajaID

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION caja 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION caja 
      ELSE 
        COMMIT TRANSACTION caja 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Acopio_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Juan delgado

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_Acopio_Get]
	@CartaporteID varchar(13)
AS
BEGIN
	SET DATEFORMAT DMY
	
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
			
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE   CartaPorte.Cerrado = 0
and CartaPorte.CartaPorteID = @CartaporteID
and  CartaPorte.BovedaID = 2


END





GO
/****** Object:  StoredProcedure [dbo].[Cartaporte_Acta_DELETE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:   
-- Create date: 05-10-2010 
-- Description:  Eliminar
-- ============================================= 
create PROCEDURE [dbo].[Cartaporte_Acta_DELETE] 
    @CartaPorteID VARCHAR(13)
	
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	

/***********************    DELETE:[CARTA DE PORTE]    ***********************/

			BEGIN TRY 
				
				DELETE FROM CartaPorte
				WHERE  CartaPorteID = @CartaPorteID 
			END TRY 
			BEGIN CATCH 
				ROLLBACK TRANSACTION cartaporte 
				SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
				SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
				RETURN
			END CATCH 
		
	 
/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @CartaPorteID    AS 'ExtraValue'
  END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_ATM_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Juan delgado

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_ATM_Get]
	@CartaporteID varchar(13)
AS
BEGIN
	SET DATEFORMAT DMY
	
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
			
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE   CartaPorte.Cerrado = 0
and CartaPorte.CartaPorteID = @CartaporteID
and  CartaPorte.BovedaID = 17


END





GO
/****** Object:  StoredProcedure [dbo].[Cartaporte_Bloque_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[Cartaporte_Bloque_INSERT] 
	@CartaporteID VARCHAR(13),
	@BloqueID VARCHAR(50),
	@Login VARCHAR(100)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION bloque 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[BLOQUE]    ***********************/

	  BEGIN TRY 
          UPDATE Bloque 
		  SET    CartaporteID = @CartaporteID,
				 EstaAbierto = 'True',
				 LoginAbierto = @Login
		  WHERE	 BloqueID = @BloqueID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION bloque 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION bloque 
      ELSE 
        COMMIT TRANSACTION bloque 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Cartaporte_CANCELAR]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:   
-- Create date: 05-10-2010 
-- Description:  cancelar
-- ============================================= 
CREATE PROCEDURE [dbo].[Cartaporte_CANCELAR] 
    @CartaPorteID VARCHAR(13),
	@BovedaID INT
	
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	  IF(EXISTS (SELECT *
					 FROM   Ruta_CartaPorte
					 WHERE  Ruta_CartaPorte.CartaPorteID = @CartaPorteID))
	  BEGIN
		ROLLBACK TRANSACTION cartaporte 
	    SELECT @ERRORMESSAGE = 'Error: No puede eliminar esta carta de portes. Se encuentra Asignado a una ruta',
			   @NUMERRORS = @NUMERRORS + 1
	    SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
	    RETURN
	  END

/***********************    VERFICAMOS QUE ESTE EN LA BOVEDA   ***********************/
	  IF(NOT EXISTS (SELECT *
					 FROM   CartaPorte
					 WHERE  CartaPorte.BovedaID = @BovedaID))
	  BEGIN
		ROLLBACK TRANSACTION cartaporte 
	    SELECT @ERRORMESSAGE = 'Error: No puede eliminar esta carta de portes.No Se encuentra en su Boveda',
			   @NUMERRORS = @NUMERRORS + 1
	    SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
	    RETURN
	  END

/***********************    VERFICAMOS QUE NO ESTE EN UN TRASPASO    ***********************/
	  IF(EXISTS (SELECT *
					 FROM   Traspaso_CartaPorte
					 WHERE  Traspaso_CartaPorte.CartaPorteID = @CartaPorteID))
	  BEGIN
		ROLLBACK TRANSACTION cartaporte 
	    SELECT @ERRORMESSAGE = 'Error: No puede eliminar esta carta de portes. Esta asignado a un traspaso',
			   @NUMERRORS = @NUMERRORS + 1
	    SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
	    RETURN
	  END


/***********************    DELETE:[CARTA DE PORTE]    ***********************/

	  BEGIN TRY 

          DELETE FROM CartaPorte
		  WHERE  CartaPorteID = @CartaPorteID 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 
/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @CartaPorteID    AS 'ExtraValue'
  END





GO
/****** Object:  StoredProcedure [dbo].[Cartaporte_DELETE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








-- ============================================= 
-- Author:   
-- Create date: 05-10-2010 
-- Description:  Eliminar
-- ============================================= 
CREATE PROCEDURE [dbo].[Cartaporte_DELETE] 
    @CartaPorteID VARCHAR(13)
	
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	  IF(NOT EXISTS (SELECT *
					 FROM   Ruta_CartaPorte
					 JOIN   Ruta
					 ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
					 WHERE  Ruta_CartaPorte.CartaPorteID = @CartaPorteID
					 AND    Ruta.Recibida = 1
				     AND    Ruta.Cerrada = 0))
	  BEGIN
		ROLLBACK TRANSACTION cartaporte 
	    SELECT @ERRORMESSAGE = 'Error: No puede eliminar esta carta de portes.',
			   @NUMERRORS = @NUMERRORS + 1
	    SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
	    RETURN
	  END


/***********************    DELETE:[CARTA DE PORTE]    ***********************/
IF(NOT EXISTS (SELECT * 
			   FROM   Traspaso_Cartaporte
			   WHERE  Traspaso_Cartaporte.CartaporteID = @CartaPorteID))
		BEGIN
			BEGIN TRY 
				DELETE FROM Ruta_CartaPorte
				WHERE  CartaPorteID = @CartaPorteID

				DELETE FROM CartaPorte
				WHERE  CartaPorteID = @CartaPorteID 
			END TRY 
			BEGIN CATCH 
				ROLLBACK TRANSACTION cartaporte 
				SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
				SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
				RETURN
			END CATCH 
		END		
		ELSE
		BEGIN
			ROLLBACK TRANSACTION cartaporte 
			SELECT @ERRORMESSAGE = 'Error: No puede eliminar esta carta de portes ya que esta asignado a un traspaso.',
			     @NUMERRORS = @NUMERRORS + 1
			SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
			RETURN
		END
	 
/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @CartaPorteID    AS 'ExtraValue'
  END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Disponibles_Contado_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_Disponibles_Contado_GetBy_Boveda]
	@BovedaID INT,
	@CuentaID   INT = NULL
AS
BEGIN
	SET DATEFORMAT DMY
	IF(@CuentaID IS NULL)
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		 
		FROM   CartaPorte
				
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID 
		AND    CartaPorte.Cerrado = 1
		AND    Cartaporte.CuentaID = 36
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
						  order by ConsignadorR.Fecha
	END
	IF(@CuentaID = 0)
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 1 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID  
		AND    CartaPorte.Cerrado = 1
		AND    CartaPorte.CuentaID NOT IN (35,36)
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		order by ConsignadorR.Fecha
	END
	ELSE
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID  
		AND    CartaPorte.Cerrado = 1
		AND    Cartaporte.CuentaID = 36
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    CartaPorte.CuentaID = @CuentaID
		order by ConsignadorR.Fecha
	END
END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Disponibles_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_Disponibles_GetBy_Boveda]
	@BovedaID INT,
	@CuentaID   INT = NULL
AS
BEGIN
	SET DATEFORMAT DMY
	IF(@CuentaID IS NULL)
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
			
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID 
		AND    CartaPorte.Cerrado = 0
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
						  order by ConsignadorR.Fecha
	END
		IF(@BovedaID = 4)
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
			
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID IN(@BovedaID,10)
		AND    CartaPorte.Cerrado = 0
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
						  order by ConsignadorR.Fecha
	END
	IF(@CuentaID = 0)
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 1 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID  
		AND    CartaPorte.Cerrado = 0
		AND    CartaPorte.CuentaID NOT IN (35,36)
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		order by ConsignadorR.Fecha
	END
	ELSE
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID  
		AND    CartaPorte.Cerrado = 0
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    CartaPorte.CuentaID = @CuentaID
		order by ConsignadorR.Fecha
	END
END

GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Disponibles_GetBy_BovedaPorTipo]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaPorte_Disponibles_GetBy_BovedaPorTipo]
	@BovedaID INT,
	@Tipo   VARCHAR(50),
@Nombre   VARCHAR(50) 
AS
BEGIN
	SET DATEFORMAT DMY


	BEGIN
SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
			
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		JOIN   Biblia
		--ON Biblia.PuntoID in(Consignador.PuntoID,Consignatario.PuntoID)
        ON Biblia.PuntoID in(Consignatario.PuntoID)
		WHERE  CartaPorte.BovedaID = @BovedaID
AND    CARTAPORTE.CERRADO = 0
--		AND    NOT EXISTS(SELECT * 
--						  FROM   Traspaso
--						  JOIN   Traspaso_CartaPorte
--						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
--						  WHERE  Traspaso.Recibido = 1
--						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  --AND    Ruta.Despachada IN (0,1)							
						  --AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    Biblia.Tipo in(@Tipo,@Tipo + 'mtb')
--AND Biblia.ruta = @Nombre
	
	END
END
GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Disponibles_GetBy_BovedaPorTipoDiaSiguiente]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaPorte_Disponibles_GetBy_BovedaPorTipoDiaSiguiente]
	@BovedaID INT,
	@Tipo   VARCHAR(50),
@Nombre   VARCHAR(50),
@CuentaID INT
AS
BEGIN
	SET DATEFORMAT DMY

BEGIN
	
SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
			
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		--JOIN   Biblia
		----ON Biblia.PuntoID in(Consignador.PuntoID,Consignatario.PuntoID)
  --      ON Biblia.PuntoID in(Consignador.PuntoID,Consignatario.PuntoID)
		WHERE  CartaPorte.BovedaID = 1
		AND    CARTAPORTE.CERRADO = 0
		AND    CartaPorte.CuentaID = @CuentaID
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  
						   --Ruta_CartaPorte.Tipo in(1,2,3,4)
						     Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						   AND Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID)
		--AND    Biblia.Tipo in('banco','banco' + 'mtb')
	
	END
END
GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Disponibles_GetBy_BovedaPorTipoDiaSiguienteEntubado]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaPorte_Disponibles_GetBy_BovedaPorTipoDiaSiguienteEntubado]
	@BovedaID INT,
	@Tipo   VARCHAR(50),
@Nombre   VARCHAR(50),
@CuentaID INT
AS
BEGIN
	SET DATEFORMAT DMY

BEGIN
	
SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
				
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		--JOIN   Biblia
		----ON Biblia.PuntoID in(Consignador.PuntoID,Consignatario.PuntoID)
  --      ON Biblia.PuntoID in(Consignador.PuntoID,Consignatario.PuntoID)
		WHERE  CartaPorte.BovedaID = 1
		AND    CARTAPORTE.CERRADO = 0
		AND    CartaPorte.CuentaID = @CuentaID
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  
						   --Ruta_CartaPorte.Tipo in(1,2,3,4)
						     Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						   AND Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID)
		--AND    Biblia.Tipo in('banco','banco' + 'mtb')
	
	END
	END
GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Disponibles_GetBy_Cuenta]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaPorte_Disponibles_GetBy_Cuenta]
	@CuentaID INT
AS
BEGIN
	SET DATEFORMAT DMY
	
	SELECT puntoID from cartaporte_punto 
	JOIN cartaporte
	ON  cartaporte.cartaporteid = cartaporte_punto.cartaporteid
	WHERE cartaporte.cuentaid  = @CuentaID
	AND NOT EXISTS(SELECT *
					 FROM   Ruta_CartaPorte
					 WHERE  Ruta_CartaPorte.CartaPorteID = cartaporte.CartaPorteID)
END


GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Disponibles_GetBy_CuentaComercial]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaPorte_Disponibles_GetBy_CuentaComercial]

AS
BEGIN
	SET DATEFORMAT DMY
	
    SELECT puntoID from cartaporte_punto 
	JOIN cartaporte
	ON  cartaporte.cartaporteid = cartaporte_punto.cartaporteid
	WHERE cartaporte.cuentaid  NOT IN  (7,12,35,36)
	AND EXISTS(SELECT *
					 FROM   Ruta_CartaPorte
					 WHERE  Ruta_CartaPorte.CartaPorteID = cartaporte.CartaPorteID)
END

GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Disponibles_Por_Solictud_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_Disponibles_Por_Solictud_GetBy_Boveda]
	@BovedaID INT
AS
BEGIN
	SET DATEFORMAT DMY

	BEGIN
	SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   CartaPorte.Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
				
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		JOIN   Solicitud_CartaPorte SC
		ON     SC.CartaPorteID = CartaPorte.CartaPorteID
		JOIN   Solicitud S
		ON     S.SolicitudID = SC.SolicitudID
		WHERE  CartaPorte.BovedaID = @BovedaID  
		AND    CartaPorte.Cerrado = 0
			AND    CartaPorte.StatusID = 3
		AND CartaPorte.CuentaID = 7
		AND  S.Tipo = 'BLOQUES'
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )

		order by ConsignadorR.Fecha
	END
END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Disponibles_Por_SolictudEfectivo_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_Disponibles_Por_SolictudEfectivo_GetBy_Boveda]
	@BovedaID INT
AS
BEGIN
	SET DATEFORMAT DMY

	BEGIN
	SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   CartaPorte.Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
				
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		JOIN   Solicitud_CartaPorte SC
		ON     SC.CartaPorteID = CartaPorte.CartaPorteID
		JOIN   Solicitud S
		ON     S.SolicitudID = SC.SolicitudID
		WHERE  CartaPorte.BovedaID = @BovedaID  
		AND    CartaPorte.Cerrado = 0
			AND    CartaPorte.StatusID = 3
		--AND CartaPorte.CuentaID = 7
		AND  S.Tipo = 'EFECTIVOS'
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada IN (0,1)							
						  AND    Ruta.Cerrada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )

		order by ConsignadorR.Fecha
	END
END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_Get]
	@CartaPorteID VARCHAR(13)
AS
BEGIN
	SET DATEFORMAT DMY

	SELECT CartaPorte.BovedaID AS BovedaID,
		   Cuenta.Nombre AS Cuenta,
		   Cuenta.CuentaID	AS  CuentaID,
		   Cuenta.Nombre	AS  CuentaNombre,
		   CartaPorte.CartaPorteID,
		   ConsignadorR.PuntoID AS ConsignadorID,
		   Consignador.Nombre AS Consignador,
		   ConsignadorR.Fecha AS ConsignadorFecha,
		   ConsignatarioR.PuntoID AS ConsignatarioID,
		   Consignatario.Nombre AS Consignatario,
		   ConsignatarioR.Fecha AS ConsignatarioFecha,
		   Monto,
		   CartaPorte.LoginCreado,
		   CartaPorte.LoginCerrado,		
   		   CartaPorte.FechaCreado,
		   CartaPorte.FechaCerrado,		
   		   CartaPorte.Cerrado
		FROM   CartaPorte
				
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
	WHERE  CartaPorte.CartaPorteID = @CartaPorteID

END




GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_GetBy_Boveda]
	@BovedaID INT,
	@CuentaID   INT = NULL
AS
BEGIN
	SET DATEFORMAT DMY
	IF(@CuentaID IS NULL)
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
				
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID  
		AND    CartaPorte.Cerrado = 0
--		AND    NOT EXISTS(SELECT * 
--						  FROM   Traspaso
--						  JOIN   Traspaso_CartaPorte
--						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
--						  WHERE  Traspaso.Recibido = 0
--						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
--			AND    NOT EXISTS(SELECT * 
--						  FROM   Ruta
--						  JOIN   Ruta_CartaPorte
--						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
--						  WHERE  Ruta_CartaPorte.Tipo = 1
--						  AND    Ruta.Despachada = 0
--						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
	END
	ELSE
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID  
		AND    CartaPorte.Cerrado = 0
--		AND    NOT EXISTS(SELECT * 
--						  FROM   Traspaso
--						  JOIN   Traspaso_CartaPorte
--						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
--						  WHERE  Traspaso.Recibido = 0
--						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
--		AND    NOT EXISTS(SELECT * 
--						  FROM   Ruta
--						  JOIN   Ruta_CartaPorte
--						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
--						  WHERE  Ruta_CartaPorte.Tipo = 1
--						  AND    Ruta.Despachada = 0
--						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
--		AND    CartaPorte.CuentaID = @CuentaID

	END
END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_GetBy_BovedaConLosTeques]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Juan DELGADO

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_GetBy_BovedaConLosTeques]
	@BovedaID INT,
	@BovedaID2 INT
	--@CuentaID   INT = NULL
AS
BEGIN
	SET DATEFORMAT DMY
	
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID IN(@BovedaID,@BovedaID2)  
		AND    CartaPorte.Cerrado = 0
	

	END
END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_GetBy_BovedaDisponible]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_GetBy_BovedaDisponible]
	@BovedaID INT,
	@CuentaID   INT = NULL
AS

	BEGIN
	SET DATEFORMAT DMY
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
				
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID
		AND    CartaPorte.Cerrado = 0
		and    CartaPorte.RubroID in(1,2,3,4)
		
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo IN(1,4)
						  --AND    Ruta.Despachada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
	END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_GetBy_BovedaDisponibleCT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_GetBy_BovedaDisponibleCT]
	@BovedaID INT,
	@BovedaID2 INT
AS

	BEGIN
	SET DATEFORMAT DMY
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
				
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
			WHERE  CartaPorte.BovedaID IN(@BovedaID,@BovedaID2)  
		AND    CartaPorte.Cerrado = 0
		and    CartaPorte.RubroID in(1,2,3,4)
		
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso.BovedaEmisorID in (@BovedaID,@BovedaID2)  
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo IN(1,4)
						  AND    Ruta.Despachada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
						  ORDER BY CartaPorte.CartaPorteID
	END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_GetBy_BovedaInventario]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_GetBy_BovedaInventario]
	@BovedaID INT
AS
BEGIN
	SET DATEFORMAT DMY
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
			
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID  
		AND    CartaPorte.Cerrado = 0
		AND    CartaPorte.StatusID = 1

	
END





GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_GetBy_Punto]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaPorte_GetBy_Punto]
	@PuntoID INT
AS
BEGIN
	SET DATEFORMAT DMY
	
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
				
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  ConsignadorR.PuntoID = @PuntoID  
		AND    CartaPorte.Cerrado = 0
		AND    CartaPorte.BovedaID = 6


END







GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_GetBy_Ruta]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_GetBy_Ruta]
	@RutaID INT,
	@Tipo   INT,
	@Tipo2   INT
AS
BEGIN
	SET DATEFORMAT DMY

	SELECT CartaPorte.BovedaID AS BovedaID,
		   Cuenta.Nombre AS Cuenta,
		   Cuenta.CuentaID	AS  CuentaID,
		   Cuenta.Nombre	AS  CuentaNombre,
		   CartaPorte.CartaPorteID,
		   ConsignadorR.PuntoID AS ConsignadorID,
		   Consignador.Nombre AS Consignador,
		   ConsignadorR.Fecha AS ConsignadorFecha,
		   ConsignatarioR.PuntoID AS ConsignatarioID,
		   Consignatario.Nombre AS Consignatario,
		   ConsignatarioR.Fecha AS ConsignatarioFecha,
		   Monto,
		   CartaPorte.LoginCreado,
		   CartaPorte.LoginCerrado,		
   		   CartaPorte.FechaCreado,
		   CartaPorte.FechaCerrado,		
		   CartaPorte.Cerrado
		   from CartaPorte
	
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
	WHERE  EXISTS(SELECT * 
				  FROM   Ruta_CartaPorte
				  WHERE  Ruta_CartaPorte.RutaID = @RutaID
				  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
				  AND    Ruta_CartaPorte.Tipo in(@Tipo,@Tipo2) )
				  
--			AND    NOT EXISTS(SELECT * 
--						  FROM   Ruta
--						  JOIN   Ruta_CartaPorte
--						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
--						  WHERE  Ruta_CartaPorte.Tipo = 1
--						  AND    Ruta.Despachada = 0
--						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )

order by  Consignador.Nombre

	
END




GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_GetBy_RutaEliminar]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_GetBy_RutaEliminar]
	@RutaID INT
AS
BEGIN
	SET DATEFORMAT DMY

	SELECT CartaPorte.BovedaID AS BovedaID,
		   Cuenta.Nombre AS Cuenta,
		   Cuenta.CuentaID	AS  CuentaID,
		   Cuenta.Nombre	AS  CuentaNombre,
		   CartaPorte.CartaPorteID,
		   ConsignadorR.PuntoID AS ConsignadorID,
		   Consignador.Nombre AS Consignador,
		   ConsignadorR.Fecha AS ConsignadorFecha,
		   ConsignatarioR.PuntoID AS ConsignatarioID,
		   Consignatario.Nombre AS Consignatario,
		   ConsignatarioR.Fecha AS ConsignatarioFecha,
		   Monto,
		   CartaPorte.LoginCreado,
		   CartaPorte.LoginCerrado,		
   		   CartaPorte.FechaCreado,
		   CartaPorte.FechaCerrado,		
		   CartaPorte.Cerrado
		FROM   CartaPorte
				
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
	WHERE  EXISTS(SELECT * 
				  FROM   Ruta_CartaPorte
				  WHERE  Ruta_CartaPorte.RutaID = @RutaID
				  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID)
				  


order by  Consignador.Nombre

	
END




GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_GetBy_Traspaso]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cartaporte Traspaso
-- =============================================
CREATE PROCEDURE [dbo].[CartaPorte_GetBy_Traspaso]
	@TraspasoID INT
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT CartaPorte.BovedaID AS BovedaID,
		   Cuenta.Nombre AS Cuenta,
		   Cuenta.CuentaID	AS  CuentaID,
		   Cuenta.Nombre	AS  CuentaNombre,
		   CartaPorte.CartaPorteID,
		   ConsignadorR.PuntoID AS ConsignadorID,
		   Consignador.Nombre AS Consignador,
		   ConsignadorR.Fecha AS ConsignadorFecha,
		   ConsignatarioR.PuntoID AS ConsignatarioID,
		   Consignatario.Nombre AS Consignatario,
		   ConsignatarioR.Fecha AS ConsignatarioFecha,
		   Monto,
		   CartaPorte.LoginCreado,
		   CartaPorte.LoginCerrado,		
	   	   CartaPorte.FechaCreado,
		   CartaPorte.FechaCerrado,		
		   CartaPorte.Cerrado
	FROM   CartaPorte	
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
	JOIN   Traspaso_CartaPorte
	ON     CartaPorte.CartaPorteID = Traspaso_CartaPorte.CartaPorteId --traspaso
	JOIN   Traspaso traspaso
	ON     Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoId --traspaso
	WHERE  traspaso.TraspasoID = @TraspasoID 

	
END






GO
/****** Object:  StoredProcedure [dbo].[Cartaporte_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Crear cartaporte	
-- ============================================= 
CREATE PROCEDURE [dbo].[Cartaporte_INSERT] 
    @CartaPorteID VARCHAR(13) = NULL,
	@CuentaID INT,
	@StatusID INT,
	@SolicitudID INT,
    @RubroID INT,
	@BovedaID INT, 
	@Monto DECIMAL(18,3),
	@LoginCreado VARCHAR(30), 
	@ConsignadorID INT,
	@ConsignatarioID INT,
	@ConsignadorFecha VARCHAR(10), 
	@ConsignatarioFecha  VARCHAR(10) = NULL
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @PorSistema BIT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	  SET @PorSistema = 1

	  IF(@CartaPorteID IS NULL)
	  BEGIN
		  SET @PorSistema = 1
		  SET @CartaPorteID = 'TVV' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (CartaPorteID, 4, LEN(CartaPorteID) -3)))
												   FROM   cartaporte
												   WHERE  porsistema = 1),0) + 1 AS VARCHAR)
	  END
	  ELSE 
	  BEGIN
		  SET @PorSistema = 0
		  IF(SUBSTRING(@CartaPorteID,1,3) = 'TVV')
			BEGIN 
			   ROLLBACK TRANSACTION cartaporte 
			   SELECT @ERRORMESSAGE = 'Error: No puede crear una carta de portes con el prefijo TVV, ya que esta reservado.',
					  @NUMERRORS = @NUMERRORS + 1
			   SELECT @NUMERRORS     AS 'ErrorCount', 
					  @ERRORMESSAGE AS 'ErrorMessage'
			   RETURN
			END 

	  END


/***********************    VALIDACIONES:[NRO DE CARTAS DE PORTE]    ***********************/

	  IF EXISTS(SELECT * 
			    FROM   CartaPorte
				WHERE  CartaPorteID =  @CartaPorteID)
        BEGIN 
		   ROLLBACK TRANSACTION cartaporte 
		   SELECT @ERRORMESSAGE = 'Error: Ya existe una carta de portes con el Nro. ' + CONVERT (VARCHAR, @CartaPorteID),
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
        END 




/***********************    INSERT:[CARTA DE PORTE]    ***********************/

	  BEGIN TRY 
          INSERT INTO cartaporte 
					  (CartaPorteID, 
					   CuentaID,
					   StatusID,
					   RubroID, 
					   BovedaID, 
					   Monto, 
					   FechaCreado, 
					   LoginCreado,
					   PorSistema) 
          VALUES      (@CartaPorteID, 
					   @CuentaID, 
					   @StatusID,
					   @RubroID,
					   @BovedaID, 
					   @Monto, 
					   GetDate(), 
					   UPPER(@LoginCreado),
					   @PorSistema) 
					   
	    IF (@SolicitudID <> '')
	    BEGIN
			INSERT INTO Solicitud_CartaPorte
						  (CartaPorteID, 
						   SolicitudID) 
			  VALUES      (@CartaPorteID, 
						   @SolicitudID) 
	    END   
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    INSERT:[CONSIGNADOR]    ***********************/

	  BEGIN TRY 
          INSERT INTO CartaPorte_Punto 
					  (CartaPorteID, 
					   PuntoID, 
					   Tipo,
					   Fecha) 
          VALUES      (@CartaPorteID, 
					   @ConsignadorID, 
					   1,
					   @ConsignadorFecha) 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 




/***********************    INSERT:[CONSIGNATARIO]    ***********************/

	  BEGIN TRY 
          INSERT INTO CartaPorte_Punto 
					  (CartaPorteID, 
					   PuntoID, 
					   Tipo,
					   Fecha) 
          VALUES      (@CartaPorteID, 
					   @ConsignatarioID, 
					   2,
					   @ConsignatarioFecha) 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @CartaPorteID    AS 'ExtraValue'
  END

GO
/****** Object:  StoredProcedure [dbo].[Cartaporte_Inventario_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Cartaporte_Inventario_INSERT] 
    @CartaPorteID VARCHAR(13) = NULL,
	@CuentaID INT,
	@StatusID INT,
	@BovedaID INT, 
	@LoginCreado VARCHAR(30), 
	@ConsignadorID INT,
	@ConsignatarioID INT

AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @PorSistema BIT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	  SET @PorSistema = 1

	  IF(@CartaPorteID IS NULL)
	  BEGIN
		  SET @PorSistema = 1
		  SET @CartaPorteID = 'TVV' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (CartaPorteID, 4, LEN(CartaPorteID) -3)))
												   FROM   cartaporte
												   WHERE  porsistema = 1),0) + 1 AS VARCHAR)
	  END
	  ELSE 
	  BEGIN
		  SET @PorSistema = 0
		  IF(SUBSTRING(@CartaPorteID,1,3) = 'TVV')
			BEGIN 
			   ROLLBACK TRANSACTION cartaporte 
			   SELECT @ERRORMESSAGE = 'Error: No puede crear una carta de portes con el prefijo TVV, ya que esta reservado.',
					  @NUMERRORS = @NUMERRORS + 1
			   SELECT @NUMERRORS     AS 'ErrorCount', 
					  @ERRORMESSAGE AS 'ErrorMessage'
			   RETURN
			END 

	  END


/***********************    VALIDACIONES:[NRO DE CARTAS DE PORTE]    ***********************/

	  IF EXISTS(SELECT * 
			    FROM   CartaPorte
				WHERE  CartaPorteID =  @CartaPorteID)
        BEGIN 
		   ROLLBACK TRANSACTION cartaporte 
		   SELECT @ERRORMESSAGE = 'Error: Ya existe una carta de portes con el Nro. ' + CONVERT (VARCHAR, @CartaPorteID),
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
        END 




/***********************    INSERT:[CARTA DE PORTE]    ***********************/

	  BEGIN TRY 
          INSERT INTO cartaporte 
					  (CartaPorteID, 
					   CuentaID,
					   StatusID,
					   BovedaID,  
					   FechaCreado, 
					   LoginCreado,
					   PorSistema,
					   Monto) 
          VALUES      (@CartaPorteID, 
					   @CuentaID,
					   @StatusID, 
					   @BovedaID, 
					   GetDate(), 
					   UPPER(@LoginCreado),
					   @PorSistema,
					   '0') 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    INSERT:[CONSIGNADOR]    ***********************/

	  BEGIN TRY 
          INSERT INTO CartaPorte_Punto 
					  (CartaPorteID, 
					   PuntoID, 
					   Tipo,
					   Fecha) 
          VALUES      (@CartaPorteID, 
					   @ConsignadorID, 
					   1,
					   GETDATE()) 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 




/***********************    INSERT:[CONSIGNATARIO]    ***********************/

	  BEGIN TRY 
          INSERT INTO CartaPorte_Punto 
					  (CartaPorteID, 
					   PuntoID, 
					   Tipo,
					   Fecha) 
          VALUES      (@CartaPorteID, 
					   @ConsignatarioID, 
					   2,
					   GETDATE()) 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @CartaPorteID    AS 'ExtraValue'
  END










GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Rubro_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaPorte_Rubro_Get]
	@CartaporteID varchar(13)
AS
BEGIN
	SET DATEFORMAT DMY
	
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado,
   			   CartaPorte.RubroID,
   			   Ruta_Cartaporte.Tipo
		FROM   CartaPorte
		JOIN   Ruta_Cartaporte
		ON     Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.CartaPorteID = @CartaporteID


END
GO
/****** Object:  StoredProcedure [dbo].[Cartaporte_Rubro_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Cartaporte_Rubro_UPDATE] 
	@CartaporteID VARCHAR(13),
	@RubroID INT
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[PUNTO]    ***********************/

	  BEGIN TRY 
          UPDATE Cartaporte 
		  SET    RubroID = @RubroID
				 
				
		  WHERE  CartaporteID = @CartaporteID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  

GO
/****** Object:  StoredProcedure [dbo].[Cartaporte_Ruta_DELETE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Cartaporte_Ruta_DELETE] 
	@CartaporteID VARCHAR(13),
	@RutaID INT
	
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	  
/***********************    DELETE   ***********************/

		BEGIN
			BEGIN TRY 
				DELETE FROM Ruta_CartaPorte
				WHERE  CartaPorteID = @CartaporteID
AND RutaID = @RutaID
				
			END TRY 
			BEGIN CATCH 
				ROLLBACK TRANSACTION cartaporte 
				SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
				SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
				RETURN
			END CATCH 
		END		
		
	 
/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END





























GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Tipo_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[CartaPorte_Tipo_Get]
	@CartaporteID varchar(13)
AS
BEGIN
	SET DATEFORMAT DMY
	
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado,
   			   Ruta_Cartaporte.Tipo
		FROM   CartaPorte
		JOIN   Ruta_Cartaporte
		ON     Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.CartaPorteID = @CartaporteID


END
GO
/****** Object:  StoredProcedure [dbo].[Cartaporte_Tipo_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Cartaporte_Tipo_UPDATE] 
	@CartaporteID VARCHAR(13),
	@Tipo INT
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[PUNTO]    ***********************/

	  BEGIN TRY 
          UPDATE Ruta_Cartaporte 
		  SET    Tipo = @Tipo
				 
				
		  WHERE  CartaporteID = @CartaporteID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  

GO
/****** Object:  StoredProcedure [dbo].[CartaPorte_Vabt_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Juan delgado

-- Description:	Obtener Cartaporte
-- =============================================
create PROCEDURE [dbo].[CartaPorte_Vabt_Get]
	@CartaporteID varchar(13)
AS
BEGIN
	SET DATEFORMAT DMY
	
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado,		
   			   CartaPorte.Cerrado
		FROM   CartaPorte
			
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE   CartaPorte.Cerrado = 0
and CartaPorte.CartaPorteID = @CartaporteID
and  CartaPorte.BovedaID = 5


END





GO
/****** Object:  StoredProcedure [dbo].[CartaporteAjuste_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaporteAjuste_UPDATE] 
	@Monto DECIMAL(18,3),
	@CartaporteAnteriorID VARCHAR(13),
	@CartaporteID VARCHAR(13),
	@FechaConsignador VARCHAR(10),
	@FechaConsignatario VARCHAR(10) 
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[CARTAPORTE]    ***********************/

	  BEGIN TRY 
          UPDATE CartaPorte 
		  SET    Monto = @Monto
				
		  WHERE  CartaPorteID = @CartaporteAnteriorID
		  
		  UPDATE CartaPorte_Punto
		  SET    Fecha = @FechaConsignador
		  WHERE  CartaPorte_Punto.CartaPorteID = @CartaporteAnteriorID
		  AND    CartaPorte_Punto.Tipo = 1
		  
		  UPDATE CartaPorte_Punto
		  SET    Fecha = @FechaConsignatario
		  WHERE  CartaPorte_Punto.CartaPorteID = @CartaporteAnteriorID
		  AND    CartaPorte_Punto.Tipo = 2

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 
      
      
      --BEGIN TRY 
      
    /***********************    DUPLICO EL CARTAPORTE    ***********************/
    
--   IF (@CartaporteAnteriorID <> '')
--          INSERT INTO CartaPorte 
--		  (CartaPorteID, CuentaID, BovedaID, Monto, FechaCreado, LoginCreado, StatusID, FechaCerrado, LoginCerrado, Cerrado, PorSistema, BolsaID)
--				
--   SELECT  @CartaporteID, CuentaID, BovedaID, Monto, FechaCreado, LoginCreado, StatusID, FechaCerrado, LoginCerrado, Cerrado, PorSistema, BolsaID
--   FROM CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
--   
--		  INSERT CartaPorte_Punto
--		  (CartaPorteID, PuntoID, Tipo, Fecha)
--    SELECT @CartaporteID, PuntoID, Tipo, Fecha 
--    FROM CartaPorte_Punto WHERE CartaPorteID = @CartaporteAnteriorID
--    
--		
--		
--		  INSERT Ruta_CartaPorte
--		  (RutaID, CartaPorteID, Tipo)
--	SELECT RutaID, @CartaporteID, Tipo
--	FROM   Ruta_CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
--			
--		  INSERT Traspaso_CartaPorte
--		  (TraspasoID, CartaPorteID)
--	SELECT TraspasoID, @CartaporteID
--	FROM Traspaso_CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
--	
--	
--	/***********************    SI EXISTE EN UNA ACTA   ***********************/
--	
--		  IF EXISTS (SELECT ActaID, CartaporteID FROM Acta_Cartaporte WHERE CartaporteID = @CartaporteAnteriorID) 
--		  INSERT Acta_Cartaporte
--		  (ActaID, CartaporteID)
--	SELECT ActaID, @CartaporteID
--	FROM Acta_Cartaporte WHERE CartaporteID = @CartaporteAnteriorID
--	
--	/***********************    SI EXISTE EN ENVASE   ***********************/
--	
--		  IF EXISTS (SELECT EnvaseID FROM Envase WHERE CartaporteID = @CartaporteAnteriorID) 
--		  UPDATE Envase
--		  SET    CartaporteID = @CartaporteID
--		  WHERE  CartaporteID = @CartaporteAnteriorID
--	
--	/***********************    SI EXISTE EN UNA DIFERENCIA   ***********************/
--	
--		  
--		  IF EXISTS (SELECT DiferenciaID, MontoDeclarado, Monto, Carnet, LoginCreado, Relacionadas,
--							 Remision, Supervisor, FechaCreado, CartaporteID, Sobrante, Faltante,
--							 Activo, Observacion, PuntoID FROM DiferenciaC WHERE CartaporteID = @CartaporteAnteriorID)
--		   UPDATE DiferenciaC
--		  SET    CartaporteID = @CartaporteID
--		  WHERE  CartaporteID = @CartaporteAnteriorID
--		  
--	/***********************    SI EXISTE EN UNA solicitud   ***********************/
--		  
--		  IF EXISTS (SELECT  SolicitudID, CartaPorteID  FROM  Solicitud_CartaPorte WHERE CartaporteID = @CartaporteAnteriorID)
--		   UPDATE Solicitud_CartaPorte
--		  SET    CartaporteID = @CartaporteID
--		  WHERE  CartaporteID = @CartaporteAnteriorID
--		  
--		  DELETE FROM CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
--		  
--		  DELETE FROM Solicitud_CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
--		  
--		  DELETE FROM Acta_Cartaporte WHERE CartaPorteID = @CartaporteAnteriorID
--		  
--		  END TRY 
--      BEGIN CATCH 
--	      ROLLBACK TRANSACTION cartaporte 
--	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
--			     @NUMERRORS = @NUMERRORS + 1
--		  SELECT @NUMERRORS     AS 'ErrorCount',
--				 CASE  ERROR_NUMBER()
--					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
--					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
--					ELSE @ERRORMESSAGE
--				 END AS 'ErrorMessage' 
--	      RETURN;
--      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[CartaporteNumeroAjuste_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaporteNumeroAjuste_UPDATE] 
	@Monto DECIMAL(18,3),
	@CartaporteAnteriorID VARCHAR(13),
	@CartaporteID VARCHAR(13),
	@FechaConsignador VARCHAR(10),
	@FechaConsignatario VARCHAR(10) 
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



--/***********************    UPDATE:[CARTAPORTE]    ***********************/
--
--	  BEGIN TRY 
--          UPDATE CartaPorte 
--		  SET    Monto = @Monto
--				
--		  WHERE  CartaPorteID = @CartaporteAnteriorID
--		  
--		  UPDATE CartaPorte_Punto
--		  SET    Fecha = @FechaConsignador
--		  WHERE  CartaPorte_Punto.CartaPorteID = @CartaporteAnteriorID
--		  AND    CartaPorte_Punto.Tipo = 1
--		  
--		  UPDATE CartaPorte_Punto
--		  SET    Fecha = @FechaConsignatario
--		  WHERE  CartaPorte_Punto.CartaPorteID = @CartaporteAnteriorID
--		  AND    CartaPorte_Punto.Tipo = 2
--
--      END TRY 
--      BEGIN CATCH 
--	      ROLLBACK TRANSACTION cartaporte 
--	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
--			     @NUMERRORS = @NUMERRORS + 1
--		  SELECT @NUMERRORS     AS 'ErrorCount',
--				 CASE  ERROR_NUMBER()
--					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
--					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
--					ELSE @ERRORMESSAGE
--				 END AS 'ErrorMessage' 
--	      RETURN;
--      END CATCH 
      
      
  BEGIN TRY 
      IF  EXISTS (SELECT * FROM Cartaporte WHERE CartaporteID = @CartaporteID) 
		BEGIN 
			   ROLLBACK TRANSACTION cartaporte 
			   SELECT @ERRORMESSAGE = 'Error: No puede Cambiar el numero e cartaporte, ya que se encuentra en uso el nuevo numero reservado por otro.',
					  @NUMERRORS = @NUMERRORS + 1
			   SELECT @NUMERRORS     AS 'ErrorCount', 
					  @ERRORMESSAGE AS 'ErrorMessage'
			   RETURN
		END 
    /***********************    DUPLICO EL CARTAPORTE    ***********************/
    
	   IF (@CartaporteAnteriorID <> '')
			  INSERT INTO CartaPorte 
			  (CartaPorteID, CuentaID, BovedaID, Monto, FechaCreado, LoginCreado, StatusID, FechaCerrado, LoginCerrado, Cerrado, PorSistema, BolsaID)
					
	   SELECT  @CartaporteID, CuentaID, BovedaID, Monto, FechaCreado, LoginCreado, StatusID, FechaCerrado, LoginCerrado, Cerrado, PorSistema, BolsaID
	   FROM CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
	   
			  INSERT CartaPorte_Punto
			  (CartaPorteID, PuntoID, Tipo, Fecha)
		SELECT @CartaporteID, PuntoID, Tipo, Fecha 
		FROM CartaPorte_Punto WHERE CartaPorteID = @CartaporteAnteriorID
	    
			
			
			  INSERT Ruta_CartaPorte
			  (RutaID, CartaPorteID, Tipo)
		SELECT RutaID, @CartaporteID, Tipo
		FROM   Ruta_CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
				
			  INSERT Traspaso_CartaPorte
			  (TraspasoID, CartaPorteID)
		SELECT TraspasoID, @CartaporteID
		FROM Traspaso_CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
		
		
		/***********************    SI EXISTE EN UNA ACTA   ***********************/
		
			  IF EXISTS (SELECT ActaID, CartaporteID FROM Acta_Cartaporte WHERE CartaporteID = @CartaporteAnteriorID) 
			  INSERT Acta_Cartaporte
			  (ActaID, CartaporteID)
		SELECT ActaID, @CartaporteID
		FROM Acta_Cartaporte WHERE CartaporteID = @CartaporteAnteriorID
		
		/***********************    SI EXISTE EN ENVASE   ***********************/
		
			  IF EXISTS (SELECT EnvaseID FROM Envase WHERE CartaporteID = @CartaporteAnteriorID) 
			  UPDATE Envase
			  SET    CartaporteID = @CartaporteID
			  WHERE  CartaporteID = @CartaporteAnteriorID
		
		/***********************    SI EXISTE EN UNA DIFERENCIA   ***********************/
		
			  
			  IF EXISTS (SELECT DiferenciaID, MontoDeclarado, Monto, Carnet, LoginCreado, Relacionadas,
								 Remision, Supervisor, FechaCreado, CartaporteID, Sobrante, Faltante,
								 Activo, Observacion, PuntoID FROM DiferenciaC WHERE CartaporteID = @CartaporteAnteriorID)
			   UPDATE DiferenciaC
			  SET    CartaporteID = @CartaporteID
			  WHERE  CartaporteID = @CartaporteAnteriorID
			  
		/***********************    SI EXISTE EN UNA solicitud   ***********************/
			  
			  IF EXISTS (SELECT  SolicitudID, CartaPorteID  FROM  Solicitud_CartaPorte WHERE CartaporteID = @CartaporteAnteriorID)
			   UPDATE Solicitud_CartaPorte
			  SET    CartaporteID = @CartaporteID
			  WHERE  CartaporteID = @CartaporteAnteriorID
			  
			  DELETE FROM CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
			  
			  DELETE FROM Solicitud_CartaPorte WHERE CartaPorteID = @CartaporteAnteriorID
			  
			  DELETE FROM Acta_Cartaporte WHERE CartaPorteID = @CartaporteAnteriorID
			  
			  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION cartaporte 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 CASE  ERROR_NUMBER()
						WHEN 4060 THEN 'Error: Base de datos Incorrecta'
						WHEN 18456 THEN 'Error: Inicio de sesión fallido'
						ELSE @ERRORMESSAGE
					 END AS 'ErrorMessage' 
			  RETURN;
		  END CATCH 
	
/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[CartaportePorSolicitud_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CartaportePorSolicitud_INSERT] 
    @SolicitudID INT,
	@LoginCreado VARCHAR(30),
	@BovedaID INT,
	@EnvaseCantidad INT = null,
	@plomo VARCHAR(50) = null
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @PorSistema BIT,
			  @CartaPorteID VARCHAR(13),
			  @CuentaID INT,
			  @RubroID INT,
			  @Monto DECIMAL(18,3), 
			  @ConsignadorID INT,
			  @ConsignatarioID INT,
			  @ConsignadorFecha datetime

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	  SET @PorSistema = 1

	   SELECT   @SolicitudID = Solicitud.SolicitudID, 
				@CuentaID = Solicitud.CuentaID, 
				@ConsignadorID = Solicitud.ConsignadorID,
				@ConsignatarioID = Solicitud.ConsignatarioID,
				@ConsignadorFecha = Solicitud.FechaCreado,
				@Monto = Solicitud.Monto,
				@RubroID = Solicitud.RubroID
		FROM	Solicitud
		WHERE   Solicitud.SolicitudID = @SolicitudID


	  IF(@CartaPorteID IS NULL)
	  BEGIN
		  SET @PorSistema = 1
		  SET @CartaPorteID = 'TVV' + CAST(ISNULL((SELECT MAX(CONVERT(INT, SUBSTRING (CartaPorteID, 4, LEN(CartaPorteID) -3)))
												   FROM   cartaporte
												   WHERE  porsistema = 1),0) + 1 AS VARCHAR)
	  END
	  ELSE 
	  BEGIN
		  SET @PorSistema = 0
		  IF(SUBSTRING(@CartaPorteID,1,3) = 'TVV')
			BEGIN 
			   ROLLBACK TRANSACTION cartaporte 
			   SELECT @ERRORMESSAGE = 'Error: No puede crear una carta de portes con el prefijo TVV, ya que esta reservado.',
					  @NUMERRORS = @NUMERRORS + 1
			   SELECT @NUMERRORS     AS 'ErrorCount', 
					  @ERRORMESSAGE AS 'ErrorMessage'
			   RETURN
			END 

	  END
/***********************    ACTUALIO LA SOLICITUD    ***********************/
	 BEGIN TRY 
			  UPDATE Solicitud_Accion
			  SET Solicitud_Accion.LoginCerrado = @Logincreado,
			  Solicitud_Accion.FechaCerrado = getdate()
			  WHERE Solicitud_Accion.SolicitudID =  @SolicitudID
			  AND  Solicitud_Accion.Secuencia = 1
	 END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    INSERT:[CARTA DE PORTE]    ***********************/

	  BEGIN TRY 
          INSERT INTO cartaporte 
					  (CartaPorteID, 
					   CuentaID,
					   StatusID, 
					   BovedaID, 
					   Monto, 
					   FechaCreado, 
					   LoginCreado,
					   PorSistema,
					   RubroID,
					   EnvaseCantidad,plomo) 
          VALUES      (@CartaPorteID, 
					   @CuentaID,
					   3, 
					   @BovedaID, 
					   @Monto, 
					   GetDate(), 
					   UPPER(@LoginCreado),
					   @PorSistema,
					   @RubroID,
					   @EnvaseCantidad,@plomo) 
					   
		INSERT INTO Solicitud_CartaPorte 
					  (CartaPorteID, 
					   SolicitudID) 
          VALUES      (@CartaPorteID, 
					   @SolicitudID) 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    INSERT:[CONSIGNADOR]    ***********************/

	  BEGIN TRY 
          INSERT INTO CartaPorte_Punto 
					  (CartaPorteID, 
					   PuntoID, 
					   Tipo,
					   Fecha) 
          VALUES      (@CartaPorteID, 
					   @ConsignadorID, 
					   1,
					   @ConsignadorFecha) 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 




/***********************    INSERT:[CONSIGNATARIO]    ***********************/

	  BEGIN TRY 
          INSERT INTO CartaPorte_Punto 
					  (CartaPorteID, 
					   PuntoID, 
					   Tipo,
					   Fecha) 
          VALUES      (@CartaPorteID, 
					   @ConsignatarioID, 
					   2,
					   @ConsignadorFecha) 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @CartaPorteID    AS 'ExtraValue'
  END




GO
/****** Object:  StoredProcedure [dbo].[Cliente_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
create PROCEDURE [dbo].[Cliente_Get]
 @ClienteID int
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT ClienteID, Descripcion, Direccion, Telefono, Email, RIF
	FROM   Cliente
where cliente.clienteid = @ClienteID
	
END


GO
/****** Object:  StoredProcedure [dbo].[Cliente_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
 


-- ============================================= 
create PROCEDURE [dbo].[Cliente_INSERT] 
	@Descripcion VARCHAR(100),
	@Direccion VARCHAR(500),
	@Telefono varchar(50),
	@Email varchar(50),
	@RIF varchar(50),
    @Login varchar(50)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cliente 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @ClienteID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	
	  
	

      /**** Crea el cliente ****/ 
      BEGIN TRY 
          INSERT INTO cliente
                      (Descripcion, Direccion, Telefono, Email, RIF) 
          VALUES      (@Descripcion, @Direccion, @Telefono, @Email, @RIF)
		SET @clienteID = SCOPE_IDENTITY()
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cliente 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cliente 
      ELSE 
        COMMIT TRANSACTION cliente 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @clienteID AS 'Identity'
  END






GO
/****** Object:  StoredProcedure [dbo].[Cliente_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
create PROCEDURE [dbo].[Cliente_UPDATE] 
	@ClienteID INT,
	@Descripcion VARCHAR(100),
    @Direccion varchar(500),
	@Email varchar(50),
	@RIF varchar(50),
	@Telefono varchar(50)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cliente 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[PUNTO]    ***********************/

	  BEGIN TRY 
          UPDATE Cliente 
		  SET    Descripcion = @Descripcion,
				 Direccion = @Direccion, Telefono = @Telefono,
				 Email = @Email, RIF = @RIF
				
		  WHERE  ClienteID = @ClienteID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cliente 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cliente 
      ELSE 
        COMMIT TRANSACTION cliente 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Clientes_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
create PROCEDURE [dbo].[Clientes_Get]
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT ClienteID, Descripcion, Direccion, Telefono, Email, RIF
	FROM   Cliente
	
END


GO
/****** Object:  StoredProcedure [dbo].[Configuracion_ActualizarDatosUsuario]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[Configuracion_ActualizarDatosUsuario]
	@UserId UNIQUEIDENTIFIER,
	@PrimerNombre VARCHAR(20), 
	@SegundoNombre VARCHAR(20), 
	@PrimerApellido VARCHAR(20), 
	@SegundoApellido VARCHAR(20)
AS
BEGIN

	SET NOCOUNT ON

	BEGIN TRANSACTION usuario 

	DECLARE @NUMERRORS     INT, 
			@ERRORMESSAGE VARCHAR(5000) 

	SELECT @NUMERRORS = 0,
		   @ERRORMESSAGE = ''

	BEGIN TRY 
		UPDATE SecureInOne..aspnet_Users
		SET    PrimerNombre = UPPER(@PrimerNombre), 
			   SegundoNombre = UPPER(@SegundoNombre), 
			   PrimerApellido = UPPER(@PrimerApellido), 
			   SegundoApellido = UPPER(@SegundoApellido)
		WHERE  UserId = @UserId
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION  

		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1

		SELECT @NUMERRORS     AS 'ErrorCount',
		       @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 


	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION usuario 
      ELSE 
        COMMIT TRANSACTION usuario 

	SELECT @NUMERRORS     AS 'ErrorCount', 
		   @ERRORMESSAGE  AS 'ErrorMessage'
END


GO
/****** Object:  StoredProcedure [dbo].[Configuracion_GetDatosUsuario]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[Configuracion_GetDatosUsuario]
	@UserId UNIQUEIDENTIFIER
AS
BEGIN

	SELECT UPPER(PrimerNombre) AS PrimerNombre, 
		   UPPER(SegundoNombre) AS SegundoNombre , 
		   UPPER(PrimerApellido) AS PrimerApellido, 
		   UPPER(SegundoApellido)  AS SegundoApellido 
	FROM   SecureInOne..aspnet_Users
	WHERE  UserId = @UserId

END



GO
/****** Object:  StoredProcedure [dbo].[Crear_Diferencia]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Crear_Diferencia] 
	@MontoDeclarado DECIMAL(18,3),
@Monto DECIMAL(18,3),
	@Carnet VARCHAR(50),
	@Login VARCHAR(50),	
	@Relacionadas VARCHAR(50),
	@Remision VARCHAR(50),
	@Supervisor VARCHAR(50),
	@FechaCreado VARCHAR(10),
    @CartaporteID VARCHAR(13),
	@Faltante DECIMAL(18,3),
	@Sobrante DECIMAL(18,3),
	@Observacion VARCHAR(500),
	@PuntoID INT,
@BovedaID INT,
@Cartaportes varchar(5000) = null,
@FechaCartaporte varchar(10)= null
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION diferencia 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @DiferenciaID	 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	


      /**** Crea la diferencia ****/ 
      BEGIN TRY 
          INSERT INTO DiferenciaC
                      (MontoDeclarado,
						Monto,
						Carnet,
						LoginCreado,
						Relacionadas,
						Remision,
						Supervisor,
						FechaCreado,
						CartaporteID,
						Faltante,
						Sobrante,
						Observacion,
						PuntoID,
	                    BovedaID,Cartaportes,FechaCartaporte) 
          VALUES      (@MontoDeclarado,
						@Monto,
						@Carnet,
						@Login,
						@Relacionadas,
						@Remision,
						@Supervisor,
						getdate(),
						@CartaporteID,
						@Faltante,
						@Sobrante,
						@Observacion,
						@PuntoID,
				        @BovedaID,@Cartaportes,@FechaCartaporte)
		SET @DiferenciaID = SCOPE_IDENTITY()
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION diferencia 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION diferencia 
      ELSE 
        COMMIT TRANSACTION diferencia 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @DiferenciaID AS 'ExtraValue'
  END








GO
/****** Object:  StoredProcedure [dbo].[Cuenta_By_Tipo_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[Cuenta_By_Tipo_Get]
@tipo varchar(50)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT Cuenta.CuentaID, 
		   Cuenta.co_cli, 
		   Cuenta.Saldo, 
		   Cuenta.FechaCreado, 
		   Cuenta.LoginCreado, 
		   Cuenta.UltimaTransaccionID, 
		   Cuenta.BovedaID, 
		   Cuenta.Nombre
	FROM   Cuenta
	
	WHERE  Cuenta.tipo = @tipo
	
END


GO
/****** Object:  StoredProcedure [dbo].[Cuenta_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[Cuenta_Get]
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT CuentaID, 
		   co_cli, 
		   Saldo, 
		   FechaCreado, 
		   LoginCreado, 
		   UltimaTransaccionID, 
		   BovedaID, 
		   Nombre
	FROM   Cuenta
	WHERE  Activo = 1
	
END


GO
/****** Object:  StoredProcedure [dbo].[Cuenta_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
CREATE PROCEDURE [dbo].[Cuenta_INSERT] 
	@Nombre VARCHAR(50),
	@Tipo VARCHAR(50),
	@Numero VARCHAR(50),
	@co_cli VARCHAR(10),
	@Activo INT,
	@LoginCreado VARCHAR(13)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cuenta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @CuentaID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	
	  
	

      /**** Crea el bloque ****/ 
      BEGIN TRY 
          INSERT INTO Cuenta
                      (co_cli,
					   Saldo,
						FechaCreado,
						LoginCreado,
						UltimaTransaccionID,
						BovedaID,
						Nombre,
						Activo,
						Numero,tipo) 
          VALUES      (@co_cli,
					   '0',
						getdate(),
						@LoginCreado,
						0,
						3,
						@Nombre,
						@Activo,
						@Numero,@Tipo)
		SET @CuentaID = SCOPE_IDENTITY()
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cuenta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @CuentaID AS 'Identity'
  END






GO
/****** Object:  StoredProcedure [dbo].[Cuenta_Numero_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
create PROCEDURE [dbo].[Cuenta_Numero_Get]
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT BancoID, 
		   numero,
			cnumeroid
	FROM   cuenta_numero
	
END


GO
/****** Object:  StoredProcedure [dbo].[Cuenta_Numero_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
CREATE PROCEDURE [dbo].[Cuenta_Numero_INSERT] 
	@Numero VARCHAR(50),
	@BancoID INT
	
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION banco 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @CNumeroID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	
	  
	

      /**** Crea ela cuenta ****/ 
      BEGIN TRY 
          INSERT INTO Cuenta_Numero
                      (numero,
						BancoID) 
          VALUES      (@Numero,
						@BancoID)
		SET @CNumeroID = SCOPE_IDENTITY()
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION banco 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION banco 
      ELSE 
        COMMIT TRANSACTION banco 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @CNumeroID AS 'Identity'
  END






GO
/****** Object:  StoredProcedure [dbo].[Cuenta_Numero_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Cuenta_Numero_UPDATE] 
	@Numero VARCHAR(50),
	@BancoID INT,
	@CNumeroID INT
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION banco 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[OFICIAL]    ***********************/

	  BEGIN TRY 
          UPDATE Cuenta_Numero 
		  SET    numero = @Numero
				
		  WHERE  BancoID = @BancoID
		AND      CNumeroID = @CNumeroID

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION banco 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION banco 
      ELSE 
        COMMIT TRANSACTION banco 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Cuenta_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
create PROCEDURE [dbo].[Cuenta_UPDATE] 
	@LoginCreado varchar(13),
	@Nombre VARCHAR(50),
    @Numero varchar(50),
	@co_cli varchar(30),
	@Activo int,
	@CuentaID int
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cuenta 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE    ***********************/

	  BEGIN TRY 
          UPDATE Cuenta 
		  SET    co_cli = @co_cli,
		         Nombre = @Nombre,
		         Activo = @Activo,
		         Numero = @Numero

		  WHERE  CuentaID = @CuentaID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cuenta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Cuenta_Usuario_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Delgado

-- Description:	Obtener Cuentas
-- =============================================
create PROCEDURE [dbo].[Cuenta_Usuario_Get]
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT Cuenta.CuentaID, 
		   Cuenta.co_cli, 
		   Cuenta.Saldo, 
		   Cuenta.FechaCreado, 
		   Cuenta.LoginCreado, 
		   Cuenta.UltimaTransaccionID, 
		   Cuenta.BovedaID, 
		   Cuenta.Nombre
	FROM   Cuenta
	JOIN   Cuenta_Usuario
	ON    Cuenta_Usuario.CuentaID = Cuenta.CuentaID
	WHERE  Activo = 1
	
END


GO
/****** Object:  StoredProcedure [dbo].[Cuenta_Usuario_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   

-- Description:  Ruta
-- ============================================= 
CREATE PROCEDURE [dbo].[Cuenta_Usuario_INSERT] 
	@CuentaID INT,
	@LoginCreado VARCHAR(50)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cuenta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	

      BEGIN TRY 
          INSERT INTO Cuenta
                      (CuentaID,
						LoginCreado) 
          VALUES      (@CuentaID,
						@LoginCreado)
	
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION cuenta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage'
			
  END






GO
/****** Object:  StoredProcedure [dbo].[CuentaAcopio_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
create PROCEDURE [dbo].[CuentaAcopio_Get]
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT CuentaID, 
		   co_cli, 
		   Saldo, 
		   FechaCreado, 
		   LoginCreado, 
		   UltimaTransaccionID, 
		   BovedaID, 
		   Nombre
	FROM   Cuenta
	WHERE  Activo = 1
	
	
END


GO
/****** Object:  StoredProcedure [dbo].[CuentaAll_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
CREATE  PROCEDURE [dbo].[CuentaAll_Get]
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT CuentaID, 
		   co_cli, 
		   Saldo, 
		   FechaCreado, 
		   LoginCreado, 
		   UltimaTransaccionID, 
		   BovedaID, 
		   Nombre,
		   Numero,
		   Activo
	FROM   Cuenta
	
END






GO
/****** Object:  StoredProcedure [dbo].[CuentaATM_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[CuentaATM_Get]
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT CuentaID, 
		   co_cli, 
		   Saldo, 
		   FechaCreado, 
		   LoginCreado, 
		   UltimaTransaccionID, 
		   BovedaID, 
		   Nombre
	FROM   Cuenta
	WHERE  Activo = 1 AND CuentaID in (68,69)
	
	
END


GO
/****** Object:  StoredProcedure [dbo].[Deposito_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
CREATE PROCEDURE [dbo].[Deposito_INSERT]  
	@Fecha  VARCHAR(10),
	@Monto  DECIMAL(18,3),
	@LoginCreado VARCHAR(50),
	@Contacto VARCHAR(50),
	@ConceptoID INT,
	@TraspasoID INT,
@CNumeroID INT,
@BancoID INT,
	@CuentaID INT
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION deposito 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @ID INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 




/***********************    INSERT:[DEPOSITO]    ***********************/

	  BEGIN TRY 
          INSERT INTO deposito 
					  (Fecha,
					  FechaCreado,
					  Contacto,
					   Monto,
					   LoginCreado,
						ConceptoID,
						CuentaID,
						CNumeroID,
						BancoID,TraspasoID) 
          VALUES      (@Fecha,
          GETDATE(),
          @Contacto,
					   @Monto,
					   @LoginCreado,
						@ConceptoID,
						@CuentaID,
						@CNumeroID,
						@BancoID,@TraspasoID) 
						
		 
		 SET @ID = SCOPE_IDENTITY()
		 
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION deposito 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION deposito 
      ELSE 
        COMMIT TRANSACTION deposito 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @ID			AS 'Identity'
  END



GO
/****** Object:  StoredProcedure [dbo].[Deposito_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
CREATE PROCEDURE [dbo].[Deposito_UPDATE] 
	@DepositoID INT,
	@Numero VARCHAR(50)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION deposito 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[PUNTO]    ***********************/

	  BEGIN TRY 
          UPDATE Deposito 
		  SET    Numero = @Numero
				
		  WHERE  DepositoID = @DepositoID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION deposito 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION deposito 
      ELSE 
        COMMIT TRANSACTION deposito 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Descuento_BovedaEmisor]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 14-12-2010 
-- Description:  descuento de efectivo en boveda 
-- ============================================= 
CREATE PROCEDURE [dbo].[Descuento_BovedaEmisor] 
		@TraspasoID INT, 
		@EfectivoID INT,
		@BovedaEmisorID INT,
		@MontoEmisor DECIMAL(18, 3),
		@NUMERRORS  INT OUTPUT , 
		@ERRORMESSAGES VARCHAR(5000) OUTPUT    
AS
BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Descuento 

      SET dateformat ymd; 

      DECLARE @MontoEmisorNuevo   DECIMAL(18, 3),
              @Monto   DECIMAL(18, 3)


      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGES = ''; 

      /**** Validamos que exista la boveda y obtenemos su efectivo ****/ 
      BEGIN TRY 
          SELECT @Monto = monto 
          FROM   boveda_efectivo 
          WHERE  bovedaid = @BovedaEmisorID
		  AND    EfectivoID =  @EfectivoID;

            BEGIN 
                SET    @MontoEmisorNuevo = @MontoEmisor - @Monto 
            END 
          
            BEGIN 
			  SET @NUMERRORS = @NUMERRORS + 1; 
			  SET @ERRORMESSAGES = @ERRORMESSAGES +  CHAR(13) + CHAR(10) + 'Error: Tipo de transacción inválida'; 
            END 

		  IF (@Monto IS NULL)
			BEGIN
              SET @NUMERRORS = @NUMERRORS + 1; 
              SET @ERRORMESSAGES = @ERRORMESSAGES +  CHAR(13) + CHAR(10) + 'Error: Cuenta inválida.'; 
 			END
      END TRY 

      BEGIN CATCH 
          SET @NUMERRORS = @NUMERRORS + @@ERROR; 
          SET @ERRORMESSAGES = @ERRORMESSAGES +  CHAR(13) + CHAR(10) + Error_message(); 
      END CATCH 


      /**** Si es un egreso validamos que tenga saldo suficiente la cuenta ****/ 
       
        BEGIN 
            IF @MontoEmisor > @Monto 
              BEGIN 
                  SET @NUMERRORS = @NUMERRORS + 1; 
                  SET @ERRORMESSAGES = @ERRORMESSAGES +  CHAR(13) + CHAR(10) + 'Error: No posee saldo suficiente para esta operación.'; 
              END 
        END 

      

      /**** Actualiza el Saldo de la Cuenta ****/ 
      BEGIN TRY 
          UPDATE boveda_efectivo
          SET    monto = @MontoEmisorNuevo
          WHERE  bovedaid = @BovedaEmisorID
		  AND    EfectivoID =  @EfectivoID;    
      END TRY 

      BEGIN CATCH 
          SET @NUMERRORS = @NUMERRORS + @@ERROR; 
          SET @ERRORMESSAGES = @ERRORMESSAGES +  CHAR(13) + CHAR(10) + Error_message(); 
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Descuento 
      ELSE 
        COMMIT TRANSACTION Descuento 


  END





GO
/****** Object:  StoredProcedure [dbo].[Diferencia_ByPunto_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Diferencia_ByPunto_Get]
   @PuntoID INT
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT DiferenciaC.DiferenciaID, 
		   DiferenciaC.Carnet, 
		   DiferenciaC.MontoDeclarado, 
		   DiferenciaC.FechaCreado, 
		   DiferenciaC.LoginCreado, 
		   DiferenciaC.Relacionadas, 
		   DiferenciaC.Remision, 
		   DiferenciaC.Supervisor,
		   DiferenciaC.Sobrante,
		   DiferenciaC.Faltante,
		   DiferenciaC.CartaporteID,
			DiferenciaC.BovedaID,
		   DiferenciaC.Observacion
	FROM   DiferenciaC

	Where DiferenciaC.PuntoID = @PuntoID
order by DiferenciaID desc
END




GO
/****** Object:  StoredProcedure [dbo].[Diferencia_DELETE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 04-12-2010 
-- Description:  Cancelar traspaso	
-- ============================================= 
CREATE PROCEDURE [dbo].[Diferencia_DELETE] 
	@DiferenciaID INT,
	@Login VARCHAR (30)

	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION diferencia 

      SET DATEFORMAT DMY

      DECLARE   @Fecha        DATETIME,
				@PuntoID      INT,
				@Monto        DECIMAL(18,3),
				@MontoTransaccion DECIMAL(18,3),
				@Descripcion  VARCHAR(MAX),
				@NUMERRORS    INT, 
				@ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


/***********************    VALIDACION:[DIFERENCIA]    ***********************/
	  IF NOT EXISTS (SELECT *
					 FROM   Diferencia 
					 WHERE  Diferencia.DiferenciaID = @DiferenciaID)
		BEGIN
			ROLLBACK TRANSACTION diferencia 
			SELECT @ERRORMESSAGE = 'Error: No puede eliminar esta diferencia, ya que fue eliminado previamente.', 
				   @NUMERRORS = @NUMERRORS + 1
		    SELECT @NUMERRORS     AS 'ErrorCount', 
			  	   @ERRORMESSAGE  AS 'ErrorMessage'
			RETURN
		END
	   ELSE
		SELECT 	@Fecha = CONVERT (DATETIME, fecha),
				@PuntoID = PuntoID,
				@Monto = Monto,
				@MontoTransaccion = MontoTransaccion,
				@Descripcion = Descripcion
		FROM    Diferencia
		WHERE   Diferencia.DiferenciaID = @DiferenciaID
			
		 
          INSERT INTO DiferenciaE 
					  (DiferenciaID, 
					   Fecha, 
					   PuntoID, 
					   Monto, 
					   MontoTransaccion, 
					   Descripcion,
					   Usuario) 
          VALUES      (@DiferenciaID, 
					   @Fecha, 
					   @PuntoID, 
					   @Monto, 
					   @MontoTransaccion, 
					   @Descripcion,
					   @Login) 
      
	   
	 
    


/***********************    DELETE:[TRASPASO]    ***********************/

	  BEGIN TRY 
          DELETE FROM  Diferencia          
          WHERE        DiferenciaID = @DiferenciaID           
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION diferencia 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 


      

/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION diferencia 
      ELSE 
        COMMIT TRANSACTION diferencia 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END

GO
/****** Object:  StoredProcedure [dbo].[Diferencia_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Diferencia_Get]
   @CartaporteID VARCHAR(13)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT DiferenciaC.DiferenciaID, 
		   DiferenciaC.Carnet, 
		   DiferenciaC.MontoDeclarado, 
		   DiferenciaC.FechaCreado, 
		   DiferenciaC.LoginCreado, 
		   DiferenciaC.Relacionadas, 
		   DiferenciaC.Remision, 
		   DiferenciaC.Supervisor,
		   DiferenciaC.Sobrante,
		   DiferenciaC.Faltante,
		   DiferenciaC.CartaporteID,
			DiferenciaC.BovedaID,
		   DiferenciaC.Observacion
	FROM   DiferenciaC
	
	JOIN Cartaporte c
	ON   c.CartaporteID = DiferenciaC.CartaporteID 
	Where c.CartaporteID = @CartaporteID
END
GO
/****** Object:  StoredProcedure [dbo].[Diferencia_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Diferencia_INSERT] 
	@DiferenciaID INT
		
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION diferencia 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000)
			 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''
   

      /**** Actualizar la diferencia ****/ 
      BEGIN TRY 
          UPDATE DiferenciaC
                       
          SET Activo = 1
		 WHERE DiferenciaID = @DiferenciaID
		
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION diferencia 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION diferencia 
      ELSE 
        COMMIT TRANSACTION diferencia 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @DiferenciaID AS 'ExtraValue'
  END






GO
/****** Object:  StoredProcedure [dbo].[DIFFSFOT_LLENARbOVEDA]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[DIFFSFOT_LLENARbOVEDA] 
AS
BEGIN

	UPDATE boveda_efectivo
	SET	   Monto = Efectivo.Denominacion * 10,
		   Piezas = 10
	FROM   boveda_efectivo
	JOIN   Efectivo
	ON     boveda_efectivo.EfectivoID = Efectivo.EfectivoID
	WHERE  BovedaID = 3
END

GO
/****** Object:  StoredProcedure [dbo].[Efectivo_Bobeda_ACTUALIZAR]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Efectivo_Bobeda_ACTUALIZAR] 
	@EfectivoID VARCHAR(15),
    @Piezas INT,
    @mONTO DECIMAL(18,3),
	@BovedaID INT
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION efectivo 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[efectivo]    ***********************/

	  BEGIN TRY 
          UPDATE Boveda_Efectivo 
		  SET    Piezas = @Piezas,
				 Monto = @Monto
				
		  WHERE  EfectivoID = @EfectivoID
		  AND    BovedaID = @BovedaID

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION efectivo 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION efectivo 
      ELSE 
        COMMIT TRANSACTION efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Efectivo_Bobeda_Entubado_ACTUALIZAR]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Efectivo_Bobeda_Entubado_ACTUALIZAR] 
	@EfectivoID VARCHAR(15),
    @Piezas INT,
    @mONTO DECIMAL(18,3),
	@PuntoID INT,
	@FechaContado VARCHAR(10)
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION efectivo 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[efectivo]    ***********************/

	  BEGIN TRY 
          UPDATE Punto_Efectivo 
		  SET    Piezas = @Piezas,
				 Monto = @Monto
				
		  WHERE  EfectivoID = @EfectivoID
		  AND    PuntoID = @PuntoID
		  AND    FechaContado = @FechaContado

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION efectivo 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION efectivo 
      ELSE 
        COMMIT TRANSACTION efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Efectivo_Envase_ACTUALIZAR]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Efectivo_Envase_ACTUALIZAR]
	@EfectivoAnteriorID VARCHAR(15),
	@EfectivoID VARCHAR(15),
    @Piezas INT,
    @monto DECIMAL(18,3),
	@EnvaseID INT,
	@NroPlomo VARCHAR(20)
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION efectivo 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[efectivo]    ***********************/

	  BEGIN TRY 
          UPDATE Envase_Efectivo 
		  SET    Piezas = @Piezas,
				 Monto = @Monto,
				 EfectivoID = @EfectivoID
				
		  WHERE  EnvaseID = @EnvaseID
				 AND EfectivoID = @EfectivoAnteriorID
				 
		  UPDATE Envase 
		  SET    NroPlomo = @NroPlomo
		  WHERE  EnvaseID = @EnvaseID
		 

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION efectivo 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION efectivo 
      ELSE 
        COMMIT TRANSACTION efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  



GO
/****** Object:  StoredProcedure [dbo].[Efectivo_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Efectivo_GetBy_Boveda]
	@BovedaID INT
AS
BEGIN
	SET DATEFORMAT DMY
	
	SELECT Boveda_Efectivo.BovedaID, 
		   Boveda_Efectivo.EfectivoID, 
		   Boveda_Efectivo.Piezas, 
		   Boveda_Efectivo.Monto,
		   Efectivo.Denominacion,
		   Efectivo.ImagePath,
		   Efectivo.EfectivoTipoID
	FROM   Boveda_Efectivo
	JOIN   Efectivo
	ON     Boveda_Efectivo.EfectivoID = Efectivo.EfectivoID
	WHERE  Boveda_Efectivo.BovedaID = @BovedaID
	AND Efectivo.EfectivoTipoID IN(1,2,3,4)
	AND Efectivo.EstaActivo = 'true'
	ORDER  BY  Efectivo.EfectivoTipoID,
	Efectivo.Denominacion
	DESC
			


END


GO
/****** Object:  StoredProcedure [dbo].[Efectivo_GetBy_Boveda2]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Efectivo_GetBy_Boveda2]
	@BovedaID INT
AS
BEGIN
	SET DATEFORMAT DMY
	
	SELECT CASE EfectivoTipoID 
			   WHEN 1 THEN 'Moneda' 
			   WHEN 2 THEN 'Billete' 
			   WHEN 3 THEN 'Moneda' 
	   		   WHEN 4 THEN 'Billete'
		   END AS Tipo,
		  CASE EfectivoTipoID 
			   WHEN 1 THEN 'Anterior' 
			   WHEN 2 THEN 'Actual' 
			   WHEN 3 THEN 'Anterior' 
	   		   WHEN 4 THEN 'Actual'
		   END AS Cono,
		  * 
	FROM   vw_efectivo
	WHERE  vw_efectivo.BovedaID = @BovedaID		


END



GO
/****** Object:  StoredProcedure [dbo].[Efectivo_GetBy_Bovedas]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Efectivo_GetBy_Bovedas]
	@BovedaID INT,
	@BovedaID2 INT
AS
BEGIN
	SET DATEFORMAT DMY
	
	SELECT 
		   Boveda_Efectivo.EfectivoID, 
		   Boveda_Efectivo.Piezas, 
		   Boveda_Efectivo.Monto,
		   Efectivo.Denominacion,
		   Efectivo.ImagePath,
		   Efectivo.EfectivoTipoID
	FROM   Boveda_Efectivo
	JOIN   Efectivo
	ON     Boveda_Efectivo.EfectivoID = Efectivo.EfectivoID
	WHERE  Boveda_Efectivo.BovedaID IN(@BovedaID,@BovedaID2)
	AND Efectivo.EfectivoTipoID IN(1,2,3,4)
	AND Efectivo.EstaActivo = 'true'
	
	GROUP BY
		   Boveda_Efectivo.EfectivoID, 
		   Boveda_Efectivo.Piezas, 
		   Boveda_Efectivo.Monto,
		   Efectivo.Denominacion,
		   Efectivo.ImagePath,
		   Efectivo.EfectivoTipoID
		   
	ORDER  BY  Efectivo.EfectivoTipoID,
	Efectivo.Denominacion DESC
			


END


GO
/****** Object:  StoredProcedure [dbo].[EfectivoActualizar_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
create PROCEDURE [dbo].[EfectivoActualizar_GetBy_Boveda]
	@BovedaID INT,
	@EfectivoID varchar(15)
AS
BEGIN
SET DATEFORMAT DMY
           SELECT Efectivo.EfectivoID,
                  Efectivo.EfectivoTipoID,
                  Efectivo.Denominacion,
                  Efectivo.ImagePath,
                  Boveda_Efectivo.Piezas,
                  Boveda_Efectivo.Monto
           FROM   Boveda_Efectivo
           JOIN   Efectivo
           ON   Boveda_Efectivo.EfectivoID = Efectivo.EfectivoID
           WHERE    Boveda_Efectivo.BovedaID = @BovedaID
			AND EFECTIVO.efectivoid = @EfectivoID
           ORDER BY  Denominacion ASC
			


END


GO
/****** Object:  StoredProcedure [dbo].[EfectivoEnvaseActualizar_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[EfectivoEnvaseActualizar_GetBy_Boveda]
	@EnvaseID INT,
	@EfectivoID varchar(15)
AS
BEGIN
SET DATEFORMAT DMY
           SELECT Efectivo.EfectivoID,
                  Efectivo.EfectivoTipoID,
                  Efectivo.Denominacion,
                  Efectivo.ImagePath,
                  Envase_Efectivo.EnvaseID,
                  Envase_Efectivo.Piezas,
                  Envase_Efectivo.Monto,
                  Envase.NroPlomo
           FROM   Envase_Efectivo
           JOIN   Envase
           ON     Envase.EnvaseID = Envase_Efectivo.EnvaseID
           JOIN   Efectivo
           ON   Envase_Efectivo.EfectivoID = Efectivo.EfectivoID
           WHERE    Envase_Efectivo.EnvaseID = @EnvaseID
			AND Envase_Efectivo.efectivoid = @EfectivoID
           ORDER BY  Denominacion ASC
			


END
GO
/****** Object:  StoredProcedure [dbo].[Envase_ABRIR]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Delgado 
-- Create date: 05-10-2010 
-- Description:  Abrir envase de cartaporte
-- ============================================= 
CREATE PROCEDURE [dbo].[Envase_ABRIR] 
	@EnvaseID INT,
	@Login varchar(30),
	@NroPlomo varchar(20)  = NULL
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 



      /**** Abre el envase ****/ 
      BEGIN TRY 
			  IF @NroPlomo <> NULL
			  BEGIN
				UPDATE Envase
				  SET    EstaAbierto = 1,
						 LoginAbierto = @Login,
						 FechaAbierto = GETDATE(),
						 NroPlomo = @NroPlomo
				  WHERE	 EnvaseID = @EnvaseID
				  END
			  ELSE
				  UPDATE Envase
				  SET    EstaAbierto = 1,
						 LoginAbierto = @Login,
						 FechaAbierto = GETDATE()
						/**** ,
						 NroPlomo = 'DEV'****/ 
				  WHERE	 EnvaseID = @EnvaseID
				  
				
			  END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION envase 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase 
      ELSE 
        COMMIT TRANSACTION envase 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @EnvaseID AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Envase_Arqueo_Efectivo_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Agregar Efectivo al Envase 
-- ============================================= 
CREATE PROCEDURE [dbo].[Envase_Arqueo_Efectivo_INSERT] 
	@Envase_ArqueoID	INT,
	@EfectivoID VARCHAR(5),
	@Piezas		INT,
	@Monto		DECIMAL(18,3),
	@CajetinID	INT,
	@ModuloID INT
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase_arqueo_efectivo 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @ArqueoID VARCHAR(13),
			  @BovedaID     INT,
			  @EstaAbierto  BIT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


	  SELECT @ArqueoID = Envase_Arqueo.ArqueoID,
			 @BovedaID     = Arqueo.BovedaID,
			 @EstaAbierto  = EstaAbierto
      FROM   Envase_Arqueo
	  JOIN   Arqueo
	  ON     Envase_Arqueo.ArqueoID = Arqueo.ArqueoID 
	  WHERE  Envase_Arqueo.Envase_ArqueoID = @Envase_ArqueoID

-- DESCOMENTAR PARA EL CUADRE
	  IF ((@BovedaID <> 1)AND(@EstaAbierto = 0))
	 

	  IF ((@BovedaID <> 1)AND(@EstaAbierto = 0))
	  BEGIN
		  /**** Crea los efectivos  ****/ 
		  BEGIN TRY 
			  INSERT INTO Envase_Arqueo_Efectivo
						  (Envase_ArqueoID, 
						   EfectivoID, 
						   Piezas,
						   Monto,CajetinID,ModuloID) 
			  VALUES      (@Envase_ArqueoID, 
						   @EfectivoID, 
						   @Piezas,
						   @Monto,@CajetinID,@ModuloID)
		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION envase_arqueo_efectivo 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage'   
			  RETURN
		  END CATCH     
	  END 
	  ELSE
	  BEGIN
		  IF NOT EXISTS(SELECT *
					    FROM   Envase_Arqueo_Efectivo
					    WHERE  EfectivoID = @EfectivoID
					    AND    Envase_ArqueoID = @Envase_ArqueoID)
		  BEGIN
			  /**** Crea los efectivos  ****/ 
			  BEGIN TRY 
				  INSERT INTO Envase_Arqueo_Efectivo
							  (Envase_ArqueoID, 
							   EfectivoID, 
							   Piezas,
							   Monto,CajetinID,ModuloID) 
				  VALUES      (@Envase_ArqueoID, 
							   @EfectivoID, 
							   @Piezas,
							   @Monto,@CajetinID,@ModuloID)
			  END TRY 
			  BEGIN CATCH 
				  ROLLBACK TRANSACTION envase_arqueo_efectivo 
				  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
						 @NUMERRORS = @NUMERRORS + 1
				  SELECT @NUMERRORS     AS 'ErrorCount',
						 @ERRORMESSAGE  AS 'ErrorMessage'   
				  RETURN
			  END CATCH 
		  END
	  END

	

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase_arqueo_efectivo 
      ELSE 
        COMMIT TRANSACTION envase_arqueo_efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END

GO
/****** Object:  StoredProcedure [dbo].[Envase_Arqueo_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Agregar envase a cartaporte
-- ============================================= 
CREATE PROCEDURE [dbo].[Envase_Arqueo_INSERT] 
	@NroPlomo VARCHAR(50) = NULL,
	@ArqueoID VARCHAR(13),
	@Monto DECIMAL(18,3),
	@Defectuoso BIT,
	@Observacion varchar(500)= NULL
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @Envase_ArqueoID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 



      /**** Crea el envase ****/ 
      BEGIN TRY 
          INSERT INTO Envase_Arqueo
                      (NroPlomo, 
					   ArqueoID,
					   Monto,
					   Defectuoso,
					   Observacion) 
          VALUES      (ISNULL(@NroPlomo, 'N/A'),
					   @ArqueoID,
					   @Monto,
					   @Defectuoso,
					   @Observacion)
		  SET @Envase_ArqueoID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION envase 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase 
      ELSE 
        COMMIT TRANSACTION envase 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @Envase_ArqueoID AS 'Identity'
  END



GO
/****** Object:  StoredProcedure [dbo].[Envase_Cartaporte_ABRIR]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Envase_Cartaporte_ABRIR] 
	@CartaporteID varchar(13),
	@Login varchar(30)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 



      /**** Abre el envase ****/ 
      BEGIN TRY 
          UPDATE Envase
          SET    EstaAbierto = 1,
				 LoginAbierto = @Login,
				 FechaAbierto = GETDATE() 
		  WHERE	 CartaporteID = @CartaporteID

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION envase 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase 
      ELSE 
        COMMIT TRANSACTION envase 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage'
  END



GO
/****** Object:  StoredProcedure [dbo].[Envase_DELETE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Envase_DELETE] 
    @NroPlomo VARCHAR(20),
	@CartaporteID VARCHAR(13)
	
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	  IF(EXISTS (SELECT *
					 FROM   Envase
					 WHERE  Envase.NroPlomo = @NroPlomo
					 AND    Envase.EstaAbierto = 'true'
					 AND    Envase.CartaPorteID = @CartaporteID))
	  BEGIN
		ROLLBACK TRANSACTION cartaporte 
	    SELECT @ERRORMESSAGE = 'Error: No puede eliminar este envase ya que ha sido contado.',
			   @NUMERRORS = @NUMERRORS + 1
	    SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
	    RETURN
	  END


/***********************    DELETE:[ENVASE]    ***********************/

		BEGIN
			BEGIN TRY 
				DELETE FROM Envase
				WHERE  NroPlomo = @NroPlomo

				
			END TRY 
			BEGIN CATCH 
				ROLLBACK TRANSACTION cartaporte 
				SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
				SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
				RETURN
			END CATCH 
		END		
		
	 
/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @NroPlomo    AS 'ExtraValue'
  END





























GO
/****** Object:  StoredProcedure [dbo].[Envase_DELETE_All]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Envase_DELETE_All] 
    @EnvaseID INT
	
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	  

/***********************    DELETE:[ENVASE]    ***********************/

		BEGIN
			BEGIN TRY 
				DELETE FROM Envase
				WHERE  Envase.EnvaseID = @EnvaseID

				
			END TRY 
			BEGIN CATCH 
				ROLLBACK TRANSACTION cartaporte 
				SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
				SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage' 
				RETURN
			END CATCH 
		END		
		
	 
/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cartaporte 
      ELSE 
        COMMIT TRANSACTION cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
			
  END





























GO
/****** Object:  StoredProcedure [dbo].[Envase_Efectivo_Cartaporte_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Envase_Efectivo_Cartaporte_INSERT] 
	@EfectivoID VARCHAR(5),
	@Piezas		INT,
	@Monto		DECIMAL(18,3)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase_efectivo 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @CartaPorteID VARCHAR(13),
			  @BovedaID     INT,
			  @EstaAbierto  BIT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


	

-- DESCOMENTAR PARA EL CUADRE
	 
	  
		  --IF ISNULL((SELECT MontoDisponible
			 -- FROM   vw_Efectivo
			 -- WHERE  EfectivoID = @EfectivoID
			 -- AND    BovedaID = 6),0) < @Monto
		  BEGIN
					 
				UPDATE Boveda_Efectivo
				SET    Monto = Boveda_Efectivo.Monto +  @Monto,
					   Piezas = Boveda_Efectivo.Piezas +  @Piezas
				
				WHERE   Boveda_Efectivo.BovedaID =  6
				AND     Boveda_Efectivo.EfectivoID = @EfectivoID

				
		  END
	
		IF @NUMERRORS > 0 
			ROLLBACK TRANSACTION envase_efectivo 
		ELSE 
			COMMIT TRANSACTION envase_efectivo 

		SELECT @NUMERRORS     AS 'ErrorCount', 
				 @ERRORMESSAGE AS 'ErrorMessage' 
	  

  END




GO
/****** Object:  StoredProcedure [dbo].[Envase_Efectivo_Cartaporte_UPDATE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Envase_Efectivo_Cartaporte_UPDATE] 
	@EfectivoID VARCHAR(5),
	@Piezas		INT,
	@Monto		DECIMAL(18,3),
	@PuntoID    INT,
	@LoginCreado VARCHAR(50),
	@FechaContado VARCHAR(10)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase_efectivo 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @CartaPorteID VARCHAR(13),
			  @BovedaID     INT,
			  @EstaAbierto  BIT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


	  BEGIN
				 
			INSERT INTO Punto_Efectivo
			(PuntoID,
			 EfectivoID,
			 Piezas,
			 Monto,
			 LoginCreado,
			 FechaContado)
			values
			(@PuntoID,
			 @EfectivoID,
			 @Piezas,
			 @Monto,
			 @LoginCreado,
			 @FechaContado)

			
	  END
	
		IF @NUMERRORS > 0 
			ROLLBACK TRANSACTION envase_efectivo 
		ELSE 
			COMMIT TRANSACTION envase_efectivo 

		SELECT @NUMERRORS     AS 'ErrorCount', 
				 @ERRORMESSAGE AS 'ErrorMessage' 
	  

  END





GO
/****** Object:  StoredProcedure [dbo].[Envase_Efectivo_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Envase_Efectivo_Get]
	@EnvaseID INT
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT Envase_Efectivo.EnvaseID, 
		   Envase_Efectivo.EfectivoID,
		   Envase_Efectivo.Piezas, 
		   Envase_Efectivo.Monto,
		   Efectivo.EfectivoTipoID,  
		   Efectivo.Denominacion,  
		   Efectivo.ImagePath,  
		   Efectivo.EstaActivo
	FROM   Envase_Efectivo
	JOIN   Efectivo
	ON     Envase_Efectivo.EfectivoID = Efectivo.EfectivoID
	WHERE  Envase_Efectivo.EnvaseID = @EnvaseID
	
END




GO
/****** Object:  StoredProcedure [dbo].[Envase_Efectivo_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Agregar Efectivo al Envase 
-- ============================================= 
CREATE PROCEDURE [dbo].[Envase_Efectivo_INSERT] 
	@EnvaseID	INT,
	@EfectivoID VARCHAR(5),
	@Piezas		INT,
	@Monto		DECIMAL(18,3)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase_efectivo 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @CartaPorteID VARCHAR(13),
			  @BovedaID     INT,
			  @EstaAbierto  BIT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


	  SELECT @CartaPorteID = Envase.CartaPorteID,
			 @BovedaID     = CartaPorte.BovedaID,
			 @EstaAbierto  = EstaAbierto
      FROM   Envase
	  JOIN   CartaPorte
	  ON     Envase.CartaPorteID = CartaPorte.CartaPorteID 
	  WHERE  Envase.EnvaseID = @EnvaseID

-- DESCOMENTAR PARA EL CUADRE
	  IF ((@BovedaID <> 1)AND(@EstaAbierto = 0))
	  BEGIN
		  IF ISNULL((SELECT MontoDisponible
			  FROM   vw_Efectivo
			  WHERE  EfectivoID = @EfectivoID
			  AND    BovedaID = @BovedaID),0) < @Monto
		  BEGIN
			  ROLLBACK TRANSACTION envase_efectivo 

		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto +  b.Monto,
			   Piezas = Boveda_Efectivo.Piezas +  b.Piezas
		FROM   (SELECT Envase_Efectivo.EfectivoID,
					   SUM(Envase_Efectivo.Monto) AS Monto,
					   SUM(Envase_Efectivo.Piezas) AS Piezas

				FROM   Boveda_Efectivo
				JOIN   Envase_Efectivo
				ON     Boveda_Efectivo.EfectivoID = Envase_Efectivo.EfectivoID
				JOIN   Envase
				ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
				WHERE  BovedaID = @BovedaID
				AND    CartaPorteID = @CartaPorteID
				GROUP  BY Envase_Efectivo.EfectivoID) b
		WHERE   Boveda_Efectivo.BovedaID =  @BovedaID
		AND     Boveda_Efectivo.EfectivoID = b.EfectivoID

		INSERT INTO Boveda_Efectivo
			 (BovedaID, 
			  EfectivoID, 
			  Piezas, 
			  Monto)
		SELECT @BovedaID AS BovedaID,
			   Envase_Efectivo.EfectivoID, 
			   SUM(Envase_Efectivo.Piezas), 
			   SUM(Envase_Efectivo.Monto)
		FROM   Envase_Efectivo
		JOIN   Envase
		ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
		WHERE  NOT EXISTS (SELECT *
							FROM   Boveda_Efectivo
							WHERE  BovedaID = @BovedaID								
							AND    Boveda_Efectivo.EfectivoID <> Envase_Efectivo.EfectivoID)
        AND    Envase.CartaPorteID = @CartaPorteID
		GROUP  BY Envase_Efectivo.EfectivoID

			  DELETE FROM CartaPorte 
			  WHERE  CartaPorteID = @CartaPorteID

			  SELECT @ERRORMESSAGE = 'Error: No tiene efectivo de ' 
									 + CAST ((SELECT Denominacion 
									          FROM   Efectivo			  
											  WHERE  EfectivoID = @EfectivoID) AS VARCHAR)  
								     + ' suficiente para crear la carta de portes Nro. ' 
									 + CAST (@CartaPorteID AS VARCHAR),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @ERRORMESSAGE AS 'ErrorMessage',
					 @NUMERRORS    AS 'ErrorCount'
		  END
	  END 

	  IF ((@BovedaID <> 1)AND(@EstaAbierto = 0))
	  BEGIN
		  /**** Crea los efectivos  ****/ 
		  BEGIN TRY 
			  INSERT INTO Envase_Efectivo
						  (EnvaseID, 
						   EfectivoID, 
						   Piezas,
						   Monto) 
			  VALUES      (@EnvaseID, 
						   @EfectivoID, 
						   @Piezas,
						   @Monto)
		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION envase_efectivo 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage'   
			  RETURN
		  END CATCH     
	  END 
	  ELSE
	  BEGIN
		  IF NOT EXISTS(SELECT *
					    FROM   Envase_Efectivo
					    WHERE  EfectivoID = @EfectivoID
					    AND    EnvaseID = @EnvaseID)
		  BEGIN
			  /**** Crea los efectivos  ****/ 
			  BEGIN TRY 
				  INSERT INTO Envase_Efectivo
							  (EnvaseID, 
							   EfectivoID, 
							   Piezas,
							   Monto) 
				  VALUES      (@EnvaseID, 
							   @EfectivoID, 
							   @Piezas,
							   @Monto)
			  END TRY 
			  BEGIN CATCH 
				  ROLLBACK TRANSACTION envase_efectivo 
				  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
						 @NUMERRORS = @NUMERRORS + 1
				  SELECT @NUMERRORS     AS 'ErrorCount',
						 @ERRORMESSAGE  AS 'ErrorMessage'   
				  RETURN
			  END CATCH 
		  END
	  END

-- DESCOMENTAR PARA EL CUADRE
--      /**** Actualiza la boveda  ****/
	  IF ((@BovedaID <> 1)AND(@EstaAbierto = 0))
	  BEGIN
 		  UPDATE Boveda_Efectivo
		  SET    Monto = Boveda_Efectivo.Monto -  @Monto,
				 Piezas = Boveda_Efectivo.Piezas -  @Piezas
		  WHERE  EfectivoID  = @EfectivoID
		  AND    BovedaID = @BovedaID
	  END

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase_efectivo 
      ELSE 
        COMMIT TRANSACTION envase_efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END

GO
/****** Object:  StoredProcedure [dbo].[Envase_Efectivo_INSERT_BK]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Agregar Efectivo al Envase 
-- ============================================= 
CREATE PROCEDURE [dbo].[Envase_Efectivo_INSERT_BK] 
	@EnvaseID	INT,
	@EfectivoID VARCHAR(5),
	@Piezas		INT,
	@Monto		DECIMAL(18,3)
AS 
  BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase_efectivo 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


      /**** Crea las Monedas  ****/ 
      BEGIN TRY 
          INSERT INTO Envase_Efectivo
                      (EnvaseID, 
					   EfectivoID, 
					   Piezas,
					   Monto) 
          VALUES      (@EnvaseID, 
					   @EfectivoID, 
					   @Piezas,
					   @Monto)
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION envase_efectivo 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'   
	      RETURN
      END CATCH     

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase_efectivo 
      ELSE 
        COMMIT TRANSACTION envase_efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  







GO
/****** Object:  StoredProcedure [dbo].[Envase_Efectivo_Total_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		Juan delgado

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Envase_Efectivo_Total_Get]
	@EnvaseID INT
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT Sum(Envase_Efectivo.Monto) as Total
	FROM   Envase_Efectivo
	JOIN   Envase
	ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
	WHERE  Envase.EnvaseID = @EnvaseID
	
END




GO
/****** Object:  StoredProcedure [dbo].[Envase_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Envase_Get]
	@EnvaseID INT
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT EnvaseID,
		   NroPlomo, 
		   EstaAbierto, 
		   FechaAbierto, 
		   LoginAbierto, 
		   CartaPorteID,
		   Defectuoso,
		   Observacion,
			Monto
	FROM   Envase	
	WHERE  EnvaseID = @EnvaseID
	
END






GO
/****** Object:  StoredProcedure [dbo].[Envase_GetBy_CartaPorte]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Envase_GetBy_CartaPorte]
	@CartaPorteID VARCHAR(13)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT EnvaseID,
		   NroPlomo, 
		   EstaAbierto, 
		   FechaAbierto, 
		   LoginAbierto, 
		   CartaPorteID,
		   Defectuoso,
		   Observacion,
			Monto
	FROM   Envase	
	WHERE  CartaPorteID = @CartaPorteID
	
END






GO
/****** Object:  StoredProcedure [dbo].[Envase_GetBy_CartaPorteAnillo]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Envase_GetBy_CartaPorteAnillo]
	@CartaPorteID VARCHAR(13)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT COUNT(*)
		   
	FROM   Envase_Efectivo
	LEFT   JOIN Envase
	ON     Envase.EnvaseID = Envase_Efectivo.EnvaseID	
	WHERE  Envase.CartaPorteID = @CartaPorteID
	
END






GO
/****** Object:  StoredProcedure [dbo].[Envase_INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Agregar envase a cartaporte
-- ============================================= 
CREATE PROCEDURE [dbo].[Envase_INSERT] 
	@NroPlomo VARCHAR(50) = NULL,
	@CartaPorteID VARCHAR(13),
	@Monto DECIMAL(18,3),
	@Defectuoso BIT,
	@Observacion varchar(500)= NULL
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @EnvaseID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 



      /**** Crea el envase ****/ 
      BEGIN TRY 
          INSERT INTO Envase
                      (NroPlomo, 
					   CartaPorteID,
					   Monto,
					   Defectuoso,
					   Observacion) 
          VALUES      (ISNULL(@NroPlomo, 'N/A'),
					   @CartaPorteID,
					   @Monto,
					   @Defectuoso,
					   @Observacion)
		  SET @EnvaseID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION envase 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase 
      ELSE 
        COMMIT TRANSACTION envase 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @EnvaseID AS 'Identity'
  END



GO
/****** Object:  StoredProcedure [dbo].[Envase_Principal_Get]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Envase_Principal_Get]
	@CartaPorteID VARCHAR(13)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT top 1 EnvaseID,
		   NroPlomo, 
		   EstaAbierto, 
		   FechaAbierto, 
		   LoginAbierto, 
		   CartaPorteID,
		   Defectuoso,
		   Observacion,
			Monto
	FROM   Envase	
	WHERE  CartaPorteID = @CartaPorteID
	
END



GO
/****** Object:  StoredProcedure [dbo].[Envase_Remesa__DELETE]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Envase_Remesa__DELETE] 
	@CartaPorteID VARCHAR(13)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @EnvaseID		 INT,
			  @ID            Varchar(500)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 



      /**** Crea el envase ****/ 
      BEGIN TRY 
          
		 DELETE FROM Envase WHERE CartaPorteID = @CartaPorteID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION envase 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

	  

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase 
      ELSE 
        COMMIT TRANSACTION envase 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @EnvaseID AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Envase_Remesa__INSERT]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Envase_Remesa__INSERT] 
	@NroPlomo VARCHAR(50) = NULL,
	@CartaPorteID VARCHAR(13),
	@Defectuoso BIT,
	@Observacion varchar(500)= NULL,
	@Monto  decimal(18,3)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @EnvaseID		 INT,
			  @ID            Varchar(500)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 



      /**** Crea el envase ****/ 
      BEGIN TRY 
          SELECT  TOP 1 @ID = EnvaseID FROM Envase 
		  WHERE CartaporteID = @CartaPorteID

          INSERT INTO Envase
                      (NroPlomo, 
					   CartaPorteID,
					   Defectuoso,
					   Observacion,
					   Monto) 
          VALUES      (ISNULL(@NroPlomo, 'N/A'),
					   @CartaPorteID,
					   @Defectuoso,
					   @Observacion,
					   @Monto)
		  SET @EnvaseID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION envase 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

	  BEGIN TRY 

		SELECT  TOP 1 @ID = EnvaseID FROM Envase 
		WHERE CartaporteID = @CartaPorteID
	
		UPDATE   Envase SET EstaAbierto = 'True'
		WHERE    EnvaseID = @ID

	  END TRY
	  BEGIN CATCH 
	      ROLLBACK TRANSACTION envase 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase 
      ELSE 
        COMMIT TRANSACTION envase 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @EnvaseID AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Estacion_Disponibles_GetBy_Boveda]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Estacion_Disponibles_GetBy_Boveda]
	@BovedaID INT
AS
BEGIN
	SET DATEFORMAT DMY
	
		SELECT distinct(Consignador.puntoid) as puntoid,
			   Consignador.nombre AS nombreconsignador,
			dbo.getTotalMontoByPunto(Consignador.puntoid)as monto
		FROM   CartaPorte	
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		
		WHERE  CartaPorte.BovedaID = @BovedaID
		AND    CartaPorte.Cerrado = 0
		group by
		Consignador.nombre,
		Consignador.puntoid
		order by 

		Consignador.puntoid
	
END










GO
/****** Object:  StoredProcedure [dbo].[GET_Boveda_Estado]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[GET_Boveda_Estado]
	@BovedaID INT
AS
BEGIN
	SET NOCOUNT ON

	IF EXISTS(SELECT * 
			  FROM   Boveda_Historial
			  WHERE  Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
			  AND    BovedaID = @BovedaID  
			  AND    FechaCerrado IS NULL)
	BEGIN
		SELECT 1 AS Estado
		RETURN
	END
	ELSE 
		SELECT 0 AS Estado
END

GO
/****** Object:  StoredProcedure [dbo].[GET_Boveda_Estado_Detalle]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_Boveda_Estado_Detalle]
	@BovedaID INT
AS
BEGIN
	SET NOCOUNT ON
	SET DATEFORMAT DMY

	DECLARE @Mensaje VARCHAR(MAX)

	IF EXISTS(SELECT * 
			  FROM   Boveda_Historial
			  WHERE  BovedaID = @BovedaID  
			  AND    FechaCerrado IS NULL)
	BEGIN
		DECLARE @Fecha DATETIME,
				@EfectivoInicial DECIMAL(18,3), 
				@TraspasosRecibidos DECIMAL(18,3), 
				@TraspaspasosEntregados DECIMAL(18,3), 
				@Salidas DECIMAL(18,3), 
				@ComprasMonedasBCV DECIMAL(18,3), 
				@EfectivoRecibidoCajero DECIMAL(18,3), 
				@ChapaletasSinContar DECIMAL(18,3), 
				@MonedasDevueltas DECIMAL(18,3),
				@DeudaEstaciones DECIMAL(18,3)


		-- 1 Dia a Cerrar
		SELECT @Fecha = Fecha,
			   @EfectivoInicial = EfectivoInicial
		FROM   Boveda_Historial
		WHERE  Fecha IS NOT NULL 
		AND    FechaCerrado IS NULL   
		AND    BovedaID = @BovedaID  

		-- 2 Traspasos
		SET @TraspasosRecibidos =   ISNULL((SELECT SUM(Monto)
											FROM   Traspaso_Efectivo
											JOIN   Traspaso
											ON     Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID
											WHERE  BovedaReceptorID = @BovedaID 
											AND    Recibido = 1
											AND    DATEADD(dd, 0, DATEDIFF(dd, 0, FechaReceptor))  = @Fecha),0)

		SET @TraspaspasosEntregados  =  ISNULL((SELECT SUM(Monto)
												FROM   Traspaso_Efectivo
												JOIN   Traspaso
												ON     Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID
												WHERE  BovedaEmisorID = @BovedaID 
												AND    Recibido = 1
												AND    DATEADD(dd, 0, DATEDIFF(dd, 0, FechaReceptor)) = @Fecha),0)
		--
		--		-- 3 Salidas
		--		SET @Salidas  =  ISNULL((SELECT SUM(Monto)
		--								 FROM   cartaporte
		--								 WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, fechacreado)) = @Fecha
		--								 AND    cartaporte.cartaportetipoid = 2
		--								 AND    aprobado = 1),0)

		--		-- 4  ComprasMonedas BCV
		--		SET @ComprasMonedasBCV = ISNULL((SELECT SUM(MontoBs)
		--			 							 FROM   cartaporte
		--										 WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, fechacreado)) = @Fecha
		--										 AND    cartaporte.cartaportetipoid = 3
		--										 AND    aprobado = 1),0)

			-- 5 Efectivo Recibido Cajero
		--	SET @EfectivoRecibidoCajero =	ISNULL((SELECT SUM(envase_moneda.montobs)
		--											FROM   envase_moneda
		--											JOIN   envase 
		--											ON     envase_moneda.envaseid = envase.envaseid
		--											JOIN   cartaporte 
		--											ON     envase.cartaporteid = cartaporte.cartaporteid
		--											WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, envase.fechaaprobado)) = @Fecha
		--											AND    envase.envasetipoid = 2
		--											AND    envase.estaabierto = 1
		--											AND    envase.aprobado = 1
		--											AND    cartaporte.cartaportetipoid = 1
		--											AND    cartaporte.aprobado = 1),0)
		--									+
		--									ISNULL((SELECT SUM(envase_billete.montobs)
		--											FROM   envase_billete
		--											JOIN   envase 
		--											ON     envase_billete.envaseid = envase.envaseid
		--											JOIN   cartaporte 
		--											ON     envase.cartaporteid = cartaporte.cartaporteid
		--											WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, envase.fechaaprobado)) = @Fecha
		--											AND    envase.envasetipoid = 2
		--											AND    envase.estaabierto = 1
		--											AND    envase.aprobado = 1
		--											AND    cartaporte.cartaportetipoid = 1
		--											AND    cartaporte.aprobado = 1),0)
			
		--	-- 6 Chapaletas Sin Contar
		--	SET @ChapaletasSinContar =	ISNULL((SELECT SUM(envase.montobs)
		--									    FROM   envase 
		--									    JOIN   cartaporte 
		--									    ON     envase.cartaporteid = cartaporte.cartaporteid
		--									    WHERE  envase.envasetipoid = 2
		--										AND    envase.aprobado = 0
		--										AND    cartaporte.cartaportetipoid = 1
		--										AND    cartaporte.aprobado = 1),0)

		--	-- 7 Deuda de Estaciones
		--	SET @DeudaEstaciones =	ISNULL((SELECT SUM(PuntoVisita.DeudaBs)
		--									FROM   PuntoVisita 
		--									JOIN   Ruta
		--									ON     PuntoVisita.rutaid = Ruta.rutaid
		--									WHERE  Ruta.rutatipoid = 1),0)
		--
		--	-- 8 Monedas Devueltas
		--	SET @MonedasDevueltas =	ISNULL((SELECT SUM(envase.montobs)
		--									FROM   envase 
		--									JOIN   cartaporte 
		--									ON     envase.cartaporteid = cartaporte.cartaporteid
		--									WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, cartaporte.fechacreado)) = @Fecha
		--									AND    envase.envasetipoid = 1
		--									AND    cartaporte.cartaportetipoid = 1
		--									AND    cartaporte.aprobado = 1),0)
		SET @Mensaje = 'EN ESTA OPERACIÓN CERRARÁ EL DÍA DE TRABAJO, RECUERDE QUE ESTA OPERACIÓN ES IRREVERSIBLE'

		SELECT   	@Fecha AS Fecha,
					@EfectivoInicial AS EfectivoInicial , 
					@TraspasosRecibidos AS  TraspasosRecibidos, 
					@TraspaspasosEntregados AS TraspaspasosEntregados, 
					@Salidas AS Salidas , 
					@ComprasMonedasBCV AS ComprasMonedasBCV, 
					@EfectivoRecibidoCajero AS EfectivoRecibidoCajero, 
					@ChapaletasSinContar AS ChapaletasSinContar, 
					@MonedasDevueltas AS MonedasDevueltas,
					@DeudaEstaciones  AS DeudaEstaciones,
					@EfectivoInicial + (@TraspasosRecibidos + @MonedasDevueltas + @EfectivoRecibidoCajero) - (@TraspaspasosEntregados + @Salidas + @ComprasMonedasBCV) AS EfectivoAlCierre ,
				    @Mensaje AS Mensaje,
					2 AS Accion 
		RETURN
	END
	ELSE 
		IF EXISTS(SELECT * 
				  FROM   Boveda_Historial
				  WHERE  Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
				  AND    BovedaID = @BovedaID  )
		BEGIN
			SELECT @Mensaje AS Mensaje,
				   0 AS Accion
		END 
		ELSE
		BEGIN
			SELECT @Mensaje AS Mensaje,
				   1 AS Accion

		END
END

GO
/****** Object:  StoredProcedure [dbo].[GET_Boveda_Historial]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[GET_Boveda_Historial]
	@CuentaID INT,
	@Desde varchar(10),
	@Hasta varchar(10)
AS
BEGIN
	SET NOCOUNT ON

	IF(@CuentaID = 7)
	BEGIN
	SELECT EfectivoInicial 
			  FROM   Boveda_Historial
			  WHERE  DATEADD(dd, DATEDIFF(dd, 0, Fecha), 0)  = DATEADD(DD,-1,@Desde)
			  AND    BovedaID = 3
	END
	
END

GO
/****** Object:  StoredProcedure [dbo].[GET_Boveda_Tareas]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_Boveda_Tareas]
	@BovedaID INT
AS
BEGIN
	SET NOCOUNT ON

	
	DECLARE   @Tareas VARCHAR(500),
			  @Entrada INT,
			  @Salida INT,
			  @Solicitud INT,
			  @EntradaS VARCHAR(3),
			  @SalidaS VARCHAR(3),
			  @SolicitudS VARCHAR(3)
			  
	SELECT @Entrada = COUNT(Traspaso.TraspasoID) FROM Traspaso
	WHERE Traspaso.BovedaReceptorID = @BovedaID
	AND Traspaso.Recibido = 'false'
	
	SELECT @Salida = COUNT(Traspaso.TraspasoID) FROM Traspaso
	WHERE Traspaso.BovedaEmisorID = @BovedaID
	AND Traspaso.Recibido = 'false'
	
	SELECT top 1 @Solicitud = COUNT(DISTINCT(Solicitud_Accion.SolicitudID)) FROM Solicitud_Accion
	WHERE Solicitud_Accion.BovedaID = @BovedaID
	AND Solicitud_Accion.LoginCerrado = ''
	
	SET	@EntradaS = Convert(varchar(3),@Entrada)
	SET @SalidaS = Convert(varchar(3),@Salida)
	SET @SolicitudS = Convert(varchar(3),@Solicitud)
			  
	SET @Tareas =  @EntradaS + ' Traspaso[s] de Entrada ' + @SalidaS + ' Traspaso[s] de Salida ' + @SolicitudS + ' Solicitud[es] Pendiente]' 
	SELECT @Tareas  as Tareas
	--SELECT @EntradaS AS Entradas
	--SELECT @SalidaS as Salidas
END

GO
/****** Object:  StoredProcedure [dbo].[GET_Caja_Estado]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_Caja_Estado]
	@CajaID INT
AS
BEGIN
	SET NOCOUNT ON

	IF EXISTS(SELECT * 
			  FROM   Caja_Historial
			  WHERE  Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
			  AND    CajaID = @CajaID  
			  AND    FechaCerrado IS NULL)
	BEGIN
		SELECT 1 AS Estado
		RETURN
	END
	ELSE 
		SELECT 0 AS Estado
END

GO
/****** Object:  StoredProcedure [dbo].[GET_Caja_Estado_Detalle]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_Caja_Estado_Detalle]
	@CajaID INT
AS
BEGIN
	SET NOCOUNT ON
	SET DATEFORMAT DMY

	DECLARE @Mensaje VARCHAR(MAX)

	IF EXISTS(SELECT * 
			  FROM   Caja_Historial
			  WHERE  CajaID = @CajaID  
			  AND    FechaCerrado IS NULL)
	BEGIN
		DECLARE @Fecha DATETIME,
				@EfectivoInicial DECIMAL(18,3), 
				@TraspasosRecibidos DECIMAL(18,3), 
				@TraspaspasosEntregados DECIMAL(18,3), 
				@Salidas DECIMAL(18,3),
				@EfectivoRecibidoCajero DECIMAL(18,3), 
				@ChapaletasSinContar DECIMAL(18,3), 
				@MonedasDevueltas DECIMAL(18,3)


		-- 1 Dia a Cerrar
		SELECT @Fecha = Fecha,
			   @EfectivoInicial = EfectivoInicial
		FROM   Caja_Historial
		WHERE  Fecha IS NOT NULL 
		AND    FechaCerrado IS NULL   
		AND    CajaID = @CajaID  

		-- 2 Traspasos
		SET @TraspasosRecibidos =   ISNULL((SELECT SUM(Monto)
											FROM   Traspaso_Efectivo
											JOIN   Traspaso
											ON     Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID
											WHERE  BovedaReceptorID = @CajaID 
											AND    Recibido = 1
											AND    DATEADD(dd, 0, DATEDIFF(dd, 0, FechaReceptor))  = @Fecha),0)

		SET @TraspaspasosEntregados  =  ISNULL((SELECT SUM(Monto)
												FROM   Traspaso_Efectivo
												JOIN   Traspaso
												ON     Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID
												WHERE  BovedaEmisorID = @CajaID 
												AND    Recibido = 1
												AND    DATEADD(dd, 0, DATEDIFF(dd, 0, FechaReceptor)) = @Fecha),0)
		--
		--		-- 3 Salidas
		--		SET @Salidas  =  ISNULL((SELECT SUM(Monto)
		--								 FROM   cartaporte
		--								 WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, fechacreado)) = @Fecha
		--								 AND    cartaporte.cartaportetipoid = 2
		--								 AND    aprobado = 1),0)

		--		-- 4  ComprasMonedas BCV
		--		SET @ComprasMonedasBCV = ISNULL((SELECT SUM(MontoBs)
		--			 							 FROM   cartaporte
		--										 WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, fechacreado)) = @Fecha
		--										 AND    cartaporte.cartaportetipoid = 3
		--										 AND    aprobado = 1),0)

			-- 5 Efectivo Recibido Cajero
		--	SET @EfectivoRecibidoCajero =	ISNULL((SELECT SUM(envase_moneda.montobs)
		--											FROM   envase_moneda
		--											JOIN   envase 
		--											ON     envase_moneda.envaseid = envase.envaseid
		--											JOIN   cartaporte 
		--											ON     envase.cartaporteid = cartaporte.cartaporteid
		--											WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, envase.fechaaprobado)) = @Fecha
		--											AND    envase.envasetipoid = 2
		--											AND    envase.estaabierto = 1
		--											AND    envase.aprobado = 1
		--											AND    cartaporte.cartaportetipoid = 1
		--											AND    cartaporte.aprobado = 1),0)
		--									+
		--									ISNULL((SELECT SUM(envase_billete.montobs)
		--											FROM   envase_billete
		--											JOIN   envase 
		--											ON     envase_billete.envaseid = envase.envaseid
		--											JOIN   cartaporte 
		--											ON     envase.cartaporteid = cartaporte.cartaporteid
		--											WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, envase.fechaaprobado)) = @Fecha
		--											AND    envase.envasetipoid = 2
		--											AND    envase.estaabierto = 1
		--											AND    envase.aprobado = 1
		--											AND    cartaporte.cartaportetipoid = 1
		--											AND    cartaporte.aprobado = 1),0)
			
		--	-- 6 Chapaletas Sin Contar
		--	SET @ChapaletasSinContar =	ISNULL((SELECT SUM(envase.montobs)
		--									    FROM   envase 
		--									    JOIN   cartaporte 
		--									    ON     envase.cartaporteid = cartaporte.cartaporteid
		--									    WHERE  envase.envasetipoid = 2
		--										AND    envase.aprobado = 0
		--										AND    cartaporte.cartaportetipoid = 1
		--										AND    cartaporte.aprobado = 1),0)

		--	-- 7 Deuda de Estaciones
		--	SET @DeudaEstaciones =	ISNULL((SELECT SUM(PuntoVisita.DeudaBs)
		--									FROM   PuntoVisita 
		--									JOIN   Ruta
		--									ON     PuntoVisita.rutaid = Ruta.rutaid
		--									WHERE  Ruta.rutatipoid = 1),0)
		--
		--	-- 8 Monedas Devueltas
		--	SET @MonedasDevueltas =	ISNULL((SELECT SUM(envase.montobs)
		--									FROM   envase 
		--									JOIN   cartaporte 
		--									ON     envase.cartaporteid = cartaporte.cartaporteid
		--									WHERE  DATEADD(dd, 0, DATEDIFF(dd, 0, cartaporte.fechacreado)) = @Fecha
		--									AND    envase.envasetipoid = 1
		--									AND    cartaporte.cartaportetipoid = 1
		--									AND    cartaporte.aprobado = 1),0)
		SET @Mensaje = 'EN ESTA OPERACIÓN CERRARÁ EL DÍA DE TRABAJO, RECUERDE QUE ESTA OPERACIÓN ES IRREVERSIBLE'

		SELECT   	@Fecha AS Fecha,
					@EfectivoInicial AS EfectivoInicial , 
					@TraspasosRecibidos AS  TraspasosRecibidos, 
					@TraspaspasosEntregados AS TraspaspasosEntregados, 
					@Salidas AS Salidas , 
					@EfectivoRecibidoCajero AS EfectivoRecibidoCajero, 
					@ChapaletasSinContar AS ChapaletasSinContar, 
					@MonedasDevueltas AS MonedasDevueltas,
					@EfectivoInicial + (@TraspasosRecibidos + @MonedasDevueltas + @EfectivoRecibidoCajero) - (@TraspaspasosEntregados + @Salidas) AS EfectivoAlCierre ,
				    @Mensaje AS Mensaje,
					2 AS Accion 
		RETURN
	END
	ELSE 
		IF EXISTS(SELECT * 
				  FROM   Caja_Historial
				  WHERE  Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
				  AND    CajaID = @CajaID  )
		BEGIN
			SELECT @Mensaje AS Mensaje,
				   0 AS Accion
		END 
		ELSE
		BEGIN
			SELECT @Mensaje AS Mensaje,
				   1 AS Accion

		END
END

GO
/****** Object:  StoredProcedure [dbo].[GET_DetalleResumen]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_DetalleResumen]
	@CuentaID INT,
	@Desde varchar(10),
	@Hasta varchar(10)
AS
BEGIN
	SET NOCOUNT ON

                           	SET DATEFORMAT DMY


           SET LANGUAGE Spanish
SELECT CONVERT(VARCHAR,ConsignadorR.fecha,105)  as 'Fecha',
           DATENAME(DW,ConsignadorR.fecha) AS DIA,
           CONVERT(VARCHAR(8),ConsignadorR.Fecha,108)  as 'Hora',
		   cartaporte.logincerrado as cajero, 
		   cartaporte.cartaporteid as cartaporte, 
		   consignador.nombre as punto,
cartaporte.monto as Monto,
dbo.getViajesLunVie(@Desde,cartaporte.cartaporteid) as ViajesLunVie,
dbo.getViajesSabado(@Desde,cartaporte.cartaporteid) as ViajesSabado,
dbo.getViajesDomin(@Desde,cartaporte.cartaporteid) as ViajesDom,
		  
		 
dbo.getEnvasesTotalByCartaporte(cartaporte.cartaporteid) AS Envases,

dbo.getTotalMontoBilletes(cartaporte.cartaporteid) AS TotalBillete,
dbo.getTotalMontoMonedas(cartaporte.cartaporteid) AS TotalMoneda,
dbo.getTotalMonto(cartaporte.cartaporteid) AS TotalContado,


dbo.getSobrante(cartaporte.monto,dbo.getTotalMonto(cartaporte.cartaporteid)) as Sobrante,
dbo.getFaltante(cartaporte.monto,dbo.getTotalMonto(cartaporte.cartaporteid)) as Faltante,
dbo.getDiferencia(cartaporte.monto,dbo.getTotalMonto(cartaporte.cartaporteid)) as Diferencia,
dbo.getMontoEfectivos(cartaporte.cartaporteid,'BF5') AS '100F',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'BF2') AS '50F',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'BF23') AS '20F',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'BF22') AS '10F',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'BF21') AS '5F',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'BF20') AS '2F',

dbo.getMontoEfectivos(cartaporte.cartaporteid,'B001') AS '5',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B002') AS '10',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B003') AS '20',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B004') AS '50',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B005') AS '100',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B006') AS '500',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B007') AS '1000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B008') AS '2000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B009') AS '5000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B012') AS '10000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B013') AS '20000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'B014') AS '50000',

dbo.getMontoEfectivos(cartaporte.cartaporteid,'MF2') AS '0,250',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'MF20') AS '0,010',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'MF21') AS '0,050',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'MF22') AS '0,100',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'MF23') AS '0,125',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'MF25') AS '0,500',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'MF26') AS '1,000',

dbo.getMontoEfectivos(cartaporte.cartaporteid,'M001') AS '1,000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'M002') AS '10,000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'M003') AS '20,000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'M004') AS '50,000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'M005') AS '100,000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'M006') AS '500,000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'M009') AS '2,000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'M010') AS '5,000',
dbo.getMontoEfectivos(cartaporte.cartaporteid,'M013') AS '1000,000'


	FROM   CartaPorte
	
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	--JOIN   Envase_Efectivo
	--ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID

	   JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
 
	WHERE  
	-- and  CONVERT(CHAR(10), r.FechaCreado, 103) = CONVERT(CHAR(10),@Fecha, 103)
	   CONVERT(CHAR(10), Cartaporte.FechaCreado, 103) = @Desde
	--CONVERT(VARCHAR,Cartaporte.FechaCreado,105)  = @Desde
	 and  cartaporte.Porsistema = 'false'
	 --and   ConsignadorR.Tipo = 1
    and Cartaporte.rubroid IN(1,2,3,4)
	and  cartaporte.cuentaid= @CuentaID

	GROUP  BY
			consignador.nombre,
			cartaporte.cartaporteid,
			cartaporte.monto,
		    cartaporte.logincerrado,
			consignador.puntoid,
			ConsignadorR.Fecha
	
	
	ORDER  BY consignador.nombre
END


GO
/****** Object:  StoredProcedure [dbo].[GET_DetalleResumenSalida]    Script Date: 07/02/2019 9:05:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

	create PROCEDURE [dbo].[GET_DetalleResumenSalida]
	@CuentaID INT,
	@Desde varchar(10),
	@Hasta varchar(10)
AS
BEGIN
	SET NOCOUNT ON

                    SET              DATEFORMAT DMY
SET              LANGUAGE Spanish
                          SELECT     Ruta.RutaID, CONVERT(VARCHAR, Ruta.Fecha, 105) AS 'Fecha', DATENAME(DW, Ruta.Fecha) AS DIA, CONVERT(VARCHAR(8), 
                                                  Ruta.FechaDespachada, 108) AS 'Hora', Ruta.Nombre, Ruta.Turno, Ruta.LoginCreado, Ruta.FechaCreado, Ruta.OficialValores, 
                                                  Ruta.AuxiliarValores, Ruta.GuardiaCustoCaj, Ruta.OficialValoresID, Ruta.AuxiliarValoresID, Ruta.GuardiaCustoCajID, Ruta.OtroOficial, 
                                                  Ruta.OtroOficialID, Ruta.UnidadPlaca, Ruta.TotalCarteras, Ruta.TotalCambio, Ruta.KilometrosSalida, Ruta.KilometrosLlegada, 
                                                  Ruta.TotalKilometros, Ruta.Cerrada, Ruta.Despachada, Ruta.Recibida, Ruta.LoginCerrada, Ruta.FechaCerrada, Ruta.LoginDespachada, 
                                                  Ruta.FechaDespachada, Ruta.LoginRecibida, Ruta.FechaRecibida, Consignatario.Nombre AS Estaciones, Consignatario.PuntoID,
                                                      (SELECT     SUM(b.MONTO)
                                                        FROM          vw_cartaporte b
                                                        WHERE      EXISTS
                                                                                   (SELECT     *
                                                                                     FROM          Ruta_CartaPorte d
                                                                                     WHERE      d .CartaPorteID = b.CartaPorteID AND d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1) AND 
                                                                               b.ConsignatarioID = Consignatario.PuntoID) AS SalidaDiaria, COUNT(DISTINCT EnvaseID) AS Envases,
                                                      (SELECT     COUNT(*)
                                                        FROM          Envase_Efectivo b JOIN
                                                                               Envase c ON b.EnvaseID = c.EnvaseID
                                                        WHERE      b.EfectivoID = 'BF2' AND EXISTS
                                                                                   (SELECT     *
                                                                                     FROM          Ruta_CartaPorte d JOIN
                                                                                                            vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                     WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                            d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1)) AS '50',
                                                      (SELECT     COUNT(*)
                                                        FROM          Envase_Efectivo b JOIN
                                                                               Envase c ON b.EnvaseID = c.EnvaseID
                                                        WHERE      b.EfectivoID = 'BF20' AND EXISTS
                                                                                   (SELECT     *
                                                                                     FROM          Ruta_CartaPorte d JOIN
                                                                                                            vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                     WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                            d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1)) AS '2',
                                                      (SELECT     COUNT(*)
                                                        FROM          Envase_Efectivo b JOIN
                                                                               Envase c ON b.EnvaseID = c.EnvaseID
                                                        WHERE      b.EfectivoID = 'BF21' AND EXISTS
                                                                                   (SELECT     *
                                                                                     FROM          Ruta_CartaPorte d JOIN
                                                                                                            vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                     WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                            d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1)) AS '5',
                                                      (SELECT     COUNT(*)
                                                        FROM          Envase_Efectivo b JOIN
                                                                               Envase c ON b.EnvaseID = c.EnvaseID
                                                        WHERE      b.EfectivoID = 'BF22' AND EXISTS
                                                                                   (SELECT     *
                                                                                     FROM          Ruta_CartaPorte d JOIN
                                                                                                            vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                     WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                            d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1)) AS '10',
                                                      (SELECT     COUNT(*)
                                                        FROM          Envase_Efectivo b JOIN
                                                                               Envase c ON b.EnvaseID = c.EnvaseID
                                                        WHERE      b.EfectivoID = 'BF23' AND EXISTS
                                                                                   (SELECT     *
                                                                                     FROM          Ruta_CartaPorte d JOIN
                                                                                                            vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                     WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                            d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1)) AS '20',
                                                      (SELECT     COUNT(*)
                                                        FROM          Envase_Efectivo b JOIN
                                                                               Envase c ON b.EnvaseID = c.EnvaseID
                                                        WHERE      b.EfectivoID = 'BF5' AND EXISTS
                                                                                   (SELECT     *
                                                                                     FROM          Ruta_CartaPorte d JOIN
                                                                                                            vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                     WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                            d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1)) AS '100',
                                                      ((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'BF2' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) +
                                                      ((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'BF20' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) +
                                                      ((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'BF21' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) +
                                                      ((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'BF22' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) +
                                                      ((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'BF23' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) +
                                                      ((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'BF5' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) AS 'T_Total', 


 (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '1,00',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,50',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,10',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,05',

   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF2'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,25',

   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF20'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,01',

   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF23'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,125',

((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'MF26' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) +
                                                      ((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'MF25' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) +
                                                      ((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'MF22' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) +
                                                      ((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'MF21' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1)))  +
((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'MF2' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1)))  + 
((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'MF20' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1))) +
((SELECT     COUNT(*)
                                                          FROM         Envase_Efectivo b JOIN
                                                                                Envase c ON b.EnvaseID = c.EnvaseID
                                                          WHERE     b.EfectivoID = 'MF23' AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d JOIN
                                                                                                             vw_Cartaporte vwc ON d .CartaPorteID = vwc.CartaPorteID
                                                                                      WHERE      vwc.CartaPorteID = c.CartaPorteID AND vwc.ConsignatarioID = Consignatario.PuntoID AND 
                                                                                                             d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1)))  AS 'T_TotalMONEDAS', 


                                             REPLACE(RTRIM
                                                      ((SELECT     CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' '
                                                          FROM         CartaPorte_Punto Grupo
                                                          WHERE     Grupo.TIPO = 2 AND Grupo.PuntoID = Consignatario.PuntoID AND EXISTS
                                                                                    (SELECT     *
                                                                                      FROM          Ruta_CartaPorte d
                                                                                      WHERE      d .CartaPorteID = Grupo.CartaPorteID AND d .RutaID = Ruta_CartaPorte.RutaID AND d.TIPO = 1) FOR 
                                                                                XML PATH(''))), ' ', ' - ') AS Cartaportes, Biblia.Secuencia,
	(SELECT COUNT(*)
		FROM   Ruta r2
		WHERE  r2.Fecha = @Desde
		AND    EXISTS(SELECT * 
					  FROM   Ruta_CartaPorte rc2
					  JOIN   vw_cartaporte v2
					  ON   v2.CartaPorteID = rc2.CartaPorteID 
					  WHERE  v2.CuentaID = 35
					  AND    v2.Consignatarioid = Consignatario.PuntoID
					  AND    rc2.Tipo = 1
					  AND   rc2.RutaID = r2.RutaID))
		 
		 AS ViajesRealizados
                           FROM         Ruta_CartaPorte JOIN
                                                  CartaPorte ON Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID JOIN
                                                  Envase ON CartaPorte.CartaPorteID = Envase.CartaPorteID JOIN
                                                  Cuenta ON CartaPorte.CuentaID = Cuenta.CuentaID JOIN
                                                  CartaPorte_Punto ConsignadorR ON CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID AND 
                                                  ConsignadorR.Tipo = 1 /*ConsignadorR*/ JOIN
                                                  Punto Consignador ON ConsignadorR.PuntoID = Consignador.PuntoId /*Consignador3*/ JOIN
                                                  CartaPorte_Punto ConsignatarioR ON CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID AND 
                                                  ConsignatarioR.Tipo = 2 /*Consignatario*/ JOIN
                                                  Punto Consignatario ON ConsignatarioR.PuntoID = Consignatario.PuntoId /*Consignatario3*/ JOIN
                                                  Biblia ON Consignatario.PuntoId = Biblia.PuntoID JOIN
                                                  Ruta ON Ruta_CartaPorte.RutaID = Ruta.RutaID
                           WHERE     Ruta_CartaPorte.TIPO = 1 AND Ruta.Fecha = @Desde AND CartaPorte.CuentaID =@CuentaID
                           GROUP BY Ruta_CartaPorte.RutaID, Ruta.RutaID, Ruta.Fecha, Ruta.Nombre, Ruta.Turno, Ruta.LoginCreado, Ruta.FechaCreado, Ruta.OficialValores, 
                                                  Ruta.AuxiliarValores, Ruta.GuardiaCustoCaj, Ruta.OficialValoresID, Ruta.AuxiliarValoresID, Ruta.GuardiaCustoCajID, Ruta.OtroOficial, 
                                                  Ruta.OtroOficialID, Ruta.UnidadPlaca, Ruta.TotalCarteras, Ruta.TotalCambio, Ruta.KilometrosSalida, Ruta.KilometrosLlegada, 
                                                  Ruta.TotalKilometros, Ruta.Cerrada, Ruta.Despachada, Ruta.Recibida, Ruta.LoginCerrada, Ruta.FechaCerrada, Ruta.LoginDespachada, 
                                                  Ruta.FechaDespachada, Ruta.LoginRecibida, Ruta.FechaRecibida, Consignatario.Nombre, Consignatario.PuntoID, 
                                                  Biblia.Secuencia
                                                  
                                                  
END

GO
/****** Object:  StoredProcedure [dbo].[GET_Diferencia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_Diferencia]
	@DiferenciaID varchar(50),
	@Cajero varchar(50),
	@Cubiculo varchar(50)
AS
BEGIN
	SET NOCOUNT ON

			select @Cajero as cajero,@Cubiculo as cubiculo,Plomo.PlomoID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, 
			count(envase.envaseid) as envases,
			--sum(envase_efectivo.monto) as montoenvase,
			CONVERT(VARCHAR,cartaporte.fechacreado,105) AS cFechacreado,
			punto.nombre as estacion,cuenta.nombre as cuenta,
            cartaporte.monto,
   --select
			diferenciaC.DiferenciaID,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			CONVERT(VARCHAR,diferenciaC.FechaCreado,105) AS Fecha,
			CONVERT(VARCHAR(8),diferenciaC.FechaCreado,108)  as 'Hora',
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
			diferenciaC.Observacion
			from diferenciaC
			join Plomo
			on   Plomo.DiferenciaID=diferenciaC.DiferenciaID
			join cartaporte
			on   cartaporte.cartaporteid= diferenciaC.cartaporteid
			join cartaporte_punto
			on  cartaporte_punto.cartaporteid = cartaporte.cartaporteid
			join punto
			on  punto.puntoid =  cartaporte_punto.puntoid
			join cuenta
			on  cuenta.cuentaid = cartaporte.cuentaid
			join envase
			on envase.cartaporteid=cartaporte.cartaporteid
			--join envase_efectivo
			--on  envase_efectivo.envaseid = envase.envaseid
			where diferenciaC.diferenciaid=CAST(@DiferenciaID AS INT)
			and  cartaporte_punto.puntoid <> 187 
			and cartaporte_punto.Tipo = 1
			and  envase.NroPlomo <> 'DEV'
			group by 
			Plomo.PlomoID,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, envase.Monto,
			diferenciaC.DiferenciaID,
			diferenciaC.CartaporteID,
			cartaporte.monto,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			cartaporte.fechacreado,
			diferenciaC.FechaCreado,
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
            diferenciaC.Observacion,
			punto.nombre,
			cuenta.nombre
END

GO
/****** Object:  StoredProcedure [dbo].[GET_Diferencia_Cajero]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_Diferencia_Cajero]
	@DiferenciaID varchar(50),
	@Cajero varchar(50),
	@Cubiculo varchar(50)
AS
BEGIN
	SET NOCOUNT ON

			select TOP 1 Envase.EnvaseID, @Cajero As cajero,@Cubiculo as cubiculo,
			
			cartaporte.cartaporteid,
			CONVERT(VARCHAR,cartaporte.fechacreado,105) AS cFechacreado,
			punto.nombre as estacion,cuenta.nombre as cuenta,
            cartaporte.monto,
   --select
			diferenciaC.DiferenciaID,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			CONVERT(VARCHAR,diferenciaC.FechaCreado,105) AS Fecha,
			CONVERT(VARCHAR(8),diferenciaC.FechaCreado,108)  as 'Hora',
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
			diferenciaC.Observacion
			from diferenciaC
			
			join cartaporte
			on   cartaporte.cartaporteid= diferenciaC.cartaporteid
			join Envase
			on   Envase.CartaPorteID=CartaPorte.CartaPorteID
			join cartaporte_punto
			on  cartaporte_punto.cartaporteid = cartaporte.cartaporteid
			join punto
			on  punto.puntoid =  cartaporte_punto.puntoid
			join cuenta
			on  cuenta.cuentaid = cartaporte.cuentaid
			where diferenciaC.diferenciaid=CAST(@DiferenciaID AS INT)
			and  cartaporte_punto.puntoid <> 187 
			and cartaporte_punto.Tipo = 1
			
			group by 
			Envase.EnvaseID,
			cartaporte.cartaporteid,
			diferenciaC.DiferenciaID,
			diferenciaC.CartaporteID,
			cartaporte.monto,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			cartaporte.fechacreado,
			diferenciaC.FechaCreado,
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
            diferenciaC.Observacion,
			punto.nombre,
			cuenta.nombre
END

GO
/****** Object:  StoredProcedure [dbo].[GET_DiferenciaAcopio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_DiferenciaAcopio]
	@DiferenciaID varchar(50),
	@Cajero varchar(50),
	@Cubiculo varchar(50)
AS
BEGIN
	SET NOCOUNT ON


			select distinct(Plomo.PlomoID),@Cajero as cajero,@Cubiculo as cubiculo,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			
			count(envase.envaseid) as envases,
			--sum(envase_efectivo.monto) as montoenvase,
			CONVERT(VARCHAR,cartaporte.fechacreado,105) AS cFechacreado,
			punto.nombre as estacion,
			cuenta.nombre as cuenta,
            cartaporte.monto,
			diferenciaC.DiferenciaID,
			diferenciaC.MontoDeclarado,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			CONVERT(VARCHAR,diferenciaC.FechaCreado,105) AS Fecha,
			CONVERT(VARCHAR(8),diferenciaC.FechaCreado,108)  as 'Hora',
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.Activo,
			diferenciaC.Observacion,
diferenciaC.Cartaportes,
diferenciaC.FechaCartaporte
			from diferenciaC
			join Plomo
			on   Plomo.DiferenciaID=diferenciaC.DiferenciaID
			join cartaporte
			on   cartaporte.cartaporteid= diferenciaC.cartaporteid
			join cartaporte_punto
			on  cartaporte_punto.cartaporteid = cartaporte.cartaporteid
			join punto
			on  punto.puntoid =  cartaporte_punto.puntoid
			join cuenta
			on  cuenta.cuentaid = cartaporte.cuentaid
			join envase
			on envase.cartaporteid=cartaporte.cartaporteid
			
			where diferenciaC.diferenciaid=CAST(@DiferenciaID AS INT)
			and  cartaporte_punto.tipo =1
			and  envase.NroPlomo <> 'DEV'
			and  diferenciaC.Activo = 1
			group by 
			Plomo.PlomoID,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, envase.Monto,
			diferenciaC.DiferenciaID,
			diferenciaC.CartaporteID,
			diferenciaC.MontoDeclarado,
			cartaporte.monto,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			cartaporte.fechacreado,
			diferenciaC.FechaCreado,
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.Activo,
diferenciaC.Observacion,
			punto.nombre,
			cuenta.nombre,
diferenciaC.Cartaportes,
diferenciaC.FechaCartaporte
END

GO
/****** Object:  StoredProcedure [dbo].[GET_DiferenciaEntubado]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_DiferenciaEntubado]
	@DiferenciaID varchar(50),
	@Cajero varchar(50),
	@Cubiculo varchar(50)
AS
BEGIN
	SET NOCOUNT ON


			select distinct(Plomo.PlomoID),@Cajero as cajero,@Cubiculo as cubiculo,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
            diferenciaC.Monto,
			punto.nombre as estacion,
			cuenta.nombre as cuenta,
			diferenciaC.DiferenciaID,
			diferenciaC.MontoDeclarado,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			CONVERT(VARCHAR,diferenciaC.FechaCreado,105) AS Fecha,
			CONVERT(VARCHAR(8),diferenciaC.FechaCreado,108)  as 'Hora',
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.Activo,
			diferenciaC.Observacion,
diferenciaC.Cartaportes,
diferenciaC.FechaCartaporte
			from diferenciaC
			join Plomo
			on   Plomo.DiferenciaID=diferenciaC.DiferenciaID
			join punto
			on punto.puntoid = diferenciaC.puntoid
			join cuenta
			on  cuenta.cuentaid = punto.cuentaid

			
			where diferenciaC.diferenciaid=CAST(@DiferenciaID AS INT)

			group by 
			Plomo.PlomoID,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			diferenciaC.Monto,
			diferenciaC.DiferenciaID,
			diferenciaC.CartaporteID,
			diferenciaC.MontoDeclarado,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			diferenciaC.FechaCreado,
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.Activo,
diferenciaC.Observacion,
			punto.nombre,
			cuenta.nombre,
diferenciaC.Cartaportes,
diferenciaC.FechaCartaporte
END

GO
/****** Object:  StoredProcedure [dbo].[GET_DiferenciaMensualMontoAcopio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_DiferenciaMensualMontoAcopio]
	@Ano varchar(4),
	@Mes varchar(2)
AS
BEGIN
	SET NOCOUNT ON

			select distinct(DiferenciaC.DiferenciaID), 
			DiferenciaC.LoginCreado as cajero,'' as cubiculo,Plomo.PlomoID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, 
			count(envase.envaseid) as envases,
			sum(envase_efectivo.monto) as montoenvase,
			CONVERT(VARCHAR,cartaporte.fechacreado,105) AS cFechacreado,
			punto.nombre as estacion,cuenta.nombre as cuenta,
            cartaporte.monto,
   --select
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			CONVERT(VARCHAR,diferenciaC.FechaCreado,105) AS Fecha,
			CONVERT(VARCHAR(8),diferenciaC.FechaCreado,108)  as 'Hora',
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
			diferenciaC.Observacion,
			DiferenciaC.BovedaID
			from diferenciaC
			join Plomo
			on   Plomo.DiferenciaID=diferenciaC.DiferenciaID
			join cartaporte
			on   cartaporte.cartaporteid= diferenciaC.cartaporteid
			join cartaporte_punto
			on  cartaporte_punto.cartaporteid = cartaporte.cartaporteid
			join punto
			on  punto.puntoid =  cartaporte_punto.puntoid
			join cuenta
			on  cuenta.cuentaid = cartaporte.cuentaid
			join envase
			on envase.cartaporteid=cartaporte.cartaporteid
			join envase_efectivo
			on  envase_efectivo.envaseid = envase.envaseid
			where YEAR(DiferenciaC.FechaCreado) = @Ano
			AND    MONTH(DiferenciaC.FechaCreado) = @Mes
			--and  cartaporte_punto.puntoid <> 187 
			and cartaporte_punto.Tipo = 1
			and  envase.NroPlomo <> 'DEV'
			and DiferenciaC.Activo = 1
			and DiferenciaC.BovedaID = 2
			group by 
			Plomo.PlomoID,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, envase.Monto,
			diferenciaC.DiferenciaID,
			diferenciaC.CartaporteID,
			cartaporte.monto,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			cartaporte.fechacreado,
			diferenciaC.FechaCreado,
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
            diferenciaC.Observacion,
            DiferenciaC.BovedaID,
			punto.nombre,
			cuenta.nombre
END

GO
/****** Object:  StoredProcedure [dbo].[GET_DiferenciaMensualMontoMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_DiferenciaMensualMontoMC]
	@Ano varchar(4),
	@Mes varchar(2)
AS
BEGIN
	SET NOCOUNT ON

			select distinct(DiferenciaC.DiferenciaID), 
			DiferenciaC.LoginCreado as cajero,'' as cubiculo,Plomo.PlomoID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, 
			count(envase.envaseid) as envases,
			sum(envase_efectivo.monto) as montoenvase,
			CONVERT(VARCHAR,cartaporte.fechacreado,105) AS cFechacreado,
			punto.nombre as estacion,cuenta.nombre as cuenta,
            cartaporte.monto,
   --select
			diferenciaC.DiferenciaID,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			CONVERT(VARCHAR,diferenciaC.FechaCreado,105) AS Fecha,
			CONVERT(VARCHAR(8),diferenciaC.FechaCreado,108)  as 'Hora',
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
			diferenciaC.Observacion,
			DiferenciaC.BovedaID
			from diferenciaC
			join Plomo
			on   Plomo.DiferenciaID=diferenciaC.DiferenciaID
			join cartaporte
			on   cartaporte.cartaporteid= diferenciaC.cartaporteid
			join cartaporte_punto
			on  cartaporte_punto.cartaporteid = cartaporte.cartaporteid
			join punto
			on  punto.puntoid =  cartaporte_punto.puntoid
			join cuenta
			on  cuenta.cuentaid = cartaporte.cuentaid
			join envase
			on envase.cartaporteid=cartaporte.cartaporteid
			join envase_efectivo
			on  envase_efectivo.envaseid = envase.envaseid
			where YEAR(DiferenciaC.FechaCreado) = @Ano
			AND    MONTH(DiferenciaC.FechaCreado) = @Mes
			--and  cartaporte_punto.puntoid <> 187 
			and cartaporte_punto.Tipo = 1
			and  envase.NroPlomo <> 'DEV'
			and DiferenciaC.Activo = 1
			and DiferenciaC.BovedaID = 4
			group by 
			Plomo.PlomoID,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, envase.Monto,
			diferenciaC.DiferenciaID,
			diferenciaC.CartaporteID,
			cartaporte.monto,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			cartaporte.fechacreado,
			diferenciaC.FechaCreado,
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
            diferenciaC.Observacion,
            DiferenciaC.BovedaID,
			punto.nombre,
			cuenta.nombre
END

GO
/****** Object:  StoredProcedure [dbo].[GET_DiferenciaMensualMontoVAB]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_DiferenciaMensualMontoVAB]
	@Ano varchar(4),
	@Mes varchar(2)
AS
BEGIN
	SET NOCOUNT ON

			select distinct(diferenciaC.DiferenciaID), 
			DiferenciaC.LoginCreado as cajero,'' as cubiculo,Plomo.PlomoID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, 
			count(envase.envaseid) as envases,
			sum(envase_efectivo.monto) as montoenvase,
			CONVERT(VARCHAR,cartaporte.fechacreado,105) AS cFechacreado,
			punto.nombre as estacion,cuenta.nombre as cuenta,
            cartaporte.monto,
   --select
			
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			CONVERT(VARCHAR,diferenciaC.FechaCreado,105) AS Fecha,
			CONVERT(VARCHAR(8),diferenciaC.FechaCreado,108)  as 'Hora',
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
			diferenciaC.Observacion,
			DiferenciaC.BovedaID
			from diferenciaC
			join Plomo
			on   Plomo.DiferenciaID=diferenciaC.DiferenciaID
			join cartaporte
			on   cartaporte.cartaporteid= diferenciaC.cartaporteid
			join cartaporte_punto
			on  cartaporte_punto.cartaporteid = cartaporte.cartaporteid
			join punto
			on  punto.puntoid =  cartaporte_punto.puntoid
			join cuenta
			on  cuenta.cuentaid = cartaporte.cuentaid
			join envase
			on envase.cartaporteid=cartaporte.cartaporteid
			join envase_efectivo
			on  envase_efectivo.envaseid = envase.envaseid
			where YEAR(DiferenciaC.FechaCreado) = @Ano
			AND    MONTH(DiferenciaC.FechaCreado) = @Mes
			--and  cartaporte_punto.puntoid <> 187 
			and cartaporte_punto.Tipo = 1
			and  envase.NroPlomo <> 'DEV'
			and DiferenciaC.Activo = 1
			and DiferenciaC.BovedaID = 8
			group by 
			Plomo.PlomoID,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, envase.Monto,
			diferenciaC.DiferenciaID,
			diferenciaC.CartaporteID,
			cartaporte.monto,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			cartaporte.fechacreado,
			diferenciaC.FechaCreado,
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
            diferenciaC.Observacion,
            DiferenciaC.BovedaID,
			punto.nombre,
			cuenta.nombre
END

GO
/****** Object:  StoredProcedure [dbo].[GET_DiferenciaMensualMontoVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_DiferenciaMensualMontoVABT]
	@Ano varchar(4),
	@Mes varchar(2)
AS
BEGIN
	SET NOCOUNT ON

			select distinct(DiferenciaC.DiferenciaID), 
			DiferenciaC.LoginCreado as cajero,'' as cubiculo,Plomo.PlomoID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, 
			count(envase.envaseid) as envases,
			sum(envase_efectivo.monto) as montoenvase,
			CONVERT(VARCHAR,cartaporte.fechacreado,105) AS cFechacreado,
			punto.nombre as estacion,cuenta.nombre as cuenta,
            cartaporte.monto,
   --select
			diferenciaC.DiferenciaID,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			CONVERT(VARCHAR,diferenciaC.FechaCreado,105) AS Fecha,
			CONVERT(VARCHAR(8),diferenciaC.FechaCreado,108)  as 'Hora',
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
			diferenciaC.Observacion,
			DiferenciaC.BovedaID
			from diferenciaC
			join Plomo
			on   Plomo.DiferenciaID=diferenciaC.DiferenciaID
			join cartaporte
			on   cartaporte.cartaporteid= diferenciaC.cartaporteid
			join cartaporte_punto
			on  cartaporte_punto.cartaporteid = cartaporte.cartaporteid
			join punto
			on  punto.puntoid =  cartaporte_punto.puntoid
			join cuenta
			on  cuenta.cuentaid = cartaporte.cuentaid
			join envase
			on envase.cartaporteid=cartaporte.cartaporteid
			join envase_efectivo
			on  envase_efectivo.envaseid = envase.envaseid
			where YEAR(DiferenciaC.FechaCreado) = @Ano
			AND    MONTH(DiferenciaC.FechaCreado) = @Mes
			--and  cartaporte_punto.puntoid <> 187 
			and cartaporte_punto.Tipo = 1
			and  envase.NroPlomo <> 'DEV'
			and DiferenciaC.Activo = 1
			and DiferenciaC.BovedaID = 5
			group by 
			Plomo.PlomoID,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, envase.Monto,
			diferenciaC.DiferenciaID,
			diferenciaC.CartaporteID,
			cartaporte.monto,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			cartaporte.fechacreado,
			diferenciaC.FechaCreado,
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
            diferenciaC.Observacion,
            DiferenciaC.BovedaID,
			punto.nombre,
			cuenta.nombre
END

GO
/****** Object:  StoredProcedure [dbo].[GET_DiferenciaMonto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_DiferenciaMonto]
	@DiferenciaID varchar(50),
	@Cajero varchar(50),
	@Cubiculo varchar(50)
AS
BEGIN
	SET NOCOUNT ON

			select @Cajero as cajero,@Cubiculo as cubiculo,Plomo.PlomoID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, 
			count(envase.envaseid) as envases,
			sum(envase_efectivo.monto) as montoenvase,
			CONVERT(VARCHAR,cartaporte.fechacreado,105) AS cFechacreado,
			punto.nombre as estacion,cuenta.nombre as cuenta,
            cartaporte.monto,
   --select
			diferenciaC.DiferenciaID,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			CONVERT(VARCHAR,diferenciaC.FechaCreado,105) AS Fecha,
			CONVERT(VARCHAR(8),diferenciaC.FechaCreado,108)  as 'Hora',
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
			diferenciaC.Observacion
			from diferenciaC
			join Plomo
			on   Plomo.DiferenciaID=diferenciaC.DiferenciaID
			join cartaporte
			on   cartaporte.cartaporteid= diferenciaC.cartaporteid
			join cartaporte_punto
			on  cartaporte_punto.cartaporteid = cartaporte.cartaporteid
			join punto
			on  punto.puntoid =  cartaporte_punto.puntoid
			join cuenta
			on  cuenta.cuentaid = cartaporte.cuentaid
			join envase
			on envase.nroplomo=Plomo.PlomoID
			join envase_efectivo
			on  envase_efectivo.envaseid = envase.envaseid
			where diferenciaC.diferenciaid=CAST(@DiferenciaID AS INT)
			--and  cartaporte_punto.puntoid <> 187 
			and cartaporte_punto.Tipo = 1
			and  envase.NroPlomo <> 'DEV'
			group by 
			Plomo.PlomoID,Plomo.DiferenciaID,
			Plomo.D0010,Plomo.D0050,Plomo.D0100,Plomo.D0125,Plomo.D0250,Plomo.D0500,Plomo.D10,Plomo.D100,
			Plomo.D1000,Plomo.D2,Plomo.D20,Plomo.D5,Plomo.D50,Plomo.F0010,Plomo.F0050,Plomo.F0100,Plomo.F0125,Plomo.F0250,Plomo.F0500,
			Plomo.F10,Plomo.F100,Plomo.F1000,Plomo.F2,Plomo.F20,Plomo.F5,Plomo.F50,
			envase.EnvaseID, envase.NroPlomo, envase.EstaAbierto, envase.FechaAbierto, envase.LoginAbierto, envase.CartaPorteID, envase.Defectuoso, envase.Monto,
			diferenciaC.DiferenciaID,
			diferenciaC.CartaporteID,
			cartaporte.monto,
			diferenciaC.Carnet,
			diferenciaC.LoginCreado,
			diferenciaC.Relacionadas,
			diferenciaC.Remision,
			diferenciaC.Supervisor, 
			cartaporte.fechacreado,
			diferenciaC.FechaCreado,
			diferenciaC.CartaporteID,
			diferenciaC.Sobrante,
			diferenciaC.Faltante, 
			diferenciaC.MontoDeclarado,
			diferenciaC.Activo,
            diferenciaC.Observacion,
			punto.nombre,
			cuenta.nombre
END

GO
/****** Object:  StoredProcedure [dbo].[GET_EntradaMensualLosTequesVAB]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_EntradaMensualLosTequesVAB]
	@Ano varchar(4),
	@Mes varchar(4)
AS
BEGIN
	SET NOCOUNT ON


SET DATEFORMAT DMY
SET LANGUAGE SPANISH
SELECT  

dbo.getFaltante((SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  --AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
(isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0))) as Faltante,

dbo.getSobrante((SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  --AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
(isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0))) as Sobrante,

dbo.getDiferencia((SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  --AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
(isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0))) as Diferencia,


Consignador.Nombre AS Estaciones,
		   Consignador.PuntoID,
		     (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  --AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true')  AS 'EntradaDiaria',
		  COUNT(Distinct EnvaseID)  AS Envases,

		    REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   					  FROM   CartaPorte_Punto Grupo
		   					  JOIN   CartaPorte
		   					  ON     CartaPorte.CartaPorteID = Grupo.CartaPorteID
							  WHERE  Grupo.TIPO = 1
							  AND    CartaPorte.Cerrado = 'true'
							  AND    Grupo.PuntoID = ConsignadorR.PuntoID
							  AND    EXISTS (SELECT *
											 FROM   Ruta_CartaPorte d
											 WHERE  d.CartaPorteID = Grupo.CartaPorteID
											 --AND    d.RutaID = Ruta_CartaPorte.RutaID
											 AND    d.TIPO = 2  GROUP BY d.CartaporteID)
											
							  FOR XML PATH (''))),' ',' - ') AS Cartaportes,

dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '100F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '50F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '20F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '10F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '5F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '2F',

dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '5a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '10a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '20a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '50a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '100a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '500a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '1000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '2000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '5000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '10000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '20000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '50000a',

dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,250',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,010',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,050',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,100',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,125',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,500',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '1,000',

dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '1,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '10,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '20,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '50,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '100,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '500,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '2,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '5,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '1000,000a',

-- montos en totales

(isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0)) as Efectivo_Monedas,


dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p100F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p50F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p20F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p10F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p5F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p2F',

dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p5a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p10a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p20a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p50a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p100a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p500a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p1000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p2000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p5000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p10000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p20000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p50000a',

dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,250',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,010',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,050',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,100',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,125',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,500',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p1,000',

dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p1,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p10,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p20,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p50,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p100,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p500,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p2,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p5,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p1000,000a',

--totales piezas
(isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0)) as Piezas_Monedas,

		   --Biblia.Secuencia,
(SELECT COUNT(*)
		FROM   Ruta
		WHERE MONTH(Ruta.Fecha) = @Mes
	    and YEAR(Ruta.Fecha) = @Ano
		AND    EXISTS(SELECT *
					  FROM   Ruta_CartaPorte
					  JOIN   vw_cartaporte
					  ON    vw_cartaporte.CartaPorteID = Ruta_CartaPorte.CartaPorteID 
					JOIN     ENVASE e
					ON       e.CartaporteID = vw_cartaporte.CartaPorteID
					  WHERE  vw_cartaporte.Consignadorid = Biblia.PuntoID
					  AND    Ruta_CartaPorte.Tipo in (2,3)
					  AND    Ruta_CartaPorte.RutaID = Ruta.RutaID))
		 
		 AS ViajesRealizados

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     ConsignadorR.PuntoId = Biblia.PuntoID 
--	JOIN   Ruta
--	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  MONTH(ConsignadorR.Fecha) = @Mes
	and    YEAR(ConsignadorR.Fecha) = @Ano
	AND    cartaporte.Porsistema = 'false'
	AND    ConsignadorR.Tipo = 1
	AND    Biblia.Tipo in ('vabMLTe')
    and cartaporte.cerrado = 'true'

	GROUP  BY 
		   Consignador.Nombre,
		   Consignador.PuntoID,
	      -- Biblia.Secuencia,
	       ConsignadorR.Fecha,
		   ConsignadorR.PuntoID,
ConsignadorR.Tipo,
		   biblia.puntoid

	--ORDER  BY Secuencia
END

GO
/****** Object:  StoredProcedure [dbo].[GET_EntradaMensualVAB]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_EntradaMensualVAB]
	@Ano varchar(4),
	@Mes varchar(2)
AS
BEGIN
	SET NOCOUNT ON


SET DATEFORMAT DMY
SET LANGUAGE SPANISH
SELECT  

dbo.getFaltante((SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  --AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
(isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0))) as Faltante,

dbo.getSobrante((SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  --AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
(isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0))) as Sobrante,

dbo.getDiferencia((SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  --AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
(isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0))) as Diferencia,


Consignador.Nombre AS Estaciones,
		   Consignador.PuntoID,
		     (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  --AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true')  AS 'EntradaDiaria',
		  --COUNT(Distinct EnvaseID)  AS Envases,

		    REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   					  FROM   CartaPorte_Punto Grupo
		   					  JOIN   CartaPorte
		   					  ON     CartaPorte.CartaPorteID = Grupo.CartaPorteID
							  WHERE  Grupo.TIPO = 1
							  AND    CartaPorte.Cerrado = 'true'
							  AND    Grupo.PuntoID = ConsignadorR.PuntoID
							  AND    EXISTS (SELECT *
											 FROM   Ruta_CartaPorte d
											 WHERE  d.CartaPorteID = Grupo.CartaPorteID
											 --AND    d.RutaID = Ruta_CartaPorte.RutaID
											 AND    d.TIPO = 2  GROUP BY d.CartaporteID)
											
							  FOR XML PATH (''))),' ',' - ') AS Cartaportes,
dbo.getEnvasesTotalByConsignador(ConsignadorR.PuntoID) as Envases,
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '100F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '50F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '20F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '10F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '5F',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '2F',

dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '5a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '10a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '20a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '50a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '100a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '500a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '1000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '2000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '5000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '10000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '20000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '50000a',

dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,250',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,010',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,050',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,100',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,125',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '0,500',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '1,000',

dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '1,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '10,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '20,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '50,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '100,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '500,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '2,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '5,000a',
dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS '1000,000a',

-- montos en totales

(isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getMontoEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0)) as Efectivo_Monedas,


dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p100F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p50F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p20F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p10F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p5F',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p2F',

dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p5a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p10a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p20a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p50a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p100a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p500a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p1000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p2000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p5000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p10000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p20000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p50000a',

dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,250',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,010',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,050',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,100',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,125',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p0,500',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p1,000',

dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p1,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p10,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p20,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p50,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p100,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p500,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p2,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p5,000a',
dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)) AS 'p1000,000a',

--totales piezas
(isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF5',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'BF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B007',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B008',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B012',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'B014',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF2',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF20',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF21',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF22',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF23',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF25',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'MF26',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +

isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M001',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M002',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M003',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M004',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M005',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M006',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M009',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M010',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0) +
isnull(dbo.getPiezasEfectivosByPuntoMensual(ConsignadorR.PuntoID,'M013',MONTH(ConsignadorR.Fecha),YEAR(ConsignadorR.Fecha)),0)) as Piezas_Monedas,

		   --Biblia.Secuencia,
(SELECT COUNT(*)
		FROM   Ruta
		WHERE MONTH(Ruta.Fecha) = @Mes
	    and YEAR(Ruta.Fecha) = @Ano
		AND    EXISTS(SELECT *
					  FROM   Ruta_CartaPorte
					  JOIN   vw_cartaporte
					  ON    vw_cartaporte.CartaPorteID = Ruta_CartaPorte.CartaPorteID 
					JOIN     ENVASE e
					ON       e.CartaporteID = vw_cartaporte.CartaPorteID
					  WHERE  vw_cartaporte.Consignadorid = Biblia.PuntoID
					  AND    Ruta_CartaPorte.Tipo in (2,3)
					  AND    Ruta_CartaPorte.RutaID = Ruta.RutaID))
		 
		 AS ViajesRealizados

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	--JOIN   Envase
	--ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     ConsignadorR.PuntoId = Biblia.PuntoID 
--	JOIN   Ruta
--	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  MONTH(ConsignadorR.Fecha) = @Mes
	and    YEAR(ConsignadorR.Fecha) = @Ano
	AND    cartaporte.Porsistema = 'false'
	AND    ConsignadorR.Tipo = 1
	AND    Biblia.Tipo in ('vab')
    and cartaporte.cerrado = 'true'

	GROUP  BY 
		   Consignador.Nombre,
		   Consignador.PuntoID,
	      -- Biblia.Secuencia,
	       ConsignadorR.Fecha,
		   ConsignadorR.PuntoID,
ConsignadorR.Tipo,
		   biblia.puntoid

END

GO
/****** Object:  StoredProcedure [dbo].[GET_ResumenCuentaEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_ResumenCuentaEntrada]
	@CuentaID INT,
	@Desde varchar(10),
	@Hasta varchar(10)
AS
BEGIN
	SET NOCOUNT ON
set dateformat dmy
	set language spanish
SELECT Ruta.Fecha  as 'Fecha',
           DATENAME(DW,Ruta.Fecha) AS DIA,

		  	 

dbo.getSobrante( (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						 on r.rutaid = d.rutaid
						 WHERE      d .CartaPorteID = b.CartaPorteID 
						 AND r.Fecha = Ruta.Fecha
						 
						  AND    d.TIPO = 2)
			AND  b.CuentaID = @CuentaID

		   --AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
		   (SELECT SUM(b.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (1,2,3,4)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2))) as Sobrante,
dbo.getFaltante( (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						 on r.rutaid = d.rutaid
						 WHERE      d .CartaPorteID = b.CartaPorteID 
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2)
AND  b.CuentaID = @CuentaID
		   --AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
		     (SELECT SUM(b.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (1,2,3,4)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2)) +dbo.getFaltanteNoContado(@Desde,@Hasta,@CuentaID)) as Faltante,
(dbo.getSobrante( (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						 on r.rutaid = d.rutaid
						 WHERE      d .CartaPorteID = b.CartaPorteID 
						 AND r.Fecha = Ruta.Fecha
						 
						  AND    d.TIPO = 2)
			AND  b.CuentaID = @CuentaID

		   --AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
		   (SELECT SUM(b.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (1,2,3,4)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2)))-
dbo.getFaltante( (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						 on r.rutaid = d.rutaid
						 WHERE      d .CartaPorteID = b.CartaPorteID 
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2)
AND  b.CuentaID = @CuentaID
		   --AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true'),
		     (SELECT SUM(b.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (1,2,3,4)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2)) +dbo.getFaltanteNoContado(@Desde,@Hasta,@CuentaID))) as Diferencia,

		  
(SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		  
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						 join ruta r
						 on r.rutaid = d.rutaid
						 WHERE      d .CartaPorteID = b.CartaPorteID 
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2)
 AND  b.CuentaID = @CuentaID
		   --AND    b.ConsignadorID = ConsignadorR.PuntoID
		   AND    b.Cerrado = 'true')  AS 'EntradaDiaria',		

		   COUNT(Distinct EnvaseID)  AS Envases,

		    REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   					  FROM   CartaPorte_Punto Grupo
		   					  JOIN   CartaPorte
		   					  ON     CartaPorte.CartaPorteID = Grupo.CartaPorteID
							  WHERE  Grupo.TIPO = 1
							  and Cartaporte.CuentaID = @CuentaID
							  AND    CartaPorte.Cerrado = 'true'
							  --AND    Grupo.PuntoID = ConsignadorR.PuntoID
							  AND    EXISTS (SELECT *
											 FROM   Ruta_CartaPorte d
											join ruta r
											 on r.rutaid = d.rutaid
											 WHERE  d.CartaPorteID = CartaPorte.CartaPorteID 
											 AND r.Fecha = Ruta.Fecha
											 AND    d.TIPO = 2  GROUP BY d.CartaporteID)
											
							  FOR XML PATH (''))),' ',' - ') AS Cartaportes,

		   
		   (SELECT SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (1,2)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						   AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2)) AS Piezas_Monedas,
		   (SELECT SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (3,4)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						   AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2)) AS Piezas_Billetes,
(SELECT SUM(b.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (1,2)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						   AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2))
						   AS Efectivo_Monedas,
(SELECT SUM(b.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (3,4)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						   AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 2))
		    AS Efectivo_Billetes,


	(SELECT COUNT(*)
		FROM   Ruta r
		WHERE r.Fecha >= @Desde
		AND   r.Fecha <= @Hasta
		AND    EXISTS(SELECT * 
					  FROM   Ruta_CartaPorte
					  JOIN   vw_cartaporte
					  ON    vw_cartaporte.CartaPorteID = Ruta_CartaPorte.CartaPorteID 
					JOIN     ENVASE e
					ON       e.CartaporteID = vw_cartaporte.CartaPorteID
					  WHERE  Ruta_CartaPorte.Tipo in (2,3)
					   AND  vw_cartaporte.CuentaID = @CuentaID
					   and Ruta_CartaPorte.CartaPorteID = vw_cartaporte.CartaPorteID 
						AND r.Fecha = Ruta.Fecha))
		 
		 AS ViajesRealizados

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE 
  	Ruta.Fecha >= @Desde
  	AND Ruta.Fecha <= @Hasta
	AND    cartaporte.Porsistema = 'false'
	AND    Ruta_Cartaporte.Tipo = 2
  	and Cartaporte.rubroid in(1,2,3,4)
	AND    Cartaporte.CuentaID = @CuentaID
	and cartaporte.cerrado = 'true'

	GROUP  BY Ruta.Fecha
		   

	ORDER  BY Ruta.Fecha  
                           
                           
                           
                                                  
                                                  
END


GO
/****** Object:  StoredProcedure [dbo].[GET_ResumenCuentaSaldo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[GET_ResumenCuentaSaldo]
	@CuentaID INT
AS
BEGIN
	
	select CONVERT(VARCHAR,CONVERT(money, dbo.GET_CuentaSaldo(@CuentaID)),1)  as Monto                        
                                                  
END

GO
/****** Object:  StoredProcedure [dbo].[GET_ResumenCuentaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GET_ResumenCuentaSalida]
	@CuentaID INT,
	@Desde varchar(10),
	@Hasta varchar(10)
AS
BEGIN
	SET NOCOUNT ON
SET              DATEFORMAT DMY
SET              LANGUAGE Spanish
                                   SELECT Ruta.Fecha  as 'Fecha',
           DATENAME(DW,Ruta.Fecha) AS DIA,                                       
    

		  
(SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		  
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						 join ruta r
						 on r.rutaid = d.rutaid
						 WHERE      d .CartaPorteID = b.CartaPorteID 
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 1)
 AND  b.CuentaID = @CuentaID)  AS 'SalidaDiaria',		

		   COUNT(Distinct EnvaseID)  AS Envases,

		    REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   					  FROM   CartaPorte_Punto Grupo
		   					  JOIN   CartaPorte
		   					  ON     CartaPorte.CartaPorteID = Grupo.CartaPorteID
							  WHERE  Grupo.TIPO = 2
							  and Cartaporte.CuentaID = @CuentaID
							 -- AND    CartaPorte.Cerrado = 'true'
							  --AND    Grupo.PuntoID = ConsignadorR.PuntoID
							  AND    EXISTS (SELECT *
											 FROM   Ruta_CartaPorte d
											join ruta r
											 on r.rutaid = d.rutaid
											 WHERE  d.CartaPorteID = CartaPorte.CartaPorteID 
											 AND r.Fecha = Ruta.Fecha
											 AND    d.TIPO = 1  GROUP BY d.CartaporteID)
											
							  FOR XML PATH (''))),' ',' - ') AS Cartaportes,

		   
		   (SELECT SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (1,2)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						   AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 1)) AS Piezas_Monedas,
		   (SELECT SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (3,4)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						   AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 1)) AS Piezas_Billetes,
(SELECT SUM(b.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (1,2)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						   AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 1))
						   AS Efectivo_Monedas,
(SELECT SUM(b.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   WHERE  d.EfectivoTipoID IN (3,4)
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  join ruta r
						  on r.rutaid = d.rutaid
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						   AND  vwc.CuentaID = @CuentaID
						 AND r.Fecha = Ruta.Fecha
						  AND    d.TIPO = 1))
		    AS Efectivo_Billetes,


	(SELECT COUNT(*)
		FROM   Ruta r
		WHERE r.Fecha >= @Desde
		AND   r.Fecha <= @Hasta
		AND    EXISTS(SELECT * 
					  FROM   Ruta_CartaPorte
					  JOIN   vw_cartaporte
					  ON    vw_cartaporte.CartaPorteID = Ruta_CartaPorte.CartaPorteID 
					JOIN     ENVASE e
					ON       e.CartaporteID = vw_cartaporte.CartaPorteID
					  WHERE  Ruta_CartaPorte.Tipo in (1,4)
					   AND  vw_cartaporte.CuentaID = @CuentaID
					   and Ruta_CartaPorte.CartaPorteID = vw_cartaporte.CartaPorteID 
						AND r.Fecha = Ruta.Fecha))
		 
		 AS ViajesRealizados

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE 
  	Ruta.Fecha >= @Desde
  	AND Ruta.Fecha <= @Hasta
	
	AND    Ruta_Cartaporte.Tipo = 1
  	and Cartaporte.rubroid in(1,2,3,4)
	AND    Cartaporte.CuentaID = @CuentaID
	--and cartaporte.cerrado = 'true'

	GROUP  BY Ruta.Fecha
		   

	ORDER  BY Ruta.Fecha  
                           
                                                  
                                                  
END


GO
/****** Object:  StoredProcedure [dbo].[GET_Ruta_By_Cataporte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[GET_Ruta_By_Cataporte]
	@CartaporteID VARCHAR(13)
AS
BEGIN
	SET NOCOUNT ON

	select * from Ruta
	join Ruta_CartaPorte
	on Ruta_CartaPorte.RutaID = Ruta.RutaID
	join CartaPorte
	on CartaPorte.CartaPorteID = Ruta_CartaPorte.CartaPorteID
	where CartaPorte.CartaPorteID = @CartaporteID
END

GO
/****** Object:  StoredProcedure [dbo].[GetCajaID_By_Cajero]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GetCajaID_By_Cajero]
	@Login VARCHAR(30)
AS
BEGIN

	SET NOCOUNT ON
    SET TRANSACTION ISOLATION LEVEL serializable 

    BEGIN TRANSACTION cajero 

    SET DATEFORMAT DMY

    DECLARE @ID INT,
		    @NUMERRORS    INT, 
            @ERRORMESSAGE VARCHAR(5000)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = '' 
	       

	BEGIN TRY

	SELECT CajaID 
			  FROM   Caja_Historial
			  WHERE  FechaCerrado IS NULL
			  AND    LoginAbierto = @Login
	END TRY

	BEGIN CATCH
		ROLLBACK TRANSACTION cajero 
		

		SELECT @ERRORMESSAGE = 'Error: Este Cajero no tiene Caja aperturada en la fecha de Hoy' + getdate() + '',
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @ERRORMESSAGE AS 'ErrorMessage',
			   @NUMERRORS    AS 'ErrorCount'
	    RETURN		
	END CATCH

	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION cajero 
	ELSE 
		COMMIT TRANSACTION cajero 

	SELECT @NUMERRORS     AS 'ErrorCount',
		   @ERRORMESSAGE  AS 'ErrorMessage'
	
END


GO
/****** Object:  StoredProcedure [dbo].[Ingreso_BovedaReceptor]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 14-12-2010 
-- Description:  ingreso de efectivo en boveda 
-- ============================================= 
CREATE PROCEDURE [dbo].[Ingreso_BovedaReceptor] 
		@TraspasoID INT, 
		@EfectivoID INT,
		@BovedaReceptorID INT,
		@MontoReceptor DECIMAL(18, 3),
		@NUMERRORS  INT OUTPUT , 
		@ERRORMESSAGES VARCHAR(5000) OUTPUT    
AS
BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Ingreso 

      SET dateformat ymd; 

      DECLARE @MontoReceptorNuevo   DECIMAL(18, 3),
              @Monto   DECIMAL(18, 3)


      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGES = ''; 

      /**** Validamos que exista la boveda y obtenemos su efectivo ****/ 
      BEGIN TRY 
          SELECT @Monto = monto 
          FROM   boveda_efectivo 
          WHERE  bovedaid = @BovedaReceptorID
		  AND    EfectivoID =  @EfectivoID;

            BEGIN 
                SET    @MontoReceptorNuevo = @MontoReceptor + @Monto 
            END 
          
            BEGIN 
			  SET @NUMERRORS = @NUMERRORS + 1; 
			  SET @ERRORMESSAGES = @ERRORMESSAGES +  CHAR(13) + CHAR(10) + 'Error: Tipo de transacción inválida'; 
            END 

		  IF (@Monto IS NULL)
			BEGIN
              SET @NUMERRORS = @NUMERRORS + 1; 
              SET @ERRORMESSAGES = @ERRORMESSAGES +  CHAR(13) + CHAR(10) + 'Error: Cuenta inválida.'; 
 			END
      END TRY 

      BEGIN CATCH 
          SET @NUMERRORS = @NUMERRORS + @@ERROR; 
          SET @ERRORMESSAGES = @ERRORMESSAGES +  CHAR(13) + CHAR(10) + Error_message(); 
      END CATCH 
 

      /**** Actualiza el Saldo de la Cuenta ****/ 
      BEGIN TRY 
          UPDATE boveda_efectivo
          SET    monto = @MontoReceptorNuevo
          WHERE  bovedaid = @BovedaReceptorID
		  AND    EfectivoID =  @EfectivoID;    
      END TRY 

      BEGIN CATCH 
          SET @NUMERRORS = @NUMERRORS + @@ERROR; 
          SET @ERRORMESSAGES = @ERRORMESSAGES +  CHAR(13) + CHAR(10) + Error_message(); 
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Ingreso 
      ELSE 
        COMMIT TRANSACTION Ingreso 


  END






GO
/****** Object:  StoredProcedure [dbo].[Oficial_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Crear cartaporte	
-- ============================================= 
CREATE PROCEDURE [dbo].[Oficial_INSERT]  
	@Nombre		VARCHAR(200),
	@OficialID	INT,
	@CI			VARCHAR(30)
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION oficial 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 




/***********************    INSERT:[OFICIAL]    ***********************/

	  BEGIN TRY 
          INSERT INTO oficial 
					  (oficialid,
					   Nombre,
					   CI) 
          VALUES      (@OficialID,
					   @Nombre,
					   @CI) 
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION oficial 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION oficial 
      ELSE 
        COMMIT TRANSACTION oficial 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END

GO
/****** Object:  StoredProcedure [dbo].[Oficial_UPDATE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Oficial_UPDATE] 
	@Nombre VARCHAR(200),
	@OficialID INT,
	@CI VARCHAR(30)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION oficial 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[OFICIAL]    ***********************/

	  BEGIN TRY 
          UPDATE Oficial 
		  SET    Nombre = @Nombre, CI = @CI
				
		  WHERE  OficialID = @OficialID

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION oficial 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION oficial 
      ELSE 
        COMMIT TRANSACTION oficial 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Placa_DELETE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 04-12-2010 
-- Description:  Cancelar traspaso	
-- ============================================= 
CREATE PROCEDURE [dbo].[Placa_DELETE] 
	@PlacaID INT,
	@Login VARCHAR (30)

	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION placa 

      SET DATEFORMAT DMY

      DECLARE   @NUMERRORS    INT, 
				@ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


/***********************    VALIDACION:[PLACA]    ***********************/
	  IF NOT EXISTS (SELECT *
					 FROM   placa 
					 WHERE  placa.placaID = @PlacaID)
		BEGIN
			ROLLBACK TRANSACTION placa 
			SELECT @ERRORMESSAGE = 'Error: No puede eliminar esta placa, ya que fue eliminado previamente.', 
				   @NUMERRORS = @NUMERRORS + 1
		    SELECT @NUMERRORS     AS 'ErrorCount', 
			  	   @ERRORMESSAGE  AS 'ErrorMessage'
			RETURN
		END
	  
    


/***********************    DELETE:[PLACA]    ***********************/

	  BEGIN TRY 
          DELETE FROM  placa          
          WHERE        placaID = @PlacaID           
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION placa 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 


      

/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION placa 
      ELSE 
        COMMIT TRANSACTION placa 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END

GO
/****** Object:  StoredProcedure [dbo].[Placa_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Crear cartaporte	
-- ============================================= 
CREATE PROCEDURE [dbo].[Placa_INSERT]  
	@Descripcion  VARCHAR(200)
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION placa 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @ID INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 




/***********************    INSERT:[PLACA]    ***********************/

	  BEGIN TRY 
          INSERT INTO placa 
					  (Descripcion) 
          VALUES      (@Descripcion) 
		 SET @ID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION placa 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION placa 
      ELSE 
        COMMIT TRANSACTION placa 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @ID			AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Placa_UPDATE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Placa_UPDATE] 
	@Nombre VARCHAR(200),
	@PlacaID INT
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION placa 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[OFICIAL]    ***********************/

	  BEGIN TRY 
          UPDATE Placa 
		  SET    Descripcion = @Nombre
				
		  WHERE  PlacaID = @PlacaID

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION placa 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION placa 
      ELSE 
        COMMIT TRANSACTION placa 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Plomo_Diferencia_Cajero_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Plomo_Diferencia_Cajero_INSERT] 
	 @PlomoID VARCHAR(50),
	 @CartaporteID VARCHAR(13),	
	 @Supervisor VARCHAR(50),	
	 @D0010 INT,
	 @D0050 INT,
	 @D0100 INT,
	 @D0125 INT,
	 @D0250 INT,
	 @D0500 INT,
	 @D10 INT,
	 @D100 INT,
	 @D1000 INT,
	 @D2 INT,
	 @D20 INT,
	 @D5 INT,
	 @D50 INT,
	 @F0010 INT,
	 @F0050 INT,
	 @F0100 INT,
	 @F0125 INT,
	 @F0250 INT,
	 @F0500 INT,
	 @F10 INT,
	 @F100 INT,
	 @F1000 INT,
	 @F2 INT,
	 @F20 INT,
	 @F5 INT,
	 @F50 INT

AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION diferencia 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	


      /**** Crea la diferencia ****/ 
      BEGIN TRY 
          INSERT INTO Plomo_Diferencia
                      (PlomoID,
						CartaporteID,
						Supervisor,
						D0010,
						D0050,
						D0100,
						D0125,
						D0250,
						D0500,
						D10,
						D100,
						D1000,
						D2,
						D20,
						D5,
						D50,
						F0010,
						F0050,
						F0100,
						F0125,
						F0250,
						F0500,
						F10,
						F100,
						F1000,
						F2,
						F20,
						F5,
						F50) 
          VALUES      (@PlomoID,
						@CartaporteID,
						@Supervisor,
						@D0010,
						@D0050,
						@D0100,
						@D0125,
						@D0250,
						@D0500,
						@D10,
						@D100,
						@D1000,
						@D2,
						@D20,
						@D5,
						@D50,
						@F0010,
						@F0050,
						@F0100,
						@F0125,
						@F0250,
						@F0500,
						@F10,
						@F100,
						@F1000,
						@F2,
						@F20,
						@F5,
						@F50)
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION diferencia 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION diferencia 
      ELSE 
        COMMIT TRANSACTION diferencia 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @PlomoID AS 'ExtraValue'
  END
GO
/****** Object:  StoredProcedure [dbo].[Plomo_Diferencia_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Plomo_Diferencia_INSERT] 
	 @PlomoID VARCHAR(50),
	 @DiferenciaID INT,	
	 @D0010 INT,
	 @D0050 INT,
	 @D0100 INT,
	 @D0125 INT,
	 @D0250 INT,
	 @D0500 INT,
	 @D10 INT,
	 @D100 INT,
	 @D1000 INT,
	 @D2 INT,
	 @D20 INT,
	 @D5 INT,
	 @D50 INT,
	 @F0010 INT,
	 @F0050 INT,
	 @F0100 INT,
	 @F0125 INT,
	 @F0250 INT,
	 @F0500 INT,
	 @F10 INT,
	 @F100 INT,
	 @F1000 INT,
	 @F2 INT,
	 @F20 INT,
	 @F5 INT,
	 @F50 INT

AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION diferencia 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 
	


      /**** Crea la diferencia ****/ 
      BEGIN TRY 
          INSERT INTO Plomo
                      (PlomoID,
						DiferenciaID,
						D0010,
						D0050,
						D0100,
						D0125,
						D0250,
						D0500,
						D10,
						D100,
						D1000,
						D2,
						D20,
						D5,
						D50,
						F0010,
						F0050,
						F0100,
						F0125,
						F0250,
						F0500,
						F10,
						F100,
						F1000,
						F2,
						F20,
						F5,
						F50) 
          VALUES      (@PlomoID,
						@DiferenciaID,
						@D0010,
						@D0050,
						@D0100,
						@D0125,
						@D0250,
						@D0500,
						@D10,
						@D100,
						@D1000,
						@D2,
						@D20,
						@D5,
						@D50,
						@F0010,
						@F0050,
						@F0100,
						@F0125,
						@F0250,
						@F0500,
						@F10,
						@F100,
						@F1000,
						@F2,
						@F20,
						@F5,
						@F50)
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION diferencia 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION diferencia 
      ELSE 
        COMMIT TRANSACTION diferencia 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @PlomoID AS 'ExtraValue'
  END
GO
/****** Object:  StoredProcedure [dbo].[Plomo_GetBy_Diferencia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Plomo_GetBy_Diferencia]
	@DiferenciaID VARCHAR(13)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT Plomo.PlomoID,
			Plomo.DiferenciaID,
			Plomo.D0010,
			Plomo.D0050,
			Plomo.D0100,
			Plomo.D0125,
			Plomo.D0250,
			Plomo.D0500,
			Plomo.D10,
			Plomo.D100,
			Plomo.D1000,
			Plomo.D2,
			Plomo.D20,
			Plomo.D5,
			Plomo.D50,
			Plomo.F0010,
			Plomo.F0050,
			Plomo.F0100,
			Plomo.F0125,
			Plomo.F0250,
			Plomo.F0500,
			Plomo.F10,
			Plomo.F100,
			Plomo.F1000,
			Plomo.F2,
			Plomo.F20,
			Plomo.F5,
			Plomo.F50
	FROM   Plomo
	JOIN   DiferenciaC d
	ON     	d.DiferenciaID = Plomo.DiferenciaID
	WHERE  d.DiferenciaID = @DiferenciaID
	
END







GO
/****** Object:  StoredProcedure [dbo].[ProActualizarSaldoDeuda]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ProActualizarSaldoDeuda]
	@BovedaID INT,
	@Ano varchar(4),
	@Mes varchar(2)
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cuenta 

	SET DATEFORMAT DMY

	SET LANGUAGE SPANISH

	DECLARE @NUMERRORS     INT, 
			@ERRORMESSAGE VARCHAR(5000),
			@MontoSalida DECIMAL(18,3),
			@MontoSalidaDia DECIMAL(18,3),
			@MontoEntrada DECIMAL(18,3),
			@MontoEntradaDia DECIMAL(18,3),
			@MontoActualizado decimal(18,3),
			@MontoActualizadoA decimal(18,3),
			@MontoActualizadoAnterior decimal(18,3),
			@DiaActual varchar(2)
			
			

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''
	

declare @DiaA varchar(10)

declare @fechas datetime
declare @fechaA datetime



set @DiaActual = DATEPART(dd,GETDATE())

set @fechas = @DiaActual + '/' + @Mes + '/' + @Ano

set @fechaA = DATEADD(dd,-1,@fechas)
set @DiaA = DATEPART(dd,@fechaA)

SET  @MontoSalidaDia = ISNULL((
	      SELECT SUM(Monto)
		FROM   vw_cartaporte
		WHERE  EXISTS (SELECT *
					   FROM   Ruta_CartaPorte 
					   JOIN   Ruta
					   ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
					   WHERE  Ruta_CartaPorte.CartaPorteID = vw_cartaporte.CartaPorteID

							AND    YEAR(Ruta.Fecha) = @Ano
						  AND    MONTH(Ruta.Fecha) = @Mes
						  and    DAY(Ruta.Fecha) =@DiaA

					
					AND    Ruta_CartaPorte.TIPO = 2 and Ruta.Nombre in('mc 1','mc 2','mc 3','mc 4','mc 5'))),0)
					
					
					
		SET  @MontoEntradaDia = ISNULL((
	      SELECT SUM(Monto)
		FROM   vw_cartaporte
		WHERE  EXISTS (SELECT *
					   FROM   Ruta_CartaPorte 
					   JOIN   Ruta
					   ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
					   WHERE  Ruta_CartaPorte.CartaPorteID = vw_cartaporte.CartaPorteID

							AND    YEAR(Ruta.Fecha) = @Ano
						  AND    MONTH(Ruta.Fecha) = @Mes
						  and    DAY(Ruta.Fecha) =@DiaA

					
					AND    Ruta_CartaPorte.TIPO = 1 and Ruta.Nombre in('mc 1','mc 2','mc 3','mc 4','mc 5'))),0)
					

	     SET  @MontoSalida = ISNULL((
	      SELECT SUM(MontoReal)
		FROM   vw_cartaporte
		WHERE  EXISTS (SELECT *
					   FROM   Ruta_CartaPorte 
					   JOIN   Ruta
					   ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
					   WHERE  Ruta_CartaPorte.CartaPorteID = vw_cartaporte.CartaPorteID

							AND    YEAR(Ruta.Fecha) = @Ano
						  AND    MONTH(Ruta.Fecha) = @Mes

					
					AND    Ruta_CartaPorte.TIPO = 2 and Ruta.Nombre in('mc 1','mc 2','mc 3','mc 4','mc 5'))),0)
					
		set @MontoEntrada = ISNULL((
		SELECT SUM(Monto)
		FROM   vw_cartaporte
		WHERE  EXISTS (SELECT *
					   FROM   Ruta_CartaPorte 
					   JOIN   Ruta
					   ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
					   WHERE  Ruta_CartaPorte.CartaPorteID = vw_cartaporte.CartaPorteID
						  AND    YEAR(Ruta.Fecha) = @Ano
						  AND    MONTH(Ruta.Fecha) = @Mes
					   AND    Ruta_CartaPorte.TIPO = 1 and Ruta.Nombre in('mc 1','mc 2','mc 3','mc 4','mc 5'))),0)
					   
		--SET @MontoActualizado = ISNULL(@MontoEntrada,0) - ISNULL(@MontoSalida,0)
		
		SET @MontoActualizadoA = ISNULL(@MontoEntradaDia,0) - ISNULL(@MontoSalidaDia,0)
		
		
		


	declare @Fecha datetime
    declare @DIA VARCHAR(2)
    declare @MontoReal DECIMAL(18,3)
	SET @DIA ='01'

	set @Fecha = @DIA + '/' + @Mes + '/' + @Ano

	DECLARE @MesA datetime
	declare @MesA2 varchar(2)
	declare @MesActual varchar(2)

	set @MesA = DATEADD(mm,-1,@Fecha)

	set @MesA2 = DATEPART(mm,@MesA)
	
	set @MesActual = DATEPART(mm,@MesA)

	select @MontoActualizadoAnterior = Deuda.Monto from Deuda
	
	set @MontoReal = ISNULL(@MontoActualizadoAnterior,0) - ISNULL(@MontoActualizadoA,0)
	--TRANSITO
	BEGIN TRY	
	
	
	
		--IF EXISTS(SELECT * FROM Deuda_Transito WHERE Ano = @Ano and Mes = @Mes) 
		--BEGIN
		--UPDATE Deuda_Transito set Monto = @MontoReal
		--where Deuda_Transito.Ano = @Ano
		--and   Deuda_Transito.Mes = @Mes
		--END
		--ELSE
		BEGIN
		--INSERT INTO Deuda_Transito (Ano,Mes,Monto) VALUES (@Ano,@Mes,@MontoReal)
		INSERT INTO Deuda (Fecha,Monto,MontoTransaccion,PuntoID) values (@fechas,@MontoReal,0,1)
		END

		
	END TRY
	BEGIN CATCH
	  ROLLBACK TRANSACTION cuenta  
	  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			 @NUMERRORS = @NUMERRORS + 1
	  SELECT @NUMERRORS     AS 'ErrorCount',
			 @ERRORMESSAGE  AS 'ErrorMessage' 
	  RETURN

	END  CATCH

	IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta


      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
END
GO
/****** Object:  StoredProcedure [dbo].[ProActualizarSaldoPendiente]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ProActualizarSaldoPendiente]
	@BovedaID INT,
	@Fecha varchar(10)
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cuenta 

	SET DATEFORMAT DMY

	SET LANGUAGE SPANISH

	DECLARE @NUMERRORS     INT, 
			@ERRORMESSAGE VARCHAR(5000),
			@FondoSalida DECIMAL(18,3),
			@FondoEntrada DECIMAL(18,3),
			@MontoActualizado DECIMAL(18,3),
			@FechaActualizada varchar(10),
			@MontoPendiente DECIMAL(18,3),
			@MontoFinal DECIMAL(18,3)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''

	
	--SALIDA
	SELECT @FondoSalida = sum(Traspaso_Efectivo.Monto)
	FROM   Traspaso_Efectivo
	JOIN   Traspaso
	ON     Traspaso.TraspasoID = Traspaso_Efectivo.TraspasoID
	WHERE  BovedaEmisorID = @BovedaID
    AND    Replace(SubString(CONVERT(VARCHAR,Traspaso.FechaEmisor,105),0,11),'-','/') = @Fecha

	--ENTRADA
	SELECT @FondoEntrada = sum(Traspaso_Efectivo.Monto)
	FROM   Traspaso_Efectivo
	JOIN   Traspaso
	ON     Traspaso.TraspasoID = Traspaso_Efectivo.TraspasoID
	WHERE  BovedaReceptorID = @BovedaID
    AND    Replace(SubString(CONVERT(VARCHAR,Traspaso.FechaReceptor,105),0,11),'-','/') = @Fecha

	set @MontoActualizado = @FondoSalida - @FondoEntrada

	
	
	--TRANSITO
	BEGIN TRY	
		SELECT @MontoPendiente = MontoPendiente FROM Boveda_Efectivo_Pendiente
		WHERE BovedaID = @BovedaID
	
		SET @MontoFinal = @MontoPendiente - @MontoActualizado
		
		INSERT Boveda_Efectivo_Pendiente 
				(BovedaID, MontoPendiente, Descripcion)
		VALUES   (@BovedaID ,@MontoActualizado,'CUENTAS POR PAGAR')
		

		
	END TRY
	BEGIN CATCH
	  ROLLBACK TRANSACTION cuenta  
	  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			 @NUMERRORS = @NUMERRORS + 1
	  SELECT @NUMERRORS     AS 'ErrorCount',
			 @ERRORMESSAGE  AS 'ErrorMessage' 
	  RETURN

	END  CATCH

	IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta


      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @Fecha         AS 'ExtraValue'
END
GO
/****** Object:  StoredProcedure [dbo].[proBOBEDA_Aprobar]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 18-11-2010 
-- Description:  Aprobar solicitud
-- ============================================= 
CREATE PROCEDURE [dbo].[proBOBEDA_Aprobar] 
	@Fecha VARCHAR(10),
	@Login VARCHAR(30)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION aprobar 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 

/***********************     VALIDACIONES    ***********************/


	  IF  EXISTS (SELECT * 
				  FROM   Solicitud 
				  WHERE  SolicitudTipoID IN (1,2,3)
				  AND    FechaCreado = @Fecha
				  AND    Aprobado = 1)
		  AND 
          EXISTS (SELECT * 
				  FROM   Solicitud 
				  WHERE  SolicitudTipoID IN (1,2,3)
				  AND    FechaCreado = @Fecha
				  AND    Aprobado = 0)
        BEGIN 
		   ROLLBACK TRANSACTION aprobar 
		   SELECT @ERRORMESSAGE = 'Error: Inconsistencia fatal comuniquese con los desarrolladores del sistema ' + @Fecha,
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN;
        END  
	  IF  EXISTS (SELECT * 
				  FROM   Solicitud 
				  WHERE  SolicitudTipoID IN (1,2,3)
				  AND    FechaCreado = @Fecha
				  AND    Aprobado = 1) 
        BEGIN 
		   ROLLBACK TRANSACTION aprobar 
		   SELECT @ERRORMESSAGE = 'Error: Ya se aprobaron las solicitudes del dia ' + @Fecha,
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN;
        END
 

/***********************    APROBAR    ***********************/

	  BEGIN TRY 
          UPDATE Solicitud
          SET    Aprobado = 1 
          WHERE  SolicitudTipoID IN (1,2,3)
		  AND    FechaCreado = @Fecha
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION aprobar 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN;
      END CATCH 




/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION aprobar 
      ELSE 
        COMMIT TRANSACTION aprobar 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  

























GO
/****** Object:  StoredProcedure [dbo].[proBoveda_AbrirDia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[proBoveda_AbrirDia] 
	@Login VARCHAR(30),
	@Observacion VARCHAR(MAX),
	@BovedaID INT
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cuenta 

	SET DATEFORMAT DMY

	SET LANGUAGE SPANISH

	DECLARE @NUMERRORS     INT, 
			@ERRORMESSAGE VARCHAR(5000),
			@Monto        DECIMAL(18,3)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''

	SET @Monto = (SELECT SUM(MONTO)
	FROM Boveda_Efectivo
	where BovedaID = @BovedaID)

/***********************    VALIDACIONES    ***********************/
	-- 1 Que no este abierto
	IF EXISTS(SELECT * 
			  FROM   Boveda_Historial
			  WHERE  Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
			  AND    BovedaID = @BovedaID)
	BEGIN
	   ROLLBACK TRANSACTION cuenta
	   SELECT @ERRORMESSAGE = 'Error: Ya esta abierto el día',
			  @NUMERRORS = @NUMERRORS + 1
	   SELECT @NUMERRORS     AS 'ErrorCount', 
              @ERRORMESSAGE AS 'ErrorMessage'
	   RETURN	
	END

	-- 2 Que no existan dias trabajados sin cerrar
	IF EXISTS(SELECT * 
			  FROM   Boveda_Historial
			  WHERE  Fecha IS NOT NULL 
			  AND    FechaCerrado IS NULL   
			  AND    BovedaID = @BovedaID)
	BEGIN
	   ROLLBACK TRANSACTION cuenta
	   SELECT @ERRORMESSAGE = 'Error: Tiene días pendientes por cerrar.',
			  @NUMERRORS = @NUMERRORS + 1
	   SELECT @NUMERRORS     AS 'ErrorCount', 
              @ERRORMESSAGE AS 'ErrorMessage'
	   RETURN	
	END

	BEGIN TRY
	IF (@Monto IS NOT NULL)
	BEGIN
		INSERT INTO Boveda_Historial
			(BovedaID, 
			 Fecha,  
			 FechaAbierto, 
			 LoginAbierto,
			 EfectivoInicial)

		VALUES(@BovedaID,
			   DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE())),
			   GETDATE(),
			   @Login,
			   @Monto)
	END
	ELSE
		INSERT INTO Boveda_Historial
			(BovedaID, 
			 Fecha,  
			 FechaAbierto, 
			 LoginAbierto,
			 EfectivoInicial)

		VALUES(@BovedaID,
			   DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE())),
			   GETDATE(),
			   @Login,
			   0)
	
	END TRY
	BEGIN CATCH
	  ROLLBACK TRANSACTION cuenta  
	  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			 @NUMERRORS = @NUMERRORS + 1
	  SELECT @NUMERRORS     AS 'ErrorCount',
			 @ERRORMESSAGE  AS 'ErrorMessage' 
	  RETURN

	END  CATCH

	IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta


      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
END


GO
/****** Object:  StoredProcedure [dbo].[proBoveda_CerrarDia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[proBoveda_CerrarDia] 
	@Login VARCHAR(30),
	@Observacion VARCHAR(MAX),
	@BovedaID INT,
	@Deuda decimal(18,3) = null,
	@PorPagar decimal(18,3) = null
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cuenta 

	SET DATEFORMAT DMY

	SET LANGUAGE SPANISH

	DECLARE @NUMERRORS     INT, 
			@ERRORMESSAGE VARCHAR(5000),
			@Fecha DATETIME, 
			@Fondo DECIMAL(18,3)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''

	--Día a cerrar
	SELECT @Fecha = Fecha
	FROM   Boveda_Historial
	WHERE  Fecha IS NOT NULL 
	AND    FechaCerrado IS NULL   
	AND    BovedaID = @BovedaID

	--FONDO
	SELECT @Fondo = Saldo
	FROM   Cuenta
	WHERE  CuentaID = 35

	--TRANSITO
	BEGIN TRY	

		--INSERT INTO Boveda_Historial_Transito
		--	(BovedaID, 
		--	 Fecha, 
		--	 Descripcion, 
		--	 Monto)

		--SELECT @BovedaID,
		--	   @Fecha,
		--	   CASE Tipo
		--		   WHEN 1 THEN 'SALIDA DEL ' + DATENAME(dw, Ruta.Fecha) + ' ' + CONVERT(VARCHAR,Ruta.Fecha,103) 
		--		   ELSE 'ENTRADA DEL ' + DATENAME(dw, Ruta.Fecha) + ' ' + CONVERT(VARCHAR,Ruta.Fecha,103) 
		--	   END AS Detalle,
		--	   SUM(vw_cartaporte.Monto)
		--FROM   vw_cartaporte
		--JOIN   Ruta_CartaPorte
		--ON     Ruta_CartaPorte.CartaPorteID = vw_cartaporte.CartaPorteID
		--JOIN   Ruta
		--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
		--WHERE  CuentaID = 35
		--AND    Cerrado = 0
		--AND    BovedaID <> @BovedaID
		--AND    EXISTS(SELECT *
		--			  FROM   Biblia
		--			  WHERE  PuntoID = vw_cartaporte.ConsignadorID 
		--			  OR     PuntoID = vw_cartaporte.ConsignatarioID)
		--GROUP  BY Ruta.Fecha,
		--	   Ruta_CartaPorte.Tipo

		--EFECTIVO
		INSERT INTO Boveda_Historial_Efectivo
			(BovedaID, 
			 Fecha, 
			 EfectivoID, 
			 Piezas, 
			 Monto)
		SELECT @BovedaID, 
			   @Fecha, 
			   EfectivoID, 
			   Piezas, 
			   Monto
		FROM   Boveda_Efectivo
		WHERE  Boveda_Efectivo.BovedaID = @BovedaID

		--CUENTAS POR COBRAR
		--INSERT INTO Boveda_Historial_Cuenta
		--	(BovedaID, 
		--	 Fecha, 
		--	 Descripcion, 
		--	 Tipo, 
		--	 Monto)
		--SELECT @BovedaID,
		--	   @Fecha,
		--	   'CUENTA POR COBRAR LA ROSA',
		--	   1,
		--	   SUM(Monto) --ROSA
		--FROM   vw_Differencias
		--WHERE  PuntoID =  186

		--INSERT INTO Boveda_Historial_Cuenta
		--	(BovedaID, 
		--	 Fecha, 
		--	 Descripcion, 
		--	 Tipo, 
		--	 Monto)
		--SELECT @BovedaID,
		--	   @Fecha,
		--	   'CUENTA POR COBRAR ESTACIONES',
		--	   1,
		--	   SUM(Monto) --ESTACIONES
		--FROM   vw_Differencias
		--WHERE  PuntoID <> 186
	END TRY
	BEGIN CATCH
	  ROLLBACK TRANSACTION cuenta  
	  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			 @NUMERRORS = @NUMERRORS + 1
	  SELECT @NUMERRORS     AS 'ErrorCount',
			 @ERRORMESSAGE  AS 'ErrorMessage' 
	  RETURN

	END  CATCH
	--CUENTAS POR PAGAR


/***********************    CERRAR DIA    ***********************/

	BEGIN TRY 
	  UPDATE Boveda_Historial
	  SET    FechaCerrado = GetDate(), 
			 LoginCerrado = @Login,
			 Observacion = 	@Observacion,
			 Deuda = @Deuda,
			 PorPagar = @PorPagar
	  FROM   Boveda_Historial
	  WHERE  Boveda_Historial.BovedaID = @BovedaID
	  AND    Boveda_Historial.Fecha = @Fecha
	  AND    Boveda_Historial.FechaCerrado IS NULL
	END TRY 
	BEGIN CATCH 
	  ROLLBACK TRANSACTION cuenta 
	  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			 @NUMERRORS = @NUMERRORS + 1
	  SELECT @NUMERRORS     AS 'ErrorCount',
			 @ERRORMESSAGE  AS 'ErrorMessage' 
	  RETURN
	END CATCH 

	IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta


      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @Fecha         AS 'ExtraValue'
END
GO
/****** Object:  StoredProcedure [dbo].[proCaja_AbrirDia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[proCaja_AbrirDia] 
	@Login VARCHAR(30),
	@Observacion VARCHAR(MAX),
	@CajaID INT
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cuenta 

	SET DATEFORMAT DMY

	SET LANGUAGE SPANISH

	DECLARE @NUMERRORS     INT, 
			@ERRORMESSAGE VARCHAR(5000)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''


/***********************    VALIDACIONES    ***********************/
	-- 1 Que no este abierto
	IF EXISTS(SELECT * 
			  FROM   Caja_Historial
			  WHERE  Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
			  AND    CajaID = @CajaID)
	BEGIN
	   ROLLBACK TRANSACTION cuenta
	   SELECT @ERRORMESSAGE = 'Error: Ya esta abierto el día',
			  @NUMERRORS = @NUMERRORS + 1
	   SELECT @NUMERRORS     AS 'ErrorCount', 
              @ERRORMESSAGE AS 'ErrorMessage'
	   RETURN	
	END

	IF EXISTS(SELECT * 
			  FROM   Caja_Historial
			  WHERE  FechaCerrado IS NULL
			  AND    LoginAbierto = @Login 
			  AND    CajaID <> @CajaID)
	BEGIN
	   ROLLBACK TRANSACTION cuenta
	   SELECT @ERRORMESSAGE = 'Error: No puede Abrir esta caja , ya se encuentra una caja Abierta por usted',
			  @NUMERRORS = @NUMERRORS + 1
	   SELECT @NUMERRORS     AS 'ErrorCount', 
              @ERRORMESSAGE AS 'ErrorMessage'
	   RETURN	
	END

	-- 2 Que no existan dias trabajados sin cerrar
	IF EXISTS(SELECT * 
			  FROM   Caja_Historial
			  WHERE  Fecha IS NOT NULL 
			  AND    FechaCerrado IS NULL   
			  AND    CajaID = @CajaID)
	BEGIN
	   ROLLBACK TRANSACTION cuenta
	   SELECT @ERRORMESSAGE = 'Error: Tiene días pendientes por cerrar.',
			  @NUMERRORS = @NUMERRORS + 1
	   SELECT @NUMERRORS     AS 'ErrorCount', 
              @ERRORMESSAGE AS 'ErrorMessage'
	   RETURN	
	END

	BEGIN TRY
		INSERT INTO Caja_Historial
			(CajaID, 
			 Fecha,  
			 FechaAbierto, 
			 LoginAbierto,
			 EfectivoInicial)

		VALUES(@CajaID,
			   DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE())),
			   GETDATE(),
			   @Login,
				0)
	END TRY
	BEGIN CATCH
	  ROLLBACK TRANSACTION cuenta  
	  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			 @NUMERRORS = @NUMERRORS + 1
	  SELECT @NUMERRORS     AS 'ErrorCount',
			 @ERRORMESSAGE  AS 'ErrorMessage' 
	  RETURN

	END  CATCH

	IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta


      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
END



GO
/****** Object:  StoredProcedure [dbo].[proCaja_CerrarDia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[proCaja_CerrarDia] 
	@Login VARCHAR(30),
	@Observacion VARCHAR(MAX),
	@CajaID INT
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cuenta 

	SET DATEFORMAT DMY

	SET LANGUAGE SPANISH

	DECLARE @NUMERRORS     INT, 
			@ERRORMESSAGE VARCHAR(5000),
			@Fecha DATETIME, 
			@Caja  INT,
			@Fondo DECIMAL(18,3),
			@Pieza INT

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''

	--Día a cerrar
	SELECT @Fecha = Fecha
	FROM   Caja_Historial
	WHERE  Fecha IS NOT NULL 
	AND    FechaCerrado IS NULL   
	AND    CajaID = @CajaID

	--FONDO
	SELECT @Fondo = Saldo
	FROM   Cuenta
	WHERE  CuentaID = 7
	
--	IF (NOT EXISTS(SELECT CajaID FROM Caja_Efectivo
--					WHERE  CajaID = @CajaID))
--	BEGIN
--	ROLLBACK TRANSACTION cuenta 
--	  SELECT @ERRORMESSAGE = 'Error: La Caja No tiene efectivo para Cerrar caja, Comuniquese con el Administrador',
--			 @NUMERRORS = @NUMERRORS + 1
--	  SELECT @NUMERRORS     AS 'ErrorCount',
--			 @ERRORMESSAGE  AS 'ErrorMessage' 
--	  RETURN
--	END


/***********************    CERRAR DIA    ***********************/

   SELECT @Pieza = sum(Piezas) FROM Caja_Efectivo WHERE CajaID = @CajaID
    IF(@Pieza <> 0)
    BEGIN
		ROLLBACK TRANSACTION cuenta
		SELECT @ERRORMESSAGE = 'No puede cerrar el cubiculo, ya que tiene efectivo sin entregar',
			 @NUMERRORS = @NUMERRORS + 1
	  SELECT @NUMERRORS     AS 'ErrorCount',
			 @ERRORMESSAGE  AS 'ErrorMessage' 
	  RETURN
    END
    ELSE

	BEGIN TRY 
	  UPDATE Caja_Historial
	  SET    FechaCerrado = GetDate(), 
			 LoginCerrado = @Login,
			 Observacion = 	@Observacion
	  FROM   Caja_Historial
	  WHERE  Caja_Historial.CajaID = @CajaID
	  AND    Caja_Historial.FechaCerrado IS NULL
	END TRY 
	BEGIN CATCH 
	  ROLLBACK TRANSACTION cuenta 
	  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			 @NUMERRORS = @NUMERRORS + 1
	  SELECT @NUMERRORS     AS 'ErrorCount',
			 @ERRORMESSAGE  AS 'ErrorMessage' 
	  RETURN
	END CATCH 

	IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta


      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @Fecha         AS 'ExtraValue'
END


GO
/****** Object:  StoredProcedure [dbo].[proCajaCartaPorte_Cerrar]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[proCajaCartaPorte_Cerrar]
	@CajaID INT,
	@CartaPorteID VARCHAR(13),
	@Login VARCHAR(30),
	@Codigo VARCHAR(20)	= NULL,
	@Fecha VARCHAR(10)
AS
BEGIN 
	SET NOCOUNT ON
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cartaporte 

	SET DATEFORMAT DMY

	DECLARE @NUMERRORS    INT, 
		    @ERRORMESSAGE VARCHAR(5000),
		    @BovedaID INT,
			@Monto DECIMAL(18,3),
			@ConsignadorID INT,
			@ConsignatarioFecha DATETIME,
			@ID INT

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''
  

/***********************    VALIDAR:[TRASPASO]    ***********************/

	IF NOT EXISTS  (SELECT *
					FROM   CartaPorte
					WHERE  CartaPorteID = @CartaPorteID
					AND    Cerrado = 0)
	BEGIN
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = 'Error: No puede cerrar esta Carta de Portes.',
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS    AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
		RETURN		
	END

	SELECT @BovedaID = BovedaID,
		   @Monto = Monto,
		   @ConsignadorID = ConsignadorID,
		   @ConsignatarioFecha = ConsignatarioFecha
	FROM   vw_CartaPorte
	WHERE  BovedaID = @BovedaID

/***********************    UPDATE:[CARTAPORTE]    ***********************/

	BEGIN TRY 
		UPDATE CartaPorte
		SET    Cerrado = 1, 
			   LoginCerrado = @Login, 
			   FechaCerrado = @Fecha
		WHERE  CartaPorteID = @CartaPorteID
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 

--    BEGIN TRY 
--		SELECT TOP 1 @ID = EnvaseID FROM Envase 
--        WHERE CartaporteID = @CartaPorteID AND EstaAbierto= 'True'
--        DELETE  FROM Envase WHERE EnvaseID = @ID
--		
--	END TRY 
--	BEGIN CATCH 
--		ROLLBACK TRANSACTION cartaporte 
--		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
--			   @NUMERRORS = @NUMERRORS + 1
--		SELECT @NUMERRORS     AS 'ErrorCount',
--			   @ERRORMESSAGE  AS 'ErrorMessage' 
--		RETURN
--	END CATCH 


/***********************    UPDATE:[EFECTIVO]    ***********************/

	BEGIN TRY 
		UPDATE Caja_Efectivo
		SET    Monto = Caja_Efectivo.Monto +  b.Monto,
			   Piezas = Caja_Efectivo.Piezas +  b.Piezas
		FROM   (SELECT Envase_Efectivo.EfectivoID,
					   SUM(Envase_Efectivo.Monto) AS Monto,
					   SUM(Envase_Efectivo.Piezas) AS Piezas

				FROM   Caja_Efectivo
				JOIN   Envase_Efectivo
				ON     Caja_Efectivo.EfectivoID = Envase_Efectivo.EfectivoID
				JOIN   Envase
				ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
				WHERE  CajaID = @CajaID
				AND    CartaPorteID = @CartaPorteID
				GROUP  BY Envase_Efectivo.EfectivoID) b
		WHERE   Caja_Efectivo.CajaID =  @CajaID
		AND     Caja_Efectivo.EfectivoID = b.EfectivoID

		INSERT INTO Caja_Efectivo
			 (CajaID, 
			  EfectivoID, 
			  Piezas, 
			  Monto)
		SELECT @CajaID AS CajaID,
			   Envase_Efectivo.EfectivoID, 
			   SUM(Envase_Efectivo.Piezas), 
			   SUM(Envase_Efectivo.Monto)
		FROM   Envase_Efectivo
		JOIN   Envase
		ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
		WHERE  NOT EXISTS (SELECT *
							FROM   Caja_Efectivo
							WHERE  CajaID = @CajaID								
							AND    Caja_Efectivo.EfectivoID <> Envase_Efectivo.EfectivoID)
        AND    Envase.CartaPorteID = @CartaPorteID
		GROUP  BY Envase_Efectivo.EfectivoID

	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS    =  @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 

/***********************    DIFFERENCIAS    ***********************/
	IF  (ISNULL((SELECT SUM(Envase_Efectivo.Monto)
		FROM   Envase_Efectivo
		JOIN   Envase
		ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
		WHERE  Envase.CartaPorteID = @CartaPorteID),0) <>@Monto)
	BEGIN
		BEGIN TRY 
			DECLARE @Diferencia DECIMAL(18,3),
					@MontoReal DECIMAL(18,3), 
					@Descripcion VARCHAR(MAX)

			SET @MontoReal = ISNULL((SELECT SUM(Envase_Efectivo.Monto)
									 FROM   Envase_Efectivo
									 JOIN   Envase
									 ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
									 WHERE  Envase.CartaPorteID = @CartaPorteID),0)
			SET     @Diferencia = @Monto - @MontoReal
			IF(@Diferencia > 0)
			BEGIN
				SET  @Descripcion = 'Faltante: La carta de portes ' + @CartaPorteID + ' dice contener ' + CAST(@Monto AS VARCHAR) + 'Bsf. y contiene ' + CAST(@MontoReal AS VARCHAR) + 'Bsf.'
			END
			IF(@Diferencia < 0)
			BEGIN
				SET  @Descripcion = 'Sobrante: La carta de portes ' + @CartaPorteID + ' dice contener ' + CAST(@Monto AS VARCHAR) + 'Bsf. y pago ' + CAST(@MontoReal AS VARCHAR) + 'Bsf.'
			END			

			DECLARE @DiferenciaActual DECIMAL(18,3)
			SET @DiferenciaActual = ISNULL((SELECT TOP 1 Monto 
											FROM Diferencia 
											WHERE PuntoID = @ConsignadorID 
											ORDER BY Fecha DESC),0)

			INSERT INTO Diferencia
				(Fecha, 
				PuntoID, 
				Monto, 
				MontoTransaccion, 
				Descripcion)
			VALUES
				(@ConsignatarioFecha, 
				@ConsignadorID, 
				@DiferenciaActual + @Diferencia, 
				@Diferencia, 
				@Descripcion)

		END TRY 
		BEGIN CATCH 
			ROLLBACK TRANSACTION cartaporte 
			SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
				   @NUMERRORS    =  @NUMERRORS + 1
			SELECT @NUMERRORS     AS 'ErrorCount',
				   @ERRORMESSAGE  AS 'ErrorMessage' 
			RETURN
		END CATCH 
	END
/***********************    FINAL    ***********************/

	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION cartaporte 
	ELSE 
		COMMIT TRANSACTION cartaporte 
		SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE  AS 'ErrorMessage'
END



GO
/****** Object:  StoredProcedure [dbo].[proCartaPorte_Cerrar]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[proCartaPorte_Cerrar]
	@CartaPorteID VARCHAR(13),
	@Login VARCHAR(30),
	@Codigo VARCHAR(20)	= NULL,
	@Fecha VARCHAR(10)
AS
BEGIN 
	SET NOCOUNT ON
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cartaporte 

	SET DATEFORMAT DMY

	DECLARE @NUMERRORS    INT, 
		    @ERRORMESSAGE VARCHAR(5000),
		    @BovedaID INT,
		    @CuentaID INT,
			@Monto DECIMAL(18,3),
			@ConsignadorID INT,
			@ConsignatarioFecha DATETIME

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''
  

/***********************    VALIDAR:[TRASPASO]    ***********************/

	IF NOT EXISTS  (SELECT *
					FROM   CartaPorte
					WHERE  CartaPorteID = @CartaPorteID
					AND    Cerrado = 0)
	BEGIN
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = 'Error: No puede cerrar esta Carta de Portes.',
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS    AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
		RETURN		
	END

	SELECT @BovedaID = BovedaID,
		   @CuentaID = CuentaID,
		   @Monto = Monto,
		   @ConsignadorID = ConsignadorID,
		   @ConsignatarioFecha = ConsignatarioFecha
	FROM   vw_CartaPorte
	WHERE  CartaPorteID = @CartaPorteID

/***********************    UPDATE:[CARTAPORTE]    ***********************/

	BEGIN TRY 
		UPDATE CartaPorte
		SET    Cerrado = 1, 
			   LoginCerrado = @Login, 
			   FechaCerrado = @Fecha
		WHERE  CartaPorteID = @CartaPorteID
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 


/***********************    UPDATE:[EFECTIVO]    ***********************/

	BEGIN TRY 
	IF(@CuentaID = 59)
	BEGIN
		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto +  b.Monto,
			   Piezas = Boveda_Efectivo.Piezas +  b.Piezas
		FROM   (SELECT Envase_Efectivo.EfectivoID,
					   SUM(Envase_Efectivo.Monto) AS Monto,
					   SUM(Envase_Efectivo.Piezas) AS Piezas

				FROM   Boveda_Efectivo
				JOIN   Envase_Efectivo
				ON     Boveda_Efectivo.EfectivoID = Envase_Efectivo.EfectivoID
				JOIN   Envase
				ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
				WHERE  BovedaID = @BovedaID
				AND    CartaPorteID = @CartaPorteID
				GROUP  BY Envase_Efectivo.EfectivoID) b
		WHERE   Boveda_Efectivo.BovedaID =  10
		AND     Boveda_Efectivo.EfectivoID = b.EfectivoID
		
		INSERT INTO Boveda_Efectivo
			 (BovedaID, 
			  EfectivoID, 
			  Piezas, 
			  Monto)
		SELECT @BovedaID AS BovedaID,
			   Envase_Efectivo.EfectivoID, 
			   SUM(Envase_Efectivo.Piezas), 
			   SUM(Envase_Efectivo.Monto)
		FROM   Envase_Efectivo
		JOIN   Envase
		ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
		WHERE  NOT EXISTS (SELECT *
							FROM   Boveda_Efectivo
							WHERE  BovedaID = @BovedaID								
							AND    Boveda_Efectivo.EfectivoID <> Envase_Efectivo.EfectivoID)
        AND    Envase.CartaPorteID = @CartaPorteID
		GROUP  BY Envase_Efectivo.EfectivoID
	END
	IF(@CuentaID = 60)
	BEGIN
		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto +  b.Monto,
			   Piezas = Boveda_Efectivo.Piezas +  b.Piezas
		FROM   (SELECT Envase_Efectivo.EfectivoID,
					   SUM(Envase_Efectivo.Monto) AS Monto,
					   SUM(Envase_Efectivo.Piezas) AS Piezas

				FROM   Boveda_Efectivo
				JOIN   Envase_Efectivo
				ON     Boveda_Efectivo.EfectivoID = Envase_Efectivo.EfectivoID
				JOIN   Envase
				ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
				WHERE  BovedaID = @BovedaID
				AND    CartaPorteID = @CartaPorteID
				GROUP  BY Envase_Efectivo.EfectivoID) b
		WHERE   Boveda_Efectivo.BovedaID =  11
		AND     Boveda_Efectivo.EfectivoID = b.EfectivoID
		
		INSERT INTO Boveda_Efectivo
			 (BovedaID, 
			  EfectivoID, 
			  Piezas, 
			  Monto)
		SELECT @BovedaID AS BovedaID,
			   Envase_Efectivo.EfectivoID, 
			   SUM(Envase_Efectivo.Piezas), 
			   SUM(Envase_Efectivo.Monto)
		FROM   Envase_Efectivo
		JOIN   Envase
		ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
		WHERE  NOT EXISTS (SELECT *
							FROM   Boveda_Efectivo
							WHERE  BovedaID = @BovedaID								
							AND    Boveda_Efectivo.EfectivoID <> Envase_Efectivo.EfectivoID)
        AND    Envase.CartaPorteID = @CartaPorteID
		GROUP  BY Envase_Efectivo.EfectivoID
	END

	IF(@CuentaID <> 60 and @CuentaID <> 59)
	BEGIN
		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto +  b.Monto,
			   Piezas = Boveda_Efectivo.Piezas +  b.Piezas
		FROM   (SELECT Envase_Efectivo.EfectivoID,
					   SUM(Envase_Efectivo.Monto) AS Monto,
					   SUM(Envase_Efectivo.Piezas) AS Piezas

				FROM   Boveda_Efectivo
				JOIN   Envase_Efectivo
				ON     Boveda_Efectivo.EfectivoID = Envase_Efectivo.EfectivoID
				JOIN   Envase
				ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
				WHERE  BovedaID = @BovedaID
				AND    CartaPorteID = @CartaPorteID
				GROUP  BY Envase_Efectivo.EfectivoID) b
		WHERE   Boveda_Efectivo.BovedaID =  @BovedaID
		AND     Boveda_Efectivo.EfectivoID = b.EfectivoID

		INSERT INTO Boveda_Efectivo
			 (BovedaID, 
			  EfectivoID, 
			  Piezas, 
			  Monto)
		SELECT @BovedaID AS BovedaID,
			   Envase_Efectivo.EfectivoID, 
			   SUM(Envase_Efectivo.Piezas), 
			   SUM(Envase_Efectivo.Monto)
		FROM   Envase_Efectivo
		JOIN   Envase
		ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
		WHERE  NOT EXISTS (SELECT *
							FROM   Boveda_Efectivo
							WHERE  BovedaID = @BovedaID								
							AND    Boveda_Efectivo.EfectivoID <> Envase_Efectivo.EfectivoID)
        AND    Envase.CartaPorteID = @CartaPorteID
		GROUP  BY Envase_Efectivo.EfectivoID
	END
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS    =  @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 

/***********************    DIFFERENCIAS    ***********************/
	IF  (ISNULL((SELECT SUM(Envase_Efectivo.Monto)
		FROM   Envase_Efectivo
		JOIN   Envase
		ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
		WHERE  Envase.CartaPorteID = @CartaPorteID),0) <>@Monto)
	BEGIN
		BEGIN TRY 
			DECLARE @Diferencia DECIMAL(18,3),
					@MontoReal DECIMAL(18,3), 
					@Descripcion VARCHAR(MAX)

			SET @MontoReal = ISNULL((SELECT SUM(Envase_Efectivo.Monto)
									 FROM   Envase_Efectivo
									 JOIN   Envase
									 ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
									 WHERE  Envase.CartaPorteID = @CartaPorteID),0)
			SET     @Diferencia = @Monto - @MontoReal
			IF(@Diferencia > 0)
			BEGIN
				SET  @Descripcion = 'Faltante: La carta de portes ' + @CartaPorteID + ' dice contener ' + CAST(@Monto AS VARCHAR) + 'Bsf. y contiene ' + CAST(@MontoReal AS VARCHAR) + 'Bsf.'
			END
			IF(@Diferencia < 0)
			BEGIN
				SET  @Descripcion = 'Sobrante: La carta de portes ' + @CartaPorteID + ' dice contener ' + CAST(@Monto AS VARCHAR) + 'Bsf. y pago ' + CAST(@MontoReal AS VARCHAR) + 'Bsf.'
			END			

			DECLARE @DiferenciaActual DECIMAL(18,3)
			SET @DiferenciaActual = ISNULL((SELECT TOP 1 Monto 
											FROM Diferencia 
											WHERE PuntoID = @ConsignadorID 
											ORDER BY Fecha DESC),0)

			INSERT INTO Diferencia
				(Fecha, 
				PuntoID, 
				Monto, 
				MontoTransaccion, 
				Descripcion)
			VALUES
				(@ConsignatarioFecha, 
				@ConsignadorID, 
				@DiferenciaActual + @Diferencia, 
				@Diferencia, 
				@Descripcion)

		END TRY 
		BEGIN CATCH 
			ROLLBACK TRANSACTION cartaporte 
			SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
				   @NUMERRORS    =  @NUMERRORS + 1
			SELECT @NUMERRORS     AS 'ErrorCount',
				   @ERRORMESSAGE  AS 'ErrorMessage' 
			RETURN
		END CATCH 
	END
/***********************    FINAL    ***********************/

	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION cartaporte 
	ELSE 
		COMMIT TRANSACTION cartaporte 
		SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE  AS 'ErrorMessage'
END

GO
/****** Object:  StoredProcedure [dbo].[proCartaPorte_CerrarOLD]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 20-10-2010 
-- Description:  Cerrar CartaPorte
-- ============================================= 
CREATE PROCEDURE [dbo].[proCartaPorte_CerrarOLD]
	@CartaPorteID VARCHAR(13),
	@Login VARCHAR(30),
	@Codigo VARCHAR(20)	= NULL
AS
BEGIN 
	SET NOCOUNT ON
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cartaporte 

	SET DATEFORMAT DMY

	DECLARE @NUMERRORS    INT, 
		    @ERRORMESSAGE VARCHAR(5000),
		    @BovedaID INT

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''
  

/***********************    VALIDAR:[TRASPASO]    ***********************/

	IF NOT EXISTS  (SELECT *
					FROM   CartaPorte
					WHERE  CartaPorteID = @CartaPorteID
					AND    Cerrado = 0)
	BEGIN
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = 'Error: No puede cerrar esta Carta de Portes.',
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS    AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
		RETURN		
	END

	SELECT @BovedaID = BovedaID
	FROM   CartaPorte
	WHERE  CartaPorteID = @CartaPorteID

/***********************    UPDATE:[CARTAPORTE]    ***********************/

	BEGIN TRY 
		UPDATE CartaPorte
		SET    Cerrado = 1, 
			   LoginCerrado = @Login, 
			   FechaCerrado = GETDATE() 
		WHERE  CartaPorteID = @CartaPorteID
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 


/***********************    UPDATE:[EFECTIVO]    ***********************/

	BEGIN TRY 
		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto +  b.Monto,
			   Piezas = Boveda_Efectivo.Piezas +  b.Piezas
		FROM   (SELECT Envase_Efectivo.EfectivoID,
					   SUM(Envase_Efectivo.Monto) AS Monto,
					   SUM(Envase_Efectivo.Piezas) AS Piezas

				FROM   Boveda_Efectivo
				JOIN   Envase_Efectivo
				ON     Boveda_Efectivo.EfectivoID = Envase_Efectivo.EfectivoID
				JOIN   Envase
				ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
				WHERE  BovedaID = @BovedaID
				AND    CartaPorteID = @CartaPorteID
				GROUP  BY Envase_Efectivo.EfectivoID) b
		WHERE   Boveda_Efectivo.BovedaID =  @BovedaID
		AND     Boveda_Efectivo.EfectivoID = b.EfectivoID

		INSERT INTO Boveda_Efectivo
			 (BovedaID, 
			  EfectivoID, 
			  Piezas, 
			  Monto)
		SELECT @BovedaID AS BovedaID,
			   Envase_Efectivo.EfectivoID, 
			   SUM(Envase_Efectivo.Piezas), 
			   SUM(Envase_Efectivo.Monto)
		FROM   Envase_Efectivo
		JOIN   Envase
		ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
		WHERE  NOT EXISTS (SELECT *
							FROM   Boveda_Efectivo
							WHERE  BovedaID = @BovedaID								
							AND    Boveda_Efectivo.EfectivoID <> Envase_Efectivo.EfectivoID)
        AND    Envase.CartaPorteID = @CartaPorteID
		GROUP  BY Envase_Efectivo.EfectivoID

	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS    =  @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 

/***********************    FINAL    ***********************/

	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION cartaporte 
	ELSE 
		COMMIT TRANSACTION cartaporte 
		SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE  AS 'ErrorMessage'
END

GO
/****** Object:  StoredProcedure [dbo].[proCartaPorte_Estacion_Cerrar]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[proCartaPorte_Estacion_Cerrar]
	@CartaPorteID VARCHAR(13),
	@Login VARCHAR(30),
	@Codigo VARCHAR(20)	= NULL,
	@Fecha VARCHAR(10)
AS
BEGIN 
	SET NOCOUNT ON
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cartaporte 

	SET DATEFORMAT DMY

	DECLARE @NUMERRORS    INT, 
		    @ERRORMESSAGE VARCHAR(5000),
		    @BovedaID INT,
			@Monto DECIMAL(18,3),
			@ConsignadorID INT,
			@ConsignatarioFecha DATETIME

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''
  

/***********************    VALIDAR:[TRASPASO]    ***********************/

	IF NOT EXISTS  (SELECT *
					FROM   CartaPorte
					WHERE  CartaPorteID = @CartaPorteID
					AND    Cerrado = 0)
	BEGIN
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = 'Error: No puede cerrar esta Carta de Portes.',
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS    AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
		RETURN		
	END

	SELECT @BovedaID = BovedaID,
		   @Monto = Monto,
		   @ConsignadorID = ConsignadorID,
		   @ConsignatarioFecha = ConsignatarioFecha
	FROM   vw_CartaPorte
	WHERE  CartaPorteID = @CartaPorteID

/***********************    UPDATE:[CARTAPORTE]    ***********************/

	BEGIN TRY 
		UPDATE CartaPorte
		SET    Cerrado = 1, 
			   LoginCerrado = @Login,
				FechaCerrado = @Fecha
		WHERE  CartaPorteID = @CartaPorteID
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION cartaporte 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 



/***********************    FINAL    ***********************/

	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION cartaporte 
	ELSE 
		COMMIT TRANSACTION cartaporte 
		SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE  AS 'ErrorMessage'
END





GO
/****** Object:  StoredProcedure [dbo].[proTraspaso_Recibir]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[proTraspaso_Recibir]
	@TraspasoID INT,
	@LoginReceptor VARCHAR(30)	
AS
BEGIN 
	SET NOCOUNT ON
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION traspaso 

	SET DATEFORMAT DMY

	DECLARE @NUMERRORS    INT, 
		    @ERRORMESSAGE VARCHAR(5000),
		    @BovedaEmisorID INT,
		    @BovedaReceptorID INT

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''
  

/***********************    VALIDAR:[TRASPASO]    ***********************/

	IF NOT EXISTS  (SELECT *
					FROM   Traspaso
					WHERE  TraspasoID = @TraspasoID
					AND    Recibido = 0)
	BEGIN
		ROLLBACK TRANSACTION traspaso 
		SELECT @ERRORMESSAGE = 'Error: No puede recibir este traspaso.',
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS    AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
		RETURN		
	END

	SELECT @BovedaEmisorID = BovedaEmisorID,
		   @BovedaReceptorID = BovedaReceptorID
	FROM   Traspaso
	WHERE  TraspasoID = @TraspasoID

/***********************    UPDATE:[TRASPASO]    ***********************/

	BEGIN TRY 
		UPDATE Traspaso 
		SET    Recibido = 1, 
			   LoginReceptor = @LoginReceptor, 
			   FechaReceptor = GETDATE() 
		WHERE  TraspasoID = @TraspasoID
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION traspaso 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 


/***********************    UPDATE:[CARTAS DE PORTES]    ***********************/

	BEGIN TRY 
		UPDATE CartaPorte 
		SET    BovedaID = @BovedaReceptorID
		WHERE  CartaPorteID IN (SELECT CartaPorteID 
							    FROM   Traspaso_CartaPorte  
							    WHERE  TraspasoID = @TraspasoID)
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION traspaso 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 


/***********************    UPDATE:[BOLSA]    ***********************/

	BEGIN TRY 
		UPDATE Bloque 
		SET    BovedaID = @BovedaReceptorID
		WHERE  BloqueID IN (SELECT BloqueID 
							    FROM   Traspaso_Bloque  
							    WHERE  TraspasoID = @TraspasoID)
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION traspaso 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 

/***********************    UPDATE:[EFECTIVO]    ***********************/

	BEGIN TRY 
		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto +  Traspaso_Efectivo.Monto,
			   Piezas = Boveda_Efectivo.Piezas +  Traspaso_Efectivo.Piezas
		FROM   Boveda_Efectivo
		JOIN   Traspaso_Efectivo
		ON     Boveda_Efectivo.EfectivoID = Traspaso_Efectivo.EfectivoID
		WHERE  BovedaID = @BovedaReceptorID
		AND    TraspasoID = @TraspasoID

		INSERT INTO Boveda_Efectivo
			 (BovedaID, 
			  EfectivoID, 
			  Piezas, 
			  Monto)
		SELECT  @BovedaReceptorID AS BovedaID, 
				Traspaso_Efectivo.EfectivoID, 
				Piezas, 
				Monto
		FROM    Traspaso_Efectivo
		WHERE   NOT EXISTS (SELECT *
							FROM   Boveda_Efectivo
							WHERE  BovedaID = @BovedaReceptorID								
							AND    Boveda_Efectivo.EfectivoID <> Traspaso_Efectivo.EfectivoID)
	    AND     TraspasoID = @TraspasoID


		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto -  Traspaso_Efectivo.Monto,
			   Piezas = Boveda_Efectivo.Piezas -  Traspaso_Efectivo.Piezas
		FROM   Boveda_Efectivo
		JOIN   Traspaso_Efectivo
		ON     Boveda_Efectivo.EfectivoID = Traspaso_Efectivo.EfectivoID
		WHERE  BovedaID = @BovedaEmisorID
		AND    TraspasoID = @TraspasoID



	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION traspaso 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS    =  @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 

/***********************    FINAL    ***********************/

	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION traspaso 
	ELSE 
		COMMIT TRANSACTION traspaso 
		SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE  AS 'ErrorMessage'
END



GO
/****** Object:  StoredProcedure [dbo].[proTraspasoCaja_Recibir]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 20-10-2010 
-- Description:  Aprobar traspaso
-- ============================================= 
CREATE PROCEDURE [dbo].[proTraspasoCaja_Recibir]
	@TraspasoID INT,
	@LoginReceptor VARCHAR(30)	
AS
BEGIN 
	SET NOCOUNT ON
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION traspaso 

	SET DATEFORMAT DMY

	DECLARE @NUMERRORS    INT, 
		    @ERRORMESSAGE VARCHAR(5000),
		    @CajaEmisorID INT,
		    @BovedaReceptorID INT,
			@Efectivo     VARCHAR(5)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''
  

/***********************    VALIDAR:[TRASPASO]    ***********************/

	IF NOT EXISTS  (SELECT *
					FROM   Traspaso_Caja
					WHERE  TraspasoID = @TraspasoID
					AND    Recibido = 0)
	BEGIN
		ROLLBACK TRANSACTION traspaso 
		SELECT @ERRORMESSAGE = 'Error: No puede recibir este traspaso.',
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS    AS 'ErrorCount', 
			   @ERRORMESSAGE AS 'ErrorMessage'
		RETURN		
	END

	SELECT @CajaEmisorID = CajaEmisorID,
		   @BovedaReceptorID = BovedaReceptorID
	FROM   Traspaso_Caja
	WHERE  TraspasoID = @TraspasoID

/***********************    UPDATE:[TRASPASO]    ***********************/

	BEGIN TRY 
		UPDATE Traspaso_Caja 
		SET    Recibido = 1, 
			   LoginReceptor = @LoginReceptor, 
			   FechaReceptor = GETDATE() 
		WHERE  TraspasoID = @TraspasoID
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION traspaso 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 

	

/***********************    UPDATE:[EFECTIVO]    ***********************/

	BEGIN TRY 

/*descuento de caja*/
		UPDATE Caja_Efectivo
		SET    Monto = Caja_Efectivo.Monto -  Traspaso_Efectivo_Caja.Monto,
			   Piezas = Caja_Efectivo.Piezas -  Traspaso_Efectivo_Caja.Piezas
		FROM   Caja_Efectivo
		JOIN   Traspaso_Efectivo_Caja
		ON     Caja_Efectivo.EfectivoID = Traspaso_Efectivo_Caja.EfectivoID
		WHERE  CajaID = @CajaEmisorID
		AND    TraspasoID = @TraspasoID

/*aumento en boveda*/
		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto +  Traspaso_Efectivo_Caja.Monto,
			   Piezas = Boveda_Efectivo.Piezas +  Traspaso_Efectivo_Caja.Piezas
		FROM   Boveda_Efectivo
		JOIN   Traspaso_Efectivo_Caja
		ON     Boveda_Efectivo.EfectivoID = Traspaso_Efectivo_Caja.EfectivoID 
        WHERE  BovedaID = @BovedaReceptorID
		AND    Traspaso_Efectivo_Caja.TraspasoID = @TraspasoID


		
		INSERT INTO Boveda_Efectivo
			 (BovedaID, 
			  EfectivoID, 
			  Piezas, 
			  Monto)
		SELECT  @BovedaReceptorID AS BovedaID, 
				Traspaso_Efectivo_Caja.EfectivoID, 
				Piezas, 
				Monto
		FROM    Traspaso_Efectivo_Caja
		WHERE   NOT EXISTS (select * 

		FROM   Boveda_Efectivo
		JOIN   Traspaso_Efectivo_Caja
		ON     Boveda_Efectivo.EfectivoID = Traspaso_Efectivo_Caja.EfectivoID 
        WHERE  BovedaID = @BovedaReceptorID
		AND    Traspaso_Efectivo_Caja.TraspasoID = @TraspasoID)
	    AND     TraspasoID = @TraspasoID


	


	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION traspaso 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS    =  @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 

/***********************    FINAL    ***********************/

	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION traspaso 
	ELSE 
		COMMIT TRANSACTION traspaso 
		SELECT @NUMERRORS     AS 'ErrorCount', 
			   @ERRORMESSAGE  AS 'ErrorMessage'
END

GO
/****** Object:  StoredProcedure [dbo].[Punto_ACTUALIZAR]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Punto_ACTUALIZAR]  
	@Nombre  VARCHAR(200),
	@CuentaID  INT,
@Numero  INT,
@Cajero VARCHAR(50),
@RubroID  INT,
	@ruta VARCHAR(50),
	@tipo VARCHAR(10),
	@PuntoID INT
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION punto 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @ID INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 




/***********************    UPDATE:[PUNTO]    ***********************/

	  BEGIN TRY 
			UPDATE punto 
		    SET    punto.Nombre = @Nombre,
					punto.Numero = @Numero,
					 punto.Cajero = @Cajero,        
				   punto.CuentaID = @CuentaID,
					punto.RubroID = @RubroID
				  
		    WHERE  punto.PuntoID = @PuntoID
		  
			UPDATE  Biblia 
			SET    Biblia.Ruta = @Ruta,
				   Biblia.Tipo = @Tipo
			WHERE  Biblia.PuntoID =@PuntoID

          
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION punto 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION punto 
      ELSE 
        COMMIT TRANSACTION punto 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @ID			AS 'Identity'
  END





GO
/****** Object:  StoredProcedure [dbo].[Punto_GetBy_Cuenta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Punto_GetBy_Cuenta]
	@CuentaID INT
AS
BEGIN
	SET DATEFORMAT DMY
		SELECT PuntoID, 
		   Nombre,
			Numero, 
			Cajero,
		   Direccion, 
		   Telefono1, 
		   Telefono2, 
		   Telefono3, 
		   Contacto, 
		   CuentaID
	FROM   Punto
	WHERE  CuentaID = @CuentaID
END


GO
/****** Object:  StoredProcedure [dbo].[Punto_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Punto_INSERT]  
	@Nombre  VARCHAR(200),
	@CuentaID  INT,
	@Numero  INT,
	@cajero VARCHAR(50),
	@RubroID INT,
	@ruta VARCHAR(50),
	@tipo VARCHAR(50)
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION punto 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @ID INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 




/***********************    INSERT:[PLACA]    ***********************/

	  BEGIN TRY 
          INSERT INTO punto 
					  (Nombre,
						Numero,
						Cajero,
					   Direccion,
					   CuentaID,
						RubroID) 
          VALUES      (@Nombre,
						@Numero,
						@cajero,
					   @Nombre,
					   @CuentaID,
						@RubroID) 
		 SET @ID = SCOPE_IDENTITY()

		INSERT  INTO Biblia
					(PuntoID,
					 LUN_0_10,
					 LUN_0_50,
					 LUN_1,
					 MAR_0_10,
					 MAR_0_50,
					 MAR_1,
					 MIE_0_10,
					 MIE_0_50,
					 MIE_1,
					 JUE_0_10,
					 JUE_0_50, 
					 JUE_1,
					 VIE_0_10,
					 VIE_0_50,
					 VIE_1,
					 SAB_0_10,
					 SAB_0_50,
					 SAB_1,
					 DOM_0_10,
					 DOM_0_50,
					 DOM_1,
					 Ruta,
					 Tipo,
					 Secuencia)
		VALUES      (@ID,
					 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
					@ruta,
					@tipo,
					1)
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION punto 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION punto 
      ELSE 
        COMMIT TRANSACTION punto 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @ID			AS 'Identity'
  END




GO
/****** Object:  StoredProcedure [dbo].[Punto_UPDATE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Punto_UPDATE] 
	@PuntoID INT,
	@PuntoConsignatarioID INT,
	@Cartaporte VARCHAR(30)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION punto 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[PUNTO]    ***********************/

	  BEGIN TRY 
          UPDATE cartaporte_punto 
			
		  SET    PuntoID = @PuntoID
		 		
		  WHERE  CartaporteID = @Cartaporte
		  --AND    PuntoID <> 187
		  AND    cartaporte_punto.Tipo = 1
		  
		  UPDATE cartaporte_punto 
			
		  SET    PuntoID = @PuntoConsignatarioID
		 		
		  WHERE  CartaporteID = @Cartaporte
		  --    PuntoID <> 187
		  AND    cartaporte_punto.Tipo = 2
		  
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION punto 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION punto 
      ELSE 
        COMMIT TRANSACTION punto 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  




GO
/****** Object:  StoredProcedure [dbo].[Razon_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Razon_INSERT] 
	@Descripcion VARCHAR(50)
	
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Razon 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @RazonID INT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 


	  BEGIN TRY 
          INSERT INTO Razon
					  (Descripcion)
          VALUES      (@Descripcion) 
		SET @RazonID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Razon
      ELSE 
        COMMIT TRANSACTION Razon

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @RazonID   AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[reBoveda_AbrirDia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[reBoveda_AbrirDia] 
	@Login VARCHAR(30),
	@BovedaID INT
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cuenta 

	SET DATEFORMAT DMY

	SET LANGUAGE SPANISH

	DECLARE @NUMERRORS     INT, 
			@ERRORMESSAGE VARCHAR(5000),
			@Monto        DECIMAL(18,3)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''

	

/***********************    VALIDACIONES    ***********************/
	
	
	BEGIN TRY
		UPDATE Boveda_Historial 
		SET    FechaCerrado = NULL, LoginCerrado = NULL		  
		WHERE  Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
				  AND    BovedaID = @BovedaID
	END TRY
	BEGIN CATCH	  
	   ROLLBACK TRANSACTION cuenta
	   SELECT @ERRORMESSAGE = 'Error: No se pudo abrir el dia',
			  @NUMERRORS = @NUMERRORS + 1
	   SELECT @NUMERRORS     AS 'ErrorCount', 
              @ERRORMESSAGE AS 'ErrorMessage'
	   RETURN	
	END  CATCH

	

	BEGIN TRY
		DELETE FROM Boveda_Historial_Cuenta 
		WHERE Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
			  AND    BovedaID = @BovedaID
			  
		DELETE FROM Boveda_Historial_Efectivo 
		WHERE Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
			  AND    BovedaID = @BovedaID
	
		DELETE FROM Boveda_Historial_Transito 
		WHERE Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
			  AND    BovedaID = @BovedaID
	
	END TRY
	BEGIN CATCH
	  ROLLBACK TRANSACTION cuenta  
	  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			 @NUMERRORS = @NUMERRORS + 1
	  SELECT @NUMERRORS     AS 'ErrorCount',
			 @ERRORMESSAGE  AS 'ErrorMessage' 
	  RETURN

	END  CATCH

	IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta


      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
END

GO
/****** Object:  StoredProcedure [dbo].[reCaja_AbrirDia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[reCaja_AbrirDia] 
	@Login VARCHAR(30),
	@CajaID INT
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION cuenta 

	SET DATEFORMAT DMY

	SET LANGUAGE SPANISH

	DECLARE @NUMERRORS     INT, 
			@ERRORMESSAGE VARCHAR(5000),
			@Monto        DECIMAL(18,3)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = ''

	

/***********************    VALIDACIONES    ***********************/
	
	
	BEGIN TRY
		UPDATE Caja_Historial 
		SET    FechaCerrado = NULL, LoginCerrado = NULL		  
		WHERE  Fecha = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))  
				  AND    CajaID = @CajaID
	END TRY
	BEGIN CATCH	  
	   ROLLBACK TRANSACTION cuenta
	   SELECT @ERRORMESSAGE = 'Error: No se pudo abrir el cubiculo',
			  @NUMERRORS = @NUMERRORS + 1
	   SELECT @NUMERRORS     AS 'ErrorCount', 
              @ERRORMESSAGE AS 'ErrorMessage'
	   RETURN	
	END  CATCH


	IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION cuenta 
      ELSE 
        COMMIT TRANSACTION cuenta


      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
END


GO
/****** Object:  StoredProcedure [dbo].[Recibir_Efectivo_Bolsa]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[Recibir_Efectivo_Bolsa] 
	@EfectivoID VARCHAR(5),
	@BovedaID    INT,
	@Monto       DECIMAL(18,3),
	@Piezas      INT
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION bolsa 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)
			 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[EFECTIVO]    ***********************/

	BEGIN TRY

		UPDATE Boveda_Efectivo
		SET    Monto = Boveda_Efectivo.Monto +  @Monto,
			   Piezas = Boveda_Efectivo.Piezas +  @Piezas
		FROM   Boveda_Efectivo
		
		WHERE  BovedaID = @BovedaID
		AND    EfectivoID = @EfectivoID

	
		
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION bolsa 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS    =  @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage' 
		RETURN
	END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION bolsa 
      ELSE 
        COMMIT TRANSACTION bolsa 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  








GO
/****** Object:  StoredProcedure [dbo].[Recover_Deleted_Data_Proc]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Script Name: Recover_Deleted_Data_Proc
-- Script Type : Recovery Procedure 
-- Develop By: Muhammad Imran
-- Date Created: 15 Oct 2011
-- Modify Date: 18 June 2012
-- Version    : 3.0
--Notes : Included BLOB data types for recovery.

CREATE PROCEDURE [dbo].[Recover_Deleted_Data_Proc]
@Database_Name NVARCHAR(MAX),
@SchemaName_n_TableName NVARCHAR(Max),
@Date_From DATETIME='1900/01/01',
@Date_To DATETIME ='9999/12/31'
AS

DECLARE @RowLogContents VARBINARY(8000)
DECLARE @TransactionID NVARCHAR(Max)
DECLARE @AllocUnitID BIGINT
DECLARE @AllocUnitName NVARCHAR(Max)
DECLARE @SQL NVARCHAR(Max)
DECLARE @Compatibility_Level INT


SELECT @Compatibility_Level=dtb.compatibility_level
FROM
master.sys.databases AS dtb WHERE dtb.name=@Database_Name

IF ISNULL(@Compatibility_Level,0)<=80
BEGIN
	RAISERROR('The compatibility level should be equal to or greater SQL SERVER 2005 (90)',16,1)
	RETURN
END

IF (SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE [TABLE_SCHEMA]+'.'+[TABLE_NAME]=@SchemaName_n_TableName)=0
BEGIN
	RAISERROR('Could not found the table in the defined database',16,1)
	RETURN
END

DECLARE @bitTable TABLE
(
  [ID] INT,
  [Bitvalue] INT
)
--Create table to set the bit position of one byte.

INSERT INTO @bitTable
SELECT 0,2 UNION ALL
SELECT 1,2 UNION ALL
SELECT 2,4 UNION ALL
SELECT 3,8 UNION ALL
SELECT 4,16 UNION ALL
SELECT 5,32 UNION ALL
SELECT 6,64 UNION ALL
SELECT 7,128

--Create table to collect the row data.
DECLARE @DeletedRecords TABLE
(
    [Row ID]			INT IDENTITY(1,1),
    [RowLogContents]	VARBINARY(8000),
    [AllocUnitID]		BIGINT,
	[Transaction ID]	NVARCHAR(Max),
    [FixedLengthData]	SMALLINT,
	[TotalNoOfCols]		SMALLINT,
	[NullBitMapLength]	SMALLINT,
	[NullBytes]			VARBINARY(8000),
	[TotalNoofVarCols]	SMALLINT,
	[ColumnOffsetArray]	VARBINARY(8000),
	[VarColumnStart]	SMALLINT,
	[Slot ID]			INT,
    [NullBitMap]		VARCHAR(MAX)
    
)
--Create a common table expression to get all the row data plus how many bytes we have for each row.
;WITH RowData AS (
SELECT 

[RowLog Contents 0] AS [RowLogContents] 

,[AllocUnitID] AS [AllocUnitID] 

,[Transaction ID] AS [Transaction ID]  

--[Fixed Length Data] = Substring (RowLog content 0, Status Bit A+ Status Bit B + 1,2 bytes)
,CONVERT(SMALLINT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) AS [FixedLengthData]  --@FixedLengthData

-- [TotalnoOfCols] =  Substring (RowLog content 0, [Fixed Length Data] + 1,2 bytes)
,CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], CONVERT(SMALLINT, CONVERT(BINARY(2)
,REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 1, 2)))) as  [TotalNoOfCols]

--[NullBitMapLength]=ceiling([Total No of Columns] /8.0)
,CONVERT(INT, ceiling(CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], CONVERT(SMALLINT, CONVERT(BINARY(2)
,REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 1, 2))))/8.0)) as [NullBitMapLength] 

--[Null Bytes] = Substring (RowLog content 0, Status Bit A+ Status Bit B + [Fixed Length Data] +1, [NullBitMapLength] )
,SUBSTRING([RowLog Contents 0], CONVERT(SMALLINT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 3,
CONVERT(INT, ceiling(CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], CONVERT(SMALLINT, CONVERT(BINARY(2)
,REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 1, 2))))/8.0))) as [NullBytes]

--[TotalNoofVarCols] = Substring (RowLog content 0, Status Bit A+ Status Bit B + [Fixed Length Data] +1, [Null Bitmap length] + 2 )
,(CASE WHEN SUBSTRING([RowLog Contents 0], 1, 1) In (0x10,0x30,0x70) THEN
CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0],
CONVERT(SMALLINT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 3
+ CONVERT(INT, ceiling(CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], CONVERT(SMALLINT, CONVERT(BINARY(2)
,REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 1, 2))))/8.0)), 2))))  ELSE null  END) AS [TotalNoofVarCols] 

--[ColumnOffsetArray]= Substring (RowLog content 0, Status Bit A+ Status Bit B + [Fixed Length Data] +1, [Null Bitmap length] + 2 , [TotalNoofVarCols]*2 )
,(CASE WHEN SUBSTRING([RowLog Contents 0], 1, 1) In (0x10,0x30,0x70) THEN
SUBSTRING([RowLog Contents 0]
, CONVERT(SMALLINT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 3
+ CONVERT(INT, ceiling(CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], CONVERT(SMALLINT, CONVERT(BINARY(2)
,REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 1, 2))))/8.0)) + 2
, (CASE WHEN SUBSTRING([RowLog Contents 0], 1, 1) In (0x10,0x30,0x70) THEN
CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0],
CONVERT(SMALLINT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 3
+ CONVERT(INT, ceiling(CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], CONVERT(SMALLINT, CONVERT(BINARY(2)
,REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 1, 2))))/8.0)), 2))))  ELSE null  END)
* 2)  ELSE null  END) AS [ColumnOffsetArray] 

--	Variable column Start = Status Bit A+ Status Bit B + [Fixed Length Data] + [Null Bitmap length] + 2+([TotalNoofVarCols]*2)
,CASE WHEN SUBSTRING([RowLog Contents 0], 1, 1)In (0x10,0x30,0x70)
THEN  (
CONVERT(SMALLINT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 4 

+ CONVERT(INT, ceiling(CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], CONVERT(SMALLINT, CONVERT(BINARY(2)
,REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 1, 2))))/8.0)) 

+ ((CASE WHEN SUBSTRING([RowLog Contents 0], 1, 1) In (0x10,0x30,0x70) THEN
CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0],
CONVERT(SMALLINT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 3
+ CONVERT(INT, ceiling(CONVERT(INT, CONVERT(BINARY(2), REVERSE(SUBSTRING([RowLog Contents 0], CONVERT(SMALLINT, CONVERT(BINARY(2)
,REVERSE(SUBSTRING([RowLog Contents 0], 2 + 1, 2)))) + 1, 2))))/8.0)), 2))))  ELSE null  END) * 2)) 

ELSE null End AS [VarColumnStart]
,[Slot ID]
FROM sys.fn_dblog(NULL, NULL)
WHERE
AllocUnitId IN
(SELECT [Allocation_unit_id] FROM sys.allocation_units allocunits
INNER JOIN sys.partitions partitions ON (allocunits.type IN (1, 3)  
AND partitions.hobt_id = allocunits.container_id) OR (allocunits.type = 2 
AND partitions.partition_id = allocunits.container_id)  
WHERE object_id=object_ID('' + @SchemaName_n_TableName + ''))

AND Context IN ('LCX_MARK_AS_GHOST', 'LCX_HEAP') AND Operation in ('LOP_DELETE_ROWS') 
And SUBSTRING([RowLog Contents 0], 1, 1)In (0x10,0x30,0x70)

/*Use this subquery to filter the date*/
AND [TRANSACTION ID] IN (SELECT DISTINCT [TRANSACTION ID] FROM    sys.fn_dblog(NULL, NULL) 
WHERE Context IN ('LCX_NULL') AND Operation in ('LOP_BEGIN_XACT')  
And [Transaction Name]='DELETE'
And  CONVERT(NVARCHAR(11),[Begin Time]) BETWEEN @Date_From AND @Date_To)),

--Use this technique to repeate the row till the no of bytes of the row.
N1 (n) AS (SELECT 1 UNION ALL SELECT 1),
N2 (n) AS (SELECT 1 FROM N1 AS X, N1 AS Y),
N3 (n) AS (SELECT 1 FROM N2 AS X, N2 AS Y),
N4 (n) AS (SELECT ROW_NUMBER() OVER(ORDER BY X.n)
           FROM N3 AS X, N3 AS Y)

INSERT INTO @DeletedRecords
SELECT	RowLogContents
		,[AllocUnitID]
		,[Transaction ID]
		,[FixedLengthData]
		,[TotalNoOfCols]
		,[NullBitMapLength]
		,[NullBytes]
		,[TotalNoofVarCols]
		,[ColumnOffsetArray]
		,[VarColumnStart]
        ,[Slot ID]
         ---Get the Null value against each column (1 means null zero means not null)
		,[NullBitMap]=(REPLACE(STUFF((SELECT ',' +
		(CASE WHEN [ID]=0 THEN CONVERT(NVARCHAR(1),(SUBSTRING(NullBytes, n, 1) % 2))  ELSE CONVERT(NVARCHAR(1),((SUBSTRING(NullBytes, n, 1) / [Bitvalue]) % 2)) END) --as [nullBitMap]
        
FROM
N4 AS Nums
Join RowData AS C ON n<=NullBitMapLength
Cross Join @bitTable WHERE C.[RowLogContents]=D.[RowLogContents] ORDER BY [RowLogContents],n ASC FOR XML PATH('')),1,1,''),',',''))
FROM RowData D

IF (SELECT COUNT(*) FROM @DeletedRecords)=0
BEGIN
	RAISERROR('There is no data in the log as per the search criteria',16,1)
	RETURN
END

DECLARE @ColumnNameAndData TABLE
(
 [Row ID]			int,
 [Rowlogcontents]	varbinary(Max),
 [NAME]				sysname,
 [nullbit]			smallint,
 [leaf_offset]		smallint,
 [length]			smallint,
 [system_type_id]	tinyint,
 [bitpos]			tinyint,
 [xprec]			tinyint,
 [xscale]			tinyint,
 [is_null]			int,
 [Column value Size]int,
 [Column Length]	int,
 [hex_Value]		varbinary(max),
 [Slot ID]			int,
 [Update]			int
)

--Create common table expression and join it with the rowdata table
-- to get each column details
/*This part is for variable data columns*/
--@RowLogContents, 
--(col.columnOffValue - col.columnLength) + 1,
--col.columnLength
--)
INSERT INTO @ColumnNameAndData
SELECT 
[Row ID],
Rowlogcontents,
NAME ,
cols.leaf_null_bit AS nullbit,
leaf_offset,
ISNULL(syscolumns.length, cols.max_length) AS [length],
cols.system_type_id,
cols.leaf_bit_position AS bitpos,
ISNULL(syscolumns.xprec, cols.precision) AS xprec,
ISNULL(syscolumns.xscale, cols.scale) AS xscale,
SUBSTRING([nullBitMap], cols.leaf_null_bit, 1) AS is_null,
(CASE WHEN leaf_offset<1 and SUBSTRING([nullBitMap], cols.leaf_null_bit, 1)=0 
THEN
(Case When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) >30000
THEN
CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) - POWER(2, 15)
ELSE
CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2))))
END)
END)  AS [Column value Size],

(CASE WHEN leaf_offset<1 and SUBSTRING([nullBitMap], cols.leaf_null_bit, 1)=0  THEN
(Case 

When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) >30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])<30000
THEN  (Case When [System_type_id]In (35,34,99) Then 16 else 24  end)

When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) >30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])>30000
THEN  (Case When [System_type_id]In (35,34,99) Then 16 else 24  end) --24 

When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) <30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])<30000
THEN (CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2))))
- ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart]))

When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) <30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])>30000

THEN POWER(2, 15) +CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2))))
- ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])

END)

END) AS [Column Length]

,(CASE WHEN SUBSTRING([nullBitMap], cols.leaf_null_bit, 1)=1 THEN  NULL ELSE
 SUBSTRING
 (
 Rowlogcontents, 
 (

(Case When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) >30000
THEN
CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) - POWER(2, 15)
ELSE
CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2))))
END)

 - 
(Case When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) >30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])<30000

THEN  (Case When [System_type_id]In (35,34,99) Then 16 else 24  end) --24 
When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) >30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])>30000

THEN  (Case When [System_type_id]In (35,34,99) Then 16 else 24  end) --24 
When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) <30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])<30000

THEN CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2))))
- ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])

When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) <30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])>30000

THEN POWER(2, 15) +CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2))))
- ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])

END)

) + 1,
(Case When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) >30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])<30000

THEN  (Case When [System_type_id] In (35,34,99) Then 16 else 24  end) --24 
When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) >30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])>30000

THEN  (Case When [System_type_id] In (35,34,99) Then 16 else 24  end) --24 
When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) <30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])<30000

THEN ABS(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2))))
- ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart]))

When CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2)))) <30000 And 
ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])>30000

THEN POWER(2, 15) +CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * leaf_offset*-1) - 1, 2))))
- ISNULL(NULLIF(CONVERT(INT, CONVERT(BINARY(2), REVERSE (SUBSTRING ([ColumnOffsetArray], (2 * ((leaf_offset*-1) - 1)) - 1, 2)))), 0), [varColumnStart])

END)
)

END) AS hex_Value
,[Slot ID]
,0
FROM @DeletedRecords A
Inner Join sys.allocation_units allocunits On A.[AllocUnitId]=allocunits.[Allocation_Unit_Id]
INNER JOIN sys.partitions partitions ON (allocunits.type IN (1, 3)
AND partitions.hobt_id = allocunits.container_id) OR (allocunits.type = 2 AND partitions.partition_id = allocunits.container_id)
INNER JOIN sys.system_internals_partition_columns cols ON cols.partition_id = partitions.partition_id
LEFT OUTER JOIN syscolumns ON syscolumns.id = partitions.object_id AND syscolumns.colid = cols.partition_column_id
WHERE leaf_offset<0
UNION
/*This part is for fixed data columns*/
SELECT  
[Row ID],
Rowlogcontents,
NAME ,
cols.leaf_null_bit AS nullbit,
leaf_offset,
ISNULL(syscolumns.length, cols.max_length) AS [length],
cols.system_type_id,
cols.leaf_bit_position AS bitpos,
ISNULL(syscolumns.xprec, cols.precision) AS xprec,
ISNULL(syscolumns.xscale, cols.scale) AS xscale,
SUBSTRING([nullBitMap], cols.leaf_null_bit, 1) AS is_null,
(SELECT TOP 1 ISNULL(SUM(CASE WHEN C.leaf_offset >1 THEN max_length ELSE 0 END),0) FROM
sys.system_internals_partition_columns C WHERE cols.partition_id =C.partition_id And C.leaf_null_bit<cols.leaf_null_bit)+5 AS [Column value Size],
syscolumns.length AS [Column Length]

,CASE WHEN SUBSTRING([nullBitMap], cols.leaf_null_bit, 1)=1 THEN NULL ELSE
SUBSTRING
(
Rowlogcontents,(SELECT TOP 1 ISNULL(SUM(CASE WHEN C.leaf_offset >1 And C.leaf_bit_position=0 THEN max_length ELSE 0 END),0) FROM
sys.system_internals_partition_columns C where cols.partition_id =C.partition_id And C.leaf_null_bit<cols.leaf_null_bit)+5
,syscolumns.length) END AS hex_Value
,[Slot ID]
,0
FROM @DeletedRecords A
Inner Join sys.allocation_units allocunits ON A.[AllocUnitId]=allocunits.[Allocation_Unit_Id]
INNER JOIN sys.partitions partitions ON (allocunits.type IN (1, 3)
AND partitions.hobt_id = allocunits.container_id) OR (allocunits.type = 2 AND partitions.partition_id = allocunits.container_id)
INNER JOIN sys.system_internals_partition_columns cols ON cols.partition_id = partitions.partition_id
LEFT OUTER JOIN syscolumns ON syscolumns.id = partitions.object_id AND syscolumns.colid = cols.partition_column_id
WHERE leaf_offset>0
Order By nullbit

Declare @BitColumnByte as int
Select @BitColumnByte=CONVERT(INT, ceiling( Count(*)/8.0)) from @ColumnNameAndData Where [System_Type_id]=104

;With N1 (n) AS (SELECT 1 UNION ALL SELECT 1),
N2 (n) AS (SELECT 1 FROM N1 AS X, N1 AS Y),
N3 (n) AS (SELECT 1 FROM N2 AS X, N2 AS Y),
N4 (n) AS (SELECT ROW_NUMBER() OVER(ORDER BY X.n)
           FROM N3 AS X, N3 AS Y),
CTE As(
Select RowLogContents,[nullbit]
        ,[BitMap]=Convert(varbinary(1),Convert(int,Substring((REPLACE(STUFF((SELECT ',' +
		(CASE WHEN [ID]=0 THEN CONVERT(NVARCHAR(1),(SUBSTRING(hex_Value, n, 1) % 2))  ELSE CONVERT(NVARCHAR(1),((SUBSTRING(hex_Value, n, 1) / [Bitvalue]) % 2)) END) --as [nullBitMap]

from N4 AS Nums
Join @ColumnNameAndData AS C ON n<=@BitColumnByte And [System_Type_id]=104 And bitpos=0
Cross Join @bitTable WHERE C.[RowLogContents]=D.[RowLogContents] ORDER BY [RowLogContents],n ASC FOR XML PATH('')),1,1,''),',','')),bitpos+1,1)))
FROM @ColumnNameAndData D Where  [System_Type_id]=104)

Update A Set [hex_Value]=[BitMap]
from @ColumnNameAndData  A
Inner Join CTE B On A.[RowLogContents]=B.[RowLogContents]
And A.[nullbit]=B.[nullbit]


/**************Check for BLOB DATA TYPES******************************/
DECLARE @Fileid INT
DECLARE @Pageid INT
DECLARE @Slotid INT
DECLARE @CurrentLSN INT
DECLARE @LinkID INT
DECLARE @Context VARCHAR(50)
DECLARE @ConsolidatedPageID VARCHAR(MAX)
DECLARE @LCX_TEXT_MIX VARBINARY(MAX)

declare @temppagedata table 
(
[ParentObject] sysname,
[Object] sysname,
[Field] sysname,
[Value] sysname)

declare @pagedata table 
(
[Page ID] sysname,
[File IDS] int,
[Page IDS] int,
[AllocUnitId] bigint,
[ParentObject] sysname,
[Object] sysname,
[Field] sysname,
[Value] sysname)

DECLARE @ModifiedRawData TABLE
(
  [ID] INT IDENTITY(1,1),
  [PAGE ID] VARCHAR(MAX),
  [FILE IDS] INT,
  [PAGE IDS] INT,
  [Slot ID]  INT,
  [AllocUnitId] BIGINT,
  [RowLog Contents 0_var] VARCHAR(Max),
  [RowLog Length] VARCHAR(50),
  [RowLog Len] INT,
  [RowLog Contents 0] VARBINARY(Max),
  [Link ID] INT default (0),
  [Update] INT
)

            DECLARE Page_Data_Cursor CURSOR FOR 
            /*We need to filter LOP_MODIFY_ROW,LOP_MODIFY_COLUMNS from log for deleted records of BLOB data type& Get its Slot No, Page ID & AllocUnit ID*/
			SELECT LTRIM(RTRIM(Replace([Description],'Deallocated',''))) AS [PAGE ID]
			,[Slot ID],[AllocUnitId],NULL AS [RowLog Contents 0],NULL AS [RowLog Contents 0],Context
			FROM    sys.fn_dblog(NULL, NULL)  
			WHERE    
			AllocUnitId IN 
			(SELECT [Allocation_unit_id] FROM sys.allocation_units allocunits
			INNER JOIN sys.partitions partitions ON (allocunits.type IN (1, 3)  
			AND partitions.hobt_id = allocunits.container_id) OR (allocunits.type = 2 
			AND partitions.partition_id = allocunits.container_id)  
			WHERE object_id=object_ID('' + @SchemaName_n_TableName + ''))
			AND Operation IN ('LOP_MODIFY_ROW') AND [Context] IN ('LCX_PFS') 
			AND Description Like '%Deallocated%' 
			/*Use this subquery to filter the date*/
			AND [TRANSACTION ID] IN (SELECT DISTINCT [TRANSACTION ID] FROM    sys.fn_dblog(NULL, NULL) 
			WHERE Context IN ('LCX_NULL') AND Operation in ('LOP_BEGIN_XACT')  
			AND [Transaction Name]='DELETE'
			AND  CONVERT(NVARCHAR(11),[Begin Time]) BETWEEN @Date_From AND @Date_To)
			GROUP BY [Description],[Slot ID],[AllocUnitId],Context

            UNION

			SELECT [PAGE ID],[Slot ID],[AllocUnitId]
            ,Substring([RowLog Contents 0],15,LEN([RowLog Contents 0])) AS [RowLog Contents 0]
            ,CONVERT(INT,Substring([RowLog Contents 0],7,2)),Context --,CAST(RIGHT([Current LSN],4) AS INT) AS [Current LSN]
			FROM    sys.fn_dblog(NULL, NULL)  
			WHERE   
			 AllocUnitId IN 
			(SELECT [Allocation_unit_id] FROM sys.allocation_units allocunits
			INNER JOIN sys.partitions partitions ON (allocunits.type IN (1, 3)  
			AND partitions.hobt_id = allocunits.container_id) OR (allocunits.type = 2 
			AND partitions.partition_id = allocunits.container_id)  
			WHERE object_id=object_ID('' + @SchemaName_n_TableName + ''))
			AND Context IN ('LCX_TEXT_MIX') AND Operation in ('LOP_DELETE_ROWS') 
			/*Use this subquery to filter the date*/
			AND [TRANSACTION ID] IN (SELECT DISTINCT [TRANSACTION ID] FROM    sys.fn_dblog(NULL, NULL) 
			WHERE Context IN ('LCX_NULL') AND Operation in ('LOP_BEGIN_XACT')  
			And [Transaction Name]='DELETE'
			And  CONVERT(NVARCHAR(11),[Begin Time]) BETWEEN @Date_From AND @Date_To)
                        
			/****************************************/

		OPEN Page_Data_Cursor

		FETCH NEXT FROM Page_Data_Cursor INTO @ConsolidatedPageID, @Slotid,@AllocUnitID,@LCX_TEXT_MIX,@LinkID,@Context

		WHILE @@FETCH_STATUS = 0
		BEGIN
			DECLARE @hex_pageid AS VARCHAR(Max)
			/*Page ID contains File Number and page number It looks like 0001:00000130.
			  In this example 0001 is file Number &  00000130 is Page Number & These numbers are in Hex format*/
			SET @Fileid=SUBSTRING(@ConsolidatedPageID,0,CHARINDEX(':',@ConsolidatedPageID)) -- Seperate File ID from Page ID
		
			SET @hex_pageid ='0x'+ SUBSTRING(@ConsolidatedPageID,CHARINDEX(':',@ConsolidatedPageID)+1,Len(@ConsolidatedPageID))  ---Seperate the page ID
 			SELECT @Pageid=Convert(INT,cast('' AS XML).value('xs:hexBinary(substring(sql:variable("@hex_pageid"),sql:column("t.pos")) )', 'varbinary(max)')) -- Convert Page ID from hex to integer
			FROM (SELECT CASE substring(@hex_pageid, 1, 2) WHEN '0x' THEN 3 ELSE 0 END) AS t(pos) 
	        
            IF @Context='LCX_PFS' 	  
              BEGIN 
						DELETE @temppagedata
						INSERT INTO @temppagedata EXEC( 'DBCC PAGE(' + @DataBase_Name + ', ' + @fileid + ', ' + @pageid + ', 1) with tableresults,no_infomsgs;'); 
						INSERT INTO @pagedata SELECT @ConsolidatedPageID,@fileid,@pageid,@AllocUnitID,[ParentObject],[Object],[Field] ,[Value] FROM @temppagedata
              END
            ELSE IF @Context='LCX_TEXT_MIX' 
              BEGIN
                        INSERT INTO  @ModifiedRawData SELECT @ConsolidatedPageID,@fileid,@pageid,@Slotid,@AllocUnitID,NULL,0,CONVERT(INT,CONVERT(VARBINARY,REVERSE(SUBSTRING(@LCX_TEXT_MIX,11,2)))),@LCX_TEXT_MIX,@LinkID,0
              END	  
			FETCH NEXT FROM Page_Data_Cursor INTO  @ConsolidatedPageID, @Slotid,@AllocUnitID,@LCX_TEXT_MIX,@LinkID,@Context
		END
	
	CLOSE Page_Data_Cursor
	DEALLOCATE Page_Data_Cursor

	DECLARE @Newhexstring VARCHAR(MAX);

	--The data is in multiple rows in the page, so we need to convert it into one row as a single hex value.
	--This hex value is in string format
	INSERT INTO @ModifiedRawData ([PAGE ID],[FILE IDS],[PAGE IDS],[Slot ID],[AllocUnitId]
	,[RowLog Contents 0_var]
    , [RowLog Length])
	SELECT [Page ID],[FILE IDS],[PAGE IDS],Substring([ParentObject],CHARINDEX('Slot', [ParentObject])+4, (CHARINDEX('Offset', [ParentObject])-(CHARINDEX('Slot', [ParentObject])+4))-2 ) as [Slot ID]
	,[AllocUnitId]
	,Substring((
	SELECT 
    REPLACE(STUFF((SELECT REPLACE(SUBSTRING([Value],CHARINDEX(':',[Value])+1,CHARINDEX('',[Value])-CHARINDEX(':',[Value])),'','')
	FROM @pagedata C  WHERE B.[Page ID]= C.[Page ID] And Substring(B.[ParentObject],CHARINDEX('Slot', B.[ParentObject])+4, (CHARINDEX('Offset', B.[ParentObject])-(CHARINDEX('Slot', B.[ParentObject])+4)) )=Substring(C.[ParentObject],CHARINDEX('Slot', C.[ParentObject])+4, (CHARINDEX('Offset', C.[ParentObject])-(CHARINDEX('Slot', C.[ParentObject])+4)) ) And 
	[Object] Like '%Memory Dump%'  Order By '0x'+ LEFT([Value],CHARINDEX(':',[Value])-1)
	FOR XML PATH('') ),1,1,'') ,' ','')
	),1,20000) AS [Value]
    
    ,
     Substring((
	SELECT '0x' +REPLACE(STUFF((SELECT REPLACE(SUBSTRING([Value],CHARINDEX(':',[Value])+1,CHARINDEX('',[Value])-CHARINDEX(':',[Value])),'','')
	FROM @pagedata C  WHERE B.[Page ID]= C.[Page ID] And Substring(B.[ParentObject],CHARINDEX('Slot', B.[ParentObject])+4, (CHARINDEX('Offset', B.[ParentObject])-(CHARINDEX('Slot', B.[ParentObject])+4)) )=Substring(C.[ParentObject],CHARINDEX('Slot', C.[ParentObject])+4, (CHARINDEX('Offset', C.[ParentObject])-(CHARINDEX('Slot', C.[ParentObject])+4)) ) And 
	[Object] Like '%Memory Dump%'  Order By '0x'+ LEFT([Value],CHARINDEX(':',[Value])-1)
	FOR XML PATH('') ),1,1,'') ,' ','')
	),7,4) AS [Length]
    
	From @pagedata B
	Where [Object] Like '%Memory Dump%'
	Group By [Page ID],[FILE IDS],[PAGE IDS],[ParentObject],[AllocUnitId]--,[Current LSN]
	Order By [Slot ID]

	UPDATE @ModifiedRawData  SET [RowLog Len] = CONVERT(VARBINARY(8000),REVERSE(cast('' AS XML).value('xs:hexBinary(substring(sql:column("[RowLog Length]"),0))', 'varbinary(Max)')))
	FROM @ModifiedRawData Where [LINK ID]=0

    UPDATE @ModifiedRawData  SET [RowLog Contents 0] =cast('' AS XML).value('xs:hexBinary(substring(sql:column("[RowLog Contents 0_var]"),0))', 'varbinary(Max)')  
	FROM @ModifiedRawData Where [LINK ID]=0

	Update B Set B.[RowLog Contents 0] =
	(CASE WHEN A.[RowLog Contents 0] IS NOT NULL AND C.[RowLog Contents 0] IS NOT NULL THEN  A.[RowLog Contents 0]+C.[RowLog Contents 0] 
		WHEN A.[RowLog Contents 0] IS NULL AND C.[RowLog Contents 0] IS NOT NULL THEN  C.[RowLog Contents 0]
		WHEN A.[RowLog Contents 0] IS NOT NULL AND C.[RowLog Contents 0] IS NULL THEN  A.[RowLog Contents 0]  
		END)
    ,B.[Update]=ISNULL(B.[Update],0)+1
	from @ModifiedRawData B
	LEFT Join @ModifiedRawData A On A.[Page IDS]=Convert(int,Convert(Varbinary(Max),Reverse(Substring(B.[RowLog Contents 0],15+14,2))))
	And A.[File IDS]=Convert(int,Convert(Varbinary(Max),Reverse(Substring(B.[RowLog Contents 0],19+14,2)))) 
    And A.[Link ID]=B.[Link ID]
    LEFT Join @ModifiedRawData C On C.[Page IDS]=Convert(int,Convert(Varbinary(Max),Reverse(Substring(B.[RowLog Contents 0],27+14,2))))
	And C.[File IDS]=Convert(int,Convert(Varbinary(Max),Reverse(Substring(B.[RowLog Contents 0],31+14,2))))
	And C.[Link ID]=B.[Link ID]
    Where  (A.[RowLog Contents 0] IS NOT NULL OR C.[RowLog Contents 0] IS NOT NULL)


	Update B Set B.[RowLog Contents 0] =
	(CASE WHEN A.[RowLog Contents 0] IS NOT NULL AND C.[RowLog Contents 0] IS NOT NULL THEN  A.[RowLog Contents 0]+C.[RowLog Contents 0] 
		WHEN A.[RowLog Contents 0] IS NULL AND C.[RowLog Contents 0] IS NOT NULL THEN  C.[RowLog Contents 0]
		WHEN A.[RowLog Contents 0] IS NOT NULL AND C.[RowLog Contents 0] IS NULL THEN  A.[RowLog Contents 0]  
		END)
    --,B.[Update]=ISNULL(B.[Update],0)+1
	from @ModifiedRawData B
	LEFT Join @ModifiedRawData A On A.[Page IDS]=Convert(int,Convert(Varbinary(Max),Reverse(Substring(B.[RowLog Contents 0],15+14,2))))
	And A.[File IDS]=Convert(int,Convert(Varbinary(Max),Reverse(Substring(B.[RowLog Contents 0],19+14,2)))) 
    And A.[Link ID]<>B.[Link ID] And B.[Update]=0
    LEFT Join @ModifiedRawData C On C.[Page IDS]=Convert(int,Convert(Varbinary(Max),Reverse(Substring(B.[RowLog Contents 0],27+14,2))))
	And C.[File IDS]=Convert(int,Convert(Varbinary(Max),Reverse(Substring(B.[RowLog Contents 0],31+14,2))))
	And C.[Link ID]<>B.[Link ID] And B.[Update]=0
    Where  (A.[RowLog Contents 0] IS NOT NULL OR C.[RowLog Contents 0] IS NOT NULL)

	UPDATE @ModifiedRawData  SET [RowLog Contents 0] =  
    (Case When [RowLog Len]>=8000 Then 
    Substring([RowLog Contents 0] ,15,[RowLog Len]) 
    When [RowLog Len]<8000 Then 
    SUBSTRING([RowLog Contents 0],15+6,Convert(int,Convert(varbinary(max),REVERSE(Substring([RowLog Contents 0],15,6)))))
    End)
	FROM @ModifiedRawData Where [LINK ID]=0

	UPDATE @ColumnNameAndData SET [hex_Value]=[RowLog Contents 0] 
    --,A.[Update]=A.[Update]+1
	FROM @ColumnNameAndData A
	INNER JOIN @ModifiedRawData B ON 
	Convert(int,Convert(Varbinary(Max),Reverse(Substring([hex_value],17,4))))=[PAGE IDS]
	AND  Convert(int,Substring([hex_value],9,2)) =B.[Link ID] 
	Where [System_Type_Id] In (99,167,175,231,239,241,165,98) And [Link ID] <>0 

	UPDATE @ColumnNameAndData SET [hex_Value]=
    (CASE WHEN B.[RowLog Contents 0] IS NOT NULL AND C.[RowLog Contents 0] IS NOT NULL THEN  B.[RowLog Contents 0]+C.[RowLog Contents 0] 
    WHEN B.[RowLog Contents 0] IS NULL AND C.[RowLog Contents 0] IS NOT NULL THEN  C.[RowLog Contents 0]
    WHEN B.[RowLog Contents 0] IS NOT NULL AND C.[RowLog Contents 0] IS NULL THEN  B.[RowLog Contents 0]  
    END)
	--,A.[Update]=A.[Update]+1
	FROM @ColumnNameAndData A
	LEFT JOIN @ModifiedRawData B ON 
	Convert(int,Convert(Varbinary(Max),Reverse(Substring([hex_value],5,4))))=B.[PAGE IDS]  And B.[Link ID] =0 
   	LEFT JOIN @ModifiedRawData C ON 
	Convert(int,Convert(Varbinary(Max),Reverse(Substring([hex_value],17,4))))=C.[PAGE IDS]  And C.[Link ID] =0 
	Where [System_Type_Id] In (99,167,175,231,239,241,165,98)  And (B.[RowLog Contents 0] IS NOT NULL OR C.[RowLog Contents 0] IS NOT NULL)

	UPDATE @ColumnNameAndData SET [hex_Value]=[RowLog Contents 0] 
    --,A.[Update]=A.[Update]+1
	FROM @ColumnNameAndData A
	INNER JOIN @ModifiedRawData B ON 
	Convert(int,Convert(Varbinary(Max),Reverse(Substring([hex_value],9,4))))=[PAGE IDS]
    And Convert(int,Substring([hex_value],3,2))=[Link ID]
	Where [System_Type_Id] In (35,34,99) And [Link ID] <>0 
    
	UPDATE @ColumnNameAndData SET [hex_Value]=[RowLog Contents 0]
    --,A.[Update]=A.[Update]+10
	FROM @ColumnNameAndData A
	INNER JOIN @ModifiedRawData B ON 
	Convert(int,Convert(Varbinary(Max),Reverse(Substring([hex_value],9,4))))=[PAGE IDS]
	Where [System_Type_Id] In (35,34,99) And [Link ID] =0

	UPDATE @ColumnNameAndData SET [hex_Value]=[RowLog Contents 0] 
    --,A.[Update]=A.[Update]+1
	FROM @ColumnNameAndData A
	INNER JOIN @ModifiedRawData B ON 
	Convert(int,Convert(Varbinary(Max),Reverse(Substring([hex_value],15,4))))=[PAGE IDS]
	Where [System_Type_Id] In (35,34,99) And [Link ID] =0

    Update @ColumnNameAndData set [hex_value]= 0xFFFE + Substring([hex_value],9,LEN([hex_value]))
	--,[Update]=[Update]+1
    Where [system_type_id]=241

CREATE TABLE [#temp_Data]
(
    [FieldName]  VARCHAR(MAX),
    [FieldValue] VARCHAR(MAX),
    [Rowlogcontents] VARBINARY(8000),
    [Row ID] int
)

INSERT INTO #temp_Data
SELECT NAME,
CASE
 WHEN system_type_id IN (231, 239) THEN  LTRIM(RTRIM(CONVERT(NVARCHAR(max),hex_Value)))  --NVARCHAR ,NCHAR
 WHEN system_type_id IN (167,175) THEN  LTRIM(RTRIM(CONVERT(VARCHAR(max),REPLACE(hex_Value, 0x00, 0x20))))  --VARCHAR,CHAR
 WHEN system_type_id IN (35) THEN  LTRIM(RTRIM(CONVERT(VARCHAR(max),hex_Value))) --Text
 WHEN system_type_id IN (99) THEN  LTRIM(RTRIM(CONVERT(NVARCHAR(max),hex_Value))) --nText 
 WHEN system_type_id = 48 THEN CONVERT(VARCHAR(MAX), CONVERT(TINYINT, CONVERT(BINARY(1), REVERSE (hex_Value)))) --TINY INTEGER
 WHEN system_type_id = 52 THEN CONVERT(VARCHAR(MAX), CONVERT(SMALLINT, CONVERT(BINARY(2), REVERSE (hex_Value)))) --SMALL INTEGER
 WHEN system_type_id = 56 THEN CONVERT(VARCHAR(MAX), CONVERT(INT, CONVERT(BINARY(4), REVERSE(hex_Value)))) -- INTEGER
 WHEN system_type_id = 127 THEN CONVERT(VARCHAR(MAX), CONVERT(BIGINT, CONVERT(BINARY(8), REVERSE(hex_Value))))-- BIG INTEGER
 WHEN system_type_id = 61 Then CONVERT(VARCHAR(MAX),CONVERT(DATETIME,CONVERT(VARBINARY(8000),REVERSE (hex_Value))),100) --DATETIME
 WHEN system_type_id =58 Then CONVERT(VARCHAR(MAX),CONVERT(SMALLDATETIME,CONVERT(VARBINARY(8000),REVERSE(hex_Value))),100) --SMALL DATETIME
 WHEN system_type_id = 108 THEN CONVERT(VARCHAR(MAX),CONVERT(NUMERIC(38,20), CONVERT(VARBINARY,CONVERT(VARBINARY(1),xprec)+CONVERT(VARBINARY(1),xscale))+CONVERT(VARBINARY(1),0) + hex_Value)) --- NUMERIC
 WHEN system_type_id =106 THEN CONVERT(VARCHAR(MAX), CONVERT(DECIMAL(38,20), CONVERT(VARBINARY,Convert(VARBINARY(1),xprec)+CONVERT(VARBINARY(1),xscale))+CONVERT(VARBINARY(1),0) + hex_Value)) --- DECIMAL
 WHEN system_type_id In(60,122) THEN CONVERT(VARCHAR(MAX),Convert(MONEY,Convert(VARBINARY(8000),Reverse(hex_Value))),2) --MONEY,SMALLMONEY
 WHEN system_type_id = 104 THEN CONVERT(VARCHAR(MAX),CONVERT (BIT,CONVERT(BINARY(1), hex_Value)%2))  -- BIT
 WHEN system_type_id =62 THEN  RTRIM(LTRIM(STR(CONVERT(FLOAT,SIGN(CAST(CONVERT(VARBINARY(8000),Reverse(hex_Value)) AS BIGINT)) * (1.0 + (CAST(CONVERT(VARBINARY(8000),Reverse(hex_Value)) AS BIGINT) & 0x000FFFFFFFFFFFFF) * POWER(CAST(2 AS FLOAT), -52)) * POWER(CAST(2 AS FLOAT),((CAST(CONVERT(VARBINARY(8000),Reverse(hex_Value)) AS BIGINT) & 0x7ff0000000000000) / EXP(52 * LOG(2))-1023))),53,LEN(hex_Value)))) --- FLOAT
 When system_type_id =59 THEN  Left(LTRIM(STR(CAST(SIGN(CAST(Convert(VARBINARY(8000),REVERSE(hex_Value)) AS BIGINT))* (1.0 + (CAST(CONVERT(VARBINARY(8000),Reverse(hex_Value)) AS BIGINT) & 0x007FFFFF) * POWER(CAST(2 AS Real), -23)) * POWER(CAST(2 AS Real),(((CAST(CONVERT(VARBINARY(8000),Reverse(hex_Value)) AS INT) )& 0x7f800000)/ EXP(23 * LOG(2))-127))AS REAL),23,23)),8) --Real
 WHEN system_type_id In (165,173) THEN (CASE WHEN CHARINDEX(0x,cast('' AS XML).value('xs:hexBinary(sql:column("hex_Value"))', 'VARBINARY(8000)')) = 0 THEN '0x' ELSE '' END) +cast('' AS XML).value('xs:hexBinary(sql:column("hex_Value"))', 'varchar(max)') -- BINARY,VARBINARY
 WHEN system_type_id =34 THEN (CASE WHEN CHARINDEX(0x,cast('' AS XML).value('xs:hexBinary(sql:column("hex_Value"))', 'VARBINARY(8000)')) = 0 THEN '0x' ELSE '' END) +cast('' AS XML).value('xs:hexBinary(sql:column("hex_Value"))', 'varchar(max)')  --IMAGE
 WHEN system_type_id =36 THEN CONVERT(VARCHAR(MAX),CONVERT(UNIQUEIDENTIFIER,hex_Value)) --UNIQUEIDENTIFIER
 WHEN system_type_id =231 THEN CONVERT(VARCHAR(MAX),CONVERT(sysname,hex_Value)) --SYSNAME
 WHEN system_type_id =241 THEN CONVERT(VARCHAR(MAX),CONVERT(xml,hex_Value)) --XML

 WHEN system_type_id =189 THEN (CASE WHEN CHARINDEX(0x,cast('' AS XML).value('xs:hexBinary(sql:column("hex_Value"))', 'VARBINARY(8000)')) = 0 THEN '0x' ELSE '' END) +cast('' AS XML).value('xs:hexBinary(sql:column("hex_Value"))', 'varchar(max)') --TIMESTAMP
 WHEN system_type_id=98 THEN (CASE 
 WHEN CONVERT(INT,SUBSTRING(hex_Value,1,1))=56 THEN CONVERT(VARCHAR(MAX), CONVERT(INT, CONVERT(BINARY(4), REVERSE(Substring(hex_Value,3,Len(hex_Value))))))  -- INTEGER
 WHEN CONVERT(INT,SUBSTRING(hex_Value,1,1))=108 THEN CONVERT(VARCHAR(MAX),CONVERT(numeric(38,20),CONVERT(VARBINARY(1),Substring(hex_Value,3,1)) +CONVERT(VARBINARY(1),Substring(hex_Value,4,1))+CONVERT(VARBINARY(1),0) + Substring(hex_Value,5,Len(hex_Value)))) --- NUMERIC
 WHEN CONVERT(INT,SUBSTRING(hex_Value,1,1))=167 THEN LTRIM(RTRIM(CONVERT(VARCHAR(max),REPLACE(Substring(hex_Value,9,Len(hex_Value)), 0x00, 0x20)))) --VARCHAR,CHAR
 WHEN CONVERT(INT,SUBSTRING(hex_Value,1,1))=36 THEN CONVERT(VARCHAR(MAX),CONVERT(UNIQUEIDENTIFIER,Substring((hex_Value),3,20))) --UNIQUEIDENTIFIER
 WHEN CONVERT(INT,SUBSTRING(hex_Value,1,1))=61 THEN CONVERT(VARCHAR(MAX),CONVERT(DATETIME,CONVERT(VARBINARY(8000),REVERSE (Substring(hex_Value,3,LEN(hex_Value)) ))),100) --DATETIME
 WHEN CONVERT(INT,SUBSTRING(hex_Value,1,1))=165 THEN '0x'+ SUBSTRING((CASE WHEN CHARINDEX(0x,cast('' AS XML).value('xs:hexBinary(sql:column("hex_Value"))', 'VARBINARY(8000)')) = 0 THEN '0x' ELSE '' END) +cast('' AS XML).value('xs:hexBinary(sql:column("hex_Value"))', 'varchar(max)'),11,LEN(hex_Value)) -- BINARY,VARBINARY
 END)
 
END AS FieldValue
,[Rowlogcontents]
,[Row ID]
FROM @ColumnNameAndData ORDER BY nullbit

--Create the column name in the same order to do pivot table.

DECLARE @FieldName VARCHAR(max)
SET @FieldName = STUFF(
(
	SELECT ',' + CAST(QUOTENAME([Name]) AS VARCHAR(MAX)) FROM syscolumns WHERE id=object_id('' + @SchemaName_n_TableName + '')
	FOR XML PATH('')), 1, 1, '')

--Finally did pivot table and get the data back in the same format.

SET @sql = 'SELECT ' + @FieldName  + ' FROM #temp_Data PIVOT (Min([FieldValue]) FOR FieldName IN (' + @FieldName  + ')) AS pvt'
EXEC sp_executesql @sql


GO
/****** Object:  StoredProcedure [dbo].[rptCierreANTEBOVEDA]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptCierreANTEBOVEDA]
	@Fecha varchar(10)
AS
BEGIN
set dateformat dmy
			 select DISTINCT((select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'MC 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre)) as mc1,
	
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'MC 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as mc2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'MC 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as mc3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'MC 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as mc4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'MC 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as mc5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'BANCO 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'BANCO 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'BANCO 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'BANCO 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'BANCO 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'COMERCIAL 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'COMERCIAL 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'COMERCIAL 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'COMERCIAL 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'COMERCIAL 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VABT 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VABT 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VABT 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VABT 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VABT 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'CARTERA 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'CARTERA 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'CARTERA 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'CARTERA 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'CARTERA 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'APOYO 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'APOYO 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'APOYO 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'APOYO 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'APOYO 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VAB 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VAB 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VAB 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VAB 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'
		AND   ruta.Nombre = 'VAB 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab5

from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'False'

		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre

END



GO
/****** Object:  StoredProcedure [dbo].[rptCierreANTEBOVEDASALIDA]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptCierreANTEBOVEDASALIDA]
	@Fecha varchar(10)
AS
BEGIN
set dateformat dmy
			 select DISTINCT((select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'MC 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre)) as mc1,
	
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'MC 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as mc2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'MC 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as mc3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'MC 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as mc4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'MC 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as mc5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'BANCO 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'BANCO 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'BANCO 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'BANCO 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'BANCO 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as banco5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'COMERCIAL 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'COMERCIAL 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'COMERCIAL 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'COMERCIAL 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'COMERCIAL 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as comercial5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VABT 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VABT 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VABT 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VABT 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VABT 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vabt5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'CARTERA 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'CARTERA 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'CARTERA 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'CARTERA 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'CARTERA 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as cartera5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'APOYO 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'APOYO 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'APOYO 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'APOYO 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'APOYO 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as apoyo5,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VAB 1'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab1,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VAB 2'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab2,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VAB 3'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab3,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VAB 4'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab4,
(select sum(Cartaporte.Monto)
		from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'
		AND   ruta.Nombre = 'VAB 5'
		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre) as vab5

from Cartaporte
		JOIN ruta_Cartaporte
		ON   ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
		JOIN ruta
		ON ruta.RutaID = ruta_Cartaporte.RutaID
		where   Cartaporte.PorSistema = 'True'

		AND   DATEADD(dd, DATEDIFF(dd, 0, ruta.FechaRecibida ), 0) = @Fecha
		GROUP BY ruta.Nombre

END



GO
/****** Object:  StoredProcedure [dbo].[rptCierreBoveda]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
CREATE PROCEDURE [dbo].[rptCierreBoveda]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY
	SELECT Distinct(Ruta.nombre), Sum(Cartaporte.Monto)AS monto
		FROM Ruta
		JOIN Ruta_Cartaporte
		ON   Ruta_Cartaporte.RutaID = Ruta.RutaID
		JOIN Cartaporte
		ON   Cartaporte.CartaporteID = Ruta_Cartaporte.CartaporteID
		WHERE Ruta_Cartaporte.Tipo = 2
		AND   Ruta.Despachada = 1
		AND   Ruta.Recibida = 1
		AND   Ruta.Cerrada = 1
		AND   Ruta.FechaCerrada = @FECHA
		GROUP BY Ruta.nombre,
				Cartaporte.Monto
		ORDER BY Ruta.nombre

END










GO
/****** Object:  StoredProcedure [dbo].[rptCurrency]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE PROCEDURE [dbo].[rptCurrency]

            (@Amount AS DECIMAL(38,3) )

 

AS 

  BEGIN 

    DECLARE  @Result VARCHAR(64), 

             @Buffer VARCHAR(64), 

             @Comma  CHAR(1) 

    SET @Result = '' 

    SET @Comma = '' 

    SET @Buffer = convert(VARCHAR(64),@Amount) 

    SET @Result = right(@Buffer,3) 

    SET @Buffer = left(@Buffer,len(@Buffer) - 3) 

    WHILE (len(@Buffer) > 0) 

      BEGIN 

        SET @Result = left(convert(VARCHAR,convert(MONEY,reverse(

                                  left(reverse(@Buffer),12))), 

                                   1),len(convert(VARCHAR,convert(MONEY,

                                   reverse(left(reverse(@Buffer),12))), 

                                            1)) - 3) + @Comma + @Result 

        SET @Buffer = CASE 

                        WHEN len(@Buffer) > 12 

                          THEN left(@Buffer,len(@Buffer) - 12) 

                        ELSE '' 

                      END 

        SET @Comma = ',' 

      END 

    SELECT  REPLACE(@Result,' ','')

  END 


GO
/****** Object:  StoredProcedure [dbo].[rptDepositos]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptDepositos]
    @Desde   datetime,
	@Hasta    datetime
AS
BEGIN
SET DATEFORMAT DMY



SELECT  Concepto.Nombre as concepto,
DATEADD(dd, DATEDIFF(dd, 0, Deposito.Fecha), 0) as Fecha,
 @Desde AS desde ,@Hasta as hasta, Deposito.Monto, 
Deposito.Numero as deposito,Cuenta.Numero as cuenta, 
Cuenta.Nombre as nombre,
Deposito.contacto,
Deposito.FechaCreado,
Banco.Descripcion, Cuenta_Numero.Numero
		FROM Deposito
		JOIN Cuenta
		ON   Cuenta.CuentaID = Deposito.CuentaID
		JOIN Concepto
		ON   Concepto.ConceptoID = Deposito.ConceptoID
	    JOIN Banco
		ON  Banco.BancoID = Deposito.BancoID
		JOIN Cuenta_Numero
		ON  Cuenta_Numero.CNumeroID = Deposito.CNumeroID
		WHERE DATEADD(dd, DATEDIFF(dd, 0, Deposito.Fecha), 0) >= @Desde
        and DATEADD(dd, DATEDIFF(dd, 0, Deposito.Fecha), 0) <= @Hasta
		and Concepto.ConceptoID in(1,2,4,5)
		and  Cuenta.CuentaID = 12
		GROUP BY Concepto.Nombre,
				 Deposito.Fecha,
				 Deposito.Monto,
				 Deposito.Numero,
				 Cuenta.Numero,
				 Cuenta.Nombre,
					Banco.Descripcion,
				 Cuenta_Numero.Numero,
				 Deposito.contacto,
Deposito.FechaCreado
		ORDER BY Concepto.Nombre

END









GO
/****** Object:  StoredProcedure [dbo].[rptDepositosREMESAS]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptDepositosREMESAS]
    @Desde   datetime,
	@Hasta    datetime
AS
BEGIN
SET DATEFORMAT DMY



SELECT  Concepto.Nombre as concepto,
        DATEADD(dd, DATEDIFF(dd, 0, Deposito.Fecha), 0) as Fecha,
        @Desde AS desde ,@Hasta as hasta, Deposito.Monto,
        Deposito.Numero as deposito,Cuenta.Numero as cuenta,
        Cuenta.Nombre as nombre,
        Deposito.contacto,
Deposito.FechaCreado,
        Banco.Descripcion, Cuenta_Numero.Numero
		FROM Deposito
		JOIN Cuenta
		ON   Cuenta.CuentaID = Deposito.CuentaID
		JOIN Concepto
		ON   Concepto.ConceptoID = Deposito.ConceptoID
		 JOIN Banco
		ON  Banco.BancoID = Deposito.BancoID
		JOIN Cuenta_Numero
		ON  Cuenta_Numero.CNumeroID = Deposito.CNumeroID
		WHERE DATEADD(dd, DATEDIFF(dd, 0, Deposito.Fecha), 0) >= @Desde
        and DATEADD(dd, DATEDIFF(dd, 0, Deposito.Fecha), 0) <= @Hasta
		and Concepto.ConceptoID = 3
		and  Cuenta.CuentaID = 7
		GROUP BY Concepto.Nombre,
				 Deposito.Fecha,
				 Deposito.Monto,
				 Deposito.Numero,
				 Cuenta.Numero,
				 Cuenta.Nombre,
	Banco.Descripcion,
	Deposito.contacto,
Deposito.FechaCreado,
				 Cuenta_Numero.Numero
		ORDER BY Concepto.Nombre

END


















GO
/****** Object:  StoredProcedure [dbo].[rptEntradaBanco]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptEntradaBanco]
	@Fecha varchar(10),
    @Ruta  varchar(50)
AS
BEGIN
	SET DATEFORMAT DMY

           SET LANGUAGE Spanish

IF @Ruta IS NOT NULL
SELECT * FROM
           (SELECT Ruta.RutaID, 
           CONVERT(VARCHAR,Ruta.Fecha,105)  as 'Fecha',
           DATENAME(DW,Ruta.Fecha) AS DIA,
           CONVERT(VARCHAR(8),Ruta.FechaDespachada,108)  as 'Hora',
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,
		   Consignador.Nombre AS Estaciones,
		   Consignador.PuntoID,		
		   (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = Consignador.PuntoID) AS 'EntradaDiaria',
		   COUNT(Distinct EnvaseID) AS Envases,
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '1,00',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,50',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,10',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,05',

		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF5'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '100F',

		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF2'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '50F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF23'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '20F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '10F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '5F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF20'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '2F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '1MF',

		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,50MF',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF2'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,25MF',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF23'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,125MF',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,10MF',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,05MF',

		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF20'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,01MF',
		   REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   				  FROM   CartaPorte_Punto Grupo
						  WHERE  Grupo.TIPO = 1
						  AND    Grupo.PuntoID = Consignador.PuntoID
						  AND    EXISTS (SELECT *
										 FROM   Ruta_CartaPorte d
										 WHERE  d.CartaPorteID = Grupo.CartaPorteID
										 AND    d.RutaID = Ruta_CartaPorte.RutaID
										 AND    d.TIPO = 2)
						  FOR XML PATH (''))),' ',' - ') AS Cartaportes,
		   Biblia.Secuencia
	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 2
	AND    Ruta.Fecha = @Fecha
AND  ruta.nombre = @Ruta
	GROUP  BY Ruta_CartaPorte.RutaID,
		   Ruta.RutaID, 
		   Ruta.Fecha, 
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,	
		   Consignador.Nombre,
		   Consignador.PuntoID,
	       Biblia.Secuencia
) A 	
	UNION 
SELECT * FROM
           (SELECT Ruta.RutaID, 
           CONVERT(VARCHAR,Ruta.Fecha,105)  as 'Fecha',
           DATENAME(DW,Ruta.Fecha) AS DIA,
           CONVERT(VARCHAR(8),Ruta.FechaDespachada,108)  as 'Hora',
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,
		   Consignatario.Nombre AS Estaciones,
		   Consignatario.PuntoID,		
		   (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignatarioID = Consignatario.PuntoID) AS 'EntradaDiaria',
		   COUNT(Distinct EnvaseID) AS Envases,
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '1,00',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,50',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,10',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,05',

		   0 AS '100F',
		   0 AS '50F',
		   0 AS '20F',
		   0 AS '10F',
		   0 AS '5F',
		   0 AS '2F',
		   0 AS '1MF',
		   0 AS '0,50MF',
		   0 AS '0,25MF',
		   0 AS '0,125MF',
		   0 AS '0,10MF',
		   0 AS '0,05MF',
		   0 AS '0,01MF',
		   REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   				  FROM   CartaPorte_Punto Grupo
						  WHERE  Grupo.TIPO = 2
						  AND    Grupo.PuntoID = Consignatario.PuntoID
						  AND    EXISTS (SELECT *
										 FROM   Ruta_CartaPorte d
										 WHERE  d.CartaPorteID = Grupo.CartaPorteID
										 AND    d.RutaID = Ruta_CartaPorte.RutaID
										 AND    d.TIPO = 2)
						  FOR XML PATH (''))),' ',' - ') AS Cartaportes,
		   Biblia.Secuencia
	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 2
	AND    Ruta.Fecha = @Fecha
AND biblia.tipo = 'banco'
AND  ruta.nombre = @Ruta
	GROUP  BY Ruta_CartaPorte.RutaID,
		   Ruta.RutaID, 
		   Ruta.Fecha, 
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,	
		   Consignatario.Nombre,
		   Consignatario.PuntoID,
	       Biblia.Secuencia
)B
	ORDER  BY Nombre,
		      Secuencia
ELSE

SELECT * FROM
           (SELECT Ruta.RutaID, 
           CONVERT(VARCHAR,Ruta.Fecha,105)  as 'Fecha',
           DATENAME(DW,Ruta.Fecha) AS DIA,
           CONVERT(VARCHAR(8),Ruta.FechaDespachada,108)  as 'Hora',
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,
		   Consignador.Nombre AS Estaciones,
		   Consignador.PuntoID,		
		   (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignadorID = Consignador.PuntoID) AS 'EntradaDiaria',
		   COUNT(Distinct EnvaseID) AS Envases,
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '1,00',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,50',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,10',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,05',

		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF5'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '100F',

		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF2'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '50F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF23'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '20F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '10F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '5F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF20'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '2F',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '1MF',

		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,50MF',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF2'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,25MF',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF23'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,125MF',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,10MF',
		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,05MF',

		   (SELECT SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF20'
		   AND    c.NroPlomo <> 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignadorID = Consignador.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,01MF',
		   REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   				  FROM   CartaPorte_Punto Grupo
						  WHERE  Grupo.TIPO = 1
						  AND    Grupo.PuntoID = Consignador.PuntoID
						  AND    EXISTS (SELECT *
										 FROM   Ruta_CartaPorte d
										 WHERE  d.CartaPorteID = Grupo.CartaPorteID
										 AND    d.RutaID = Ruta_CartaPorte.RutaID
										 AND    d.TIPO = 2)
						  FOR XML PATH (''))),' ',' - ') AS Cartaportes,
		   Biblia.Secuencia
	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 2
	AND    Ruta.Fecha = @Fecha

	GROUP  BY Ruta_CartaPorte.RutaID,
		   Ruta.RutaID, 
		   Ruta.Fecha, 
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,	
		   Consignador.Nombre,
		   Consignador.PuntoID,
	       Biblia.Secuencia
) A 	
	UNION 
SELECT * FROM
           (SELECT Ruta.RutaID, 
           CONVERT(VARCHAR,Ruta.Fecha,105)  as 'Fecha',
           DATENAME(DW,Ruta.Fecha) AS DIA,
           CONVERT(VARCHAR(8),Ruta.FechaDespachada,108)  as 'Hora',
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,
		   Consignatario.Nombre AS Estaciones,
		   Consignatario.PuntoID,		
		   (SELECT SUM(b.MONTO) 
		   FROM   vw_cartaporte b
		   WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = b.CartaPorteID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)

		   AND    b.ConsignatarioID = Consignatario.PuntoID) AS 'EntradaDiaria',
		   COUNT(Distinct EnvaseID) AS Envases,
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '1,00',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,50',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,10',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 2)) AS '0,05',

		   0 AS '100F',
		   0 AS '50F',
		   0 AS '20F',
		   0 AS '10F',
		   0 AS '5F',
		   0 AS '2F',
		   0 AS '1MF',
		   0 AS '0,50MF',
		   0 AS '0,25MF',
		   0 AS '0,125MF',
		   0 AS '0,10MF',
		   0 AS '0,05MF',
		   0 AS '0,01MF',
		   REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   				  FROM   CartaPorte_Punto Grupo
						  WHERE  Grupo.TIPO = 2
						  AND    Grupo.PuntoID = Consignatario.PuntoID
						  AND    EXISTS (SELECT *
										 FROM   Ruta_CartaPorte d
										 WHERE  d.CartaPorteID = Grupo.CartaPorteID
										 AND    d.RutaID = Ruta_CartaPorte.RutaID
										 AND    d.TIPO = 2)
						  FOR XML PATH (''))),' ',' - ') AS Cartaportes,
		   Biblia.Secuencia
	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 2
	AND    Ruta.Fecha = @Fecha
AND biblia.tipo = 'banco'
	GROUP  BY Ruta_CartaPorte.RutaID,
		   Ruta.RutaID, 
		   Ruta.Fecha, 
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,	
		   Consignatario.Nombre,
		   Consignatario.PuntoID,
	       Biblia.Secuencia
)B
	ORDER  BY Nombre,
		      Secuencia

	
END






GO
/****** Object:  StoredProcedure [dbo].[rptImpCartaPorteMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[rptImpCartaPorteMC] 
	@CartaPorteID VARCHAR(max)
AS
BEGIN

	SET NOCOUNT ON
	SET LANGUAGE Spanish

	SELECT vw_cartaporte.CartaPorteID,
		   DATENAME(DW,vw_cartaporte.ConsignadorFecha)  as 'DIA',
		   vw_cartaporte.Consignador,
		   vw_cartaporte.Consignatario,
		   COUNT(DISTINCT(Envase.EnvaseID)) AS Envases,
		   CASE WHEN COUNT(DISTINCT(_0_05.EnvaseID)) > 0
				THEN CAST(COUNT(DISTINCT(_0_05.EnvaseID)) AS VARCHAR) + ' x 0,05'
				ELSE ''
		   END +
		   CASE WHEN COUNT(DISTINCT(_0_05.EnvaseID)) > 0 AND COUNT(DISTINCT(_0_10.EnvaseID)) > 0
				THEN ' + '
				ELSE ''
		   END +
		   CASE WHEN COUNT(DISTINCT(_0_10.EnvaseID)) > 0
		 		THEN CAST(COUNT(DISTINCT(_0_10.EnvaseID)) AS VARCHAR) + ' x 0,10'
				ELSE ''
		   END +
		   CASE WHEN (COUNT(DISTINCT(_0_10.EnvaseID)) > 0 OR COUNT(DISTINCT(_0_05.EnvaseID)) > 0) AND COUNT(DISTINCT(_0_50.EnvaseID)) > 0
				THEN ' + '
				ELSE ''
		   END +
		   CASE WHEN COUNT(DISTINCT(_0_50.EnvaseID)) > 0
 				THEN CAST(COUNT(DISTINCT(_0_50.EnvaseID)) AS VARCHAR) + ' x 0,50'
				ELSE ''
		   END +
		   CASE WHEN (COUNT(DISTINCT(_0_10.EnvaseID)) > 0 OR COUNT(DISTINCT(_0_05.EnvaseID)) > 0 OR COUNT(DISTINCT(_0_50.EnvaseID)) > 0) AND COUNT(DISTINCT(_1_00.EnvaseID)) > 0
				THEN ' + '
				ELSE ''
		   END +
		   CASE WHEN COUNT(DISTINCT(_1_00.EnvaseID)) > 0
				THEN CAST(COUNT(DISTINCT(_1_00.EnvaseID)) AS VARCHAR) + ' x 1,00'
				ELSE ''
		   END  AS Detalle,
		   COUNT(DISTINCT(_0_05.EnvaseID)) AS '0,05',
		   COUNT(DISTINCT(_0_10.EnvaseID)) AS '0,10',
		   COUNT(DISTINCT(_0_50.EnvaseID)) AS '0,50',
		   COUNT(DISTINCT(_1_00.EnvaseID)) AS '1,00',
		   vw_cartaporte.Monto,
		   dbo.Numeroenletra(vw_cartaporte.Monto) + ' BOLIVARES FUERTES' AS MontoLetras,
		   CONVERT(VARCHAR,vw_cartaporte.ConsignadorFecha,105) AS ConsignadorFecha,    
		   CONVERT(VARCHAR,vw_cartaporte.ConsignatarioFecha,105)AS ConsignatarioFecha
	FROM   vw_cartaporte
	JOIN   Envase
	ON     Envase.CartaPorteID = vw_cartaporte.CartaPorteID
	LEFT   JOIN Envase_Efectivo _0_05
	ON     Envase.EnvaseID = _0_05.EnvaseID
	AND    _0_05.EfectivoID = 'MF21'
	LEFT   JOIN Envase_Efectivo _0_10
	ON     Envase.EnvaseID = _0_10.EnvaseID
	AND    _0_10.EfectivoID = 'MF22'
	LEFT   JOIN Envase_Efectivo _0_50
	ON     Envase.EnvaseID = _0_50.EnvaseID
	AND    _0_50.EfectivoID = 'MF25'
	LEFT   JOIN Envase_Efectivo _1_00
	ON     Envase.EnvaseID = _1_00.EnvaseID
	AND    _1_00.EfectivoID = 'MF26'
	WHERE  vw_cartaporte.CartaPorteID IN (@CartaPorteID)
	GROUP  BY vw_cartaporte.CartaPorteID,
		   vw_cartaporte.ConsignadorFecha,
		   vw_cartaporte.Consignador,
		   vw_cartaporte.Consignatario,
		   vw_cartaporte.Monto,
		   vw_cartaporte.ConsignadorFecha,
		   vw_cartaporte.ConsignatarioFecha
END

GO
/****** Object:  StoredProcedure [dbo].[rptImpSalidaEnvasesMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[rptImpSalidaEnvasesMC] 
	@Fecha DATETIME 
AS
BEGIN

	SET NOCOUNT ON
	SET LANGUAGE Spanish
	SET DATEFORMAT DMY
	

	SELECT Biblia.Ruta,
		   Efectivo.Denominacion, 
		   COUNT(Envase_Efectivo.EnvaseID) Envases
	FROM   vw_cartaporte
	JOIN   Envase
	ON     Envase.CartaPorteID = vw_cartaporte.CartaPorteID
	JOIN   Envase_Efectivo 
	ON     Envase.EnvaseID = Envase_Efectivo.EnvaseID
	JOIN   Efectivo 
	ON     Envase_Efectivo.EfectivoID = Efectivo.EfectivoID
	JOIN   Biblia
	ON     vw_cartaporte.ConsignatarioID = Biblia.PuntoID
	WHERE  vw_cartaporte.CuentaID in(35,59)
    AND    vw_cartaporte.ConsignadorFecha = @Fecha
	AND    Envase.EstaAbierto = 'false'
	AND Envase_Efectivo.EfectivoID <> 'BF20'
	AND    Envase.NroPlomo <> 'N/A'
	GROUP  BY Biblia.Ruta,
		   Efectivo.Denominacion
	ORDER  BY Biblia.Ruta,
		   Efectivo.Denominacion

END


GO
/****** Object:  StoredProcedure [dbo].[rptImpTraspasoBloque]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptImpTraspasoBloque] 
	@TraspasoID INT
AS
BEGIN

	SET NOCOUNT ON
	SET  DATEFORMAT DMY

	SELECT DISTINCT(Traspaso.TraspasoID), 
		   Emisor.Nombre AS Emisor,
		   Receptor.Nombre AS Receptor,
		   LoginEmisor,
		   CONVERT(VARCHAR,FechaEmisor,105) AS FechaEmisor, 
		   LoginReceptor,  
		   CONVERT(VARCHAR,FechaReceptor,105) AS FechaReceptor, 
		   Observacion,
		   Bloque.BloqueID,
		   (Select count(*) from Bloque where BloqueID = Bloque.BloqueID) as Bloques,
		   (dbo.getTotalMontoBloque(Bloque.BloqueID)) as Monto
	FROM   Traspaso_Bloque
	JOIN   Bloque
	ON	   Traspaso_Bloque.BloqueID = Bloque.BloqueID
	
	JOIN   Bloque_Efectivo
	ON     Bloque_Efectivo.BloqueID = Bloque.BloqueID
	JOIN   Traspaso
	ON     Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID
	JOIN   Boveda Emisor
	ON     Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN   Boveda Receptor
	ON     Traspaso.BovedaReceptorID = Receptor.BovedaID
	WHERE  Traspaso.Recibido = 1
	AND    Traspaso.TraspasoID = @TraspasoID

END







GO
/****** Object:  StoredProcedure [dbo].[rptImpTraspasoBolsa]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptImpTraspasoBolsa] 
	@TraspasoID INT
AS
BEGIN

	SET NOCOUNT ON
	SET  DATEFORMAT DMY

	SELECT DISTINCT(Traspaso.TraspasoID), 
		   Emisor.Nombre AS Emisor,
		   Receptor.Nombre AS Receptor,
		   LoginEmisor,
		   CONVERT(VARCHAR,FechaEmisor,105) AS FechaEmisor, 
		   LoginReceptor,  
		   CONVERT(VARCHAR,FechaReceptor,105) AS FechaReceptor, 
		   Observacion,
		   Bolsa.BolsaID,
		   (Select count(*) from Bloque where BolsaID = Bloque.BolsaID) as Bloques,
		   (Select sum(Bloque_Efectivo.Monto) from Bloque_Efectivo where BloqueID = Bloque_Efectivo.BloqueID) as Monto
	FROM   Traspaso_Bolsa
	JOIN   Bolsa
	ON	   Traspaso_Bolsa.BolsaID = Bolsa.BolsaID
	JOIN   Bloque
	ON     Bloque.BolsaID = Bolsa.BolsaID
	JOIN   Bloque_Efectivo
	ON     Bloque_Efectivo.BloqueID = Bloque.BloqueID
	JOIN   Traspaso
	ON     Traspaso_Bolsa.TraspasoID = Traspaso.TraspasoID
	JOIN   Boveda Emisor
	ON     Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN   Boveda Receptor
	ON     Traspaso.BovedaReceptorID = Receptor.BovedaID
	WHERE  Traspaso.Recibido = 1
	AND    Traspaso.TraspasoID = @TraspasoID


END







GO
/****** Object:  StoredProcedure [dbo].[rptImpTraspasoCartaPorte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE PROCEDURE [dbo].[rptImpTraspasoCartaPorte] 
	@TraspasoID INT
AS
BEGIN

	SET NOCOUNT ON
	SET  DATEFORMAT DMY

	SELECT Traspaso.TraspasoID, 
		   Emisor.Nombre AS Emisor,
		   Receptor.Nombre AS Receptor,
		   LoginEmisor,
		   CONVERT(VARCHAR,FechaEmisor,105) AS FechaEmisor, 
		   LoginReceptor,  
		   CONVERT(VARCHAR,FechaReceptor,105) AS FechaReceptor, 
		   Traspaso.Observacion,
		   vw_CartaPorte.CartaPorteID,
		   vw_CartaPorte.Envases,
		   vw_CartaPorte.Monto,
		   vw_CartaPorte.Consignador,
		   vw_CartaPorte.Consignatario,
		   
		    REPLACE(RTRIM((SELECT CAST(Grupo.NroPlomo AS VARCHAR(MAX)) + ' ' 
		   				  FROM   Envase Grupo
						  WHERE  Grupo.CartaPorteID = vw_CartaPorte.CartaPorteID
						  
						  FOR XML PATH (''))),' ',' - ') AS Plomos
	FROM   Traspaso_CartaPorte
	JOIN   vw_CartaPorte
	ON	   Traspaso_CartaPorte.CartaPorteID = vw_CartaPorte.CartaPorteID 
	
	JOIN   Traspaso
	ON     Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID
	JOIN   Boveda Emisor
	ON     Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN   Boveda Receptor
	ON     Traspaso.BovedaReceptorID = Receptor.BovedaID
	WHERE  Traspaso.Recibido = 1
	AND    Traspaso.TraspasoID = @TraspasoID

order by vw_CartaPorte.Consignador
END







GO
/****** Object:  StoredProcedure [dbo].[rptImpTraspasoCartaPorteA]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE PROCEDURE [dbo].[rptImpTraspasoCartaPorteA] 
	@TraspasoID INT
AS
BEGIN

	SET NOCOUNT ON
	SET  DATEFORMAT DMY

	SELECT Traspaso.TraspasoID, 
		   Emisor.Nombre AS Emisor,
		   Receptor.Nombre AS Receptor,
		   LoginEmisor,
		   CONVERT(VARCHAR,FechaEmisor,105) AS FechaEmisor, 
		   LoginReceptor,  
		   CONVERT(VARCHAR,FechaReceptor,105) AS FechaReceptor, 
		   Traspaso.Observacion,
		   vw_CartaPorte.CartaPorteID,
		   dbo.getTotalEnvasesAnillo(vw_CartaPorte.CartaPorteID) as Envases,
		   vw_CartaPorte.Monto,
		   vw_CartaPorte.Consignador,
		   vw_CartaPorte.Consignatario,
		    REPLACE(RTRIM((SELECT CAST(Grupo.NroPlomo AS VARCHAR(MAX)) + ' ' 
		   				  FROM   Envase Grupo
						  WHERE  Grupo.CartaPorteID = vw_CartaPorte.CartaPorteID
						  
						  FOR XML PATH (''))),' ',' - ') AS Plomos
	FROM   Traspaso_CartaPorte
	JOIN   vw_CartaPorte
	ON	   Traspaso_CartaPorte.CartaPorteID = vw_CartaPorte.CartaPorteID 
	
	
	JOIN   Traspaso
	ON     Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID
	JOIN   Boveda Emisor
	ON     Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN   Boveda Receptor
	ON     Traspaso.BovedaReceptorID = Receptor.BovedaID
	WHERE  Traspaso.Recibido = 1
	AND    Traspaso.TraspasoID = @TraspasoID


END







GO
/****** Object:  StoredProcedure [dbo].[rptImpTraspasoEfectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE PROCEDURE [dbo].[rptImpTraspasoEfectivo] 
	@TraspasoID INT
AS
BEGIN

	SET NOCOUNT ON
	SET  DATEFORMAT DMY

	SELECT Traspaso.TraspasoID, 
		   Emisor.Nombre AS Emisor,
		   Receptor.Nombre AS Receptor,
		   LoginEmisor,
		   CONVERT(VARCHAR,FechaEmisor,105) AS FechaEmisor, 
		   LoginReceptor,  
		   CONVERT(VARCHAR,FechaReceptor,105) AS FechaReceptor, 
		   Observacion,
		   Traspaso_Efectivo.Monto
	FROM   Traspaso_Efectivo
	JOIN   Traspaso
	ON     Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID
	JOIN   Boveda Emisor
	ON     Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN   Boveda Receptor
	ON     Traspaso.BovedaReceptorID = Receptor.BovedaID
	WHERE  Traspaso.Recibido = 1
	AND    Traspaso.TraspasoID = @TraspasoID


END









GO
/****** Object:  StoredProcedure [dbo].[rptImpTraspasoEfectivoCaja]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE PROCEDURE [dbo].[rptImpTraspasoEfectivoCaja] 
	@TraspasoID INT
AS
BEGIN

	SET NOCOUNT ON
	SET  DATEFORMAT DMY

	SELECT Traspaso_Caja.TraspasoID, 
		   Emisor.Nombre AS Emisor,
		   Receptor.Nombre AS Receptor,
		   LoginEmisor,
		   CONVERT(VARCHAR,FechaEmisor,105) AS FechaEmisor, 
		   LoginReceptor,  
		   CONVERT(VARCHAR,FechaReceptor,105) AS FechaReceptor, 
		   Observacion,
		   Traspaso_Efectivo_Caja.Monto
	FROM   Traspaso_Efectivo_Caja
	JOIN   Traspaso_Caja
	ON     Traspaso_Efectivo_Caja.TraspasoID = Traspaso_Caja.TraspasoID
	JOIN   Caja Emisor
	ON     Traspaso_Caja.CajaEmisorID = Emisor.CajaID
	JOIN   Boveda Receptor
	ON     Traspaso_Caja.BovedaReceptorID = Receptor.BovedaID
	WHERE  Traspaso_Caja.Recibido = 1
	AND    Traspaso_Caja.TraspasoID = @TraspasoID


END









GO
/****** Object:  StoredProcedure [dbo].[rptImpTraspasoEfectivoDeposito]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE PROCEDURE [dbo].[rptImpTraspasoEfectivoDeposito] 
	@TraspasoID INT
AS
BEGIN

	SET NOCOUNT ON
	SET  DATEFORMAT DMY

	SELECT Traspaso.TraspasoID, 
		   Emisor.Nombre AS Emisor,
		   Receptor.Nombre AS Receptor,
		   LoginEmisor,
		   CONVERT(VARCHAR,FechaEmisor,105) AS FechaEmisor, 
		   LoginReceptor,  
		   CONVERT(VARCHAR,FechaReceptor,105) AS FechaReceptor, 
		   Observacion,
		   Traspaso_Efectivo.Monto
	FROM   Traspaso_Efectivo
	JOIN   Traspaso
	ON     Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID
	JOIN   Boveda Emisor
	ON     Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN   Boveda Receptor
	ON     Traspaso.BovedaReceptorID = Receptor.BovedaID
	WHERE  Traspaso.TraspasoID = @TraspasoID


END









GO
/****** Object:  StoredProcedure [dbo].[rptMontoConteoACOPIO]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoConteoACOPIO]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT  SUM(Envase_Efectivo.Monto) as monto
from Envase_Efectivo
JOIN Envase
ON   Envase.EnvaseID = Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON   Cartaporte.CartaporteID = Envase.CartaporteID
JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
JOIN Biblia
ON  Biblia.PuntoID = Consignador.PuntoID




where  DATEADD(dd, DATEDIFF(dd, 0, Envase.FechaAbierto), 0) = @Fecha
AND  Biblia.tipo in('comercial','banco','cartera','ATM','carMLTe','carteramtb','CarteraMTC')


END









GO
/****** Object:  StoredProcedure [dbo].[rptMontoConteoENTUBADO]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoConteoENTUBADO]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT  SUM(Envase_Efectivo.Monto) as monto
from Envase_Efectivo
JOIN Envase
ON   Envase.EnvaseID = Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON   Cartaporte.CartaporteID = Envase.CartaporteID
JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
JOIN Biblia
ON  Biblia.PuntoID = Consignador.PuntoID




where  DATEADD(dd, DATEDIFF(dd, 0, Envase.FechaAbierto), 0) = @Fecha
AND  Biblia.tipo = 'vab'

END









GO
/****** Object:  StoredProcedure [dbo].[rptMontoConteoMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoConteoMC]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT  SUM(Envase_Efectivo.Monto) as monto
from Envase_Efectivo
JOIN Envase
ON   Envase.EnvaseID = Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON   Cartaporte.CartaporteID = Envase.CartaporteID
JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
JOIN Biblia
ON  Biblia.PuntoID = Consignador.PuntoID

--ON   Cartaporte.CartaporteID = Envase.CartaporteID
--JOIN Cartaporte_Punto
--ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
--JOIN Punto
--ON   Punto.PuntoID = Cartaporte_Punto.PuntoID
--JOIN Biblia
--ON  Biblia.PuntoID = Punto.PuntoID


where  DATEADD(dd, DATEDIFF(dd, 0, Envase.FechaAbierto), 0) = @Fecha
AND  Biblia.tipo in('metro','metromtb')
END









GO
/****** Object:  StoredProcedure [dbo].[rptMontoConteoVAB]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoConteoVAB]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT  SUM(Envase_Efectivo.Monto) as monto
from Envase_Efectivo
JOIN Envase
ON   Envase.EnvaseID = Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON   Cartaporte.CartaporteID = Envase.CartaporteID
JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
JOIN Biblia
ON  Biblia.PuntoID = Consignador.PuntoID

--ON   Cartaporte.CartaporteID = Envase.CartaporteID
--JOIN Cartaporte_Punto
--ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
--JOIN Punto
--ON   Punto.PuntoID = Cartaporte_Punto.PuntoID
--JOIN Biblia
--ON  Biblia.PuntoID = Punto.PuntoID


where  DATEADD(dd, DATEDIFF(dd, 0, Envase.FechaAbierto), 0) = @Fecha
AND  Biblia.tipo = 'vab'
END









GO
/****** Object:  StoredProcedure [dbo].[rptMontoConteoVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoConteoVABT]
    @Fecha   datetime
AS
BEGIN
SET DATEFORMAT DMY


SELECT  SUM(Envase_Efectivo.Monto) as monto
from Envase_Efectivo
JOIN Envase
ON   Envase.EnvaseID = Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON   Cartaporte.CartaporteID = Envase.CartaporteID
JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
JOIN Biblia
ON  Biblia.PuntoID = Consignador.PuntoID

--ON   Cartaporte.CartaporteID = Envase.CartaporteID
--JOIN Cartaporte_Punto
--ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
--JOIN Punto
--ON   Punto.PuntoID = Cartaporte_Punto.PuntoID
--JOIN Biblia
--ON  Biblia.PuntoID = Punto.PuntoID


where  DATEADD(dd, DATEDIFF(dd, 0, Envase.FechaAbierto), 0) = @Fecha
AND  Biblia.tipo = 'vabt'
END









GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoACOPIO_BOVEDA]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoEntregadoACOPIO_BOVEDA]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY

SELECT  SUM(Monto) as monto
from Traspaso_Efectivo
JOIN Traspaso
ON Traspaso.TraspasoID = Traspaso_Efectivo.TraspasoID

where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 2
--AND  Traspaso.BovedaReceptorID = 3

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoANILLO]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoEntregadoANILLO]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT  SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 7

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoAnteriorMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoEntregadoAnteriorMC]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = DATEADD(DD,-1,@Fecha)
AND  Traspaso.BovedaEmisorID = 4

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoBloqueBOVEDAPRINCIPAL]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoEntregadoBloqueBOVEDAPRINCIPAL]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY

SELECT  SUM(Bloque_efectivo.Monto) as monto
from Bloque_efectivo
JOIN Bloque
ON  Bloque.Bloqueid= Bloque_efectivo.Bloqueid
JOIN Traspaso_Bloque
ON Traspaso_Bloque.Bloqueid = Bloque.Bloqueid
JOIN Traspaso
ON Traspaso.TraspasoID =Traspaso_Bloque.TraspasoID

where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 3
END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoCartaporteBOVEDAPRINCIPAL]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoEntregadoCartaporteBOVEDAPRINCIPAL]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY

SELECT  SUM(cartaporte.Monto) as monto
from cartaporte
join Traspaso_cartaporte
on  Traspaso_cartaporte.Cartaporteid = cartaporte.cartaporteid
JOIN Traspaso
ON Traspaso.TraspasoID = Traspaso_cartaporte.TraspasoID

where DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 3

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoEfectivoAnteriorMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoEntregadoEfectivoAnteriorMC]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY



SELECT SUM(TRASPASO_EFECTIVO.Monto)
from TRASPASO_EFECTIVO
JOIN Traspaso
ON   Traspaso.TraspasoID = TRASPASO_EFECTIVO.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = DATEADD(DD,-1,@Fecha)
AND  Traspaso.BovedaEmisorID = 4

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoEfectivoBOVEDAPRINCIPAL]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoEntregadoEfectivoBOVEDAPRINCIPAL]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY

SELECT  SUM(Traspaso_efectivo.Monto) as monto
from Traspaso_efectivo
JOIN Traspaso
ON Traspaso.TraspasoID = Traspaso_efectivo.TraspasoID

where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 3

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoEfectivoMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoEntregadoEfectivoMC]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY



SELECT SUM(TRASPASO_EFECTIVO.Monto)
from TRASPASO_EFECTIVO
JOIN Traspaso
ON   Traspaso.TraspasoID = TRASPASO_EFECTIVO.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 4

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoEfectivoVAB]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoEntregadoEfectivoVAB]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY



SELECT SUM(TRASPASO_EFECTIVO.Monto)as monto
from TRASPASO_EFECTIVO
JOIN Traspaso
ON   Traspaso.TraspasoID = TRASPASO_EFECTIVO.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID  in(6,8)

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoEfectivoVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoEntregadoEfectivoVABT]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY



SELECT SUM(TRASPASO_EFECTIVO.Monto)
from TRASPASO_EFECTIVO
JOIN Traspaso
ON   Traspaso.TraspasoID = TRASPASO_EFECTIVO.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 5

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoENTUBADO_ACOPIO]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoEntregadoENTUBADO_ACOPIO]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT  SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 6
AND  Traspaso.BovedaReceptorID = 2

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoENTUBADO_ANILLO]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoEntregadoENTUBADO_ANILLO]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT  SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 6
AND  Traspaso.BovedaReceptorID = 7

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoEntregadoMC]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 4

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoVAB]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoEntregadoVAB]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID  in(6,8)

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoEntregadoVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoEntregadoVABT]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaEmisorID = 5
AND  Traspaso.Tipo <> 1

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoANILLO]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoRecibidoANILLO]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT  SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaEmisor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID = 7

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoAnteriorMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoRecibidoAnteriorMC]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID = 4

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoEfectivoANILLO]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoRecibidoEfectivoANILLO]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(TRASPASO_EFECTIVO.Monto)
from TRASPASO_EFECTIVO
JOIN Traspaso
ON   Traspaso.TraspasoID = TRASPASO_EFECTIVO.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID = 7

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoEfectivoAnteriorMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoRecibidoEfectivoAnteriorMC]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(TRASPASO_EFECTIVO.Monto) as monto
from TRASPASO_EFECTIVO
JOIN Traspaso
ON   Traspaso.TraspasoID = TRASPASO_EFECTIVO.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID = 4

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoEfectivoMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoRecibidoEfectivoMC]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(TRASPASO_EFECTIVO.Monto)
from TRASPASO_EFECTIVO
JOIN Traspaso
ON   Traspaso.TraspasoID = TRASPASO_EFECTIVO.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID = 4

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoEfectivoVAB]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoRecibidoEfectivoVAB]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(TRASPASO_EFECTIVO.Monto) as monto
from TRASPASO_EFECTIVO
JOIN Traspaso
ON   Traspaso.TraspasoID = TRASPASO_EFECTIVO.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID  in(6,8)

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoEfectivoVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoRecibidoEfectivoVABT]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(TRASPASO_EFECTIVO.Monto)
from TRASPASO_EFECTIVO
JOIN Traspaso
ON   Traspaso.TraspasoID = TRASPASO_EFECTIVO.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID = 5

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoRecibidoMC]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID = 4

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoVAB]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[rptMontoRecibidoVAB]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID  in(6,8)

END
GO
/****** Object:  StoredProcedure [dbo].[rptMontoRecibidoVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[rptMontoRecibidoVABT]
    @Fecha   VARCHAR(10)
AS
BEGIN
SET DATEFORMAT DMY


SELECT SUM(Cartaporte.Monto) as monto
from Cartaporte
JOIN Traspaso_Cartaporte
ON   Cartaporte.CartaporteID = Traspaso_Cartaporte.CartaporteID
JOIN Traspaso
ON   Traspaso.TraspasoID = Traspaso_Cartaporte.TraspasoID
where  DATEADD(dd, DATEDIFF(dd, 0, Traspaso.FechaReceptor), 0)  = @Fecha
AND  Traspaso.BovedaReceptorID = 5
and Traspaso.BovedaEmisorID <> 1


END
GO
/****** Object:  StoredProcedure [dbo].[rptRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[rptRuta]
	@RutaID INT
AS
BEGIN
SET DATEFORMAT DMY
	SET LANGUAGE Spanish
	SELECT Punto.Nombre as puntonombre,
Ruta.RutaID, 
           CONVERT(VARCHAR,Ruta.Fecha,105)  as 'Fecha',
		   DATENAME(DW,Ruta.Fecha) AS DIA,
           CONVERT(VARCHAR(8),Ruta.FechaDespachada,108)  as 'Hora',
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,
       dbo.getPlomosByEnvase(Ruta.RutaID,Biblia.PuntoID,1) AS Plomo,
       dbo.getTotalPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1) AS PiezasProcesadas,
		dbo.getTotalEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1) AS Envases,
		dbo.getTotalEnvasesByRutaAnillo(Ruta.RutaID,Biblia.PuntoID,1) as Bolsas,
	   dbo.getCartaportesByRuta(Ruta.RutaID,Biblia.PuntoID,1) AS Cartaportes,
	   dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'MF26') AS '1,00',
dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'MF25') AS '0,50',
dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'MF22') AS '0,10',
dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'MF21') AS '0,05',
dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF2') AS '50',
dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF20') AS '2',
dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF21') AS '5',
dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF22') AS '10',
dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF23') AS '20',
dbo.getEnvasesByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF5') AS '100',

 dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'MF26') AS 'Piezas 1,00',
dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'MF25') AS 'Piezas 0,50',
dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'MF22') AS 'Piezas 0,10',
dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'MF21') AS 'Piezas 0,05',
dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF2') AS 'Piezas 50',
dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF20') AS 'Piezas 2',
dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF21') AS 'Piezas 5',
dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF22') AS 'Piezas 10',
dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF23') AS 'Piezas 20',
dbo.getPiezasByRuta(Ruta.RutaID,Biblia.PuntoID,1,'BF5') AS 'Piezas 100'
FROM   Punto
JOIN   Biblia 
ON     Biblia.PuntoID = Punto.PuntoID
JOIN   Ruta
ON     Ruta.Nombre = Biblia.Ruta
WHERE Ruta.RutaID = @RutaID

GROUP  BY Punto.Nombre,
		   Ruta.RutaID, 
		   Ruta.Fecha, 
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,	
		  Biblia.PuntoID

ORDER BY Biblia.PuntoID


END


GO
/****** Object:  StoredProcedure [dbo].[rptRutaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[rptRutaSalida]
	@RutaID INT
AS
BEGIN
SET DATEFORMAT DMY
	SET LANGUAGE Spanish

	SELECT Ruta.RutaID, 
           CONVERT(VARCHAR,Ruta.Fecha,105)  as 'Fecha',
		   DATENAME(DW,Ruta.Fecha) AS DIA,
           CONVERT(VARCHAR(8),Ruta.FechaDespachada,108)  as 'Hora',
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,
		   Consignatario.Nombre AS Estaciones,
		   Consignatario.PuntoID,
		   COUNT(Distinct Envase.EnvaseID) AS Envases,
		   SUM(Envase_Efectivo.Piezas) AS PiezasProcesada,
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '1,00',
		   (SELECT SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS 'Piezas 1,00',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,50',

			(SELECT SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS 'Piezas 0,50',
		   
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,10',
			(SELECT SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS 'Piezas 0,10',
		 
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,05',
		   (SELECT SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS 'Piezas 0,05',

           

		   REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   				  FROM   CartaPorte_Punto Grupo
						  WHERE  Grupo.TIPO = 2
						  AND    Grupo.PuntoID = Consignatario.PuntoID
						  AND    EXISTS (SELECT *
										 FROM   Ruta_CartaPorte d
										 WHERE  d.CartaPorteID = Grupo.CartaPorteID
										 AND    d.RutaID = Ruta_CartaPorte.RutaID
										 AND    d.TIPO = 1)
						  FOR XML PATH (''))),' ',' - ') AS Cartaportes,
dbo.getPlomosByEnvase(Ruta.RutaID,Consignatario.PuntoID,1) AS Plomo

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Envase_Efectivo
	ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 1
	AND    Ruta.RutaID = @RutaID
	GROUP  BY Ruta_CartaPorte.RutaID,
		   Ruta.RutaID, 
		   Ruta.Fecha, 
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,	
		   Consignatario.Nombre,
		   Consignatario.PuntoID

	ORDER  BY Ruta.Nombre

END


GO
/****** Object:  StoredProcedure [dbo].[rptRutaSalidaMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
CREATE PROCEDURE [dbo].[rptRutaSalidaMC]
	@RutaID INT
AS
BEGIN
	SET DATEFORMAT DMY
	SET LANGUAGE Spanish

	SELECT Ruta.RutaID, 
           CONVERT(VARCHAR,Ruta.Fecha,105)  as 'Fecha',
		   DATENAME(DW,Ruta.Fecha) AS DIA,
           CONVERT(VARCHAR(8),Ruta.FechaDespachada,108)  as 'Hora',
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,
		   Consignatario.Nombre AS Estaciones,
		   Consignatario.PuntoID,
		   COUNT(Distinct EnvaseID) AS Envases,
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '1,00',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,50',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,10',
		   (SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    vwc.ConsignatarioID = Consignatario.PuntoID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO = 1)) AS '0,05',

		   REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   				  FROM   CartaPorte_Punto Grupo
						  WHERE  Grupo.TIPO = 2
						  AND    Grupo.PuntoID = Consignatario.PuntoID
						  AND    EXISTS (SELECT *
										 FROM   Ruta_CartaPorte d
										 WHERE  d.CartaPorteID = Grupo.CartaPorteID
										 AND    d.RutaID = Ruta_CartaPorte.RutaID
										 AND    d.TIPO = 1)
						  FOR XML PATH (''))),' ',' - ') AS Cartaportes,
dbo.getPlomosByEnvase(Ruta.RutaID,Biblia.PuntoID,1) AS Plomo,
		   Biblia.Secuencia
	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 1
	AND    Ruta.RutaID = @RutaID
	GROUP  BY Ruta_CartaPorte.RutaID,
		   Ruta.RutaID, 
		   Ruta.Fecha, 
		   Ruta.Nombre, 
		   Ruta.Turno, 
		   Ruta.LoginCreado, 
		   Ruta.FechaCreado, 
		   Ruta.OficialValores, 
		   Ruta.AuxiliarValores, 
		   Ruta.GuardiaCustoCaj, 
		   Ruta.OficialValoresID, 
		   Ruta.AuxiliarValoresID, 
		   Ruta.GuardiaCustoCajID, 
		   Ruta.OtroOficial, 
		   Ruta.OtroOficialID, 
		   Ruta.UnidadPlaca, 
		   Ruta.TotalCarteras, 
		   Ruta.TotalCambio, 
		   Ruta.KilometrosSalida, 
		   Ruta.KilometrosLlegada, 
		   Ruta.TotalKilometros, 
		   Ruta.Cerrada, 
		   Ruta.Despachada, 
		   Ruta.Recibida, 
		   Ruta.LoginCerrada, 
		   Ruta.FechaCerrada, 
		   Ruta.LoginDespachada, 
		   Ruta.FechaDespachada, 
		   Ruta.LoginRecibida,
		   Ruta.FechaRecibida,	
		   Consignatario.Nombre,
		   Consignatario.PuntoID,
	       Biblia.Secuencia,
		  Biblia.PuntoID
	ORDER  BY Ruta.Nombre,
		   Biblia.Secuencia

END
GO
/****** Object:  StoredProcedure [dbo].[Rubros_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Rubros_Get]
	
AS
BEGIN
	SET DATEFORMAT DMY

	SELECT Rubro.RubroID,
		   Rubro.Definicion
		  
		  
	FROM   Rubro

END





GO
/****** Object:  StoredProcedure [dbo].[Ruta_ABRIR]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[Ruta_ABRIR] 
	@RutaID INT
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION ruta 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[BOLSA]    ***********************/

	  BEGIN TRY 
          UPDATE Ruta 
		  SET    Cerrada = 'false',
				 FechaCerrada = NULL,
				 LoginCerrada = NULL
				
		  WHERE  RutaID = @RutaID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION ruta 
      ELSE 
        COMMIT TRANSACTION ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  





GO
/****** Object:  StoredProcedure [dbo].[Ruta_Actualizar_Cartaporte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Ruta_Actualizar_Cartaporte] 
	@CartaporteID VARCHAR(13),
	@RutaID INT
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION ruta 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 




	  BEGIN TRY 
          UPDATE Ruta_Cartaporte 
		  SET    RutaID = @RutaID
				
		  WHERE  CartaporteID = @CartaporteID

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION ruta 
      ELSE 
        COMMIT TRANSACTION ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  


GO
/****** Object:  StoredProcedure [dbo].[Ruta_Actualizar_Fecha]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Ruta_Actualizar_Fecha] 
	@Fecha VARCHAR(50),
	@RutaID INT
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION ruta 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 




	  BEGIN TRY 
          UPDATE Ruta
		  SET    Fecha = @Fecha
				
		  WHERE  RutaID = @RutaID

      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION ruta 
      ELSE 
        COMMIT TRANSACTION ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END  


GO
/****** Object:  StoredProcedure [dbo].[Ruta_CartaPorte_Insert]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 

-- ============================================= 
CREATE PROCEDURE [dbo].[Ruta_CartaPorte_Insert] 
	@RutaID INT,
	@CartaPorteID VARCHAR(13),
	@Tipo INT,
	@LoginCreado VARCHAR(50)
AS 

  BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION ruta_cartaporte 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
              @RutaSolicitud  VARCHAR(5000) ,
			  @EnvaseID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

	  /*******VALIDACIONES******/
	  IF @Tipo = 1
	  BEGIN
		IF NOT EXISTS(SELECT * 
					  FROM   Ruta
					  WHERE  Cerrada = 0
					  AND	 Recibida = 0
					  AND	 Despachada = 0
					  AND    RutaID = @RutaID)
		BEGIN
		   ROLLBACK TRANSACTION ruta_cartaporte 
		   SELECT @ERRORMESSAGE = 'Error: Esta ruta no esta disponibe para ser despachada',
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
		END
	  END
	  IF @Tipo = 2
	  BEGIN
		IF NOT EXISTS(SELECT * 
					  FROM   Ruta
					  WHERE  Cerrada = 0
					  AND	 Recibida = 1
					  AND	 Despachada = 1
					  AND    RutaID = @RutaID)
		BEGIN
		   ROLLBACK TRANSACTION ruta_cartaporte 
		   SELECT @ERRORMESSAGE = 'Error: Esta ruta no esta disponibe para  recibir',
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
		END
	  END


--/***********************    VERIFICAR SI SE ASIGNA A UNA RUTA    ***********************/

--SELECT @RutaSolicitud = CartaPorte.CartaPorteID FROM CartaPorte 
--JOIN Solicitud_CartaPorte
--ON Solicitud_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
--JOIN Solicitud
--ON Solicitud.SolicitudID = Solicitud_CartaPorte.SolicitudID
--JOIN Solicitud_Accion 
--ON Solicitud_Accion.SolicitudID = Solicitud.SolicitudID

--WHERE Solicitud_Accion.LoginCerrado =''
--AND Solicitud_Accion.Secuencia = 2

--IF (@CartaPorteID = @RutaSolicitud)
--	  BEGIN TRY 
--          UPDATE Solicitud_Accion
--          SET LoginCerrado = @LoginCreado,
--              FechaCerrado = getdate()
              
--      END TRY 
--      BEGIN CATCH 
--	      ROLLBACK TRANSACTION traspaso 
--	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
--			     @NUMERRORS = @NUMERRORS + 1
--		  SELECT @NUMERRORS     AS 'ErrorCount',
--				 CASE  ERROR_NUMBER()
--					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
--					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
--					ELSE @ERRORMESSAGE
--				 END AS 'ErrorMessage' 
--	      RETURN;
--      END CATCH 

      /**** ruta_cartaporte ****/ 
      BEGIN TRY 
          INSERT INTO Ruta_CartaPorte
                      (RutaID,
					   CartaPorteID,
					   Tipo) 
          VALUES      (@RutaID, 
					   @CartaPorteID,
					   @Tipo)
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION ruta_cartaporte 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION ruta_cartaporte 
      ELSE 
        COMMIT TRANSACTION ruta_cartaporte 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @EnvaseID AS 'Identity'
  END  





















GO
/****** Object:  StoredProcedure [dbo].[Ruta_CartaPortesDisponibles_GetBy_Boveda]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cartaporte
-- =============================================
CREATE PROCEDURE [dbo].[Ruta_CartaPortesDisponibles_GetBy_Boveda]
	@BovedaID INT,
	@CuentaID   INT = NULL
AS
BEGIN
	SET DATEFORMAT DMY
	IF(@CuentaID IS NULL)
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado
		FROM   CartaPorte	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 1 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID 
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
			AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
	END
	ELSE
	BEGIN
		SELECT CartaPorte.BovedaID AS BovedaID,
			   Cuenta.Nombre AS Cuenta,
			   Cuenta.CuentaID	AS  CuentaID,
			   Cuenta.Nombre	AS  CuentaNombre,
			   CartaPorte.CartaPorteID,
			   ConsignadorR.PuntoID AS ConsignadorID,
			   Consignador.Nombre AS Consignador,
			   ConsignadorR.Fecha AS ConsignadorFecha,
			   ConsignatarioR.PuntoID AS ConsignatarioID,
			   Consignatario.Nombre AS Consignatario,
			   ConsignatarioR.Fecha AS ConsignatarioFecha,
			   Monto,
			   CartaPorte.LoginCreado,
			   CartaPorte.LoginCerrado,		
	   		   CartaPorte.FechaCreado,
			   CartaPorte.FechaCerrado
		FROM   CartaPorte	
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 1 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		WHERE  CartaPorte.BovedaID = @BovedaID 
		AND    NOT EXISTS(SELECT * 
						  FROM   Traspaso
						  JOIN   Traspaso_CartaPorte
						  ON     Traspaso.TraspasoID = Traspaso_CartaPorte.TraspasoID
						  WHERE  Traspaso.Recibido = 0
						  AND    Traspaso_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    NOT EXISTS(SELECT * 
						  FROM   Ruta
						  JOIN   Ruta_CartaPorte
						  ON     Ruta.RutaID = Ruta_CartaPorte.RutaID
						  WHERE  Ruta_CartaPorte.Tipo = 1
						  AND    Ruta.Despachada = 0
						  AND    Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID )
		AND    CartaPorte.CuentaID = @CuentaID

	END
END

GO
/****** Object:  StoredProcedure [dbo].[Ruta_CERRAR]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Ruta_CERRAR] 
	@RutaID INT,
	@Login  VARCHAR(30),
    @TipoRuta VARCHAR(30),
	@CartaPortesNoEntregados VARCHAR(MAX) = NULL,
	@CartaPortesNoEntregadosSistema VARCHAR(MAX) = NULL
AS 
  BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Ruta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 


/***********************    VALIDACIONES:[NRO DE CARTAS DE PORTE]    ***********************/

	  IF NOT EXISTS(SELECT * 
			        FROM   Ruta
					WHERE  RutaID = @RutaID
					AND    Cerrada = 0
					AND	Recibida = 1
					AND	Despachada = 1)
        BEGIN 
		   ROLLBACK TRANSACTION Ruta 
		   SELECT @ERRORMESSAGE = 'Error: No Existe una ruta: ' +  CAST(@RutaID AS VARCHAR) + ', por cerrar.',
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
        END 



/***********************    UDATE:[RUTA]    ***********************/

	  BEGIN TRY 
		  IF(@CartaPortesNoEntregados IS NOT NULL AND @TipoRuta = 'MC')
			
				  BEGIN 
					  INSERT INTO Ruta_CartaPorte
							(RutaID, 
							 CartaPorteID, 
							 Tipo)
					  SELECT @RutaID, 
							 CartaPorteID, 
							 2				      
					  FROM   CartaPorte
					  WHERE  CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (@CartaPortesNoEntregados))
				  END
		  ELSE
				  BEGIN
				      INSERT INTO Ruta_CartaPorte
							(RutaID, 
							 CartaPorteID, 
							 Tipo)
					  SELECT @RutaID, 
							 CartaPorteID, 
							 2				      
					  FROM   CartaPorte
					  WHERE  CartaPorteID IN (SELECT * FROM dbo.list_to_car (@CartaPortesNoEntregados))
					  
				  END
		IF(@CartaPortesNoEntregadosSistema IS NOT NULL AND @TipoRuta = 'MC')
			
				  BEGIN 
					  INSERT INTO Ruta_CartaPorte
							(RutaID, 
							 CartaPorteID, 
							 Tipo)
					  SELECT @RutaID, 
							 CartaPorteID, 
							 2				      
					  FROM   CartaPorte
					  WHERE  CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (@CartaPortesNoEntregadosSistema))
				  END
		  ELSE
				  BEGIN
				      INSERT INTO Ruta_CartaPorte
							(RutaID, 
							 CartaPorteID, 
							 Tipo)
					  SELECT @RutaID, 
							 CartaPorteID, 
							 2				      
					  FROM   CartaPorte
					  WHERE  CartaPorteID IN (SELECT * FROM dbo.list_to_car (@CartaPortesNoEntregadosSistema))
					  
				  END
				  
			IF(@CartaPortesNoEntregados IS NOT NULL)
		  BEGIN
		  UPDATE Envase
				
          SET    Envase.NroPlomo = 'DEV'
		  FROM   Envase
		  JOIN   CartaPorte
		  on     CartaPorte.CartaPorteID = Envase.CartaPorteID
		  WHERE  CartaPorte.CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (@CartaPortesNoEntregados))
		  
		  IF(@CartaPortesNoEntregadosSistema IS NOT NULL)
		  BEGIN
		  UPDATE Envase
				
          SET    Envase.NroPlomo = 'N/A'
		  FROM   Envase
		  JOIN   CartaPorte
		  on     CartaPorte.CartaPorteID = Envase.CartaPorteID
		  WHERE  CartaPorte.CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (@CartaPortesNoEntregadosSistema))
		  
		 
			END 
		  
		 
			END 
          UPDATE Ruta
				
          SET    Cerrada = 1,
				 LoginCerrada = @Login,
				 FechaCerrada = GetDate()
		  WHERE  RutaID = @RutaID
		  
		  
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    UDATE:CARTAPORTES    ***********************/

	  BEGIN TRY 
		
          UPDATE CartaPorte
		  SET    Cerrado = 1,
				 LoginCerrado = @Login,
				 FechaCerrado = GetDate()
		  WHERE  EXISTS (SELECT *
					     FROM   Ruta_cartaporte
						 WHERE  Ruta_cartaporte.RutaID = @RutaID
						 AND    Ruta_cartaporte.Tipo = 1
						 AND    Ruta_cartaporte.CartaPorteID = CartaPorte.CartaPorteID
						 AND    Ruta_cartaporte.CartaPorteID NOT IN (SELECT * FROM dbo.list_to_tbl (ISNULL(@CartaPortesNoEntregados,''))))

		 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Ruta 
      ELSE 
        COMMIT TRANSACTION Ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
			 
  END  



GO
/****** Object:  StoredProcedure [dbo].[Ruta_CERRAR_New]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Ruta_CERRAR_New] 
	@RutaID INT,
	@Login  VARCHAR(30),
    @TipoRuta VARCHAR(30),
    @CartaPortesEntregaDirecta VARCHAR(MAX) = NULL,
	@CartaPortesEntregados VARCHAR(MAX) = NULL,
	@CartaPortesEntregadosSistema VARCHAR(MAX) = NULL,
	@CartaPortesEntregadosCliente VARCHAR(MAX) = NULL
	
AS 
  BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Ruta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 


/***********************    VALIDACIONES:[NRO DE CARTAS DE PORTE]    ***********************/

	  IF NOT EXISTS(SELECT * 
			        FROM   Ruta
					WHERE  RutaID = @RutaID
					AND    Cerrada = 0
					AND	Recibida = 1
					AND	Despachada = 1)
        BEGIN 
		   ROLLBACK TRANSACTION Ruta 
		   SELECT @ERRORMESSAGE = 'Error: No Existe una ruta: ' +  CAST(@RutaID AS VARCHAR) + ', por cerrar.',
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
        END 



/***********************    UDATE:[RUTA]    ***********************/

	  BEGIN TRY 
		  
	
		  
		  IF(@CartaPortesEntregadosCliente IS NOT NULL)
			
				  BEGIN 
					  
					  INSERT INTO Ruta_CartaPorte
							(RutaID, 
							 CartaPorteID, 
							 Tipo)
					  SELECT @RutaID, 
							 CartaPorteID, 
							 2			      
					  FROM   CartaPorte
					  WHERE  CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (@CartaPortesEntregadosCliente))
				  END
		  
		
				  
		  IF(@CartaPortesEntregados IS NOT NULL)
		  BEGIN
		  UPDATE Envase
				
          SET    Envase.NroPlomo = 'N/A'
		  FROM   Envase
		  JOIN   CartaPorte
		  on     CartaPorte.CartaPorteID = Envase.CartaPorteID
		  WHERE  CartaPorte.CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (@CartaPortesEntregados))
		  
		  IF(@CartaPortesEntregadosSistema IS NOT NULL)
		  BEGIN
		  UPDATE Envase
				
          SET    Envase.NroPlomo = 'N/A'
		  FROM   Envase
		  JOIN   CartaPorte
		  on     CartaPorte.CartaPorteID = Envase.CartaPorteID
		  WHERE  CartaPorte.CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (@CartaPortesEntregadosSistema))
		  
		  IF(@CartaPortesEntregadosCliente IS NOT NULL)
		  BEGIN
		  UPDATE Envase
				
          SET    Envase.NroPlomo = 'DEV'
		  FROM   Envase
		  JOIN   CartaPorte
		  on     CartaPorte.CartaPorteID = Envase.CartaPorteID
		  WHERE  CartaPorte.CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (@CartaPortesEntregadosCliente))
		  
		  end	 
			END 
		  
		 
			END 
          UPDATE Ruta
				
          SET    Cerrada = 1,
				 LoginCerrada = @Login,
				 FechaCerrada = GetDate()
		  WHERE  RutaID = @RutaID
		  
		  
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    UDATE:CARTAPORTES    ***********************/

	  BEGIN TRY 
		
          UPDATE CartaPorte
		  SET    Cerrado = 1,
				 LoginCerrado = @Login,
				 FechaCerrado = GetDate()
		  WHERE  EXISTS (SELECT *
					     FROM   Ruta_cartaporte
						 WHERE  Ruta_cartaporte.RutaID = @RutaID
						 AND    Ruta_cartaporte.Tipo = 1
						 AND    Ruta_cartaporte.CartaPorteID = CartaPorte.CartaPorteID
						 AND    Ruta_cartaporte.CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (ISNULL(@CartaPortesEntregados,''))))
		UPDATE CartaPorte
		  SET    Cerrado = 1,
				 LoginCerrado = @Login,
				 FechaCerrado = GetDate()
		  WHERE  EXISTS (SELECT *
					     FROM   Ruta_cartaporte
						 WHERE  Ruta_cartaporte.RutaID = @RutaID
						 AND    Ruta_cartaporte.Tipo = 2
						 AND    Ruta_cartaporte.CartaPorteID = CartaPorte.CartaPorteID						 
						 AND    Ruta_cartaporte.CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (ISNULL(@CartaPortesEntregaDirecta,''))))
		IF(@CartaPortesEntregadosSistema IS NOT NULL)
		
		delete Ruta_CartaPorte	
		where  Ruta_cartaporte.CartaPorteID IN (SELECT * FROM dbo.list_to_tbl (@CartaPortesEntregadosSistema))
		
		

		 
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Ruta 
      ELSE 
        COMMIT TRANSACTION Ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
			 
  END  


GO
/****** Object:  StoredProcedure [dbo].[Ruta_CERRAR_OLD]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO














-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
CREATE PROCEDURE [dbo].[Ruta_CERRAR_OLD] 
	@RutaID INT,
	@Login  VARCHAR(30),
	@CartaPortesNoEntregados VARCHAR(MAX) = NULL
AS 
  BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Ruta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 


/***********************    VALIDACIONES:[NRO DE CARTAS DE PORTE]    ***********************/

	  IF NOT EXISTS(SELECT * 
			        FROM   Ruta
					WHERE  RutaID = @RutaID
					AND    Cerrada = 0
					AND	Recibida = 1
					AND	Despachada = 1)
        BEGIN 
		   ROLLBACK TRANSACTION Ruta 
		   SELECT @ERRORMESSAGE = 'Error: No Existe una ruta: ' +  CAST(@RutaID AS VARCHAR) + ', por cerrar.',
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
        END 



/***********************    UDATE:[RUTA]    ***********************/

	  BEGIN TRY 
          UPDATE Ruta
				
          SET    Cerrada = 1,
				 LoginCerrada = @Login,
				 FechaCerrada = GetDate()
		  WHERE  RutaID = @RutaID
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 

/***********************    UDATE:CARTAPORTES    ***********************/

	  BEGIN TRY 
          UPDATE CartaPorte
		  SET    Cerrado = 1,
				 LoginCerrado = @Login,
				 FechaCerrado = GetDate()
		  WHERE  EXISTS (SELECT *
					     FROM   Ruta_cartaporte
						 WHERE  Ruta_cartaporte.RutaID = @RutaID
						 AND    Ruta_cartaporte.Tipo = 1
						 AND    Ruta_cartaporte.CartaPorteID = CartaPorte.CartaPorteID
						 AND    Ruta_cartaporte.CartaPorteID NOT IN (ISNULL(@CartaPortesNoEntregados,0)))

		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Ruta 
      ELSE 
        COMMIT TRANSACTION Ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
			 
  END  










































GO
/****** Object:  StoredProcedure [dbo].[Ruta_Despachar]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Ruta_Despachar] 
	@RutaID INT,
	@Nombre VARCHAR(50),
	@Turno CHAR(2) = NULL, 
	@OficialValores VARCHAR(50) = NULL, 
	@AuxiliarValores VARCHAR(50) = NULL, 
	@GuardiaCustoCaj VARCHAR(50) = NULL, 
	@OficialValoresID INT = NULL, 
	@AuxiliarValoresID INT = NULL, 
	@GuardiaCustoCajID INT = NULL, 
	@OtroOficial VARCHAR(50) = NULL, 
	@OtroOficialID INT = NULL, 
	@UnidadPlaca VARCHAR(30) = NULL,
	@KilometrosSalida DECIMAL(18,2) = NULL,
	@LoginDespachada VARCHAR(30)
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Ruta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 

/***********************    VALIDACIONES:[OFICIALES]    ***********************/

--		IF EXISTS(SELECT * 
--					FROM   Ruta
--					WHERE  recibida = 'false'
--					AND    UnidadPlaca = @UnidadPlaca)
--        BEGIN 
--		   ROLLBACK TRANSACTION Ruta 
--		   SELECT @ERRORMESSAGE = 'Error: No Puede crear la ruta ya que el camion con la placa numero : ' +  @UnidadPlaca + ', ya se encuentra en una ruta para esta fecha.',
--				  @NUMERRORS = @NUMERRORS + 1
--		   SELECT @NUMERRORS     AS 'ErrorCount', 
--                  @ERRORMESSAGE AS 'ErrorMessage'
--		   RETURN
--        END 

		--IF EXISTS(SELECT * 
		--			FROM   Ruta
		--			WHERE  recibida = 'false'
		--			AND     OficialValoresID = @OficialValoresID
		--			AND     OficialValoresID <> 1)
  --      BEGIN 
		--   ROLLBACK TRANSACTION Ruta 
		--   SELECT @ERRORMESSAGE = 'Error: No Puede crear la ruta ya que el transportista : ' +  @OficialValores + ', ya se encuentra en una ruta para esta fecha.',
		--		  @NUMERRORS = @NUMERRORS + 1
		--   SELECT @NUMERRORS     AS 'ErrorCount', 
  --                @ERRORMESSAGE AS 'ErrorMessage'
		--   RETURN
  --      END 

		--IF EXISTS(SELECT * 
		--			FROM   Ruta
		--			WHERE  recibida = 'false'
		--			AND	   AuxiliarValoresID = @AuxiliarValoresID
		--			AND     OficialValoresID <> 1)
  --      BEGIN 
		--   ROLLBACK TRANSACTION Ruta 
		--   SELECT @ERRORMESSAGE = 'Error: No Puede crear la ruta ya que el transportista : ' +  @AuxiliarValores + ',ya se encuentra en una ruta para esta fecha .',
		--		  @NUMERRORS = @NUMERRORS + 1
		--   SELECT @NUMERRORS     AS 'ErrorCount', 
  --                @ERRORMESSAGE AS 'ErrorMessage'
		--   RETURN
  --      END 

		--IF EXISTS(SELECT * 
		--			FROM   Ruta
		--			WHERE  recibida = 'false'
		--			AND	   GuardiaCustoCajID = @GuardiaCustoCajID
		--			AND     OficialValoresID <> 1)
  --      BEGIN 
		--   ROLLBACK TRANSACTION Ruta 
		--   SELECT @ERRORMESSAGE = 'Error: No Puede crear la ruta ya que el transportista : ' +  @GuardiaCustoCaj + ',ya se encuentra en una ruta para esta fecha .',
		--		  @NUMERRORS = @NUMERRORS + 1
		--   SELECT @NUMERRORS     AS 'ErrorCount', 
  --                @ERRORMESSAGE AS 'ErrorMessage'
		--   RETURN
  --      END 

		--IF EXISTS(SELECT * 
		--			FROM   Ruta
		--			WHERE  recibida = 'false'
		--			AND    OtroOficialID = @OtroOficialID
		--			AND     OficialValoresID <> 1)
  --      BEGIN 
		--   ROLLBACK TRANSACTION Ruta 
		--   SELECT @ERRORMESSAGE = 'Error: No Puede crear la ruta ya que el transportista : ' +  @OtroOficial + ',ya se encuentra en una ruta para esta fecha .',
		--		  @NUMERRORS = @NUMERRORS + 1
		--   SELECT @NUMERRORS     AS 'ErrorCount', 
  --                @ERRORMESSAGE AS 'ErrorMessage'
		--   RETURN
  --      END 


/***********************    VALIDACIONES:[NRO DE RUTA]    ***********************/

	  IF NOT EXISTS(SELECT * 
					FROM   Ruta
					WHERE  RutaID = @RutaID
					AND    Cerrada = 0
					AND	   Recibida = 0
					AND	   Despachada = 0)
        BEGIN 
		   ROLLBACK TRANSACTION Ruta 
		   SELECT @ERRORMESSAGE = 'Error: NO Existe una ruta Numero: ' +  CAST(@RutaID AS VARCHAR) + ', para despachar.',
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
        END 




/***********************    UPDATE:[RUTA]    ***********************/

	  BEGIN TRY 
          UPDATE   Ruta 
          SET	   OficialValores = @OficialValores, 
				   AuxiliarValores = @AuxiliarValores, 
				   GuardiaCustoCaj = @GuardiaCustoCaj, 
				   OficialValoresID =@OficialValoresID, 
				   AuxiliarValoresID = @AuxiliarValoresID, 
				   GuardiaCustoCajID = @GuardiaCustoCajID, 
				   OtroOficial = @OtroOficial, 
				   OtroOficialID = @OtroOficialID, 
				   UnidadPlaca = @UnidadPlaca, 
				   Turno = @Turno, 
				   KilometrosSalida = @KilometrosSalida, 
				   Nombre = @Nombre,
				   LoginDespachada = @LoginDespachada,
				   FechaDespachada = GetDate(),
				   Despachada = 1 
		WHERE      RutaID = @RutaID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Ruta 
      ELSE 
        COMMIT TRANSACTION Ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END


GO
/****** Object:  StoredProcedure [dbo].[Ruta_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[Ruta_Get]
	@RutaID INT,
	@Tipo   CHAR(4) =  NULL
AS
BEGIN
	 SET DATEFORMAT DMY
	 SET LANGUAGE Spanish
	 IF(@TIPO = 'MC_S')

	 BEGIN
		SELECT Ruta.RutaID, 
			   Ruta.Fecha, 
			   Ruta.Nombre, 
			   Ruta.Turno, 
			   Ruta.LoginCreado, 
			   Ruta.FechaCreado, 
			   Ruta.OficialValores, 
			   Ruta.AuxiliarValores, 
			   Ruta.GuardiaCustoCaj, 
			   Ruta.OficialValoresID, 
			   Ruta.AuxiliarValoresID, 
			   Ruta.GuardiaCustoCajID, 
			   Ruta.OtroOficial, 
			   Ruta.OtroOficialID, 
			   Ruta.UnidadPlaca, 
			   Ruta.TotalCarteras, 
			   Ruta.TotalCambio, 
			   Ruta.KilometrosSalida, 
			   Ruta.KilometrosLlegada, 
			   Ruta.TotalKilometros, 
			   Ruta.Cerrada, 
			   Ruta.Despachada, 
			   Ruta.Recibida, 
			   Ruta.LoginCerrada, 
			   Ruta.FechaCerrada, 
			   Ruta.LoginDespachada, 
			   Ruta.FechaDespachada, 
			   Ruta.LoginRecibida,
			   Ruta.FechaRecibida

			   ,Consignatario.Nombre AS Estaciones,
			   Consignatario.PuntoID,
			   COUNT(Distinct EnvaseID) AS Envases,
			   (SELECT COUNT(*) 
			   FROM   Envase_Efectivo b
			   JOIN   Envase c
			   ON     b.EnvaseID = c.EnvaseID
			   WHERE  b.EfectivoID = 'MF26'
			   AND    EXISTS (SELECT *
							  FROM   Ruta_CartaPorte d
							  WHERE  d.CartaPorteID = c.CartaPorteID
							  AND    d.RutaID = Ruta_CartaPorte.RutaID
							  AND    d.TIPO = 2)) AS '1,00',
			   (SELECT COUNT(*) 
			   FROM   Envase_Efectivo b
			   JOIN   Envase c
			   ON     b.EnvaseID = c.EnvaseID
			   WHERE  b.EfectivoID = 'MF25'
			   AND    EXISTS (SELECT *
							  FROM   Ruta_CartaPorte d
							  WHERE  d.CartaPorteID = c.CartaPorteID
							  AND    d.RutaID = Ruta_CartaPorte.RutaID
							  AND    d.TIPO = 2)) AS '0,50',
			   (SELECT COUNT(*) 
			   FROM   Envase_Efectivo b
			   JOIN   Envase c
			   ON     b.EnvaseID = c.EnvaseID
			   WHERE  b.EfectivoID = 'MF22'
			   AND    EXISTS (SELECT *
							  FROM   Ruta_CartaPorte d
							  WHERE  d.CartaPorteID = c.CartaPorteID
							  AND    d.RutaID = Ruta_CartaPorte.RutaID
							  AND    d.TIPO = 2)) AS '0,10',


			   REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
				   			  FROM   CartaPorte_Punto Grupo
							  WHERE  Grupo.TIPO = 2
							  AND    Grupo.PuntoID = Consignatario.PuntoID
							  AND    EXISTS (SELECT *
											 FROM   Ruta_CartaPorte d
											 WHERE  d.CartaPorteID = Grupo.CartaPorteID
											 AND    d.RutaID = Ruta_CartaPorte.RutaID
											 AND    d.TIPO = 2)
							  FOR XML PATH (''))),' ',' - ') AS Cartaportes

		FROM   Ruta_CartaPorte
		JOIN   CartaPorte	
		ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
		JOIN   Envase
		ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
		JOIN   Cuenta
		ON	   CartaPorte.CuentaID = Cuenta.CuentaID
		JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 1 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		JOIN   Ruta
		ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
		WHERE  Ruta_CartaPorte.TIPO = 2
		AND    Ruta.RutaID = @RutaID
		GROUP  BY Ruta_CartaPorte.RutaID,
			   Ruta.RutaID, 
			   Ruta.Fecha, 
			   Ruta.Nombre, 
			   Ruta.Turno, 
			   Ruta.LoginCreado, 
			   Ruta.FechaCreado, 
			   Ruta.OficialValores, 
			   Ruta.AuxiliarValores, 
			   Ruta.GuardiaCustoCaj, 
			   Ruta.OficialValoresID, 
			   Ruta.AuxiliarValoresID, 
			   Ruta.GuardiaCustoCajID, 
			   Ruta.OtroOficial, 
			   Ruta.OtroOficialID, 
			   Ruta.UnidadPlaca, 
			   Ruta.TotalCarteras, 
			   Ruta.TotalCambio, 
			   Ruta.KilometrosSalida, 
			   Ruta.KilometrosLlegada, 
			   Ruta.TotalKilometros, 
			   Ruta.Cerrada, 
			   Ruta.Despachada, 
			   Ruta.Recibida, 
			   Ruta.LoginCerrada, 
			   Ruta.FechaCerrada, 
			   Ruta.LoginDespachada, 
			   Ruta.FechaDespachada, 
			   Ruta.LoginRecibida,
			   Ruta.FechaRecibida,	
			   Consignatario.Nombre,
			   Consignatario.PuntoID
	 END
     ELSE
	 BEGIN
		 SELECT RutaID, 
				OficialValores, 
				AuxiliarValores, 
				GuardiaCustoCaj, 
				OficialValoresID, 
				AuxiliarValoresID, 
				GuardiaCustoCajID, 
				OtroOficial, 
				OtroOficialID, 
				UnidadPlaca, 
				Turno, 
				TotalCarteras, 
				TotalCambio, 
				KilometrosSalida, 
				KilometrosLlegada, 
				TotalKilometros, 
				Nombre, 
				LoginCreado, 
				FechaCreado, 
				Cerrada, 
				Despachada, 
				Recibida, 
				LoginCerrada, 
				FechaCerrada, 
				LoginDespachada, 
				FechaDespachada, 
				LoginRecibida, 
				FechaRecibida ,
				Fecha,
				/*PARA VISTAS*/
				DATENAME(DW,Fecha) AS DIA
		 FROM   Ruta
		 WHERE  @RutaID = RutaID
	 END
END



GO
/****** Object:  StoredProcedure [dbo].[Ruta_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Ruta_INSERT] 
	@Fecha VARCHAR(10), 
	@Nombre VARCHAR(50),
	@Turno CHAR(2) = NULL, 
	@OficialValores VARCHAR(50) = NULL, 
	@AuxiliarValores VARCHAR(50) = NULL, 
	@GuardiaCustoCaj VARCHAR(50) = NULL, 
	@OficialValoresID INT = NULL, 
	@AuxiliarValoresID INT = NULL, 
	@GuardiaCustoCajID INT = NULL, 
	@OtroOficial VARCHAR(50) = NULL, 
	@OtroOficialID INT = NULL, 
	@UnidadPlaca VARCHAR(30) = NULL,
	@KilometrosSalida DECIMAL(18,2) = NULL,
	@LoginCreado VARCHAR(30)
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Ruta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @RutaID INT 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 


/***********************    VALIDACIONES:[NRO DE CARTAS DE PORTE]    ***********************/
--
--	  IF EXISTS(SELECT * 
--			    FROM   Ruta
--				WHERE  FechaDespachada IS NULL
--				AND    Nombre = @Nombre)
--        BEGIN 
--		   ROLLBACK TRANSACTION Ruta 
--		   SELECT @ERRORMESSAGE = 'Error: Existe una ruta: ' +  @Nombre + ', sin despachar.',
--				  @NUMERRORS = @NUMERRORS + 1
--		   SELECT @NUMERRORS     AS 'ErrorCount', 
--                  @ERRORMESSAGE AS 'ErrorMessage'
--		   RETURN
--        END 




/***********************    INSERT:[CARTA DE PORTE]    ***********************/

	  BEGIN TRY 
          INSERT INTO Ruta
					  (Fecha,
				       OficialValores, 
					   AuxiliarValores, 
					   GuardiaCustoCaj, 
					   OficialValoresID, 
					   AuxiliarValoresID, 
					   GuardiaCustoCajID, 
					   OtroOficial, 
					   OtroOficialID, 
					   UnidadPlaca, 
					   Turno, 
					   KilometrosSalida, 
					   Nombre,
					   LoginCreado,
					   FechaCreado) 
          VALUES      (@Fecha,
				       @OficialValores, 
					   @AuxiliarValores, 
					   @GuardiaCustoCaj, 
					   @OficialValoresID, 
					   @AuxiliarValoresID, 
					   @GuardiaCustoCajID, 
					   @OtroOficial, 
					   @OtroOficialID, 
					   @UnidadPlaca, 
					   @Turno, 
					   @KilometrosSalida, 
					   @Nombre,
					   UPPER(@LoginCreado),
					   GetDate()) 
		SET @RutaID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Ruta 
      ELSE 
        COMMIT TRANSACTION Ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @RutaID   AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Ruta_PreDespachar]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
CREATE PROCEDURE [dbo].[Ruta_PreDespachar] 
	@RutaID INT,
	@OficialValores VARCHAR(50) = NULL, 
	@AuxiliarValores VARCHAR(50) = NULL, 
	@GuardiaCustoCaj VARCHAR(50) = NULL, 
	@OficialValoresID INT = NULL, 
	@AuxiliarValoresID INT = NULL, 
	@GuardiaCustoCajID INT = NULL, 
	@OtroOficial VARCHAR(50) = NULL, 
	@OtroOficialID INT = NULL, 
	@UnidadPlaca VARCHAR(30) = NULL,
	@LoginDespachada VARCHAR(30)
AS
BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Ruta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 


/***********************    VALIDACIONES:[NRO DE RUTA]    ***********************/

	  IF NOT EXISTS(SELECT * 
					FROM   Ruta
					WHERE  RutaID = @RutaID
					AND    Cerrada = 0
					AND	   Recibida = 0
					AND	   Despachada = 0)
        BEGIN 
		   ROLLBACK TRANSACTION Ruta 
		   SELECT @ERRORMESSAGE = 'Error: NO Existe una ruta Numero: ' +  CAST(@RutaID AS VARCHAR) + ', para despachar.',
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
        END 




/***********************    UPDATE:[RUTA]    ***********************/

	  BEGIN TRY 
          UPDATE   Ruta 
          SET	   OficialValores = @OficialValores, 
				   AuxiliarValores = @AuxiliarValores, 
				   GuardiaCustoCaj = @GuardiaCustoCaj, 
				   OficialValoresID =@OficialValoresID, 
				   AuxiliarValoresID = @AuxiliarValoresID, 
				   GuardiaCustoCajID = @GuardiaCustoCajID, 
				   OtroOficial = @OtroOficial, 
				   OtroOficialID = @OtroOficialID, 
				   UnidadPlaca = @UnidadPlaca,
				   LoginDespachada = @LoginDespachada
		WHERE      RutaID = @RutaID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Ruta 
      ELSE 
        COMMIT TRANSACTION Ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END






GO
/****** Object:  StoredProcedure [dbo].[Ruta_RECIBIR]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











-- ============================================= 
-- Author:    Juan, Godoy   

-- Description:  Ruta
-- ============================================= 
CREATE PROCEDURE [dbo].[Ruta_RECIBIR] 
	@RutaID INT,
	@KilometrosLlegada DECIMAL(18,2),
	@TotalKilometros DECIMAL(18,2),  
	@Nombre VARCHAR(50),
	@LoginRecibida VARCHAR(30)
AS 
  BEGIN 
      SET NOCOUNT ON
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION Ruta 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 


/***********************    VALIDACIONES:[NRO DE CARTAS DE PORTE]    ***********************/

	  IF NOT EXISTS(SELECT * 
			        FROM   Ruta
					WHERE  RutaID = @RutaID
					AND    Cerrada = 0
					AND	Recibida = 0
					AND	Despachada = 1)
        BEGIN 
		   ROLLBACK TRANSACTION Ruta 
		   SELECT @ERRORMESSAGE = 'Error: No Existe una ruta: ' +  CAST(@RutaID AS VARCHAR) + ', por recibir.',
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN
        END 




/***********************    UDATE:[RUTA]    ***********************/

	  BEGIN TRY 
          UPDATE  Ruta
				
          SET        KilometrosLlegada = @KilometrosLlegada, 
					 TotalKilometros = @TotalKilometros, 
					 Nombre =  @Nombre,
					 LoginRecibida = @LoginRecibida,
					 FechaRecibida = GetDate() ,
					 Recibida = 1
		  WHERE      RutaID = @RutaID
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION Ruta 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 



/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION Ruta 
      ELSE 
        COMMIT TRANSACTION Ruta 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
			 
  END  







































GO
/****** Object:  StoredProcedure [dbo].[RutaByCartaporte_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[RutaByCartaporte_Get]
@CartaporteID VARCHAR(13)
AS

BEGIN
	 SET DATEFORMAT DMY
	 	 SELECT Ruta.RutaID, 
			Ruta.Fecha
	 FROM   Ruta
	 JOIN   Ruta_Cartaporte
	 ON     Ruta_Cartaporte.RutaID = Ruta.RutaID
	 WHERE  Ruta_Cartaporte.CartaporteID = @CartaporteID

	
END




GO
/****** Object:  StoredProcedure [dbo].[RutasPorCerrar_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[RutasPorCerrar_Get]
AS
BEGIN
	 SET DATEFORMAT DMY
	 SELECT RutaID, 
			OficialValores, 
			AuxiliarValores, 
			GuardiaCustoCaj, 
			OficialValoresID, 
			AuxiliarValoresID, 
			GuardiaCustoCajID, 
			OtroOficial, 
			OtroOficialID, 
			UnidadPlaca, 
			Turno, 
			TotalCarteras, 
			TotalCambio, 
			KilometrosSalida, 
			KilometrosLlegada, 
			TotalKilometros, 
			Nombre, 
			LoginCreado, 
			FechaCreado, 
			Cerrada, 
			Despachada, 
			Recibida, 
			LoginCerrada, 
			FechaCerrada, 
			LoginDespachada, 
			FechaDespachada, 
			LoginRecibida, 
			FechaRecibida  ,
			Fecha
	 FROM   Ruta
	 WHERE  Cerrada = 0
	 AND	Recibida = 1
	 AND	Despachada = 1
	
END




GO
/****** Object:  StoredProcedure [dbo].[RutasPorCerrarVab_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[RutasPorCerrarVab_Get]
AS
BEGIN
	 SET DATEFORMAT DMY
	 SELECT RutaID, 
			OficialValores, 
			AuxiliarValores, 
			GuardiaCustoCaj, 
			OficialValoresID, 
			AuxiliarValoresID, 
			GuardiaCustoCajID, 
			OtroOficial, 
			OtroOficialID, 
			UnidadPlaca, 
			Turno, 
			TotalCarteras, 
			TotalCambio, 
			KilometrosSalida, 
			KilometrosLlegada, 
			TotalKilometros, 
			Nombre, 
			LoginCreado, 
			FechaCreado, 
			Cerrada, 
			Despachada, 
			Recibida, 
			LoginCerrada, 
			FechaCerrada, 
			LoginDespachada, 
			FechaDespachada, 
			LoginRecibida, 
			FechaRecibida  ,
			Fecha
	 FROM   Ruta
	 WHERE  Cerrada = 0
	 AND	Recibida = 1
	 AND	Despachada = 1
and    SUBSTRING(Nombre, 1, 4) in('vab ','MLTe')
and    SUBSTRING(Nombre, 1, 4) <> 'vabt'

	
END




GO
/****** Object:  StoredProcedure [dbo].[RutasPorDespachar_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[RutasPorDespachar_Get]
AS
BEGIN
	 SET DATEFORMAT DMY
	 SELECT RutaID, 
			OficialValores, 
			AuxiliarValores, 
			GuardiaCustoCaj, 
			OficialValoresID, 
			AuxiliarValoresID, 
			GuardiaCustoCajID, 
			OtroOficial, 
			OtroOficialID, 
			UnidadPlaca, 
			Turno, 
			TotalCarteras, 
			TotalCambio, 
			KilometrosSalida, 
			KilometrosLlegada, 
			TotalKilometros,  
			Nombre, 
			LoginCreado, 
			FechaCreado, 
			Cerrada, 
			Despachada, 
			Recibida, 
			LoginCerrada, 
			FechaCerrada, 
			LoginDespachada, 
			FechaDespachada, 
			LoginRecibida, 
			FechaRecibida  ,
			Fecha
	 FROM   Ruta
	 WHERE  Cerrada = 0
	 AND	Recibida = 0
	 AND	Despachada = 0
	
END




GO
/****** Object:  StoredProcedure [dbo].[RutasPorDespacharVab_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[RutasPorDespacharVab_Get]
AS
BEGIN
	 SET DATEFORMAT DMY
	 SELECT RutaID, 
			OficialValores, 
			AuxiliarValores, 
			GuardiaCustoCaj, 
			OficialValoresID, 
			AuxiliarValoresID, 
			GuardiaCustoCajID, 
			OtroOficial, 
			OtroOficialID, 
			UnidadPlaca, 
			Turno, 
			TotalCarteras, 
			TotalCambio, 
			KilometrosSalida, 
			KilometrosLlegada, 
			TotalKilometros,  
			Nombre, 
			LoginCreado, 
			FechaCreado, 
			Cerrada, 
			Despachada, 
			Recibida, 
			LoginCerrada, 
			FechaCerrada, 
			LoginDespachada, 
			FechaDespachada, 
			LoginRecibida, 
			FechaRecibida  ,
			Fecha
	 FROM   Ruta
	 WHERE  Cerrada = 0
	 AND	Recibida = 0
	 AND	Despachada = 0
and    SUBSTRING(Nombre, 1, 4) in('vab ','vabt','MLTe')

	
END




GO
/****** Object:  StoredProcedure [dbo].[RutasPorRecibir_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[RutasPorRecibir_Get]
AS
BEGIN
	 SET DATEFORMAT DMY
	 SELECT RutaID, 
			OficialValores, 
			AuxiliarValores, 
			GuardiaCustoCaj, 
			OficialValoresID, 
			AuxiliarValoresID, 
			GuardiaCustoCajID, 
			OtroOficial, 
			OtroOficialID, 
			UnidadPlaca, 
			Turno, 
			TotalCarteras, 
			TotalCambio, 
			KilometrosSalida, 
			KilometrosLlegada, 
			TotalKilometros, 

			Nombre, 
			LoginCreado, 
			FechaCreado, 
			Cerrada, 
			Despachada, 
			Recibida, 
			LoginCerrada, 
			FechaCerrada, 
			LoginDespachada, 
			FechaDespachada, 
			LoginRecibida, 
			FechaRecibida  ,
			Fecha
	 FROM   Ruta
	 WHERE  Cerrada = 0
	 AND	Recibida = 0
	 AND	Despachada = 1
	
END



GO
/****** Object:  StoredProcedure [dbo].[RutasPorRecibirEntubado_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[RutasPorRecibirEntubado_Get]
AS
BEGIN
	 SET DATEFORMAT DMY
	 SELECT RutaID, 
			OficialValores, 
			AuxiliarValores, 
			GuardiaCustoCaj, 
			OficialValoresID, 
			AuxiliarValoresID, 
			GuardiaCustoCajID, 
			OtroOficial, 
			OtroOficialID, 
			UnidadPlaca, 
			Turno, 
			TotalCarteras, 
			TotalCambio, 
			KilometrosSalida, 
			KilometrosLlegada, 
			TotalKilometros, 

			Nombre, 
			LoginCreado, 
			FechaCreado, 
			Cerrada, 
			Despachada, 
			Recibida, 
			LoginCerrada, 
			FechaCerrada, 
			LoginDespachada, 
			FechaDespachada, 
			LoginRecibida, 
			FechaRecibida  ,
			Fecha
	 FROM   Ruta
	 WHERE  Cerrada = 0
	 AND	Recibida = 0
	 AND	Despachada = 1
	AND     Nombre IN ('vab 1','vab 2','vab 3','vab 4','vab 5','vabt 1','vabt 2','vabt 3','vabt 4','vabt 5','mc 1','mc 2','mc 3','mc 4')
	
END



GO
/****** Object:  StoredProcedure [dbo].[RutasPorRecibirVab_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[RutasPorRecibirVab_Get]
AS
BEGIN
	 SET DATEFORMAT DMY
	 SELECT RutaID, 
			OficialValores, 
			AuxiliarValores, 
			GuardiaCustoCaj, 
			OficialValoresID, 
			AuxiliarValoresID, 
			GuardiaCustoCajID, 
			OtroOficial, 
			OtroOficialID, 
			UnidadPlaca, 
			Turno, 
			TotalCarteras, 
			TotalCambio, 
			KilometrosSalida, 
			KilometrosLlegada, 
			TotalKilometros, 

			Nombre, 
			LoginCreado, 
			FechaCreado, 
			Cerrada, 
			Despachada, 
			Recibida, 
			LoginCerrada, 
			FechaCerrada, 
			LoginDespachada, 
			FechaDespachada, 
			LoginRecibida, 
			FechaRecibida  ,
			Fecha
	 FROM   Ruta
	 WHERE  Cerrada = 0
	 AND	Recibida = 0
	 AND	Despachada = 1
and    SUBSTRING(Nombre, 1, 4) in('vab ','vabt','MLTe')
END



GO
/****** Object:  StoredProcedure [dbo].[RutasRecibidas_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		Juan Godoy

-- Description:	Obtener Cuentas
-- =============================================
CREATE PROCEDURE [dbo].[RutasRecibidas_Get]
AS
BEGIN
	 SET DATEFORMAT DMY
	 SELECT RutaID, 
			OficialValores, 
			AuxiliarValores, 
			GuardiaCustoCaj, 
			OficialValoresID, 
			AuxiliarValoresID, 
			GuardiaCustoCajID, 
			OtroOficial, 
			OtroOficialID, 
			UnidadPlaca, 
			Turno, 
			TotalCarteras, 
			TotalCambio, 
			KilometrosSalida, 
			KilometrosLlegada, 
			TotalKilometros, 
			Nombre, 
			LoginCreado, 
			FechaCreado, 
			Cerrada, 
			Despachada, 
			Recibida, 
			LoginCerrada, 
			FechaCerrada, 
			LoginDespachada, 
			FechaDespachada, 
			LoginRecibida, 
			FechaRecibida  ,
			Fecha
	 FROM   Ruta
	 WHERE  Cerrada = 0
	 AND	Recibida = 1
	 AND	Despachada = 1
	
END




GO
/****** Object:  StoredProcedure [dbo].[RutasRecibidasVab_Get]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[RutasRecibidasVab_Get]
AS
BEGIN
	 SET DATEFORMAT DMY
	 	 SELECT RutaID, 
			OficialValores, 
			AuxiliarValores, 
			GuardiaCustoCaj, 
			OficialValoresID, 
			AuxiliarValoresID, 
			GuardiaCustoCajID, 
			OtroOficial, 
			OtroOficialID, 
			UnidadPlaca, 
			Turno, 
			TotalCarteras, 
			TotalCambio, 
			KilometrosSalida, 
			KilometrosLlegada, 
			TotalKilometros, 
			Nombre, 
			LoginCreado, 
			FechaCreado, 
			Cerrada, 
			Despachada, 
			Recibida, 
			LoginCerrada, 
			FechaCerrada, 
			LoginDespachada, 
			FechaDespachada, 
			LoginRecibida, 
			FechaRecibida  ,
			Fecha
	 FROM   Ruta
	 
	 WHERE  Cerrada = 0
	 AND	Recibida = 1
	 AND	Despachada = 1
	 and    SUBSTRING(Nombre, 1, 4) in('vab ','vabt','MLTe')

	
END




GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Confirmar_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Solicitud_Confirmar_GET]
	@SolicitudID INT,
	@TraspasoID INT = NULL,
	@CartaporteID VARCHAR(13)= NULL
AS
BEGIN
	declare @efectivoenvase varchar(5),
	@montoenvase decimal(18,3),
	@efectivoenvase2 varchar(5),
	@montoenvase2 decimal(18,3)

IF(@CartaporteID != '')
	BEGIN
		SELECT  @efectivoenvase = solicitud_envase_efectivo.EfectivoID, @montoenvase = solicitud_envase_efectivo.monto 
		FROM solicitud_envase_efectivo
		JOIN Solicitud_envase
		ON  Solicitud_envase.envaseid = solicitud_envase_efectivo.envaseid
		WHERE Solicitud_envase.solicitudid = @SolicitudID
		
		SELECT @efectivoenvase2 = envase_efectivo.EfectivoID, @montoenvase2 = envase_efectivo.monto 
		FROM envase_efectivo
		JOIN envase
		ON  envase.envaseid = envase_efectivo.envaseid
		WHERE envase.cartaporteid = @CartaporteID
		
		IF(@efectivoenvase = @efectivoenvase2 AND @montoenvase = @montoenvase2) 
		BEGIN 

		SELECT SolicitudTipoID FROM solicitudTipo WHERE SolicitudTipoID = 1
		END
		ELSE
		
		SELECT SolicitudTipoID FROM solicitudTipo WHERE SolicitudTipoID = 2
	END
IF(@TraspasoID != '')
	BEGIN
		SELECT  @efectivoenvase = EfectivoID, @montoenvase = monto 
		FROM solicitud_envase_efectivo
		JOIN Solicitud_envase
		ON  Solicitud_envase.envaseid = solicitud_envase_efectivo.envaseid
		WHERE Solicitud_envase.solicitudid = @SolicitudID
		
		SELECT @efectivoenvase2 = envase_efectivo.EfectivoID, @montoenvase2 = envase_efectivo.monto 
		FROM envase_efectivo
		JOIN envase
		ON  envase.envaseid= envase_efectivo.envaseid
		JOIN cartaporte 
		ON cartaporte.cartaporteid = envase.cartaporteid
		JOIN traspaso_cartaporte
		ON  traspaso_cartaporte.cartaporteid = cartaporte.cartaporteid
		WHERE traspaso_cartaporte.traspasoid = @TraspasoID
		
		IF(@efectivoenvase = @efectivoenvase2 AND @montoenvase = @montoenvase2) 
		BEGIN 

		SELECT SolicitudTipoID FROM solicitudTipo WHERE SolicitudTipoID = 1
		END
		ELSE
		
		SELECT SolicitudTipoID FROM solicitudTipo WHERE SolicitudTipoID = 2
	END
	
END



GO
/****** Object:  StoredProcedure [dbo].[Solicitud_DELETE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Solicitud_DELETE] 
	@SolicitudID INT,
	@Login VARCHAR(30)
AS 
  BEGIN 
	SET nocount ON; 
	SET TRANSACTION ISOLATION LEVEL serializable 

	BEGIN TRANSACTION solicitud 

	SET DATEFORMAT DMY; 

	DECLARE @Aprobado BIT,
			@Descripcion VARCHAR(500), 
            @NUMERRORS     INT, 
            @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 
	

/***********************    VALIDACION:[SOLICITUD]    ***********************/
	  IF  EXISTS (SELECT *
					 FROM   Solicitud 
					 WHERE  Solicitud.StatusSolicitudID <> 1
				     AND    Solicitud.SolicitudID = @SolicitudID)
		BEGIN
			ROLLBACK TRANSACTION traspaso 
			SELECT @ERRORMESSAGE = 'Error: No puede eliminar esta solicitud, ya que fue procesada previamente.', 
				   @NUMERRORS = @NUMERRORS + 1
		    SELECT @NUMERRORS     AS 'ErrorCount', 
			  	   @ERRORMESSAGE  AS 'ErrorMessage'
			RETURN
		END

/***********************    ELIMINACION    ***********************/

	  BEGIN TRY 
          DELETE FROM solicitud 
		  WHERE  SolicitudID = @SolicitudID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION solicitud 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION solicitud 
      ELSE 
        COMMIT TRANSACTION solicitud 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
	END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Efectivo_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 22-11-2010 
-- Description:  Buscar operacion
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Efectivo_GET] 
	@SolicitudID INT

AS 
  BEGIN 
	
		SELECT  Solicitud_Efectivo.SolicitudID,
			    Solicitud_Efectivo.EfectivoID,
			    Solicitud_Efectivo.Piezas,
				Solicitud_Efectivo.Monto,
				Efectivo.Denominacion
				
		FROM	Solicitud_Efectivo

		JOIN    Solicitud 
		ON      Solicitud_Efectivo.SolicitudID = Solicitud.SolicitudID 
		
		JOIN    Efectivo
		ON      Solicitud_Efectivo.EfectivoID = Efectivo.EfectivoID 

		
		WHERE   Solicitud.SolicitudID = @SolicitudID
		

  END  


GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Efectivos_Envase_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- alter date: 22-11-2010 
-- Description:  Buscar operacion
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Efectivos_Envase_GET] 
	@EnvaseID INT

AS 
  BEGIN 
	
		SELECT  Solicitud_Envase_Efectivo.EfectivoID,
				Solicitud_Envase_Efectivo.EnvaseID,
				Solicitud_Envase_Efectivo.Monto,
				Solicitud_Envase_Efectivo.Piezas,
				Efectivo.Denominacion
				
		FROM	Solicitud_Envase_Efectivo
JOIN     Efectivo
ON    Efectivo.EfectivoID = Solicitud_Envase_Efectivo.EfectivoID

		
		WHERE   Solicitud_Envase_Efectivo.EnvaseID = @EnvaseID
		

  END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Efectivos_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 14-12-2010 
-- Description:  Agregar efectivo a la solicitud
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Efectivos_INSERT] 
	@EfectivoID VARCHAR(5),
	@SolicitudID INT,
	@Piezas INT,
	@Monto DECIMAL(18,3)
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION efectivo 

      SET DATEFORMAT DMY; 

      DECLARE @ID INT,
			  @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 

      /**** Guarda el efectivo  ****/ 
      BEGIN TRY 
          INSERT INTO Solicitud_Efectivo
                      (SolicitudID, 
					   EfectivoID,
					   Piezas,
					   Monto) 
          VALUES      (@SolicitudID, 
					   @EfectivoID,
					   @Piezas,
					   @Monto)
SET @SolicitudID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION efectivo 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 2627 THEN 'Error: Ya existe un registro con este numero de solicitud y la misma operacion.' 
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage'   
	      RETURN;
      END CATCH     

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION efectivo 
      ELSE 
        COMMIT TRANSACTION efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage',
			 @ID   AS 'Identity' 
  END  



GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Envase_Efectivo_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Agregar Efectivo al Envase 
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Envase_Efectivo_INSERT] 
	@EnvaseID	INT,
	@EfectivoID VARCHAR(5),
	@Piezas		INT,
	@Monto		DECIMAL(18,3)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION solicitud_envase_efectivo 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @SolicitudID VARCHAR(13),
			  @ClienteID     INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


	  SELECT @SolicitudID = Solicitud_Envase.SolicitudID,
			 @ClienteID     = Solicitud.ClienteID
      FROM   Solicitud_Envase
	  JOIN   Solicitud
	  ON     Solicitud_Envase.SolicitudID = Solicitud.SolicitudID 
	  WHERE  Solicitud_Envase.EnvaseID = @EnvaseID



	  IF (@ClienteID <> 1)
	  BEGIN
		  /**** Crea los efectivos  ****/ 
		  BEGIN TRY 
			  INSERT INTO Solicitud_Envase_Efectivo
						  (EnvaseID, 
						   EfectivoID, 
						   Piezas,
						   Monto) 
			  VALUES      (@EnvaseID, 
						   @EfectivoID, 
						   @Piezas,
						   @Monto)
		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION solicitud_envase_efectivo 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 @ERRORMESSAGE  AS 'ErrorMessage'   
			  RETURN
		  END CATCH     
	  END 
	  ELSE
	  BEGIN
		  IF NOT EXISTS(SELECT *
					    FROM   Solicitud_Envase_Efectivo
					    WHERE  EfectivoID = @EfectivoID
					    AND    EnvaseID = @EnvaseID)
		  BEGIN
			  /**** Crea los efectivos  ****/ 
			  BEGIN TRY 
				  INSERT INTO Solicitud_Envase_Efectivo
							  (EnvaseID, 
							   EfectivoID, 
							   Piezas,
							   Monto) 
				  VALUES      (@EnvaseID, 
							   @EfectivoID, 
							   @Piezas,
							   @Monto)
			  END TRY 
			  BEGIN CATCH 
				  ROLLBACK TRANSACTION solicitud_envase_efectivo 
				  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
						 @NUMERRORS = @NUMERRORS + 1
				  SELECT @NUMERRORS     AS 'ErrorCount',
						 @ERRORMESSAGE  AS 'ErrorMessage'   
				  RETURN
			  END CATCH 
		  END
	  END


      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION solicitud_envase_efectivo 
      ELSE 
        COMMIT TRANSACTION solicitud_envase_efectivo 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Envase_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- alter date: 22-11-2010 
-- Description:  Buscar operacion
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Envase_GET] 
	@SolicitudID INT

AS 
  BEGIN 
	
		SELECT  Solicitud_Envase.EnvaseID
				
		FROM	Solicitud_Envase


		
		WHERE   Solicitud_Envase.SolicitudID = @SolicitudID
		

  END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Envase_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Agregar envase a cartaporte
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Envase_INSERT] 
	@SolicitudID INT
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION envase 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000) ,
			  @EnvaseID		 INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 



      /**** Crea el envase ****/ 
      BEGIN TRY 
          INSERT INTO Solicitud_Envase
                      (SolicitudID) 
          VALUES      (@SolicitudID)
		  SET @EnvaseID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION envase 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION envase 
      ELSE 
        COMMIT TRANSACTION envase 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @EnvaseID AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 18-11-2010 
-- Description:  Buscar solicitud
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_GET] 
	@SolicitudID INT,
	@SolicitudTipoID INT = NULL
AS 
  BEGIN 
	IF (@SolicitudTipoID IS NULL)
	  BEGIN
		SELECT  Solicitud.SolicitudID,
				Solicitud.Tipo,
				Solicitud.CuentaID,
				Solicitud.BovedaID,
				Solicitud.ClienteID,
				Solicitud.ConsignadorID, 
				Solicitud.ConsignatarioID,
				Solicitud.SolicitudTipoID, 
				Solicitud.LoginCreado, 
				Solicitud.FechaCreado,
				StatusSolicitud.Descripcion AS Status, 
				Consignador.Nombre AS Consignador,
				Consignatario.Nombre AS Consignatario,
		--		Cliente.Descripcion AS nombrecliente,
				SolicitudTipo.descripcion AS solicitudtipo
		FROM	Solicitud
		JOIN    Punto Consignador
		ON      Solicitud.ConsignadorID = Consignador.PuntoID 
		JOIN    Punto Consignatario
		ON      Solicitud.ConsignatarioID = Consignatario.PuntoID 
		JOIN    SolicitudTipo 
		ON      Solicitud.SolicitudTipoID = SolicitudTipo.SolicitudTipoID 
		JOIN    StatusSolicitud 
		ON      Solicitud.StatusSolicitudID = StatusSolicitud.StatusSolicitudID 
		--JOIN    Cliente
		--ON      Solicitud.ClienteID = Cliente.ClienteID 
		WHERE   Solicitud.SolicitudID = @SolicitudID
	  END
	ELSE
	  BEGIN
		SELECT  Solicitud.SolicitudID, 
				Solicitud.Tipo,
				Solicitud.CuentaID,
				solicitud.BovedaID, 
				Solicitud.ConsignadorID,
				Solicitud.ConsignatarioID,
				Solicitud.SolicitudTipoID,   
				Solicitud.LoginCreado, 
				Solicitud.FechaCreado,
				StatusSolicitud.Descripcion AS Status, 
				Consignador.Nombre AS Consignador,
				Consignatario.Nombre AS Consignatario,
			--	Cliente.Descripcion AS nombrecliente,
				SolicitudTipo.descripcion AS solicitudtipo
		FROM	Solicitud
		JOIN    Punto Consignador
		ON      Solicitud.ConsignadorID = Consignador.PuntoID 
		JOIN    Punto Consignatario
		ON      Solicitud.ConsignatarioID = Consignatario.PuntoID 
		JOIN    SolicitudTipo 
		ON      Solicitud.SolicitudTipoID = SolicitudTipo.SolicitudTipoID 
		JOIN    StatusSolicitud 
		ON      Solicitud.StatusSolicitudID = StatusSolicitud.StatusSolicitudID 
		--JOIN    Cliente
		--ON      Solicitud.ClienteID = Cliente.ClienteID 
		WHERE   Solicitud.SolicitudID = @SolicitudID
		AND	    Solicitud.SolicitudTipoID = @SolicitudTipoID
	  END

  END  





























GO
/****** Object:  StoredProcedure [dbo].[Solicitud_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Solicitud_INSERT] 
	@CuentaID INT,
	@BovedaID INT,
	@ClienteID INT,
	@RubroID INT,
	@StatusSolicitudID INT,
	@OperacionID INT,
	@ConsignadorID INT,
	@ConsignatarioID INT, 
	@Fecha VARCHAR(10),  
	@SolicitudTipoID INT,
	@Login VARCHAR(30),
	@Monto DECIMAL(18,3),
	@Tipo VARCHAR(50)

AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION solicitud 

      SET DATEFORMAT DMY; 

      DECLARE @SaldoCuenta   DECIMAL(18, 3), 
			  @SolicitudID   INT,
			  @Descripcion VARCHAR(500),
              @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 


/***********************    VALIDACIONES:[NRO DE SOLICITUD]    ***********************/

	  IF EXISTS(SELECT * 
			    FROM  Solicitud
				WHERE  SolicitudID =  @SolicitudID)
        BEGIN 
		   ROLLBACK TRANSACTION solicitud 
		   SELECT @ERRORMESSAGE = 'Error: Ya existe una solicitud con el Nro. ' + CONVERT (VARCHAR, @SolicitudID),
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN;
        END 

/***********************    VALIDACIONES:[TIPOS SOLICITUD]    ***********************/

	  IF @SolicitudTipoID NOT IN(1,2,3) 
        BEGIN 
		   ROLLBACK TRANSACTION solicitud 
		   SELECT @ERRORMESSAGE = 'Error: Tipo de Solicitud Invalido.',
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN;
        END 





/***********************    INSERT:[SOLICITUD]    ***********************/

	  BEGIN TRY 
          INSERT INTO solicitud 
                      (SolicitudTipoID,
					   CuentaID,
					   BovedaID,
					   ClienteID,
					   RubroID,
					   ConsignadorID, 
					   ConsignatarioID,
					   LoginCreado,
					   FechaCreado,
					   StatusSolicitudID,
					   Monto,
					   OperacionID,
					   Tipo) 
          VALUES      (@SolicitudTipoID,
					   @CuentaID,
					   @BovedaID,
					   @ClienteID,
					   @RubroID,
					   @ConsignadorID, 
					   @ConsignatarioID,
					   @Login,
					   @Fecha,
				 	   @StatusSolicitudID,
					   @Monto,
					   @OperacionID,
					   @Tipo) 
		SET @SolicitudID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION solicitud 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    INSERT:[SOLICITUD_ACCION]    ***********************/
/***********************    SALIDA    ***********************/
IF @SolicitudTipoID = 1
BEGIN
	IF @OperacionID = 1 AND @BovedaID <> 17
	  BEGIN TRY 
          INSERT INTO solicitud_accion 
                      (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   1, 
					   'PENDIENTE',
					   '',
					   'CREAR CARTAPORTE(SALIDA)',
					   2) 

	      INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   2, 
					   'PENDIENTE',
					   '',
					   'TRASPASAR A ANTEBOVEDA(SALIDA)',
					   2) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   3, 
					   'PENDIENTE',
					   '',
					   'ASIGNAR A UNA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   4, 
					   'PENDIENTE',
					   '',
					   'DESPACHAR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   5, 
					   'PENDIENTE',
					   '',
					   'RECIBIR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   6, 
					   'PENDIENTE',
					   '',
					   'CERRAR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   7, 
					   'PENDIENTE',
					   '',
					   'SOLICITUD FINALIZADA, ENTREGADO A CLIENTE(SALIDA)',
					   9) 
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION solicitud 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 
     
    IF @OperacionID = 1 AND @BovedaID = 17
	  BEGIN TRY 
          INSERT INTO solicitud_accion 
                      (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   1, 
					   'PENDIENTE',
					   '',
					   'PROCESADA LA SOLICITUD(SERVICIO)',
					   17) 

	      INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   2, 
					   'PENDIENTE',
					   '',
					   'TRASPASAR A ANTEBOVEDA(SALIDA)',
					   17) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   3, 
					   'PENDIENTE',
					   '',
					   'ASIGNAR A UNA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   4, 
					   'PENDIENTE',
					   '',
					   'DESPACHAR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   5, 
					   'PENDIENTE',
					   '',
					   'RECIBIR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   6, 
					   'PENDIENTE',
					   '',
					   'CERRAR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   7, 
					   'PENDIENTE',
					   '',
					   'SOLICITUD FINALIZADA, ENTREGADO A CLIENTE(SALIDA)',
					   9) 
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION solicitud 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 

    IF @OperacionID = 2 AND @BovedaID <> 17
	  BEGIN TRY 
           INSERT INTO solicitud_accion 
                      (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   1, 
					   'PENDIENTE',
					   '',
					   'CREAR CARTAPORTE(SALIDA)',
					   2) 

	      INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   2, 
					   'PENDIENTE',
					   '',
					   'TRASPASAR A ANTEBOVEDA(SALIDA)',
					   2) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   3, 
					   'PENDIENTE',
					   '',
					   'ASIGNAR A UNA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   4, 
					   'PENDIENTE',
					   '',
					   'DESPACHAR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   5, 
					   'PENDIENTE',
					   '',
					   'RECIBIR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   6, 
					   'PENDIENTE',
					   '',
					   'CERRAR LA RUTA(SALIDA)',
					   1) 
			INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   7, 
					   'PENDIENTE',
					   '',
					   'SOLICITUD FINALIZADA, ENTREGADO A CLIENTE(SALIDA)',
					   9) 
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION solicitud 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 
      
    IF @OperacionID = 2 AND @BovedaID = 17
	  BEGIN TRY 
           INSERT INTO solicitud_accion 
                      (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   1, 
					   'PENDIENTE',
					   '',
					   'PROCESADA LA SOLICITUD(SERVICIO)',
					   17) 

	      INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   2, 
					   'PENDIENTE',
					   '',
					   'TRASPASAR A ANTEBOVEDA(SALIDA)',
					   17) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   3, 
					   'PENDIENTE',
					   '',
					   'ASIGNAR A UNA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   4, 
					   'PENDIENTE',
					   '',
					   'DESPACHAR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   5, 
					   'PENDIENTE',
					   '',
					   'RECIBIR LA RUTA(SALIDA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   6, 
					   'PENDIENTE',
					   '',
					   'CERRAR LA RUTA(SALIDA)',
					   1) 
			INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   7, 
					   'PENDIENTE',
					   '',
					   'SOLICITUD FINALIZADA, ENTREGADO A CLIENTE(SALIDA)',
					   9) 
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION solicitud 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


END


IF @SolicitudTipoID = 2
	  BEGIN TRY 
           INSERT INTO solicitud_accion 
                      (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   1, 
					   'PENDIENTE',
					   '',
					   'ASIGNAR A UNA RUTA(ENTRADA)',
					   1) 

	      INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   2, 
					   'PENDIENTE',
					   '',
					   'DESPACHAR LA RUTA(ENTRADA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   3, 
					   'PENDIENTE',
					   '',
					   'RECIBIR LA RUTA(ENTRADA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   4, 
					   'PENDIENTE',
					   '',
					   'RECIBIR CARTAPORTE(ENTRADA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   5, 
					   'PENDIENTE',
					   '',
					   'TRASPASAR A ACOPIO(ENTRADA)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   5, 
					   'PENDIENTE',
					   '',
					   'CIERRE(CONTEO) DE CARTAPORTE(ENTRADA)',
					   2) 
		  --INSERT INTO solicitud_accion 
				--	  (SolicitudID,
				--	   Tipo,
				--	   Secuencia,
				--	   LoginCerrado,
				--	   FechaCerrado,
				--	   Observacion,
				--	   BovedaID) 
    --      VALUES      (@SolicitudID,
				--	   @SolicitudTipoID,
				--	   6, 
				--	   '',
				--	   '',
				--	   'TRASPASAR A BOVEDA PRINCIPAL(ENTRADA)',
				--	   2) 
					   
		INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   6, 
					   'PENDIENTE',
					   '',
					   'DEPOSITAR EN CUENTA CLIENTE(ENTRADA)',
					   3) 
			INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   7, 
					   'PENDIENTE',
					   '',
					   'SOLICITUD FINALIZADA, ENTREGADO A CLIENTE(ENTRADA)',
					   9) 
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION solicitud 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 

IF @SolicitudTipoID = 3
	  BEGIN TRY 
	    
		  INSERT INTO solicitud_accion 
                      (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   1, 
					   'PENDIENTE',
					   '',
					   'ASIGNAR A UNA RUTA(EXPRESO)',
					   1) 

	      INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   2, 
					   'PENDIENTE',
					   '',
					   'DESPACHAR LA RUTA(EXPRESO)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   3, 
					   'PENDIENTE',
					   '',
					   'RECIBIR LA RUTA(EXPRESO)',
					   1) 
					   
		 INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   4, 
					   'PENDIENTE',
					   '',
					   'CUSTODIAR CARTA DE PORTE(EXPRESO)',
					   1) 
					   
		INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   5, 
					   'PENDIENTE',
					   '',
					   'CERRAR LA RUTA(EXPRESO)',
					   1) 
					   
		
					   
					   
					   
		  INSERT INTO solicitud_accion 
                      (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   6, 
					   'PENDIENTE',
					   '',
					   'ASIGNAR A UNA RUTA DE SALIDA(EXPRESO)',
					   1) 

	      INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   7, 
					   'PENDIENTE',
					   '',
					   'DESPACHAR LA RUTA DE SALIDA(EXPRESO)',
					   1) 
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   8, 
					   'PENDIENTE',
					   '',
					   'RECIBIR LA RUTA DE SALIDA(EXPRESO)',
					   1) 
					   
		  INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   9, 
					   'PENDIENTE',
					   '',
					   'CERRAR LA RUTA DE SALIDA(EXPRESO)',
					   1) 		   
					   
					   
					   
					   
	      INSERT INTO solicitud_accion 
					  (SolicitudID,
					   Tipo,
					   Secuencia,
					   LoginCerrado,
					   FechaCerrado,
					   Observacion,
					   BovedaID) 
          VALUES      (@SolicitudID,
					   @SolicitudTipoID,
					   10, 
					   'PENDIENTE',
					   '',
					   'SOLICITUD FINALIZADA, CARTA DE PORTE PROCESADO(CUSTODIA)(EXPRESO)',
					   9)  
		
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION solicitud 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION solicitud 
      ELSE 
        COMMIT TRANSACTION solicitud 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @SolicitudID   AS 'ExtraValue'
  END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Operacion_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 18-11-2010 
-- Description:  Buscar solicitud
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Operacion_GET] 
	@SolicitudID INT
AS 
  BEGIN 
	
		SELECT Solicitud_Operacion.OperacionID AS OperacionID,
				Operacion.Descripcion AS Descripcion
				
		FROM	Solicitud_Operacion
		JOIN Operacion ON Operacion.OperacionID = Solicitud_Operacion.OperacionID
		WHERE   SolicitudID = @SolicitudID
	  
	

  END  





























GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Operaciones_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 14-12-2010 
-- Description:  Agregar efectivo a la solicitud
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Operaciones_INSERT] 
	@OperacionID INT,
	@SolicitudID INT
	
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION solicitud 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000)

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 

      /**** Guarda la operacion  ****/ 
      BEGIN TRY 
          INSERT INTO Solicitud_Operacion
                      (SolicitudID, 
					   OperacionID) 
          VALUES      (@SolicitudID, 
					   @OperacionID)

      END TRY 
     BEGIN CATCH 
	      ROLLBACK TRANSACTION solicitud 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 
  END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_PROCESS]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- alter date: 18-11-2010 
-- Description:  Crear Solicitud	
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_PROCESS] 
	@Login VARCHAR(30),
	@SolicitudID INT,
	@SecuenciaID INT,
	@TraspasoID INT = NULL,
	@RutaID INT = NULL,
	@CartaporteID VARCHAR(13) = NULL,
	@Observacion  VARCHAR(50) = NULL

AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION solicitud 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  @efectivoenvase varchar(5),
			  @montoenvase decimal(18,3),
			  @efectivoenvase2 varchar(5),
		      @montoenvase2 decimal(18,3) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 


/***********************    VALIDACIONES:[NRO DE TRASPASO]    ***********************/
IF (@TraspasoID != '')
	BEGIN
	  IF NOT EXISTS(SELECT * 
			    FROM  Traspaso
				WHERE  TraspasoID =  @TraspasoID)
        BEGIN 
		   ROLLBACK TRANSACTION solicitud 
		   SELECT @ERRORMESSAGE = 'Error: No existe un traspaso con el Nro. ' + CONVERT (VARCHAR, @TraspasoID),
				  @NUMERRORS = @NUMERRORS + 1
		   SELECT @NUMERRORS     AS 'ErrorCount', 
                  @ERRORMESSAGE AS 'ErrorMessage'
		   RETURN;
        END 
		ELSE
/***********************    INSERT:[SOLICITUD_TRASPASO]    ***********************/

		BEGIN TRY 
		  UPDATE Solicitud_Accion
		  SET LoginCerrado = @Login,
		  FechaCerrado = getdate()
		  WHERE SolicitudID =  @SolicitudID
		  AND  Observacion  = @Observacion

		  INSERT INTO solicitud_traspaso 
					  (SolicitudID,
					   TraspasoID) 
		  VALUES      (@SolicitudID,
					   @TraspasoID) 
			
		  END TRY 
		  BEGIN CATCH 
			  ROLLBACK TRANSACTION solicitud 
			  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
					 @NUMERRORS = @NUMERRORS + 1
			  SELECT @NUMERRORS     AS 'ErrorCount',
					 CASE  ERROR_NUMBER()
						WHEN 4060 THEN 'Error: Base de datos Incorrecta'
						WHEN 18456 THEN 'Error: Inicio de sesión fallido'
						ELSE @ERRORMESSAGE
					 END AS 'ErrorMessage' 
			  RETURN;
		  END CATCH 

		
	END
/***********************    VALIDACIONES:[NRO DE RUTA]    ***********************/

	 IF (@RutaID != 0)
		BEGIN 
			  UPDATE Solicitud_Accion
			  SET LoginCerrado = @Login,
			  FechaCerrado = getdate()
			  WHERE SolicitudID =  @SolicitudID
			  AND  Observacion  = @Observacion

			  IF NOT EXISTS(SELECT * 
						FROM  Ruta
						WHERE  RutaID =  @RutaID)
				BEGIN 
				   ROLLBACK TRANSACTION solicitud 
				   SELECT @ERRORMESSAGE = 'Error: No existe una ruta con el Nro. ' + CONVERT (VARCHAR, @RutaID),
						  @NUMERRORS = @NUMERRORS + 1
				   SELECT @NUMERRORS     AS 'ErrorCount', 
						  @ERRORMESSAGE AS 'ErrorMessage'
				   RETURN;
				END 
				ELSE
		/***********************    INSERT:[SOLICITUD_RUTA]    ***********************/

				BEGIN TRY 
				  INSERT INTO solicitud_ruta 
							  (SolicitudID,
							   RutaID) 
				  VALUES      (@SolicitudID,
							   @RutaID) 
					
				  END TRY 
				  BEGIN CATCH 
					  ROLLBACK TRANSACTION solicitud 
					  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
							 @NUMERRORS = @NUMERRORS + 1
					  SELECT @NUMERRORS     AS 'ErrorCount',
							 CASE  ERROR_NUMBER()
								WHEN 4060 THEN 'Error: Base de datos Incorrecta'
								WHEN 18456 THEN 'Error: Inicio de sesión fallido'
								ELSE @ERRORMESSAGE
							 END AS 'ErrorMessage' 
					  RETURN;
				  END CATCH 

				
		END 


/***********************    VALIDACIONES:[NRO DE CARTAPORTE]    ***********************/

		IF (@CartaporteID != '')
		BEGIN
		   IF NOT EXISTS(SELECT * 
					FROM  cartaporte
					WHERE  cartaporteID =  @CartaporteID)
				BEGIN 
				   ROLLBACK TRANSACTION solicitud 
				   SELECT @ERRORMESSAGE = 'Error:No existe un Cartaporte con el Nro. ' + CONVERT (VARCHAR, @CartaporteID),
						  @NUMERRORS = @NUMERRORS + 1
				   SELECT @NUMERRORS     AS 'ErrorCount', 
						  @ERRORMESSAGE AS 'ErrorMessage'
				   RETURN;
				END 
			ELSE
	/***********************    INSERT:[SOLICITUD_CARTAPORTE]    ***********************/

				BEGIN TRY 

				  UPDATE Solicitud_Accion
				  SET LoginCerrado = @Login,
				  FechaCerrado = getdate()
				  WHERE SolicitudID =  @SolicitudID
				  AND  Observacion  = @Observacion

				  INSERT INTO solicitud_cartaporte 
							  (SolicitudID,
							   CartaporteID) 
				  VALUES      (@SolicitudID,
							   @CartaporteID) 
					
				  END TRY 
				  BEGIN CATCH 
					  ROLLBACK TRANSACTION solicitud 
					  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
							 @NUMERRORS = @NUMERRORS + 1
					  SELECT @NUMERRORS     AS 'ErrorCount',
							 CASE  ERROR_NUMBER()
								WHEN 4060 THEN 'Error: Base de datos Incorrecta'
								WHEN 18456 THEN 'Error: Inicio de sesión fallido'
								ELSE @ERRORMESSAGE
							 END AS 'ErrorMessage' 
					  RETURN;
				  END CATCH 

			
			END
	

/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION solicitud 
      ELSE 
        COMMIT TRANSACTION solicitud 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @SolicitudID  AS 'ExtraValue'
  END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Servicio_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Godoy   
-- Create date: 05-10-2010 
-- Description:  Agregar envase a cartaporte
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Servicio_INSERT] 
	@SolicitudID INT,
	@ServicioID INT,
	@Descripcion VARCHAR(50),
	@OperadorID INT,
	@Operador VARCHAR(50)
AS
BEGIN 
      SET NOCOUNT ON 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION servicio 

      SET DATEFORMAT DMY 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE  VARCHAR(5000),
			  @ID INT

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = '' 



      /**** Crea el servicio ****/ 
      BEGIN TRY 
          INSERT INTO Solicitud_Servicio
                      (SolicitudID,ServicioID,Descripcion,OperadorID,Operador) 
          VALUES      (@SolicitudID,@ServicioID,@Descripcion,@OperadorID,@Operador)
		  SET @ID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION servicio 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage'  
	      RETURN
      END CATCH 

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION servicio 
      ELSE 
        COMMIT TRANSACTION servicio 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' ,
			 @ID AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Status_PROCESS]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:    Juan, Delgado   
-- alter date: 18-11-2010 
-- Description:  	
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Status_PROCESS] 
	@Login VARCHAR(50),
	@Tipo  VARCHAR(50),
	@SolicitudID INT,
	@CartaporteID VARCHAR(13),
	@TraspasoID INT,
	@RutaID  INT,
	@DepositoID INT,
	@BovedaID INT
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION solicitud 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000),
			  
		      @SolicitudIDgenerica int,
		      @Solicitud_AccionID int,
		      @Solicitud_CartaPorteID int,
			  @Solicitud_EnvaseID int,
			  @Solicitud_OperacionID int,
			  @Solicitud_RutaID int,
			  @Solicitud_TraspasoID int,
			  @Solicitud_Observacion VARCHAR(500),
			  @Solicitud_DepositoID int,
			  @Solicitud_Tipo INT
      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 


/***********************    VALIDACIONES:[VERIFICO STATUS DE LA SOLICITUD]    ***********************/
      BEGIN TRY
		
			--SELECT @SolicitudIDgenerica = SolicitudID
			--FROM Solicitud
			
			SELECT @Solicitud_AccionID = SolicitudID
			FROM Solicitud_Accion
			
			SELECT @Solicitud_CartaPorteID = SolicitudID
			FROM Solicitud_CartaPorte
			
			SELECT @Solicitud_EnvaseID = SolicitudID
			FROM Solicitud_Envase
			join Solicitud_Envase_Efectivo
			on Solicitud_Envase_Efectivo.EnvaseID = Solicitud_Envase.EnvaseID

			SELECT @Solicitud_OperacionID = SolicitudID
			FROM Solicitud_Operacion
			
			SELECT @Solicitud_RutaID = SolicitudID
			FROM Solicitud_Ruta
			
			SELECT @Solicitud_TraspasoID = SolicitudID
			FROM Solicitud_Traspaso
			
			SELECT @Solicitud_DepositoID = SolicitudID
			FROM Solicitud_Deposito

/***********************    ACTUALIZO EL STATUS   ***********************/
/***********************    SALIDAS  ***********************/
				IF(@Tipo = 'ENTRADA' OR @Tipo = 'EXPRESO')
				BEGIN
					
					SELECT top 1 @Solicitud_Observacion = Solicitud_Accion.Observacion,
					@Solicitud_Tipo = Solicitud_Accion.Tipo,
					@SolicitudIDgenerica = Solicitud_Accion.SolicitudID from Solicitud_Accion
					where  Solicitud_Accion.LoginCerrado = 'PENDIENTE' and Solicitud_Accion.SolicitudID = @SolicitudID
				END
				IF(@Tipo = 'SALIDA')
				BEGIN
					SELECT top 1 @Solicitud_Observacion = Solicitud_Accion.Observacion,
					@SolicitudIDgenerica = Solicitud_Accion.SolicitudID from Solicitud_Accion
					JOIN  Solicitud_CartaPorte
					ON   Solicitud_CartaPorte.SolicitudID = Solicitud_Accion.SolicitudID
					where  Solicitud_Accion.LoginCerrado = 'PENDIENTE' and Solicitud_CartaPorte.CartaPorteID = @CartaporteID
				END
				IF(@Tipo = 'N/A')
				BEGIN
					SELECT top 1 @Solicitud_Observacion = Solicitud_Accion.Observacion,
					@SolicitudIDgenerica = Solicitud_Accion.SolicitudID from Solicitud_Accion
					JOIN  Solicitud_Ruta
					ON   Solicitud_Ruta.SolicitudID = Solicitud_Accion.SolicitudID
					where  Solicitud_Accion.LoginCerrado = 'PENDIENTE' and Solicitud_Ruta.rutaID = @RutaID
				END
				IF(@Tipo = 'TRASPASO')
				BEGIN
					SELECT top 1 @Solicitud_Observacion = Solicitud_Accion.Observacion,
					@SolicitudIDgenerica = Solicitud_Accion.SolicitudID from Solicitud_Accion
					JOIN  Solicitud_CartaPorte
					ON   Solicitud_CartaPorte.SolicitudID = Solicitud_Accion.SolicitudID
					where  Solicitud_Accion.Secuencia = '2' and Solicitud_CartaPorte.CartaPorteID = @CartaporteID
				END
				IF(@DepositoID <> 0)
				BEGIN
					SELECT top 1 @Solicitud_Observacion = Solicitud_Accion.Observacion,
					@SolicitudIDgenerica = Solicitud_Accion.SolicitudID from Solicitud_Accion
					where  Solicitud_Accion.LoginCerrado = '' and Solicitud_Accion.SolicitudID = @SolicitudID
					AND Solicitud_Accion.Observacion = 'DEPOSITAR EN CUENTA CLIENTE(ENTRADA)'
					or Solicitud_Accion.Observacion = 'DEPOSITAR EN CUENTA CLIENTE(EXPRESO)'
				END
			  
			  
			  IF(@Solicitud_Observacion = 'TRASPASAR A ANTEBOVEDA(SALIDA)')
				BEGIN
				         IF NOT EXISTS(SELECT SolicitudID FROM Solicitud_Traspaso WHERE SolicitudID = @SolicitudIDgenerica)
				         begin
						  INSERT INTO Solicitud_Traspaso 
									  (SolicitudID,
									   TraspasoID) 
						  VALUES      (@SolicitudIDgenerica,
									   @TraspasoID) 
						 end
						 UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID = @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
						  AND Secuencia = 2
			  END
			  
			 
			  IF(@Solicitud_Observacion = 'ASIGNAR A UNA RUTA(SALIDA)')
				BEGIN
				IF NOT EXISTS(SELECT SolicitudID FROM Solicitud_Ruta WHERE SolicitudID = @SolicitudIDgenerica)
				         begin
						  INSERT INTO Solicitud_Ruta 
									  (SolicitudID,
									   rutaID) 
						  VALUES      (@SolicitudIDgenerica,
									   @RutaID) 
				  
						 
						 end
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
				  AND Secuencia = 3
			  END
			  
			  IF(@Solicitud_Observacion = 'DESPACHAR LA RUTA(SALIDA)')
				BEGIN
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						 -- AND  Observacion  = @Solicitud_Observacion
				  AND Secuencia = 4
			  END
			  
			  IF(@Solicitud_Observacion = 'RECIBIR LA RUTA(SALIDA)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						 -- AND  Observacion  = @Solicitud_Observacion
				 AND Secuencia = 5
			  END
			  
			  IF(@Solicitud_Observacion = 'CERRAR LA RUTA(SALIDA)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
						  AND Secuencia = 6
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudID
						  AND  Secuencia  = 7
				   
			  END
			  
			  
			  
			  
/***********************    ACTUALIZO EL STATUS   ***********************/
/***********************    ENTRADAS  ***********************/

             IF(@Solicitud_Observacion = 'ASIGNAR A UNA RUTA(ENTRADA)')
				BEGIN
				IF (@Solicitud_Tipo = 2)
					BEGIN
					IF NOT EXISTS(SELECT SolicitudID FROM Solicitud_Ruta WHERE SolicitudID = @SolicitudIDgenerica)
				         begin
						  INSERT INTO Solicitud_Ruta 
									  (SolicitudID,
									   rutaID) 
						  VALUES      (@SolicitudIDgenerica,
									   @RutaID) 
				  
						  
						  end
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  AND  Observacion  = @Solicitud_Observacion
					END
				  
			  END
			  
			  IF(@Solicitud_Observacion = 'DESPACHAR LA RUTA(ENTRADA)')
				BEGIN
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  AND  Observacion  = @Solicitud_Observacion
						  
				  
			  END
			  
			  IF(@Solicitud_Observacion = 'RECIBIR LA RUTA(ENTRADA)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  AND  Observacion  = @Solicitud_Observacion
						  
				 
			  END
			  
			 IF(@Solicitud_Observacion = 'RECIBIR CARTAPORTE(ENTRADA)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  AND  Observacion  = @Solicitud_Observacion
						 
				 
			  END
			  
			  IF(@Solicitud_Observacion = 'TRASPASAR A ACOPIO(ENTRADA)')
				BEGIN
				  IF NOT EXISTS(SELECT SolicitudID FROM Solicitud_Traspaso WHERE SolicitudID = @SolicitudIDgenerica)
				         begin
						  INSERT INTO Solicitud_Traspaso 
									  (SolicitudID,
									   TraspasoID) 
						  VALUES      (@SolicitudIDgenerica,
									   @TraspasoID)
						  
						 end
						 UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  AND  Observacion  = @Solicitud_Observacion
						 
				   
			  END
			  
			  IF(@Solicitud_Observacion = 'CIERRE(CONTEO) DE CARTAPORTE(ENTRADA)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  AND  Observacion  = @Solicitud_Observacion
						  
				   
			  END
			  
			 -- IF(@Solicitud_Observacion = 'TRASPASAR A BOVEDA PRINCIPAL(ENTRADA)')
				--BEGIN
				  
				  
				--		  UPDATE Solicitud_Accion
				--		  SET LoginCerrado = @Login,
				--		  FechaCerrado = getdate()
				--		  WHERE SolicitudID =  @SolicitudIDgenerica
				--		  AND  Observacion  = @Solicitud_Observacion
						  
						 
				   
			 -- END
			  
			  IF(@Solicitud_Observacion = 'DEPOSITAR EN CUENTA CLIENTE(ENTRADA)')
				BEGIN
				  IF NOT EXISTS(SELECT SolicitudID FROM Solicitud_Deposito WHERE SolicitudID = @SolicitudIDgenerica)
				         begin
						  INSERT INTO Solicitud_Deposito 
									  (SolicitudID,
									   DepositoID) 
						  VALUES      (@SolicitudIDgenerica,
									   @DepositoID)
									   
						  
				    end
				    UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
						  AND Secuencia = 6
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  AND  Secuencia  = 7
			  END
			  

/***********************    ACTUALIZO EL STATUS   ***********************/
/***********************    EXPRESOS  ***********************/

             IF(@Solicitud_Observacion = 'ASIGNAR A UNA RUTA(EXPRESO)')
				BEGIN
				IF NOT EXISTS(SELECT SolicitudID FROM Solicitud_Ruta WHERE SolicitudID = @SolicitudIDgenerica)
				         begin
						  INSERT INTO Solicitud_Ruta 
									  (SolicitudID,
									   rutaID) 
						  VALUES      (@SolicitudIDgenerica,
									   @RutaID) 
				  
						 
						end
						 UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
							AND Secuencia = 1
			  END
			  
			  IF(@Solicitud_Observacion = 'DESPACHAR LA RUTA(EXPRESO)')
				BEGIN
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						 -- AND  Observacion  = @Solicitud_Observacion
				  AND Secuencia = 2
			  END
			  
			  IF(@Solicitud_Observacion = 'RECIBIR LA RUTA(EXPRESO)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
				 AND Secuencia = 3
			  END
			  
			  IF(@Solicitud_Observacion = 'CERRAR LA RUTA(EXPRESO)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
						  
						  --UPDATE Solicitud_Accion
						  --SET LoginCerrado = @Login,
						  --FechaCerrado = getdate()
						  --WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Secuencia  = 7
				   AND Secuencia = 4
			  END
			  
			  IF(@Solicitud_Observacion = 'ASIGNAR A UNA RUTA DE SALIDA(EXPRESO)')
				BEGIN
				IF NOT EXISTS(SELECT SolicitudID FROM Solicitud_Ruta WHERE SolicitudID = @SolicitudIDgenerica)
				         begin
						  INSERT INTO Solicitud_Ruta 
									  (SolicitudID,
									   rutaID) 
						  VALUES      (@SolicitudIDgenerica,
									   @RutaID) 
				  
						 
						end
						 UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
						AND Secuencia = 5
			  END
			  
			  IF(@Solicitud_Observacion = 'DESPACHAR LA RUTA DE SALIDA(EXPRESO)')
				BEGIN
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
				  AND Secuencia = 6
			  END
			  
			  IF(@Solicitud_Observacion = 'RECIBIR LA RUTA DE SALIDA(EXPRESO)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						 -- AND  Observacion  = @Solicitud_Observacion
				 AND Secuencia = 7
			  END
			  
			  IF(@Solicitud_Observacion = 'CUSTODIAR CARTA DE PORTE(EXPRESO)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
				 AND Secuencia = 8
			  END
			  
			  IF(@Solicitud_Observacion = 'CERRAR LA RUTA DE SALIDA(EXPRESO)')
				BEGIN
				  
				  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  --AND  Observacion  = @Solicitud_Observacion
						  
						  AND Secuencia = 9
						  
						  UPDATE Solicitud_Accion
						  SET LoginCerrado = @Login,
						  FechaCerrado = getdate()
						  WHERE SolicitudID =  @SolicitudIDgenerica
						  AND  Secuencia  = 10
				   
			  END
			  
			
			  END TRY 
			  BEGIN CATCH 
				  ROLLBACK TRANSACTION solicitud 
				  SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
						 @NUMERRORS = @NUMERRORS + 1
				  SELECT @NUMERRORS     AS 'ErrorCount',
						 CASE  ERROR_NUMBER()
							WHEN 4060 THEN 'Error: Base de datos Incorrecta'
							WHEN 18456 THEN 'Error: Inicio de sesión fallido'
							ELSE @ERRORMESSAGE
						 END AS 'ErrorMessage' 
				  RETURN;
			  END CATCH 

		


	
/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION solicitud 
      ELSE 
        COMMIT TRANSACTION solicitud 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
			 @SolicitudIDgenerica  AS 'ExtraValue'
  END

GO
/****** Object:  StoredProcedure [dbo].[Solicitud_Tipo_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 18-11-2010 
-- Description:  Buscar solicitud
-- ============================================= 
CREATE PROCEDURE [dbo].[Solicitud_Tipo_GET] 
	@SolicitudID INT,
	@SolicitudTipoID INT = NULL
AS 
  BEGIN 
	
	SELECT  Solicitud.SolicitudID,
				Solicitud.CuentaID,
				Solicitud.ClienteID,
				Solicitud.ConsignadorID, 
				Solicitud.ConsignatarioID,
				Solicitud.SolicitudTipoID, 
				Solicitud.LoginCreado, 
				Solicitud.FechaCreado,
				--StatusSolicitud.Descripcion AS Status, 
				Solicitud.Tipo,
				--Cliente.Descripcion AS nombrecliente,
				SolicitudTipo.descripcion AS solicitudtipo
		FROM	Solicitud
		
		JOIN    SolicitudTipo 
		ON      Solicitud.SolicitudTipoID = SolicitudTipo.SolicitudTipoID 
		--JOIN    StatusSolicitud 
		--ON      Solicitud.StatusSolicitudID = StatusSolicitud.StatusSolicitudID 
		--JOIN    Cliente
		--ON      Solicitud.ClienteID = Cliente.ClienteID 
		WHERE   Solicitud.SolicitudID = @SolicitudID
	
	
  END  





























GO
/****** Object:  StoredProcedure [dbo].[SolicitudDisponible_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 18-12-2010 
-- Description:  Buscar solicitud Disponible
-- ============================================= 
CREATE PROCEDURE [dbo].[SolicitudDisponible_GET] 
	@OperacionID INT ,
	@StatusSolicitudID INT,
	@StatusSolicitudID2 INT
AS 
  BEGIN 
	
		SELECT  Solicitud.SolicitudID, 
				Solicitud.BovedaID, 
				Solicitud.ConsignadorID,
				Solicitud.ConsignatarioID,
				Solicitud.SolicitudTipoID,
				Solicitud.LoginCreado, 
				Solicitud.FechaCreado,
				Solicitud.Monto,
                StatusSolicitud.descripcion AS status, 
                SolicitudTipo.descripcion AS nombresolicitud ,
				Consignador.Nombre AS Consignador,
				Consignatario.Nombre AS Consignatario,
				Boveda.Nombre AS nombreboveda,
				SolicitudTipo.descripcion AS solicitudtipo
		FROM	Solicitud
		JOIN    Punto Consignador
		ON      Solicitud.ConsignadorID = Consignador.PuntoID 
		JOIN    Punto Consignatario
		ON      Solicitud.ConsignatarioID = Consignatario.PuntoID 
		JOIN    SolicitudTipo 
		ON      Solicitud.SolicitudTipoID = SolicitudTipo.SolicitudTipoID 
		JOIN    StatusSolicitud 
		ON      Solicitud.StatusSolicitudID = StatusSolicitud.StatusSolicitudID 
		JOIN    Boveda
		ON      Solicitud.BovedaID = Boveda.BovedaID 
		JOIN    Solicitud_Operacion
		ON      Solicitud.SolicitudID = Solicitud_Operacion.SolicitudID 
		WHERE	Solicitud_Operacion.OperacionID = @OperacionID
		AND     Solicitud.StatusSolicitudID = @StatusSolicitudID
		OR      Solicitud.StatusSolicitudID = @StatusSolicitudID2
	

  END  
































GO
/****** Object:  StoredProcedure [dbo].[Solicitudes_BloqueCartaporte_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Solicitudes_BloqueCartaporte_GET]
	@EfectivoID VARCHAR(50)
AS
BEGIN
	SET DATEFORMAT DMY
	
			 
	
SELECT TOP 1 Bloque.BloqueID 
	FROM   Bloque
	join   Bloque_Efectivo
	on     Bloque_Efectivo.BloqueID = Bloque.BloqueID
	WHERE  Bloque_Efectivo.EfectivoID = @EfectivoID
	and    Bloque.EstaAbierto = 'false'  
	AND   Bloque.CartaporteID = 'NOCOMPRO'
	--IF (@BloqueIDC <> null)
		 
  
	--  UPDATE Bloque 
	--  SET    CartaporteID = 'COMPROMETIDO'
			 
	--  WHERE	 BloqueID = @BloqueIDC
		
	
		
     
END

GO
/****** Object:  StoredProcedure [dbo].[Solicitudes_Envases_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Solicitudes_Envases_GET]
	@SolicitudID INT
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT Solicitud_Envase_Efectivo.EnvaseID, 
		   Solicitud_Envase_Efectivo.EfectivoID,
		   Solicitud_Envase_Efectivo.Piezas, 
		   Solicitud_Envase_Efectivo.Monto,
		   Efectivo.EfectivoTipoID,  
		   Efectivo.Denominacion,  
		   Efectivo.ImagePath,  
		   Efectivo.EstaActivo
	FROM   Solicitud_Envase_Efectivo
	JOIN   Efectivo
	ON     Solicitud_Envase_Efectivo.EfectivoID = Efectivo.EfectivoID
	JOIN   Solicitud_Envase
	ON     Solicitud_Envase.EnvaseID = Solicitud_Envase_Efectivo.EnvaseID
	JOIN   Solicitud
	ON     Solicitud.SolicitudID = Solicitud_Envase.SolicitudID
	WHERE  Solicitud.SolicitudID = @SolicitudID
	
END
GO
/****** Object:  StoredProcedure [dbo].[Solicitudes_EnvasesCartaporte_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Solicitudes_EnvasesCartaporte_GET]
	@SolicitudID INT
AS
BEGIN
	SET DATEFORMAT DMY
SELECT     Solicitud_Envase_Efectivo.EfectivoID,
		   Solicitud_Envase_Efectivo.Piezas as Piezas, 
		   Solicitud_Envase_Efectivo.Monto as Monto,
		   Efectivo.EfectivoTipoID,  
		   Efectivo.Denominacion,  
		   Efectivo.ImagePath,  
		   Efectivo.EstaActivo
	FROM   Solicitud_Envase_Efectivo
	JOIN   Efectivo
	ON     Solicitud_Envase_Efectivo.EfectivoID = Efectivo.EfectivoID
	JOIN   Solicitud_Envase
	ON     Solicitud_Envase.EnvaseID = Solicitud_Envase_Efectivo.EnvaseID
	JOIN   Solicitud
	ON     Solicitud.SolicitudID = Solicitud_Envase.SolicitudID
	WHERE  Solicitud.SolicitudID =@SolicitudID
	
END
GO
/****** Object:  StoredProcedure [dbo].[Traspaso_Bloque_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Traspaso_Bloque_INSERT] 
	@TraspasoID INT,
	@BloqueID VARCHAR(50)
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY; 

      DECLARE @Descripcion  VARCHAR(50),
              @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    INSERT:[TRASPASO]    ***********************/

	  BEGIN TRY 
          INSERT INTO  Traspaso_Bloque
                      (TraspasoID, 
                       BloqueID) 
          VALUES      (@TraspasoID, 
                       @BloqueID) 
          
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 




/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
             @TraspasoID    AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Traspaso_Bolsa_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Traspaso_Bolsa_INSERT] 
	@TraspasoID INT,
	@BloqueID VARCHAR(50)
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY; 

      DECLARE @Descripcion  VARCHAR(50),
              @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    INSERT:[TRASPASO]    ***********************/

	  BEGIN TRY 
          INSERT INTO  Traspaso_Bloque
                      (TraspasoID, 
                       BloqueID) 
          VALUES      (@TraspasoID, 
                       @BloqueID) 
          
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 




/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
             @TraspasoID    AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[Traspaso_CartaPorte_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 03-12-2010 
-- Description:  Crear traspaso	cartaportes
-- ============================================= 
CREATE PROCEDURE [dbo].[Traspaso_CartaPorte_INSERT] 
	@TraspasoID INT,
	@CartaPorteID VARCHAR(13),
	@LoginCreado VARCHAR(50)
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY; 

      DECLARE @Descripcion  VARCHAR(50),
              @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000) ,
              @CartaporteSolicitud VARCHAR(13)

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    INSERT:[TRASPASO]    ***********************/

	  BEGIN TRY 
          INSERT INTO  Traspaso_CartaPorte
                      (TraspasoID, 
                       CartaPorteID) 
          VALUES      (@TraspasoID, 
                       @CartaPorteID) 
          
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    VERIFICAR SI ESTA EN UNA SOLICITUD    ***********************/

SELECT @CartaporteSolicitud = CartaPorte.CartaPorteID FROM CartaPorte 
JOIN Solicitud_CartaPorte
ON Solicitud_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
JOIN Solicitud
ON Solicitud.SolicitudID = Solicitud_CartaPorte.SolicitudID
JOIN Solicitud_Accion 
ON Solicitud_Accion.SolicitudID = Solicitud.SolicitudID

WHERE Solicitud_Accion.LoginCerrado =''
AND Solicitud_Accion.Secuencia = 2

IF (@CartaPorteID = @CartaporteSolicitud)
	  BEGIN TRY 
          UPDATE Solicitud_Accion
          SET LoginCerrado = @LoginCreado,
              FechaCerrado = getdate()
              
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
             @TraspasoID    AS 'Identity'
  END






GO
/****** Object:  StoredProcedure [dbo].[Traspaso_DELETE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 04-12-2010 
-- Description:  Cancelar traspaso	
-- ============================================= 
CREATE PROCEDURE [dbo].[Traspaso_DELETE] 
	@TraspasoID INT
	

	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY

      DECLARE   @NUMERRORS    INT, 
				@ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


/***********************    VALIDACION:[TRASPASO]    ***********************/
	  IF NOT EXISTS (SELECT *
					 FROM   Traspaso 
					 WHERE  Traspaso.TraspasoID = @TraspasoID)
		BEGIN
			ROLLBACK TRANSACTION traspaso 
			SELECT @ERRORMESSAGE = 'Error: No puede eliminar este traspaso, ya que fue eliminado previamente.', 
				   @NUMERRORS = @NUMERRORS + 1
		    SELECT @NUMERRORS     AS 'ErrorCount', 
			  	   @ERRORMESSAGE  AS 'ErrorMessage'
			RETURN
		END

	  IF NOT EXISTS (SELECT *
					 FROM   Traspaso 
					 WHERE  Traspaso.TraspasoID = @TraspasoID
					 AND    Traspaso.Recibido = 0)
		BEGIN
			ROLLBACK TRANSACTION traspaso 
			SELECT @ERRORMESSAGE = 'Error: No puede eliminar este traspaso, ya fue recibido.', 
				   @NUMERRORS = @NUMERRORS + 1
		    SELECT @NUMERRORS     AS 'ErrorCount', 
			  	   @ERRORMESSAGE  AS 'ErrorMessage'
			RETURN;
		END



/***********************    DELETE:[TRASPASO]    ***********************/

	  BEGIN TRY 
          DELETE FROM  Traspaso          
          WHERE        TraspasoID = @TraspasoID           
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 


      

/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END



GO
/****** Object:  StoredProcedure [dbo].[Traspaso_Efectivo_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Author:    Juan, Delgado   
-- Create date: 29-11-2010 
-- Description:  Buscar el efectivo de un traspaso
-- ============================================= 
CREATE PROCEDURE [dbo].[Traspaso_Efectivo_GET] 
	@TraspasoID INT,
	@EfectivoTipoID INT
AS 
  BEGIN  
  SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 
      
  BEGIN TRY  
	SELECT	*	
	FROM Efectivo
	JOIN Traspaso_Efectivo
	ON   Efectivo.EfectivoID = Traspaso_Efectivo.EfectivoID 
	JOIN Traspaso 
	ON   Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID 
	
	WHERE Traspaso.TraspasoID = @TraspasoID
	AND   Efectivo.EfectivoTipoID = @EfectivoTipoID
END TRY
  BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 
      /***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
             @TraspasoID    AS 'Identity'
  END



GO
/****** Object:  StoredProcedure [dbo].[Traspaso_Efectivo_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 14-12-2010 
-- Description:  Agregar efectivo al traspao
-- ============================================= 
CREATE PROCEDURE [dbo].[Traspaso_Efectivo_INSERT] 
	@EfectivoID VARCHAR(5),
	@TraspasoID INT,
	@Monto DECIMAL(18,3),
	@Piezas INT
	
AS
BEGIN 
	SET nocount ON
    SET TRANSACTION ISOLATION LEVEL serializable 

    BEGIN TRANSACTION efectivo 

    SET DATEFORMAT DMY

    DECLARE @ID INT,
		    @NUMERRORS    INT, 
            @ERRORMESSAGE VARCHAR(5000)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = '' 
	       
	IF (SELECT montodisponible
		FROM   vw_Efectivo
		WHERE  EfectivoID = @EfectivoID
		AND    BovedaID = (SELECT BovedaEmisorID
					 	   FROM   Traspaso
						   WHERE  TraspasoID = @TraspasoID)) < @Monto
	BEGIN
		ROLLBACK TRANSACTION efectivo 
		DELETE FROM Traspaso 
		WHERE TraspasoID = @TraspasoID

		SELECT @ERRORMESSAGE = 'Error: NO TIENE EFECTIVO DE ' + CAST ((SELECT  Denominacion FROM Efectivo WHERE EfectivoID = @EfectivoID) AS VARCHAR)    + ' SUFICIENTE PARA REALIZAR EL TRASPASO.',
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @ERRORMESSAGE AS 'ErrorMessage',
			   @NUMERRORS    AS 'ErrorCount'
	    RETURN		
	END
	

	/**** Guarda el efectivo  ****/ 
	BEGIN TRY 
		 INSERT INTO Traspaso_Efectivo
				    (TraspasoID, 
				     EfectivoID,
				     Monto,
				     Piezas) 
	    VALUES      (@TraspasoID, 
				     @EfectivoID,
				     @Monto,
				     @Piezas)
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION efectivo 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage'   
		RETURN
	END CATCH     

	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION efectivo 
	ELSE 
		COMMIT TRANSACTION efectivo 

	SELECT @NUMERRORS     AS 'ErrorCount',
		   @ERRORMESSAGE  AS 'ErrorMessage'
END


GO
/****** Object:  StoredProcedure [dbo].[Traspaso_EfectivoCaja_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Traspaso_EfectivoCaja_GET] 
	@TraspasoID INT,
	@EfectivoTipoID INT
AS 
  BEGIN  
  SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 
      
  BEGIN TRY  
	SELECT	*	
	FROM Efectivo
	JOIN Traspaso_Efectivo_Caja
	ON   Efectivo.EfectivoID = Traspaso_Efectivo_Caja.EfectivoID 
	JOIN Traspaso_Caja 
	ON   Traspaso_Efectivo_Caja.TraspasoID = Traspaso_Caja.TraspasoID 
	
	WHERE Traspaso_Caja.TraspasoID = @TraspasoID
	AND   Efectivo.EfectivoTipoID = @EfectivoTipoID
END TRY
  BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 
      /***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
             @TraspasoID    AS 'Identity'
  END




GO
/****** Object:  StoredProcedure [dbo].[Traspaso_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 14-12-2010 
-- Description:  Buscar un traspaso por id
-- ============================================= 
CREATE PROCEDURE [dbo].[Traspaso_GET] 
	@TraspasoID INT
AS 
BEGIN

	SET DATEFORMAT DMY 
	SELECT	 Traspaso.TraspasoID, 
			 Traspaso.BovedaEmisorID, 
			 Traspaso.BovedaReceptorID, 
			 Traspaso.LoginEmisor, 
			 Traspaso.FechaEmisor, 
			 Traspaso.LoginReceptor, 
			 Traspaso.FechaReceptor, 
			 Traspaso.Recibido, 
			 Traspaso.Observacion,
			 Emisor.Nombre as Emisor,
			 Receptor.Nombre as Receptor
			  
	FROM Traspaso	
	JOIN Boveda Emisor
	ON   Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN Boveda Receptor
	ON   Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE Traspaso.TraspasoID = @TraspasoID


  END




GO
/****** Object:  StoredProcedure [dbo].[Traspaso_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 03-12-2010 
-- Description:  Crear traspaso	
-- ============================================= 
CREATE PROCEDURE [dbo].[Traspaso_INSERT] 
	@BovedaEmisorID INT, 
	@LoginEmisor VARCHAR(30),
	@Observacion VARCHAR(5000),
	@BovedaReceptorID INT,
	@Deposito INT = NULL,
	@Tipo INT = NULL
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY; 

      DECLARE @TraspasoID   INT, 
		      @Descripcion  VARCHAR(50),
              @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    INSERT:[TRASPASO]    ***********************/

	  BEGIN TRY 
          INSERT INTO  Traspaso
                      (BovedaEmisorID, 
                       LoginEmisor, 
                       BovedaReceptorID,
					   FechaEmisor,
					   Observacion,
					   Deposito) 
          VALUES      (@BovedaEmisorID, 
                       @LoginEmisor, 
                       @BovedaReceptorID,
					   getdate(),
					   @Observacion,
					   @Deposito) 
          
          SET @TraspasoID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 




/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
             @TraspasoID    AS 'Identity'
  END







GO
/****** Object:  StoredProcedure [dbo].[Traspaso_OUT_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[Traspaso_OUT_GET] 
	@BovedaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   BovedaEmisorID = @BovedaID
	AND		Recibido = 0
	

  END


GO
/****** Object:  StoredProcedure [dbo].[TraspasoBloque_IN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[TraspasoBloque_IN_GET] 
	@BovedaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor,
			(select count(Bloque.BloqueID)
			FROM	Traspaso
	JOIN    Traspaso_Bloque
	ON      Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID
	JOIN    Bloque
	ON      Bloque.BloqueID = Traspaso_Bloque.BloqueID
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Bloque
					WHERE  Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID))as bloques,
	(select sum(Bloque_Efectivo.Monto)
			FROM	Traspaso
	JOIN    Traspaso_Bloque
	ON      Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID
	JOIN    Bloque
	ON      Bloque.BloqueID = Traspaso_Bloque.BloqueID
	JOIN	Bloque_Efectivo
	ON		Bloque_Efectivo.BloqueID = Bloque.BloqueID
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Bloque
					WHERE  Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID))as MontoTotal
	FROM	Traspaso
	
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Bloque
					WHERE  Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID)

END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoBloque_OUT_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[TraspasoBloque_OUT_GET] 
	@BovedaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor,
			(select count(Bloque.BloqueID)
			FROM	Traspaso
	JOIN    Traspaso_Bloque
	ON      Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID
	JOIN    Bloque
	ON      Bloque.BloqueID = Traspaso_Bloque.BloqueID
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaEmisorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Bloque
					WHERE  Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID))as bloques,
	(select sum(Bloque_Efectivo.Monto)
			FROM	Traspaso
	JOIN    Traspaso_Bloque
	ON      Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID
	JOIN    Bloque
	ON      Bloque.BloqueID = Traspaso_Bloque.BloqueID
	JOIN	Bloque_Efectivo
	ON		Bloque_Efectivo.BloqueID = Bloque.BloqueID
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaEmisorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Bloque
					WHERE  Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID))as MontoTotal
	FROM	Traspaso
	
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaEmisorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Bloque
					WHERE  Traspaso_Bloque.TraspasoID = Traspaso.TraspasoID)

END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoBolsa_IN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoBolsa_IN_GET] 
	@BovedaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Bolsa
					WHERE  Traspaso_Bolsa.TraspasoID = Traspaso.TraspasoID)

END



GO
/****** Object:  StoredProcedure [dbo].[TraspasoBolsa_OUT_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoBolsa_OUT_GET] 
	@BovedaID INT
AS
BEGIN  

    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   BovedaEmisorID = @BovedaID
	AND		Recibido = 0	
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Bolsa
					WHERE  Traspaso_Bolsa.TraspasoID = Traspaso.TraspasoID)
  END



GO
/****** Object:  StoredProcedure [dbo].[TraspasoCaja_DELETE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 04-12-2010 
-- Description:  Cancelar traspaso	
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCaja_DELETE] 
	@TraspasoID INT
	

	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY

      DECLARE   @NUMERRORS    INT, 
				@ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0
      SET @ERRORMESSAGE = ''


/***********************    VALIDACION:[TRASPASO]    ***********************/
	  IF NOT EXISTS (SELECT *
					 FROM   Traspaso_Caja 
					 WHERE  Traspaso_Caja.TraspasoID = @TraspasoID)
		BEGIN
			ROLLBACK TRANSACTION traspaso 
			SELECT @ERRORMESSAGE = 'Error: No puede eliminar este traspaso, ya que fue eliminado previamente.', 
				   @NUMERRORS = @NUMERRORS + 1
		    SELECT @NUMERRORS     AS 'ErrorCount', 
			  	   @ERRORMESSAGE  AS 'ErrorMessage'
			RETURN
		END

	  IF NOT EXISTS (SELECT *
					 FROM   Traspaso_Caja 
					 WHERE  Traspaso_Caja.TraspasoID = @TraspasoID
					 AND    Traspaso_Caja.Recibido = 0)
		BEGIN
			ROLLBACK TRANSACTION traspaso 
			SELECT @ERRORMESSAGE = 'Error: No puede eliminar este traspaso, ya fue recibido.', 
				   @NUMERRORS = @NUMERRORS + 1
		    SELECT @NUMERRORS     AS 'ErrorCount', 
			  	   @ERRORMESSAGE  AS 'ErrorMessage'
			RETURN;
		END



/***********************    DELETE:[TRASPASO]    ***********************/

	  BEGIN TRY 
          DELETE FROM  Traspaso_Caja          
          WHERE        TraspasoID = @TraspasoID           
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 @ERRORMESSAGE  AS 'ErrorMessage' 
	      RETURN
      END CATCH 


      

/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage'
  END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoCaja_Efectivo_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Author:    Juan, Delgado   
-- Create date: 29-11-2010 
-- Description:  Buscar el efectivo de un traspaso
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCaja_Efectivo_GET] 
	@TraspasoID INT,
	@EfectivoTipoID INT
AS 
  BEGIN  
  SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 
      
  BEGIN TRY  
	SELECT	*	
	FROM Efectivo
	JOIN Traspaso_Efectivo_Caja
	ON   Efectivo.EfectivoID = Traspaso_Efectivo_Caja.EfectivoID 
	JOIN Traspaso_Caja 
	ON   Traspaso_Efectivo_Caja.TraspasoID = Traspaso_Caja.TraspasoID 
	
	WHERE Traspaso_Caja.TraspasoID = @TraspasoID
	AND   Efectivo.EfectivoTipoID = @EfectivoTipoID
END TRY
  BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 
      /***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
             @TraspasoID    AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoCaja_Efectivo_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 14-12-2010 
-- Description:  Agregar efectivo al traspao
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCaja_Efectivo_INSERT] 
	@EfectivoID VARCHAR(5),
	@TraspasoID INT,
	@Monto DECIMAL(18,3),
	@Piezas INT
	
AS
BEGIN 
	SET nocount ON
    SET TRANSACTION ISOLATION LEVEL serializable 

    BEGIN TRANSACTION efectivo 

    SET DATEFORMAT DMY

    DECLARE @ID INT,
		    @NUMERRORS    INT, 
            @ERRORMESSAGE VARCHAR(5000)

	SET @NUMERRORS = 0
	SET @ERRORMESSAGE = '' 
	       
	IF (SELECT montodisponible
		FROM   vw_EfectivoCaja
		WHERE  EfectivoID = @EfectivoID
		AND    CajaID = (SELECT CajaEmisorID
					 	   FROM   Traspaso_Caja
						   WHERE  TraspasoID = @TraspasoID)) < @Monto
	OR NOT EXISTS(SELECT montodisponible
		FROM   vw_EfectivoCaja
		WHERE  EfectivoID = @EfectivoID
		AND    CajaID = (SELECT CajaEmisorID
					 	   FROM   Traspaso_Caja
						   WHERE  TraspasoID = @TraspasoID))
	
	BEGIN
		ROLLBACK TRANSACTION efectivo 
		DELETE FROM Traspaso_Caja 
		WHERE TraspasoID = @TraspasoID

		SELECT @ERRORMESSAGE = 'Error: NO TIENE EFECTIVO DE ' + CAST ((SELECT  Denominacion FROM Efectivo WHERE EfectivoID = @EfectivoID) AS VARCHAR)    + ' SUFICIENTE PARA REALIZAR EL TRASPASO.',
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @ERRORMESSAGE AS 'ErrorMessage',
			   @NUMERRORS    AS 'ErrorCount'
	    RETURN		
	END
	

	/**** Guarda el efectivo  ****/ 
	BEGIN TRY 
		 INSERT INTO Traspaso_Efectivo_Caja
				    (TraspasoID, 
				     EfectivoID,
				     Monto,
				     Piezas) 
	    VALUES      (@TraspasoID, 
				     @EfectivoID,
				     @Monto,
				     @Piezas)
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION efectivo 
		SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			   @NUMERRORS = @NUMERRORS + 1
		SELECT @NUMERRORS     AS 'ErrorCount',
			   @ERRORMESSAGE  AS 'ErrorMessage'   
		RETURN
	END CATCH     

	IF @NUMERRORS > 0 
		ROLLBACK TRANSACTION efectivo 
	ELSE 
		COMMIT TRANSACTION efectivo 

	SELECT @NUMERRORS     AS 'ErrorCount',
		   @ERRORMESSAGE  AS 'ErrorMessage'
END




GO
/****** Object:  StoredProcedure [dbo].[TraspasoCaja_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Author:    Juan, Delgado   
-- Create date: 14-12-2010 
-- Description:  Buscar un traspaso por id
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCaja_GET] 
	@TraspasoID INT
AS 
BEGIN

	SET DATEFORMAT DMY 
	SELECT	 Traspaso_Caja.TraspasoID, 
			 Traspaso_Caja.CajaEmisorID, 
			 Traspaso_Caja.BovedaReceptorID, 
			 Traspaso_Caja.LoginEmisor, 
			 Traspaso_Caja.FechaEmisor, 
			 Traspaso_Caja.LoginReceptor, 
			 Traspaso_Caja.FechaReceptor, 
			 Traspaso_Caja.Recibido, 
			 Traspaso_Caja.Observacion,
			 Emisor.Nombre as Emisor,
			 Receptor.Nombre as Receptor
			  
	FROM Traspaso_Caja	
	JOIN Caja Emisor
	ON   Emisor.CajaID = Traspaso_Caja.CajaEmisorID 
	JOIN Boveda Receptor
	ON   Receptor.BovedaID = Traspaso_Caja.BovedaReceptorID 
	WHERE Traspaso_Caja.TraspasoID = @TraspasoID


  END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoCaja_INSERT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============================================= 
-- Author:    Juan, Delgado   
-- Create date: 03-12-2010 
-- Description:  Crear traspaso	
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCaja_INSERT] 
	@CajaEmisorID INT, 
	@LoginEmisor VARCHAR(30),
	@Observacion VARCHAR(5000),
	@BovedaReceptorID INT
	
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION traspaso 

      SET DATEFORMAT DMY; 

      DECLARE @TraspasoID   INT, 
		      @Descripcion  VARCHAR(50),
              @NUMERRORS    INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    INSERT:[TRASPASO]    ***********************/

	  BEGIN TRY 
          INSERT INTO  Traspaso_Caja
                      (CajaEmisorID, 
                       LoginEmisor, 
                       BovedaReceptorID,
					   FechaEmisor,
					   Observacion) 
          VALUES      (@CajaEmisorID, 
                       @LoginEmisor, 
                       @BovedaReceptorID,
					   getdate(),
					   @Observacion) 
          
          SET @TraspasoID = SCOPE_IDENTITY()
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION traspaso 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 




/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION traspaso 
      ELSE 
        COMMIT TRANSACTION traspaso 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE  AS 'ErrorMessage',
             @TraspasoID    AS 'Identity'
  END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoCaja_OUT_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCaja_OUT_GET] 
	@CajaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso_Caja.TraspasoID, 
			Traspaso_Caja.CajaEmisorID, 
			Traspaso_Caja.BovedaReceptorID, 
			Traspaso_Caja.LoginEmisor, 
			Traspaso_Caja.FechaEmisor, 
			Traspaso_Caja.LoginReceptor, 
			Traspaso_Caja.FechaReceptor, 
			Traspaso_Caja.Recibido, 
			Traspaso_Caja.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso_Caja
	JOIN    Caja Emisor
	ON      Emisor.CajaID = Traspaso_Caja.CajaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso_Caja.BovedaReceptorID 
	WHERE   CajaEmisorID = @CajaID
	AND		Recibido = 0
	

  END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoCajaEfectivo_IN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCajaEfectivo_IN_GET] 
	@BovedaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso_Caja.TraspasoID, 
			Traspaso_Caja.CajaEmisorID, 
			Traspaso_Caja.BovedaReceptorID, 
			Traspaso_Caja.LoginEmisor, 
			Traspaso_Caja.FechaEmisor, 
			Traspaso_Caja.LoginReceptor, 
			Traspaso_Caja.FechaReceptor, 
			Traspaso_Caja.Recibido, 
			Traspaso_Caja.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso_Caja
	JOIN    Caja Emisor
	ON      Emisor.CajaID = Traspaso_Caja.CajaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso_Caja.BovedaReceptorID 
	WHERE   Traspaso_Caja.BovedaReceptorID = @BovedaID
	AND		Traspaso_Caja.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo_Caja
					WHERE  Traspaso_Efectivo_Caja.TraspasoID = Traspaso_Caja.TraspasoID)

END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoCajaEfectivo_OUT_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCajaEfectivo_OUT_GET] 
	@CajaID INT
AS
BEGIN  

    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso_Caja.TraspasoID, 
			Traspaso_Caja.CajaEmisorID, 
			Traspaso_Caja.BovedaReceptorID, 
			Traspaso_Caja.LoginEmisor, 
			Traspaso_Caja.FechaEmisor, 
			Traspaso_Caja.LoginReceptor, 
			Traspaso_Caja.FechaReceptor, 
			Traspaso_Caja.Recibido, 
			Traspaso_Caja.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso_Caja
	JOIN    Caja Emisor
	ON      Emisor.CajaID = Traspaso_Caja.CajaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso_Caja.BovedaReceptorID 
	WHERE   CajaEmisorID = @CajaID
	AND		Recibido = 0	
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo_Caja
					WHERE  Traspaso_Efectivo_Caja.TraspasoID = Traspaso_Caja.TraspasoID)
  END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoCajaEfectivos_Realizados]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar traspasos efectivos realizados
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCajaEfectivos_Realizados] 
	@CajaID INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso_Caja.TraspasoID, 
			Traspaso_Caja.CajaEmisorID, 
			Traspaso_Caja.BovedaReceptorID, 
			Traspaso_Caja.LoginEmisor, 
			Traspaso_Caja.FechaEmisor, 
			Traspaso_Caja.Recibido,
			Emisor.Nombre AS Emisor,
			Receptor.Nombre AS Receptor
	FROM	Traspaso_Caja
	JOIN	Caja Emisor
	ON	    Traspaso_Caja.CajaEmisorID = Emisor.CajaID
	JOIN	Boveda Receptor
	ON	    Traspaso_Caja.BovedaReceptorID = Receptor.BovedaID	
	WHERE   Traspaso_Caja.CajaEmisorID = @CajaID
	AND     Traspaso_Caja.Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso_Caja.FechaEmisor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo_Caja
					WHERE  Traspaso_Efectivo_Caja.TraspasoID = Traspaso_Caja.TraspasoID)

END

GO
/****** Object:  StoredProcedure [dbo].[TraspasoCartaPorte_IN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCartaPorte_IN_GET] 
	@BovedaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     Traspaso.BovedaEmisorID <> 7
	AND     EXISTS (SELECT * 
					FROM   Traspaso_CartaPorte
					WHERE  Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID)

END


GO
/****** Object:  StoredProcedure [dbo].[TraspasoCartaPorte_LosTeques_IN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCartaPorte_LosTeques_IN_GET] 
	@BovedaID INT,
	@BovedaT INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID in(@BovedaID,@BovedaT)
	AND		Traspaso.Recibido = 0
	AND     Traspaso.BovedaEmisorID <> 7
	AND     EXISTS (SELECT * 
					FROM   Traspaso_CartaPorte
					WHERE  Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID)

END


GO
/****** Object:  StoredProcedure [dbo].[TraspasoCartaPorte_OUT_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCartaPorte_OUT_GET] 
	@BovedaID INT
AS
BEGIN  

    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   BovedaEmisorID = @BovedaID
	AND		Recibido = 0	
	AND     EXISTS (SELECT * 
					FROM   Traspaso_CartaPorte
					WHERE  Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID)
  END


GO
/****** Object:  StoredProcedure [dbo].[TraspasoCartaPorteAnillo_IN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCartaPorteAnillo_IN_GET] 
	@BovedaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     Traspaso.BovedaEmisorID = 7
	AND     EXISTS (SELECT * 
					FROM   Traspaso_CartaPorte
					WHERE  Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID)

END


GO
/****** Object:  StoredProcedure [dbo].[TraspasoCartaPortes_Realizados]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




-- Author:    Juan, Delgado   
-- Create date: 17-12-2010 
-- Description:  Buscar cartaportes realizados
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCartaPortes_Realizados] 
	@BovedaID INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.Recibido,
			Emisor.Nombre AS Emisor,
			Receptor.Nombre AS Receptor
	FROM	Traspaso
	JOIN	Boveda Emisor
	ON	    Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN	Boveda Receptor
	ON	    Traspaso.BovedaReceptorID = Receptor.BovedaID	
	WHERE   Traspaso.BovedaEmisorID = @BovedaID
	AND		Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso.FechaEmisor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_CartaPorte
					WHERE  Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID)

END




GO
/****** Object:  StoredProcedure [dbo].[TraspasoCartaPortes_RealizadosConLosTeques]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




-- Author:    Juan, Delgado   
-- Create date: 17-12-2010 
-- Description:  Buscar cartaportes realizados
-- de traspasos
-- ============================================= 
create PROCEDURE [dbo].[TraspasoCartaPortes_RealizadosConLosTeques] 
	@BovedaID INT,
	@BovedaID2 INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.Recibido,
			Emisor.Nombre AS Emisor,
			Receptor.Nombre AS Receptor
	FROM	Traspaso
	JOIN	Boveda Emisor
	ON	    Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN	Boveda Receptor
	ON	    Traspaso.BovedaReceptorID = Receptor.BovedaID	
	WHERE   Traspaso.BovedaEmisorID in(@BovedaID,@BovedaID2)
	AND		Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso.FechaEmisor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_CartaPorte
					WHERE  Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID)

END




GO
/****** Object:  StoredProcedure [dbo].[TraspasoCartaPortes_Recibidos]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




-- Author:    Juan, Delgado   
-- Create date: 17-12-2010 
-- Description:  Buscar cartaportes recibidos
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoCartaPortes_Recibidos] 
	@BovedaID INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.Recibido,
			Receptor.Nombre AS Receptor,
			Emisor.Nombre AS Emisor
	FROM	Traspaso
	JOIN	Boveda Emisor
	ON	    Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN	Boveda Receptor
	ON	    Traspaso.BovedaReceptorID = Receptor.BovedaID
	WHERE   Traspaso.BovedaReceptorID = @BovedaID
	AND     Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso.FechaReceptor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_CartaPorte
					WHERE  Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID)

END




GO
/****** Object:  StoredProcedure [dbo].[TraspasoCartaPortes_RecibidosConLosTeques]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




-- Author:    Juan, Delgado   
-- Create date: 17-12-2010 
-- Description:  Buscar cartaportes recibidos
-- de traspasos
-- ============================================= 
create PROCEDURE [dbo].[TraspasoCartaPortes_RecibidosConLosTeques] 
	@BovedaID INT,
	@BovedaID2 INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.Recibido,
			Receptor.Nombre AS Receptor,
			Emisor.Nombre AS Emisor
	FROM	Traspaso
	JOIN	Boveda Emisor
	ON	    Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN	Boveda Receptor
	ON	    Traspaso.BovedaReceptorID = Receptor.BovedaID
	WHERE   Traspaso.BovedaReceptorID in(@BovedaID,@BovedaID2)
	AND     Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso.FechaReceptor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_CartaPorte
					WHERE  Traspaso_CartaPorte.TraspasoID = Traspaso.TraspasoID)

END




GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivo_IN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoEfectivo_IN_GET] 
	@BovedaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID = @BovedaID
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo
					WHERE  Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID)

END


GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivo_LosTequesIN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
create PROCEDURE [dbo].[TraspasoEfectivo_LosTequesIN_GET] 
	@BovedaID INT,
	@BovedaIDT INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID in(@BovedaID,@BovedaIDT)
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo
					WHERE  Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID)

END


GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivo_OUT_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoEfectivo_OUT_GET] 
	@BovedaID INT
AS
BEGIN  

    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   BovedaEmisorID = @BovedaID
	AND		Recibido = 0	
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo
					WHERE  Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID)
  END


GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivoBovedas_IN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
create PROCEDURE [dbo].[TraspasoEfectivoBovedas_IN_GET] 
	@BovedaID INT,
	@Boveda2 INT,
	@Boveda3 INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
	WHERE   Traspaso.BovedaReceptorID in(@BovedaID,@Boveda2,@Boveda3) 
	AND		Traspaso.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo
					WHERE  Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID)

END


GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivoCaja_IN_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[TraspasoEfectivoCaja_IN_GET] 
	@BovedaID INT
AS
BEGIN  
    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso_Caja.TraspasoID, 
			Traspaso_Caja.CajaEmisorID, 
			Traspaso_Caja.BovedaReceptorID, 
			Traspaso_Caja.LoginEmisor, 
			Traspaso_Caja.FechaEmisor, 
			Traspaso_Caja.LoginReceptor, 
			Traspaso_Caja.FechaReceptor, 
			Traspaso_Caja.Recibido, 
			Traspaso_Caja.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso_Caja
	JOIN    Caja Emisor
	ON      Emisor.CajaID = Traspaso_Caja.CajaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso_Caja.BovedaReceptorID 
	WHERE   Traspaso_Caja.BovedaReceptorID = @BovedaID
	AND		Traspaso_Caja.Recibido = 0
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo_Caja
					WHERE  Traspaso_Efectivo_Caja.TraspasoID = Traspaso_Caja.TraspasoID)

END



GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivos_Realizados]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar traspasos efectivos realizados
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoEfectivos_Realizados] 
	@BovedaID INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.Recibido,
			Emisor.Nombre AS Emisor,
			Receptor.Nombre AS Receptor
	FROM	Traspaso
	JOIN	Boveda Emisor
	ON	    Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN	Boveda Receptor
	ON	    Traspaso.BovedaReceptorID = Receptor.BovedaID	
	WHERE   Traspaso.BovedaEmisorID = @BovedaID
	AND     Traspaso.Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso.FechaEmisor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo
					WHERE  Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID)

END



GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivos_RealizadosConLosTeques]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar traspasos efectivos realizados
-- de traspasos
-- ============================================= 
create PROCEDURE [dbo].[TraspasoEfectivos_RealizadosConLosTeques] 
	@BovedaID INT,
	@BovedaID2 INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.Recibido,
			Emisor.Nombre AS Emisor,
			Receptor.Nombre AS Receptor
	FROM	Traspaso
	JOIN	Boveda Emisor
	ON	    Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN	Boveda Receptor
	ON	    Traspaso.BovedaReceptorID = Receptor.BovedaID	
	WHERE   Traspaso.BovedaEmisorID in(@BovedaID,@BovedaID2)
	AND     Traspaso.Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso.FechaEmisor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo
					WHERE  Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID)

END



GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivos_Recibidos]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar traspasos efectivos recibidos
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoEfectivos_Recibidos] 
	@BovedaID INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.Recibido,
			Emisor.Nombre AS Emisor,
			Receptor.Nombre AS Receptor
	FROM	Traspaso
	JOIN	Boveda Emisor
	ON	    Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN	Boveda Receptor
	ON	    Traspaso.BovedaReceptorID = Receptor.BovedaID	
	WHERE   Traspaso.BovedaReceptorID = @BovedaID
	AND     Traspaso.Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso.FechaReceptor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo
					WHERE  Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID)

END



GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivos_RecibidosConLosTeques]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar traspasos efectivos recibidos
-- de traspasos
-- ============================================= 
create PROCEDURE [dbo].[TraspasoEfectivos_RecibidosConLosTeques] 
	@BovedaID INT,
	@BovedaID2 INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.Recibido,
			Emisor.Nombre AS Emisor,
			Receptor.Nombre AS Receptor
	FROM	Traspaso
	JOIN	Boveda Emisor
	ON	    Traspaso.BovedaEmisorID = Emisor.BovedaID
	JOIN	Boveda Receptor
	ON	    Traspaso.BovedaReceptorID = Receptor.BovedaID	
	WHERE   Traspaso.BovedaReceptorID in(@BovedaID,@BovedaID2)
	AND     Traspaso.Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso.FechaReceptor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo
					WHERE  Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID)

END



GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivosCaja_Recibidos]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[TraspasoEfectivosCaja_Recibidos] 
	@BovedaID INT,
	@Fecha DATETIME
AS
BEGIN  

SET DATEFORMAT DMY; 

	SELECT  Traspaso_Caja.TraspasoID, 
			Traspaso_Caja.CajaEmisorID, 
			Traspaso_Caja.BovedaReceptorID, 
			Traspaso_Caja.LoginEmisor, 
			Traspaso_Caja.FechaEmisor, 
			Traspaso_Caja.Recibido,
			Emisor.Nombre AS Emisor,
			Receptor.Nombre AS Receptor
	FROM	Traspaso_Caja
	JOIN	Caja Emisor
	ON	    Traspaso_Caja.CajaEmisorID = Emisor.CajaID
	JOIN	Boveda Receptor
	ON	    Traspaso_Caja.BovedaReceptorID = Receptor.BovedaID	
	WHERE   Traspaso_Caja.BovedaReceptorID = @BovedaID
	AND     Traspaso_Caja.Recibido = 1
	AND     CONVERT(VARCHAR(10),Traspaso_Caja.FechaReceptor,103) =  @Fecha
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo_Caja
					WHERE  Traspaso_Efectivo_Caja.TraspasoID = Traspaso_Caja.TraspasoID)

END








GO
/****** Object:  StoredProcedure [dbo].[TraspasoEfectivoT_OUT_GET]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- Author:    Juan, Delgado   
-- Create date: 18-10-2010 
-- Description:  Buscar un mi bandeja de entrada
-- de traspasos
-- ============================================= 
CREATE PROCEDURE [dbo].[TraspasoEfectivoT_OUT_GET] 
	@BovedaID INT,
	@BovedaID2 INT
AS
BEGIN  

    SET NOCOUNT ON

	SET DATEFORMAT DMY

   
	SELECT	Traspaso.TraspasoID, 
			Traspaso.BovedaEmisorID, 
			Traspaso.BovedaReceptorID, 
			Traspaso.LoginEmisor, 
			Traspaso.FechaEmisor, 
			Traspaso.LoginReceptor, 
			Traspaso.FechaReceptor, 
			Traspaso.Recibido, 
			Traspaso.Observacion,
			Emisor.Nombre as Emisor,
			Receptor.Nombre as Receptor
	FROM	Traspaso
	JOIN    Boveda Emisor
	ON      Emisor.BovedaID = Traspaso.BovedaEmisorID 
	JOIN    Boveda Receptor
	ON      Receptor.BovedaID = Traspaso.BovedaReceptorID 
WHERE   BovedaEmisorID IN(@BovedaID,@BovedaID2)
	AND		Recibido = 0	
	AND     EXISTS (SELECT * 
					FROM   Traspaso_Efectivo
					WHERE  Traspaso_Efectivo.TraspasoID = Traspaso.TraspasoID)
  END


GO
/****** Object:  StoredProcedure [dbo].[Update_Bloque]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Update_Bloque] 
	@BloqueID VARCHAR(50)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION bloque 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[BLOQUE]    ***********************/

	  BEGIN TRY 
          UPDATE Bloque 
	  SET    CartaporteID = 'COMPROMETIDO'
			 
	  WHERE	 BloqueID = @BloqueID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION bloque 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION bloque 
      ELSE 
        COMMIT TRANSACTION bloque 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END

GO
/****** Object:  StoredProcedure [dbo].[Update_BloqueDevolucion]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Update_BloqueDevolucion] 
	@BloqueID VARCHAR(50)
AS 
  BEGIN 
      SET nocount ON; 
      SET TRANSACTION ISOLATION LEVEL serializable 

      BEGIN TRANSACTION bloque 

      SET DATEFORMAT DMY; 

      DECLARE @NUMERRORS     INT, 
              @ERRORMESSAGE VARCHAR(5000) 

      SET @NUMERRORS = 0; 
      SET @ERRORMESSAGE = ''; 



/***********************    UPDATE:[BLOQUE]    ***********************/

	  BEGIN TRY 
          UPDATE Bloque 
	  SET    CartaporteID = 'NOCOMPRO'
			 
	  WHERE	 BloqueID = @BloqueID
      END TRY 
      BEGIN CATCH 
	      ROLLBACK TRANSACTION bloque 
	      SELECT @ERRORMESSAGE = ERROR_MESSAGE(),
			     @NUMERRORS = @NUMERRORS + 1
		  SELECT @NUMERRORS     AS 'ErrorCount',
				 CASE  ERROR_NUMBER()
					WHEN 4060 THEN 'Error: Base de datos Incorrecta'
					WHEN 18456 THEN 'Error: Inicio de sesión fallido'
					ELSE @ERRORMESSAGE
				 END AS 'ErrorMessage' 
	      RETURN;
      END CATCH 


/***********************    FINAL    ***********************/

      IF @NUMERRORS > 0 
        ROLLBACK TRANSACTION bloque 
      ELSE 
        COMMIT TRANSACTION bloque 

      SELECT @NUMERRORS     AS 'ErrorCount', 
             @ERRORMESSAGE AS 'ErrorMessage' 
  END

GO
/****** Object:  UserDefinedFunction [dbo].[ConvertMontoDecimal]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[ConvertMontoDecimal]
(@Monto VARCHAR(5000))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


	SELECT @Resultado = CONVERT(DECIMAL(18,2),CONVERT(VARCHAR,CONVERT(money, @Monto),1))

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[F_centenas]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--Función para centenas  
--Función que devuelve en letra las centenas. El párametro @Estilo permite identificar los distintos valores que puede tener un mismo número.  
--Figura 4.  
--CREATE FUNCTION F_Centenas(@Numero as bigint, @Estilo as bit=0)  
CREATE FUNCTION [dbo].[F_centenas](@Numero AS BIGINT, 
                           @Estilo AS BIT=0) 
RETURNS VARCHAR(500) 
AS 
  BEGIN 
      DECLARE @Texto VARCHAR(500) 

      SELECT @Texto = '' 

      SELECT @Texto = CASE 
                        WHEN @Numero = 000 THEN ' ' 
                        WHEN @Numero = 100 THEN 'CIEN' 
                        WHEN @Numero > 100 
                             AND @Numero < 200 THEN 'CIENTO ' + 
                                                    dbo.F_decenas(RIGHT( 
                                                    CONVERT(VARCHAR, 
                                                    @Numero), 2) 
                                                    , 0) 
                        WHEN ( @Numero >= 200 
                               AND @Numero < 500 ) 
                              OR ( @Numero > 599 
                                   AND @Numero < 1000 ) THEN 
                        dbo.F_decenas(LEFT( 
                        CONVERT(VARCHAR, @Numero), 1), 1) + 'CIENTOS ' + 
                        dbo.F_decenas(RIGHT(CONVERT(VARCHAR, @Numero), 2), 
                        1) 
                        WHEN @Numero = 500 THEN 'QUINIENTOS' 
                        WHEN @Numero>500 and @Numero<600 THEN 'QUINIENTOS '+
						dbo.F_Decenas(RIGHT(CONVERT(varchar, @Numero), 2), 1)
						WHEN @Numero < 10 THEN dbo.F_unidades(@Numero, 0) 
                        WHEN @Numero < 100 THEN dbo.F_decenas(@Numero, @Estilo) 
                      END 

      RETURN @Texto 
  END 



GO
/****** Object:  UserDefinedFunction [dbo].[F_decenas]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--Función para decenas  
--Función que devuelve en letra las decenas. El párametro @Estilo permite identificar los distintos valores que puede tener un mismo número.  
--Figura 3.  
---CREATE FUNCTION F_Decenas(@Numero as bigint, @Estilo as bit=0)  
CREATE FUNCTION [dbo].[F_decenas](@Numero AS BIGINT, 
                          @Estilo AS BIT=0) 
RETURNS VARCHAR(500) 
AS 
  BEGIN 
      DECLARE @Texto VARCHAR(500) 

      SELECT @Texto = '' 

      SELECT @Texto = CASE 
                        WHEN @Numero = 0 THEN ' ' 
                        WHEN @Numero = 10 THEN 'DIEZ ' 
                        WHEN @Numero = 11 THEN 'ONCE ' 
                        WHEN @Numero = 12 THEN 'DOCE ' 
                        WHEN @Numero = 13 THEN 'TRECE ' 
                        WHEN @Numero = 14 THEN 'CATORCE ' 
                        WHEN @Numero = 15 THEN 'QUINCE ' 
                        WHEN @Numero > 15 
                             AND @Numero < 19 THEN 'DIECI' + dbo.F_unidades( 
                                                             RIGHT( 
                                                             CONVERT(VARCHAR, 
                                                             @Numero), 
                                                             1), 1 
                                                             ) 
                        WHEN @Numero = 19 THEN 'DIECINUEVE' 
                        WHEN @Numero = 20 THEN 'VEINTE' 
                        WHEN @Numero > 20 
                             AND @Numero < 30 THEN 'VEINTI' + 
                                                   dbo.F_unidades(RIGHT( 
                                                   CONVERT(VARCHAR, @Numero 
                                                   ), 1), 
                                                   1) 
                        WHEN @Numero = 30 THEN 'TREINTA' 
                        WHEN @Numero > 30 
                             AND @Numero < 40 THEN 'TREINTA Y ' + 
                                                   dbo.F_unidades( 
                                                   RIGHT( 
                                                   CONVERT(VARCHAR, 
                                                   @Numero), 
                                                   1 
                                                   ), 0) 
                        WHEN @Numero = 40 THEN 'CUARENTA' 
                        WHEN @Numero > 40 
                             AND @Numero < 50 THEN 'CUARENTA Y ' + 
                                                   dbo.F_unidades( 
                                                   RIGHT( 
                                                   CONVERT(VARCHAR, @Numero), 1) 
                                                   , 0 
                                                   ) 
                        WHEN @Numero = 50 THEN 'CINCUENTA' 
                        WHEN @Numero > 50 
                             AND @Numero < 60 THEN 'CINCUENTA Y ' + 
                                                   dbo.F_unidades( 
                                                   RIGHT( 
                                                   CONVERT(VARCHAR, @Numero), 1) 
                                                   , 
                                                   0) 
                        WHEN @Numero = 60 THEN 'SESENTA' 
                        WHEN @Numero > 60 
                             AND @Numero < 70 THEN 'SESENTA Y ' + 
                                                   dbo.F_unidades( 
                                                   RIGHT( 
                                                   CONVERT(VARCHAR, 
                                                   @Numero), 
                                                   1 
                                                   ), 0) 
                        WHEN @Numero = 70 THEN 'SETENTA' 
                        WHEN @Numero > 70 
                             AND @Numero < 80 THEN 'SETENTA Y ' + 
                                                   dbo.F_unidades( 
                                                   RIGHT( 
                                                   CONVERT(VARCHAR, 
                                                   @Numero), 
                                                   1 
                                                   ), 0) 
                        WHEN @Numero = 80 THEN 'OCHENTA' 
                        WHEN @Numero > 80 
                             AND @Numero < 90 THEN 'OCHENTA Y ' + 
                                                   dbo.F_unidades( 
                                                   RIGHT( 
                                                   CONVERT(VARCHAR, 
                                                   @Numero), 
                                                   1 
                                                   ), 0) 
                        WHEN @Numero = 90 THEN 'NOVENTA' 
                        WHEN @Numero > 90 
                             AND @Numero < 100 THEN 
                        'NOVENTA Y ' + dbo.F_unidades( 
                                       RIGHT( 
                        CONVERT(VARCHAR, @Numero), 1), 
                                       0) 
                        WHEN @Numero < 10 THEN dbo.F_unidades(@Numero, @Estilo) 
                      END 

      RETURN @Texto 
  END 


GO
/****** Object:  UserDefinedFunction [dbo].[F_millares]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--Función para millares  
---Función que devuelve en letra los millares. El párametro @Estilo permite identificar los distintos valores que puede tener un mismo número.  
---Figura 5.  
--CREATE FUNCTION F_Millares(@Numero as bigint, @Estilo as bit=0)  
CREATE FUNCTION [dbo].[F_millares](@Numero AS BIGINT, 
                           @Estilo AS BIT=0) 
RETURNS VARCHAR(500) 
AS 
  BEGIN 
      DECLARE @Texto VARCHAR(500) 
      DECLARE @EstiloCentenas BIT 

      SELECT @EstiloCentenas = CONVERT(BIT, Len(@Numero)-4) 

      SELECT @Texto = CASE 
                        WHEN @Numero = 0000 THEN ' ' 
                        WHEN @Numero = 1000 THEN 'MIL' 
                        WHEN @Numero > 1000 
                             AND @Numero < 1999 THEN 'MIL ' + 
                        dbo.F_centenas(RIGHT( 
                        CONVERT(VARCHAR, @Numero), 3), 1) 
                        WHEN @Numero > 1999 
                             AND @Numero < 1000000 THEN 
                        dbo.F_centenas(LEFT( 
                        CONVERT(VARCHAR, @Numero), 
                        Len(@Numero) - 3), 
                        @EstiloCentenas) + ' MIL ' + 
                        dbo.F_centenas(RIGHT( 
                        CONVERT(VARCHAR, @Numero) 
                                       , 3), 1) 
                        WHEN @Numero < 1000 THEN dbo.F_centenas(@Numero, @Estilo 
                                                 ) 
                        WHEN @Numero < 10 THEN dbo.F_unidades(@Numero, 0) 
                        WHEN @Numero < 100 THEN dbo.F_decenas(@Numero, @Estilo) 
                        WHEN @Numero < 1000 THEN dbo.F_centenas(@Numero, @Estilo 
                                                 ) 
                      END 

      RETURN @Texto 
  END  
GO
/****** Object:  UserDefinedFunction [dbo].[F_unidades]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--En el proceso principal se delega el procesado de la parte entera y decimal de un número en las funciones de apoyo.   
--Función para unidades   
--Función que devuelve en letra las unidades. El párametro @Estilo permite identificar los distintos valores que puede tener un mismo número.   
--Figura 2.   
--CREATE FUNCTION F_Unidades(@Numero as bigint, @Estilo as bit=0)   
CREATE FUNCTION [dbo].[F_unidades](@Numero AS BIGINT, 
                                  @Estilo AS BIT=0) 
RETURNS VARCHAR(500) 
AS 
  BEGIN 
      DECLARE @Texto VARCHAR(500) 

      SELECT @Texto = '' 

      SELECT @Texto = CASE 
--                        WHEN @Numero = 0 THEN 'CERO ' 
--                        WHEN @Numero = 1 THEN 'UNO ' 

						WHEN @Numero = 0
                             AND @Estilo = 0 THEN 'CERO ' 
                        WHEN @Numero = 0 
                             AND @Estilo = 1 THEN 'CERO'

                        WHEN @Numero = 1 
                             AND @Estilo = 0 THEN 'UNO ' 
                        WHEN @Numero = 1 
                             AND @Estilo = 1 THEN 'UNO' 

                        WHEN @Numero = 2 
                             AND @Estilo = 0 THEN 'DOS ' 
                        WHEN @Numero = 2 
                             AND @Estilo = 1 THEN 'DOS' 
                        WHEN @Numero = 3 
                             AND @Estilo = 0 THEN 'TRES ' 
                        WHEN @Numero = 3 
                             AND @Estilo = 1 THEN 'TRES' 
                        WHEN @Numero = 4 
                             AND @Estilo = 0 THEN 'CUATRO ' 
                        WHEN @Numero = 4 
                             AND @Estilo = 1 THEN 'CUATRO' 
                        WHEN @Numero = 5 THEN 'CINCO ' 
                        WHEN @Numero = 6 
                             AND @Estilo = 0 THEN 'SEIS ' 
                        WHEN @Numero = 6 
                             AND @Estilo = 1 THEN 'SEIS' 
                        WHEN @Numero = 7 
                             AND @Estilo = 0 THEN 'SIETE ' 
                        WHEN @Numero = 7 
                             AND @Estilo = 1 THEN 'SETE' 
                        WHEN @Numero = 8 
                             AND @Estilo = 0 THEN 'OCHO ' 
                        WHEN @Numero = 8 
                             AND @Estilo = 1 THEN 'OCHO' 
                        WHEN @Numero = 9 
                             AND @Estilo = 0 THEN 'NUEVE ' 
                        WHEN @Numero = 9 
                             AND @Estilo = 1 THEN 'NUEVE' 
                      END 

      RETURN @Texto 
  END  
GO
/****** Object:  UserDefinedFunction [dbo].[fnDecimalToCurrency]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[fnDecimalToCurrency]

            (@Amount AS DECIMAL(38,2) )

RETURNS VARCHAR(64) 

AS 

  BEGIN 

    DECLARE  @Result VARCHAR(64), 

             @Buffer VARCHAR(64), 

             @Comma  CHAR(1) 

    SET @Result = '' 

    SET @Comma = '' 

    SET @Buffer = convert(VARCHAR(64),@Amount) 

    SET @Result = right(@Buffer,3) 

    SET @Buffer = left(@Buffer,len(@Buffer) - 3) 

    WHILE (len(@Buffer) > 0) 

      BEGIN 

        SET @Result = left(convert(VARCHAR,convert(MONEY,reverse(

                                  left(reverse(@Buffer),12))), 

                                   1),len(convert(VARCHAR,convert(MONEY,

                                   reverse(left(reverse(@Buffer),12))), 

                                            1)) - 3) + @Comma + @Result 

        SET @Buffer = CASE 

                        WHEN len(@Buffer) > 12 

                          THEN left(@Buffer,len(@Buffer) - 12) 

                        ELSE '' 

                      END 

        SET @Comma = ',' 

      END 

    RETURN REPLACE(@Result,' ','') 

  END 


GO
/****** Object:  UserDefinedFunction [dbo].[GET_CuentaSaldo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[GET_CuentaSaldo]
	(@CuentaID INT)
	RETURNS decimal(18,3)	
AS
BEGIN


declare @MontoC decimal(18,3)
declare @MontoE decimal(18,3)
declare @MontoB decimal(18,3)
declare @MontoBl decimal(18,3)
declare @Total decimal(18,3)

set @MontoC = (select sum(monto) from cartaporte where cuentaid = @CuentaID) 
set @MontoE = (select sum(envase_efectivo.monto) from envase_efectivo 
	join envase
	on envase.envaseid = envase_efectivo.envaseid
	join cartaporte
	on cartaporte.cartaporteid = envase.cartaporteid
	where cartaporte.cuentaid = @CuentaID ) 
set @MontoB = (select sum(monto) from boveda_efectivo where  bovedaid = 3) 
set @MontoBl = (select sum(bloque_efectivo.monto) from bloque_efectivo join bloque 
	on bloque.bloqueid = bloque_efectivo.bloqueid
	where bloque.bovedaid =3)
	
select   @Total = @MontoC + @MontoE + @MontoB + @MontoBl
		  	
return @Total
                                                  
                                                  
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getCartaportesByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getCartaportesByRuta]
(@RutaID INT,
@PuntoID INT,
@Tipo INT)
RETURNS varchar(13)
AS 
BEGIN 
DECLARE @Resultado varchar(13)


SELECT @Resultado = Cartaporte.CartaporteID
FROM  Cartaporte 
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Cartaporte_Punto
ON Cartaporte_Punto.CartaporteID = Ruta_Cartaporte.CartaporteID
AND  PuntoID = @PuntoID
WHERE Ruta_Cartaporte.RutaID =@RutaID

AND  Ruta_Cartaporte.Tipo =@Tipo
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getCartaportesByRutaAll]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getCartaportesByRutaAll]
(@RutaID INT,
@PuntoID INT)
RETURNS varchar(5000)
AS 
BEGIN 
DECLARE @Resultado varchar(5000)


SELECT @Resultado =  REPLACE(RTRIM((SELECT CAST(Grupo.CartaPorteID AS VARCHAR(MAX)) + ' ' 
		   					  FROM   CartaPorte_Punto Grupo
							  WHERE  Grupo.TIPO = 2
							  AND    Grupo.PuntoID = @PuntoID
							  AND    EXISTS (SELECT *
											 FROM   Ruta_CartaPorte d
											 WHERE  d.CartaPorteID = Grupo.CartaPorteID
											 AND    d.RutaID = @RutaID
											 AND    d.TIPO = 1  GROUP BY d.CartaporteID)
							  FOR XML PATH (''))),' ',' - ')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getCartaportesByRutaConFondo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getCartaportesByRutaConFondo]
(@RutaID INT,
@PuntoID INT,
@Tipo INT)
RETURNS varchar(13)
AS 
BEGIN 
DECLARE @Resultado varchar(13)


SELECT @Resultado = Cartaporte.CartaporteID
FROM  Cartaporte 
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Cartaporte_Punto
ON Cartaporte_Punto.CartaporteID = Ruta_Cartaporte.CartaporteID
AND  PuntoID = @PuntoID
WHERE Ruta_Cartaporte.RutaID =@RutaID

AND  Ruta_Cartaporte.Tipo in(1,4)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getDiferencia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getDiferencia]
(@MontoCartaporte decimal(18,3),
@MontoContado decimal(18,3))
RETURNS decimal	(18,3)
AS 
BEGIN 

DECLARE @Resultado decimal(18,3)

SET @Resultado =  @MontoContado - @MontoCartaporte

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getDiferenciaByPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getDiferenciaByPunto]
(@MontoEntrada decimal(18,3),
@MontoContado decimal(18,3))
RETURNS decimal	(18,3)
AS 
BEGIN 

DECLARE @Resultado decimal(18,3)

SET @Resultado = @MontoContado - @MontoEntrada

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getDiferenciaVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getDiferenciaVABT]
(@MontoCartaporte decimal(18,3),
@MontoContado decimal(18,3))
RETURNS decimal	(18,3)
AS 
BEGIN 

DECLARE @Resultado decimal(18,3)

SET @Resultado =  @MontoContado - @MontoCartaporte

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasePorPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasePorPunto]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignatario int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = COUNT(DISTINCT(Envase.envaseid))
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignatarioR.Fecha) = @Mes
	        and YEAR(ConsignatarioR.Fecha) = @Ano
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.Cartaporteid like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	
	and Cartaporte.rubroID in(@rubro)
	and consignatario.PuntoID = @Consignatario
	and consignatarioR.tipo=2
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasePorPuntoEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create FUNCTION [dbo].[getEnvasePorPuntoEntrada]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignador int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = COUNT(DISTINCT(Envase.envaseid))
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignadorR.Fecha) = @Mes
	        and YEAR(ConsignadorR.Fecha) = @Ano
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cartaporteid  not like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	
	and Cartaporte.rubroID in(@rubro)
	and consignador.PuntoID = @Consignador
	and consignadorR.tipo=1
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesBilletesByCartaporte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesBilletesByCartaporte]
(@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.envaseid))
		FROM   Envase e
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		WHERE  e.CartaporteID = @CartaporteID
	    AND Efectivo.EfectivoTipoID in(3,4)
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesBilletesByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesBilletesByRuta]
(@Ruta VARCHAR(13),@Denominacion VARCHAR(30))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.envaseid))
		FROM   Envase e
		JOIN CartaPorte 
		ON CartaPorte.CartaPorteID = e.CartaPorteID
		JOIN Ruta_CartaPorte
		ON Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
		JOIN Ruta
		ON Ruta.RutaID = Ruta_CartaPorte.RutaID
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		WHERE  Efectivo.EfectivoTipoID in(3,4)
	    and Ruta.Nombre = @Ruta
		   AND Efectivo.Denominacion = @Denominacion
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesBilletesByRuta2]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesBilletesByRuta2]
(@Ruta VARCHAR(13))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.NroPlomo))
		FROM   Envase e
		JOIN CartaPorte 
		ON CartaPorte.CartaPorteID = e.CartaPorteID
		JOIN Ruta_CartaPorte
		ON Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
		JOIN Ruta
		ON Ruta.RutaID = Ruta_CartaPorte.RutaID
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		WHERE  Efectivo.EfectivoTipoID in(3,4)
	    and Ruta.Nombre = @Ruta
		   AND Efectivo.EfectivoID = 'BF20'
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesBilletesByRuta5]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesBilletesByRuta5]
(@Ruta VARCHAR(13))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.NroPlomo))
		FROM   Envase e
		JOIN CartaPorte 
		ON CartaPorte.CartaPorteID = e.CartaPorteID
		JOIN Ruta_CartaPorte
		ON Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
		JOIN Ruta
		ON Ruta.RutaID = Ruta_CartaPorte.RutaID
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		WHERE  Efectivo.EfectivoTipoID in(3,4)
	    and Ruta.Nombre = @Ruta
		   AND Efectivo.EfectivoID = 'BF21'
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesBilletesByRuta52]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesBilletesByRuta52]
(@Ruta VARCHAR(13))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.NroPlomo))
		FROM   Envase e
		JOIN CartaPorte 
		ON CartaPorte.CartaPorteID = e.CartaPorteID
		JOIN Ruta_CartaPorte
		ON Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
		JOIN Ruta
		ON Ruta.RutaID = Ruta_CartaPorte.RutaID
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		WHERE  Efectivo.EfectivoTipoID in(3,4)
	    and Ruta.Nombre = @Ruta
		   AND Efectivo.EfectivoID in('BF21','BF20')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesByCartaporte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesByCartaporte]
(@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  COUNT(*) 
		   FROM   Envase 
		   
		   WHERE  Envase.CartaporteID = @CartaporteID
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesByRuta]
(@RutaID INT,
@PuntoID INT,
@Tipo INT,
@EfectivoID VARCHAR(5))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = @EfectivoID
		   AND    EXISTS (SELECT *
						 FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN Cartaporte_Punto P
						  ON   P.CartaporteID = d.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    d.RutaID = @RutaID
						  AND  P.PuntoID = @PuntoID
						  AND    d.TIPO = @Tipo)
		   
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesByRutaAll]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesByRutaAll]
(@RutaID INT,
@PuntoID INT)
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  COUNT(*) 
		   FROM   Envase c
		   WHERE    EXISTS (SELECT *
						 FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN Cartaporte_Punto P
						  ON   P.CartaporteID = d.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    d.RutaID = @RutaID
						  AND  P.PuntoID = @PuntoID
						  AND  p.Tipo = 2)
		   
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesByRutaConFondo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getEnvasesByRutaConFondo]
(@RutaID INT,
@PuntoID INT,
@Tipo INT,
@EfectivoID VARCHAR(5))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = @EfectivoID
		   AND    EXISTS (SELECT *
						 FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN Cartaporte_Punto P
						  ON   P.CartaporteID = d.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    d.RutaID = @RutaID
						  AND  P.PuntoID = @PuntoID
						  AND    d.TIPO in(1,4))
		   
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesByRutaConFondoTotal]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesByRutaConFondoTotal]
(@RutaID INT,
@PuntoID INT,
@Tipo INT,
@EfectivoID VARCHAR(5))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  SUM(c.EnvaseID)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = @EfectivoID
		   AND    EXISTS (SELECT *
						 FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN Cartaporte_Punto P
						  ON   P.CartaporteID = d.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    d.RutaID = @RutaID
						  AND  P.PuntoID = @PuntoID
						  AND    d.TIPO in(1,4))
		   
		  
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesEntradaAcopio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesEntradaAcopio]
(@rubro int,@Fecha varchar(10),@cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = COUNT((Envase.EnvaseID))
  
                   
    FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	and Cartaporte.rubroID in(@rubro)
	
		

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesEntradaATM]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesEntradaATM]
(@rubro int,@Fecha varchar(10),@cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = COUNT((Envase.EnvaseID))
  
                   
    FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	AND consignador.PuntoID = @PuntoID
	and Cartaporte.rubroID in(@rubro)
	
		

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesEntradaATMSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getEnvasesEntradaATMSalida]
(@rubro int,@Fecha varchar(10),@cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = COUNT((Envase.EnvaseID))
  
                   
    FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,2,3,4)
	and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	AND consignador.PuntoID = @PuntoID
	and Cartaporte.rubroID in(@rubro)
	
		

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesEntradaATMSalidaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getEnvasesEntradaATMSalidaSalida]
(@rubro int,@Fecha varchar(10),@cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = COUNT((Envase.EnvaseID))
  
                   
    FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,2,3,4)
	and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	AND consignatario.PuntoID = @PuntoID
	and Cartaporte.rubroID in(@rubro)
	
		

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesEntradaBanco]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesEntradaBanco]
(@rubro int,@Fecha varchar(10),@cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = COUNT((Envase.EnvaseID))
  
                   
    FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 

	
	where   Ruta_CartaPorte.Tipo in(2,3)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
			AND    cartaporte.Porsistema = 'false'
	
		

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesMonedasByCartaporte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesMonedasByCartaporte]
(@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.envaseid)) 
		  FROM   Envase e
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		WHERE  e.CartaporteID = @CartaporteID
			AND Efectivo.EfectivoTipoID in(1,2)
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesMonedasByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesMonedasByRuta]
(@RutaID int)
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.envaseid))
		FROM   Envase e
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		JOIN Cartaporte
		ON  Cartaporte.CartaporteID = e.EnvaseID
		JOIN Ruta_Cartaporte 
		ON   Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
        JOIN  Ruta
		ON Ruta.RutaID = Ruta_Cartaporte.RutaID
		WHERE  Ruta.RutaID = @RutaID
	    AND Efectivo.EfectivoTipoID in(1,2)
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesSalidaAcopio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesSalidaAcopio]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = COUNT((Envase.EnvaseID))
  
                   
    FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.CartaporteID LIKE '%TVV%'
	--and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	and Cartaporte.rubroID in(@rubro)
	
	
		

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesSalidaATM]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesSalidaATM]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = COUNT((Envase.EnvaseID))
  
                   
    FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.CartaporteID LIKE '%TVV%'
	--and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	AND CONSIGNATARIO.PUNTOID =@PuntoID
	and Cartaporte.rubroID in(@rubro)
	
	
		

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesTotalByCartaporte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getEnvasesTotalByCartaporte]
(@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.envaseid)) 
		  FROM   Envase e
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		WHERE  e.CartaporteID = @CartaporteID
			AND Efectivo.EfectivoTipoID in(1,2,3,4)
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesTotalByCartaporteVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesTotalByCartaporteVABT]
(@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.envaseid)) 
		  FROM   Envase e
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		WHERE  e.CartaporteID = @CartaporteID
			AND Efectivo.EfectivoTipoID in(1,2,3,4)
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesTotalByCartaporteVABTMensual]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesTotalByCartaporteVABTMensual]
(@Ano VARCHAR(4),
@Mes VARCHAR(2),
@Login varchar(30))
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.envaseid)) 
		  FROM   Envase e
		  Join   Cartaporte
		  ON Cartaporte.CartaporteID = e.CartaporteID
		JOIN Envase_Efectivo
		ON   Envase_Efectivo.EnvaseID = e.EnvaseID
		JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
		WHERE  Efectivo.EfectivoTipoID in(1,2,3,4)
		    and MONTH(Cartaporte.FechaCerrado) = @Mes
	        and YEAR(Cartaporte.FechaCerrado) = @Ano
		  AND   Cartaporte.CuentaID = 5
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesTotalByConsignador]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesTotalByConsignador]
(@ConsignadorID INT)
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado =  count(distinct(e.envaseid)) 
		  FROM   Envase e
		  JOIN Cartaporte
		  ON Cartaporte.Cartaporteid = e.Cartaporteid
		  JOIN   CartaPorte_Punto ConsignadorR
		ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
		AND    ConsignadorR.Tipo = 1 --ConsignadorR
		JOIN   Punto Consignador
		ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
		JOIN   CartaPorte_Punto ConsignatarioR
		ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
		AND    ConsignatarioR.Tipo = 2 --Consignatario
		JOIN   Punto Consignatario
		ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
		  
		WHERE  ConsignadorR.PuntoID = @ConsignadorID
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getEnvasesTotalByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getEnvasesTotalByRuta]
(@RutaID INT,
@PuntoID INT)
RETURNS VARCHAR(5000)
AS 
BEGIN 
DECLARE @Resultado VARCHAR(5000)
							  
SELECT @Resultado = REPLACE(RTRIM((SELECT CAST(e.NroPlomo AS VARCHAR(MAX)) + ' ' 
		  FROM   Envase e
	    WHERE  EXISTS (SELECT *
					  FROM   Ruta_CartaPorte d
					  join   CartaPorte
					  on CartaPorte.CartaPorteID = d.CartaPorteID
					  join Envase
					  on   Envase.CartaPorteID = CartaPorte.CartaPorteID
					  JOIN   vw_Cartaporte vwc
					  ON	 d.CartaPorteID = vwc.CartaPorteID
					  JOIN Cartaporte_Punto P
					  ON   P.CartaporteID = d.CartaporteID
					  WHERE Envase.EnvaseID = e.EnvaseID 
					  and d.RutaID = @RutaID
					  AND  P.PuntoID = @PuntoID
					  AND  p.Tipo = 2)					  
					  FOR XML PATH (''))),' ',' - ')
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getFaltante]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getFaltante]
(@MontoCartaporte decimal(18,3),
@MontoContado decimal(18,3))
RETURNS decimal	(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)

IF @MontoCartaporte > @MontoContado

BEGIN
	SET @Resultado =  @MontoContado - @MontoCartaporte
END	


RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getFaltanteByPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getFaltanteByPunto]
(@MontoEntrada decimal(18,3),
@MontoContado decimal(18,3))
RETURNS decimal	(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)

IF @MontoEntrada > @MontoContado

BEGIN
	SET @Resultado = @MontoContado - @MontoEntrada
END	


RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getFaltanteNoContado]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

	CREATE FUNCTION [dbo].[getFaltanteNoContado]
(@Desde varchar(10),
 @Hasta varchar(10),
 @CuentaID int)
RETURNS decimal	(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)



SELECT @Resultado =  sum(cartaporte.monto)


	FROM   CartaPorte
	
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	--JOIN   Envase_Efectivo
	--ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID

	   JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
 
	WHERE  
	-- and  CONVERT(CHAR(10), r.FechaCreado, 103) = CONVERT(CHAR(10),@Fecha, 103)
	   CONVERT(CHAR(10), Cartaporte.FechaCreado, 103) = @Desde
	--CONVERT(VARCHAR,Cartaporte.FechaCreado,105)  = @Desde
	 and  cartaporte.Porsistema = 'false'
	 --and   ConsignadorR.Tipo = 1
    and Cartaporte.rubroid IN(1,2,3,4)
	and  cartaporte.cuentaid= @CuentaID
    and Envase.nroplomo = 'DEV'


RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getFaltanteVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREate FUNCTION [dbo].[getFaltanteVABT]
(@MontoCartaporte decimal(18,3),
@MontoContado decimal(18,3))
RETURNS decimal	(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)

IF @MontoCartaporte > @MontoContado

BEGIN
	SET @Resultado =  @MontoContado - @MontoCartaporte
END	


RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getMontoByPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getMontoByPunto]
(@PuntoID INT,
@FechaContado datetime)
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   punto_Efectivo b
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (1,2,3,4)
			AND  b.FechaContado = @FechaContado
			AND  b.PuntoID = @PuntoID

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getMontobyTipoEfectivoEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontobyTipoEfectivoEntrada]
(@Fecha VARCHAR(10),@TipoEfectivo VARCHAR(4),@CartaPorteID VARCHAR(30))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


						  
select @Resultado = SUM(Envase_Efectivo.Monto) 
		  

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Envase_Efectivo
	ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 2
	AND    Ruta.Fecha = @Fecha
--and biblia.puntoid = 187
and Envase_Efectivo.EfectivoID =@TipoEfectivo
                   AND Biblia.tipo in('metro','metromtb')
                  and CartaPorte.CartaPorteID=@CartaPorteID
	

	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontobyTipoEfectivoEntradaFondo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontobyTipoEfectivoEntradaFondo]
(@Fecha VARCHAR(10),@TipoEfectivo VARCHAR(4),@CartaPorteID VARCHAR(30))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


						  
select @Resultado = SUM(Envase_Efectivo.Monto) 
		  

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Envase_Efectivo
	ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 3
	AND    Ruta.Fecha = @Fecha
--and biblia.puntoid = 187
and Envase_Efectivo.EfectivoID =@TipoEfectivo
                   AND Biblia.tipo in('metro','metromtb')
                  and CartaPorte.CartaPorteID=@CartaPorteID
	

	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontobyTipoEfectivoEntradaFondoLosTeques]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontobyTipoEfectivoEntradaFondoLosTeques]
(@Fecha VARCHAR(10),@TipoEfectivo VARCHAR(4),@CartaPorteID VARCHAR(30))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


						  
select @Resultado = SUM(Envase_Efectivo.Monto) 
		  

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Envase_Efectivo
	ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 3
	AND    Ruta.Fecha = @Fecha
--and biblia.puntoid = 187
and Envase_Efectivo.EfectivoID =@TipoEfectivo
                   AND Biblia.tipo in('MetroMLTe')
                  and CartaPorte.CartaPorteID=@CartaPorteID
	

	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontobyTipoEfectivoEntradaLosTeques]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontobyTipoEfectivoEntradaLosTeques]
(@Fecha VARCHAR(10),@TipoEfectivo VARCHAR(4),@CartaPorteID VARCHAR(30))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


						  
select @Resultado = SUM(Envase_Efectivo.Monto) 
		  

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Envase_Efectivo
	ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 2
	AND    Ruta.Fecha = @Fecha
--and biblia.puntoid = 187
and Envase_Efectivo.EfectivoID =@TipoEfectivo
                   AND Biblia.tipo in('MetroMLTe')
                  and CartaPorte.CartaPorteID=@CartaPorteID
	

	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEfectivos]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getMontoEfectivos]
(@CartaporteID VARCHAR(13),
@EfectivoID VARCHAR(5))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		  SELECT @Resultado =  SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
		   WHERE  b.EfectivoID = @EfectivoID
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1
		  
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEfectivosByPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getMontoEfectivosByPunto]
(@PuntoID INT,
@EfectivoID VARCHAR(5),
@FechaContado datetime)
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		  SELECT @Resultado =  SUM(b.MONTO) 
		   FROM   punto_Efectivo b
		   WHERE  b.EfectivoID = @EfectivoID
			AND  b.FechaContado = @FechaContado
			AND  b.PuntoID = @PuntoID

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEfectivosByPuntoMensual]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getMontoEfectivosByPuntoMensual]
(@PuntoID INT,
@EfectivoID VARCHAR(5),
@Mes varchar(2),
@Ano varchar(4))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		  SELECT @Resultado =  SUM(b.MONTO) 
		   FROM   punto_Efectivo b
		   WHERE  b.EfectivoID = @EfectivoID
		    and MONTH(b.FechaContado) = @Mes
	        and YEAR(b.FechaContado) = @Ano
			AND  b.PuntoID = @PuntoID

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEfectivosVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getMontoEfectivosVABT]
(@CartaporteID VARCHAR(13),
@EfectivoID VARCHAR(5))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		  SELECT @Resultado =  SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
		   WHERE  b.EfectivoID = @EfectivoID
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1
		  AND   Cartaporte.CuentaID = 5
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEfectivosVABTMensual]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getMontoEfectivosVABTMensual]
(@Ano VARCHAR(4),
@Mes VARCHAR(2),
@EfectivoID VARCHAR(5),@Login varchar(30))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		  SELECT @Resultado =  SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
		   WHERE  b.EfectivoID = @EfectivoID
           AND    c.estaabierto = 1
               and MONTH(Cartaporte.FechaCerrado) = @Mes
	        and YEAR(Cartaporte.FechaCerrado) = @Ano
		  AND   Cartaporte.CuentaID = 5
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEntradabyConteo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getMontoEntradabyConteo]
(@Rubro int,@FechaCerrado VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		  SELECT @Resultado =  SUM(CartaPorte.MONTO) 
		   FROM  Cartaporte
		   WHERE  Cartaporte.FechaCerrado = @FechaCerrado
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
			AND    cartaporte.Porsistema = 'false'
		  
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEntradaByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoEntradaByRuta]
(@Fecha VARCHAR(10))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID

	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
	AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
	and biblia.puntoid <> 187
	AND Biblia.tipo in('metro','metromtb')

	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEntradaByRutaAcopio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoEntradaByRutaAcopio]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	and Cartaporte.rubroID in(@rubro)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEntradaByRutaATM]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoEntradaByRutaATM]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	and Cartaporte.rubroID in(@rubro)
	and consignador.PuntoID = @PuntoID
	and consignadorR.tipo=1
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEntradaByRutaATMSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoEntradaByRutaATMSalida]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,2,3,4)
	and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	and Cartaporte.rubroID in(@rubro)
	and consignador.PuntoID = @PuntoID
	and consignadorR.tipo=1
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEntradaByRutaATMSalidaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoEntradaByRutaATMSalidaSalida]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,2,3,4)
	and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	and Cartaporte.rubroID in(@rubro)
	and consignatario.PuntoID = @PuntoID
	and consignatarioR.tipo=2
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEntradaByRutaBanco]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoEntradaByRutaBanco]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   CartaPorte.FechaCerrado = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cerrado = 'true'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	and Cartaporte.rubroID in(@rubro)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoEntradaByRutaConMlte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoEntradaByRutaConMlte]
(@Fecha VARCHAR(10))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = CartaPorte.CartaPorteID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO in(2,3))
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and biblia.puntoid <> 187
	AND Biblia.tipo in('metro','metromtb')

	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoPorPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoPorPunto]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignatario int)
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignatarioR.Fecha) = @Mes
	        and YEAR(ConsignatarioR.Fecha) = @Ano
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.Cartaporteid like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	
	and Cartaporte.rubroID in(@rubro)
	and consignatario.PuntoID = @Consignatario
	and consignatarioR.tipo=2
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoPorPuntoEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getMontoPorPuntoEntrada]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignador int)
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignadorR.Fecha) = @Mes
	        and YEAR(ConsignadorR.Fecha) = @Ano
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cartaporteid not like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	
	and Cartaporte.rubroID in(@rubro)
	and consignador.PuntoID = @Consignador
	and consignadorR.tipo=1
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoSalidaByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoSalidaByRuta]
(@Fecha VARCHAR(10))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and biblia.puntoid <> 187
	AND Biblia.tipo in('metro','metromtb')

	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoSalidaByRutaAcopio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoSalidaByRutaAcopio]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	--and Cartaporte.Cerrado = 'true'
	and Cartaporte.CartaporteID LIKE '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	and Cartaporte.rubroID in(@rubro)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontoSalidaByRutaATM]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontoSalidaByRutaATM]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID INT)
RETURNS decimal(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


select @Resultado = SUM(CartaPorte.MONTO) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3   
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	AND Consignatario.PuntoID = @PuntoID
	AND ConsignatarioR.tipo=2
	--and Cartaporte.Cerrado = 'true'
	and Cartaporte.CartaporteID LIKE '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	and Cuenta.CuentaID in (@Cuentas)
	and Cartaporte.rubroID in(@rubro)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getMontosSalidaFacturacionMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getMontosSalidaFacturacionMC]
(@Fecha varchar(10))
RETURNS decimal(18,3)
AS 
BEGIN 


DECLARE @Resultado decimal(18,3)

  select @Resultado  =((SELECT SUM(c.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
			and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5') 
						  AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4) ))) +
			((SELECT SUM(c.Monto)  
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF20'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
			and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5') 
						  AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4) ))) +
  ((SELECT SUM(c.Monto) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
			and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5') 
						  AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4) )) * 5 ) +
		   ((SELECT SUM(c.Monto)  
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5')  
						   AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4) )) * 10) +
		   ((SELECT SUM(c.Monto)   
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5')
						   AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4) )) * 20) +
		   ((SELECT SUM(c.Monto)  
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
			and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5')
						   AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4)  )) * 40 )                 
	
			
			
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getNroPlomos]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getNroPlomos]
(@Cartaportes VARCHAR(500))
RETURNS varchar(500)
AS 
BEGIN 
DECLARE @Resultado varchar(500)


SELECT @Resultado = REPLACE(RTRIM((SELECT CAST(Grupo.NroPlomo AS VARCHAR(MAX)) + ' ' 
		   					  FROM   Envase Grupo
							  WHERE  Grupo.CartaporteID in(@Cartaportes) 
							  FOR XML PATH (''))),' ',' - ')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPiezasByEnvase]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getPiezasByEnvase]
(@EnvaseID INT)
RETURNS VARCHAR(500)
AS 
BEGIN 
DECLARE @Resultado VARCHAR(500)


SELECT @Resultado =  SUM(Piezas/1000) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   
		   
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPiezasByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPiezasByRuta]
(@RutaID INT,
@PuntoID INT,
@Tipo INT,
@EfectivoID VARCHAR(5))
RETURNS VARCHAR(50)
AS 
BEGIN 
DECLARE @Resultado VARCHAR(50)


SELECT @Resultado =  SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = @EfectivoID
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN Cartaporte_Punto P
						  ON   P.CartaporteID = d.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    d.RutaID = @RutaID
						  AND  P.PuntoID = @PuntoID
						  AND    d.TIPO = @Tipo)
		   
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPiezasByRutaConFondo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getPiezasByRutaConFondo]
(@RutaID INT,
@PuntoID INT,
@Tipo INT,
@EfectivoID VARCHAR(5))
RETURNS VARCHAR(50)
AS 
BEGIN 
DECLARE @Resultado VARCHAR(50)


SELECT @Resultado =  SUM(Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = @EfectivoID
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN Cartaporte_Punto P
						  ON   P.CartaporteID = d.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    d.RutaID = @RutaID
						  AND  P.PuntoID = @PuntoID
						  AND    d.TIPO in(1,4))
		   
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPiezasEfectivosByPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getPiezasEfectivosByPunto]
(@PuntoID INT,
@EfectivoID VARCHAR(5),
@FechaContado datetime)
RETURNS int	
AS 
BEGIN 
DECLARE @Resultado int


		  SELECT @Resultado =  SUM(b.PIEZAS) 
		   FROM   punto_Efectivo b
		   WHERE  b.EfectivoID = @EfectivoID
			AND  b.FechaContado = @FechaContado
			AND  b.PuntoID = @PuntoID

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPiezasEfectivosByPuntoMensual]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getPiezasEfectivosByPuntoMensual]
(@PuntoID INT,
@EfectivoID VARCHAR(5),
@Mes varchar(2),
@Ano varchar(4))
RETURNS int	
AS 
BEGIN 
DECLARE @Resultado int


		  SELECT @Resultado =  SUM(b.PIEZAS) 
		   FROM   punto_Efectivo b
		   WHERE  b.EfectivoID = @EfectivoID
            and MONTH(b.FechaContado) = @Mes
	        and YEAR(b.FechaContado) = @Ano
			AND  b.PuntoID = @PuntoID

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPlomosByEnvase]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPlomosByEnvase]
(@RutaID INT,
@PuntoID INT,
@Tipo INT)
RETURNS VARCHAR(500)
AS 
BEGIN 
DECLARE @Resultado VARCHAR(500)


SELECT @Resultado =  c.NroPlomo 
		   FROM   Envase c
	
		   WHERE  EXISTS (SELECT *
						 FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN Cartaporte_Punto P
						  ON   P.CartaporteID = d.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  AND    d.RutaID = @RutaID
						  AND  P.PuntoID = @PuntoID
						  AND    d.TIPO = @Tipo)
 
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPlomosByEnvaseAll]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPlomosByEnvaseAll]
(@RutaID INT,
@PuntoID INT,
@Tipo INT)
RETURNS VARCHAR(500)
AS 
BEGIN 
DECLARE @Resultado VARCHAR(500)


SELECT @Resultado = REPLACE(RTRIM((SELECT CAST(Grupo.BloqueID AS VARCHAR(MAX)) + ' ' 
			  FROM   Bloque Grupo
			  WHERE  EXISTS (select vwc.cartaporteid  from vw_Cartaporte vwc
						  join  Ruta_CartaPorte d
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN Cartaporte_Punto P
						  ON   P.CartaporteID = d.CartaporteID
						  WHERE d.RutaID = @RutaID
						  AND  P.PuntoID = @PuntoID
						  AND    d.TIPO = 2)
			  FOR XML PATH (''))),' ',' - ')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPlomosByEnvaseTodos]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPlomosByEnvaseTodos]
(@RutaID INT,
@PuntoID INT,
@Tipo INT)
RETURNS VARCHAR(500)
AS 
BEGIN 
DECLARE @Resultado VARCHAR(500)



						  
SELECT @Resultado = REPLACE(RTRIM((SELECT CAST(Grupo.NroPlomo AS VARCHAR(MAX)) + ' ' 
			  FROM   Envase Grupo
			  WHERE  EXISTS (SELECT *
						 FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN Cartaporte_Punto P
						  ON   P.CartaporteID = d.CartaporteID
						  WHERE  vwc.CartaPorteID = Grupo.CartaPorteID
						  AND    d.RutaID = @RutaID
						  AND  P.PuntoID = @PuntoID
						  AND    d.TIPO = @Tipo)
			  FOR XML PATH (''))),' ',' - ')
 
		   
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPB]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPB]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
		    WHERE  d.EfectivoTipoID IN (3,4)
			AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(2,3)

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBAcopio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBAcopio]
(@rubro int,@Biblia varchar(50),@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (3,4)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(1,4)
			  AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBAcopioEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBAcopioEntrada]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (3,4)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(2,3)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBAcopioSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBAcopioSalida]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (3,4)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  and Cartaporte.CartaporteID LIKE '%TVV%'
			  AND    ruta_cartaporte.TIPO in(1,4)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBATMEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBATMEntrada]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (3,4)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(2,3)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              AND CONSIGNADOR.PUNTOID =@PuntoID
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBATMEntradaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getPPBATMEntradaSalida]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (3,4)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(1,2,3,4)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              AND CONSIGNADOR.PUNTOID =@PuntoID
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBATMEntradaSalidaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getPPBATMEntradaSalidaSalida]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (3,4)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(1,2,3,4)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              AND CONSIGNATARIO.PUNTOID =@PuntoID
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBATMSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBATMSalida]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (3,4)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  and Cartaporte.CartaporteID LIKE '%TVV%'
			  AND    ruta_cartaporte.TIPO in(1,4)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              and consignatario.PuntoID = @PuntoID
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBBancoEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBBancoEntrada]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (3,4)
			and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
			AND    cartaporte.Porsistema = 'false'
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBMonto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBMonto]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Monto)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
		    WHERE  d.EfectivoTipoID IN (3,4)
			AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(2,3)

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBMontoMlte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBMontoMlte]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Monto)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
		    WHERE  d.EfectivoTipoID IN (3,4)
		    AND  EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  WHERE  d.CartaPorteID = CartaPorte.CartaPorteID
						  AND    d.RutaID = Ruta_CartaPorte.RutaID
						  AND    d.TIPO in(2,3))
			AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(2,3)

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPBPorPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getPPBPorPunto]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignatario int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = SUM(Envase_Efectivo.Piezas)
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN Envase_Efectivo
	ON     Envase.envaseid = Envase_Efectivo.Envaseid
	JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignatarioR.Fecha) = @Mes
	        and YEAR(ConsignatarioR.Fecha) = @Ano
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.Cartaporteid like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	AND Efectivo.EfectivoTipoID in(3,4)
	and Cartaporte.rubroID in(@rubro)
	and consignatario.PuntoID = @Consignatario
	and consignatarioR.tipo=2
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getPPBPorPuntoEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBPorPuntoEntrada]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignador int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = SUM(Envase_Efectivo.Piezas)
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN Envase_Efectivo
	ON     Envase.envaseid = Envase_Efectivo.Envaseid
	JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignadorR.Fecha) = @Mes
	        and YEAR(ConsignadorR.Fecha) = @Ano
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cartaporteid not like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	AND Efectivo.EfectivoTipoID in(3,4)
	and Cartaporte.rubroID in(@rubro)
	and consignador.PuntoID = @Consignador
	and consignadorR.tipo=1
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getPPBSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPBSalida]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
		    WHERE  d.EfectivoTipoID IN (3,4)
			AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(1,4)

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPM]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPM]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
		    WHERE  d.EfectivoTipoID IN (1,2)
			AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			   AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(2,3)
			    AND c.nroplomo <> 'dev'                        
	

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPMAcopioEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPMAcopioEntrada]
(@rubro int,@Fecha varchar(10),@Cuentas varchar(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
 SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (1,2)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(2,3)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPMAcopioSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPMAcopioSalida]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (1,2)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(1,4)
			  and Cartaporte.CartaporteID LIKE '%TVV%'
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPMATMEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPMATMEntrada]
(@rubro int,@Fecha varchar(10),@Cuentas varchar(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
 SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (1,2)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(2,3)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              and consignador.PuntoID = @PuntoID
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPMATMEntradaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getPPMATMEntradaSalida]
(@rubro int,@Fecha varchar(10),@Cuentas varchar(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
 SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (1,2)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(1,2,3,4)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              and consignador.PuntoID = @PuntoID
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPMATMEntradaSalidaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getPPMATMEntradaSalidaSalida]
(@rubro int,@Fecha varchar(10),@Cuentas varchar(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
 SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (1,2)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(1,2,3,4)
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              and consignatario.PuntoID = @PuntoID
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPMATMSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPMATMSalida]
(@rubro int,@Fecha varchar(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (1,2)
			--AND    ruta.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10')
			  AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
			  AND    ruta_cartaporte.TIPO in(1,4)
			  and Cartaporte.CartaporteID LIKE '%TVV%'
			 -- AND Biblia.Tipo in (@Biblia)
              and Cartaporte.rubroid in(@rubro)
              and Consignatario.PuntoID = @PuntoID
              	and cuenta.cuentaid in (@cuentas)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPMBancoEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getPPMBancoEntrada]
(@rubro int,@Fecha varchar(10),@Cuentas varchar(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
 SELECT @Resultado = SUM(b.Piezas)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   JOIN   Efectivo d
		   ON	  d.EfectivoID = b.EfectivoID 
		   join cartaporte
           on cartaporte.cartaporteid = c.cartaporteid
           JOIN   Cuenta
			ON	   CartaPorte.CuentaID = Cuenta.CuentaID
			join ruta_cartaporte
			on ruta_cartaporte.cartaporteid = cartaporte.cartaporteid
			join ruta
			on ruta.rutaid = ruta_cartaporte.rutaid
			JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
		    WHERE  d.EfectivoTipoID IN (1,2)
			and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
			AND    cartaporte.Porsistema = 'false'
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPPMPorPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getPPMPorPunto]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignatario int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = SUM(Envase_Efectivo.Piezas)
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN Envase_Efectivo
	ON     Envase.envaseid = Envase_Efectivo.Envaseid
	JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignatarioR.Fecha) = @Mes
	        and YEAR(ConsignatarioR.Fecha) = @Ano
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.Cartaporteid like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	AND Efectivo.EfectivoTipoID in(1,2)
	and Cartaporte.rubroID in(@rubro)
	and consignatario.PuntoID = @Consignatario
	and consignatarioR.tipo=2
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getPPMPorPuntoEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getPPMPorPuntoEntrada]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignador int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = SUM(Envase_Efectivo.Piezas)
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN Envase_Efectivo
	ON     Envase.envaseid = Envase_Efectivo.Envaseid
	JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignadorR.Fecha) = @Mes
	        and YEAR(ConsignadorR.Fecha) = @Ano
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cartaporteid  not like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	AND Efectivo.EfectivoTipoID in(1,2)
	and Cartaporte.rubroID in(@rubro)
	and consignador.PuntoID = @Consignador
	and consignadorR.tipo=1
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getPromedioCajeroByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

CREATE FUNCTION [dbo].[getPromedioCajeroByMes]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS decimal	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)
declare @P decimal(18,3)
declare @E decimal(18,3)
declare @PE decimal(18,3)
declare @time datetime
declare @TotalPromedio decimal(18,3)
declare @Elevado1 decimal(18,3)
declare @Elevado2 decimal(18,3)
declare @TotalCajeros int
declare @ECajero int

set @P = dbo.getTotalPiezasCajeroByMes(@Ano,@Mes,@Login)
--select @P
set @E = dbo.getTotalEnvasesByMes(@Ano,@Mes) 
--select @E
set @PE=@P / @E
--select @PE  
set @ECajero = dbo.getTotalCajeros(@Ano,@Mes)
set @Elevado1 = power(@PE,2) + power(@ECajero,2)
--set @Elevado2 = 
--select @Elevado1
set @TotalPromedio = SQRT(@Elevado1)
select  @Resultado = @TotalPromedio
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPromedioCajeroByMesVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

CREATE FUNCTION [dbo].[getPromedioCajeroByMesVABT]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS decimal	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)
declare @P decimal(18,3)
declare @E decimal(18,3)
declare @PE decimal(18,3)
declare @time datetime
declare @TotalPromedio decimal(18,3)
declare @Elevado1 decimal(18,3)
declare @Elevado2 decimal(18,3)
declare @TotalCajeros int
declare @ECajero int

set @P = dbo.getTotalPiezasCajeroByMesVABT(@Ano,@Mes,@Login)
--select @P
set @E = dbo.getTotalEnvasesByMesVABT(@Ano,@Mes) 
--select @E
set @PE=@P / @E
--select @PE  
set @ECajero = dbo.getTotalCajerosVABT(@Ano,@Mes)
set @Elevado1 = power(@PE,2) + power(@ECajero,2)
--set @Elevado2 = 
--select @Elevado1
set @TotalPromedio = SQRT(@Elevado1)
select  @Resultado = @TotalPromedio
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPromedioEnvaseCajeroByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

CREATE FUNCTION [dbo].[getPromedioEnvaseCajeroByMes]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS decimal	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)
declare @P decimal(18,3)
declare @E decimal(18,3)
declare @PE decimal(18,3)
declare @time datetime
declare @TotalPromedio decimal(18,3)
declare @Elevado1 decimal(18,3)
declare @Elevado2 decimal(18,3)
declare @TotalCajeros int
declare @ECajero int

set @P = dbo.getTotalPiezasCajeroByMes(@Ano,@Mes,@Login)
--select @P
set @E = dbo.getTotalEnvasesByMes(@Ano,@Mes) 
--select @E
set @PE=@P / @E
--select @PE  
set @ECajero = dbo.getTotalCajeros(@Ano,@Mes)
set @Elevado1 = power(@PE,2) + power(@ECajero,2)
--set @Elevado2 = 
--select @Elevado1
--set @TotalPromedio = SQRT(@Elevado1)
select  @Resultado = @PE
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getPromedioEnvaseCajeroByMesVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

CREATE FUNCTION [dbo].[getPromedioEnvaseCajeroByMesVABT]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS decimal	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)
declare @P decimal(18,3)
declare @E decimal(18,3)
declare @PE decimal(18,3)
declare @time datetime
declare @TotalPromedio decimal(18,3)
declare @Elevado1 decimal(18,3)
declare @Elevado2 decimal(18,3)
declare @TotalCajeros int
declare @ECajero int

set @P = dbo.getTotalPiezasCajeroByMesVABT(@Ano,@Mes,@Login)
--select @P
set @E = dbo.getTotalEnvasesByMesVABT(@Ano,@Mes) 
--select @E
set @PE=@P / @E
--select @PE  
set @ECajero = dbo.getTotalCajerosVABT(@Ano,@Mes)
set @Elevado1 = power(@PE,2) + power(@ECajero,2)
--set @Elevado2 = 
--select @Elevado1
--set @TotalPromedio = SQRT(@Elevado1)
select  @Resultado = @PE
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getSobrante]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getSobrante]
(@MontoCartaporte decimal(18,3),
@MontoContado decimal(18,3))
RETURNS decimal	(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)

IF @MontoCartaporte < @MontoContado

BEGIN
	SET @Resultado =  @MontoContado - @MontoCartaporte
END	


RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getSobranteByPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getSobranteByPunto]
(@MontoEntrada decimal(18,3),
@MontoContado decimal(18,3))
RETURNS decimal	(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)

IF @MontoEntrada < @MontoContado

BEGIN
	SET @Resultado =  @MontoContado - @MontoEntrada
END	


RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getSobranteVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getSobranteVABT]
(@MontoCartaporte decimal(18,3),
@MontoContado decimal(18,3))
RETURNS decimal	(18,3)
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)

IF @MontoCartaporte < @MontoContado

BEGIN
	SET @Resultado =  @MontoContado - @MontoCartaporte
END	


RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalCajeroIdeal]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getTotalCajeroIdeal]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


declare @Promedio INT
declare @time datetime
declare @TotalPromedio decimal(18,3)
declare @Ideal decimal(18,3)



set @Promedio =(((dbo.getTotalPiezasCajeroByMes(@Ano,@Mes,@Login) ) / (dbo.getTotalEnvasesCajeroByMes(@Ano,@Mes,@Login))))


set @TotalPromedio = (SQRT(power(@Promedio,2)) +(power(dbo.getTotalEnvasesCajeroByMes(@Ano,@Mes,@Login),2)))

select @Resultado = ((@TotalPromedio) / (dbo.getTotalCajeros(@Ano,@Mes)))


RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalCajeros]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalCajeros]
(@Ano varchar(4),
@Mes varchar(2))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado = count(distinct(cartaporte.logincerrado))


	FROM   CartaPorte
	
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Envase_Efectivo
	ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID

	JOIN   CartaPorte_Punto 
	ON	   CartaPorte.CartaPorteID = CartaPorte_Punto.CartaPorteID

	
	JOIN  Biblia
	ON    Biblia.PuntoID = CartaPorte_Punto.PuntoID
 
	WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND   MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	AND    Biblia.Tipo in('banco','cartera','comercial','vabt','apoyo')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalCajerosVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalCajerosVABT]
(@Ano varchar(4),
@Mes varchar(2))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT


SELECT @Resultado = count(distinct(cartaporte.logincerrado))


	FROM   CartaPorte
	
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Envase_Efectivo
	ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID

	JOIN   CartaPorte_Punto 
	ON	   CartaPorte.CartaPorteID = CartaPorte_Punto.CartaPorteID

	
	JOIN  Biblia
	ON    Biblia.PuntoID = CartaPorte_Punto.PuntoID
 
	WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND   MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	AND    Biblia.Tipo in('vabt')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesAnillo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

CREATE FUNCTION [dbo].[getTotalEnvasesAnillo]
(@CartaporteID VARCHAR(13))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = sum(Envase_Efectivo.Piezas/1000)

FROM Envase_Efectivo
JOIN Envase
ON Envase.EnvaseID = Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID


WHERE  Cartaporte.CartaporteID = @CartaporteID
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

CREATE FUNCTION [dbo].[getTotalEnvasesByMes]
(@Ano varchar(4),
@Mes varchar(2))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = count(*) 

FROM Envase
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID

WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND    MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	AND    Biblia.Tipo IN('banco','comercial','cartera','vabt','apoyo')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesByMesVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

CREATE FUNCTION [dbo].[getTotalEnvasesByMesVABT]
(@Ano varchar(4),
@Mes varchar(2))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = count(*) 

FROM Envase
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID

WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND    MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	AND    Biblia.Tipo IN('vabt')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

CREATE FUNCTION [dbo].[getTotalEnvasesByRuta]
(@RutaID INT,
@PuntoID INT,
@Tipo INT)
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = count(*) 
FROM Envase
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
WHERE Ruta.RutaID =@RutaID
AND  Cartaporte_Punto.PuntoID = @PuntoID
--AND  Ruta_Cartaporte.Tipo in(@Tipo,2)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesByRutaAnillo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

create FUNCTION [dbo].[getTotalEnvasesByRutaAnillo]
(@RutaID INT,
@PuntoID INT,
@Tipo INT)
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = isnull(_0_05.Piezas/1000 ,0) 
+ isnull(_0_10.Piezas/1000 ,0)  
+ isnull(_0_50.Piezas/1000 ,0) 
+ isnull(_1_00.Piezas/1000 ,0) 
+ isnull(_0_25.Piezas/1000 ,0) 
+ isnull(_0_125.Piezas/1000 ,0)

from Cartaporte
JOIN   Envase
	ON     Envase.CartaPorteID = Cartaporte.CartaPorteID
	LEFT   JOIN Envase_Efectivo _0_05
	ON     Envase.EnvaseID = _0_05.EnvaseID
	AND    _0_05.EfectivoID = 'MF21'
	LEFT   JOIN Envase_Efectivo _0_10
	ON     Envase.EnvaseID = _0_10.EnvaseID
	AND    _0_10.EfectivoID = 'MF22'
	LEFT   JOIN Envase_Efectivo _0_50
	ON     Envase.EnvaseID = _0_50.EnvaseID
	AND    _0_50.EfectivoID = 'MF25'
	LEFT   JOIN Envase_Efectivo _1_00
	ON     Envase.EnvaseID = _1_00.EnvaseID
	AND    _1_00.EfectivoID = 'MF26'
	LEFT   JOIN Envase_Efectivo _0_25
	ON     Envase.EnvaseID = _0_25.EnvaseID
	AND    _0_25.EfectivoID = 'MF2'
	LEFT   JOIN Envase_Efectivo _0_125
	ON     Envase.EnvaseID = _0_125.EnvaseID
	AND    _0_125.EfectivoID = 'MF23'

JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
WHERE Ruta_Cartaporte.RutaID =@RutaID
AND  PuntoID = @PuntoID
AND  Ruta_Cartaporte.Tipo =@Tipo
RETURN @Resultado
END;



GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesByRutaConFondo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

create FUNCTION [dbo].[getTotalEnvasesByRutaConFondo]
(@RutaID INT,
@PuntoID INT,
@Tipo INT)
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = count(*) 
FROM Envase
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
WHERE Ruta_Cartaporte.RutaID =@RutaID
AND  PuntoID = @PuntoID
AND  Ruta_Cartaporte.Tipo in(1,4)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesCajeroByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalEnvasesCajeroByMes]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = count(DISTINCT Envase.EnvaseID) 

FROM   Envase_Efectivo
JOIN   Envase
ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID
/*
WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND    MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	and cartaporte.cerrado='true'
	AND    CartaPorte_Punto.Tipo = 2
				AND    Biblia.Tipo IN('cartera','carteraMTB','carteraMTC','carteraM4','CarteraCB','carMLTe')
    AND     Cartaporte.LoginCerrado = @Login
   */ 
    
			WHERE  YEAR(Cartaporte_Punto.Fecha) = @Ano
			AND    MONTH(Cartaporte_Punto.Fecha) = @Mes
			AND  CartaPorte.logincerrado = cartaporte.LoginCerrado
			AND    CartaPorte.Porsistema = 'false'
			AND    CartaPorte_Punto.Tipo = 2
			AND    Biblia.Tipo IN('cartera','carteraMTB','carteraMTC','carteraM4','CarteraCB','carMLTe')
		  -- AND  b.EfectivoID = 'B013'
		   AND Cartaporte.LoginCerrado = @Login
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesCajeroByMesVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalEnvasesCajeroByMesVABT]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = count(*) 

FROM Envase
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID

WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND    MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	AND    Biblia.Tipo IN('vabt')
    AND     Cartaporte.LoginCerrado = @Login
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesCajeroIdealByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

create FUNCTION [dbo].[getTotalEnvasesCajeroIdealByMes]
(@Ano varchar(4),
@Mes varchar(2))
RETURNS decimal	
AS 
BEGIN 
DECLARE @Resultado decimal

SELECT @Resultado = count(*) 

FROM Envase
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID

WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND    MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	AND    Biblia.Tipo IN('banco','comercial','cartera','vabt','apoyo')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalEnvasesCajerosByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalEnvasesCajerosByMes]
(@Ano varchar(4),
@Mes varchar(2))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = count(DISTINCT Envase.EnvaseID) 

FROM   Envase_Efectivo
JOIN   Envase
ON     Envase_Efectivo.EnvaseID = Envase.EnvaseID
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID

WHERE  YEAR(Cartaporte_Punto.Fecha) = @Ano
			AND    MONTH(Cartaporte_Punto.Fecha) = @Mes
			AND  CartaPorte.logincerrado = cartaporte.LoginCerrado
			AND    CartaPorte.Porsistema = 'false'
			AND    CartaPorte_Punto.Tipo = 2
			AND    Biblia.Tipo IN('cartera','carteraMTB','carteraMTC','carteraM4','CarteraCB','carMLTe')
 
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMonto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMonto]
(@CartaporteID VARCHAR(13))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (1,2,3,4)
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoBilletes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMontoBilletes]
(@CartaporteID VARCHAR(13))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (3,4)
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoBilletesVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMontoBilletesVABT]
(@CartaporteID VARCHAR(13))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (3,4)
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1
           AND   Cartaporte.CuentaID = 5

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoBilletesVABTMensual]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMontoBilletesVABTMensual]
(@Ano VARCHAR(4),
@Mes VARCHAR(2),@Login varchar(30))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (3,4)
           AND    c.estaabierto = 1
            and MONTH(Cartaporte.FechaCerrado) = @Mes
	        and YEAR(Cartaporte.FechaCerrado) = @Ano
		  AND   Cartaporte.CuentaID = 5

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoBloque]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMontoBloque]
(@BloqueID VARCHAR(50))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Bloque_Efectivo b
		   JOIN   Bloque c
		   ON     b.BloqueID = c.BloqueID
			
		   WHERE  c.BloqueID = @BloqueID
			

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoByPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getTotalMontoByPunto]
(@PuntoID VARCHAR(13))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(Cartaporte.MONTO) 
			from Cartaporte
			JOIN cartaporte_Punto
			ON   cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
		    WHERE cartaporte_Punto.PuntoID = @PuntoID
			and  CartaPorte.BovedaID = 6
			AND  CartaPorte.Cerrado = 0

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoMonedas]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMontoMonedas]
(@CartaporteID VARCHAR(13))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (1,2)
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoMonedasVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMontoMonedasVABT]
(@CartaporteID VARCHAR(13))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (1,2)
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1
			AND   Cartaporte.CuentaID = 5
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoMonedasVABTMensual]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMontoMonedasVABTMensual]
(@Ano VARCHAR(4),
@Mes VARCHAR(2),@Login varchar(30))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (1,2)
           AND    c.estaabierto = 1
			 and MONTH(Cartaporte.FechaCerrado) = @Mes
	        and YEAR(Cartaporte.FechaCerrado) = @Ano
		  AND   Cartaporte.CuentaID = 5
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMontoVABT]
(@CartaporteID VARCHAR(13))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (1,2,3,4)
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1
AND   Cartaporte.CuentaID = 5
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalMontoVABTMensual]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalMontoVABTMensual]
(@Ano VARCHAR(4),
@Mes VARCHAR(2),@Login varchar(30))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.MONTO) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (1,2,3,4)
           AND    c.estaabierto = 1
	 and MONTH(Cartaporte.FechaCerrado) = @Mes
	        and YEAR(Cartaporte.FechaCerrado) = @Ano
		  AND   Cartaporte.CuentaID = 5
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalPiezasBilletes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalPiezasBilletes]
(@CartaporteID VARCHAR(13))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (3,4)
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalPiezasByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalPiezasByMes]
(@Ano varchar(4),
@Mes varchar(2))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = sum(Envase_Efectivo.Piezas) 

FROM Envase_Efectivo
JOIN Envase
ON Envase.EnvaseID =Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID

WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND    MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	AND    Biblia.Tipo IN('banco','comercial','cartera','vabt','apoyo')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalPiezasByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalPiezasByRuta]
(@RutaID INT,
@PuntoID INT,
@Tipo INT)
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = SUM(Envase_Efectivo.Piezas) 
FROM Envase_Efectivo
JOIN Envase
ON   Envase.EnvaseID=Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
WHERE Ruta_Cartaporte.RutaID =@RutaID
AND  PuntoID = @PuntoID
AND  Ruta_Cartaporte.Tipo =@Tipo
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalPiezasCajeroByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalPiezasCajeroByMes]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = sum(Envase_Efectivo.Piezas) 

FROM Envase_Efectivo
JOIN Envase
ON Envase.EnvaseID =Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID
JOIN Efectivo
ON Efectivo.EfectivoID = Envase_Efectivo.EfectivoID

WHERE  YEAR(Cartaporte_Punto.Fecha) = @Ano
	AND    MONTH(Cartaporte_Punto.Fecha) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 2
				AND    Biblia.Tipo IN('cartera','carteraMTB','carteraMTC','carMLTe')
and cartaporte.LoginCerrado = @Login
and Efectivo.EstaActivo = 'true' AND Efectivo.EfectivoTipoID in(3,4)
--.EnvaseID in('B001','B002','B003','B004','B005','B006','B007','B008','B009','B012','B013','B014','BF2','BF2','BF20','BF21','BF2',)
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalPiezasCajeroByMesBilletes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getTotalPiezasCajeroByMesBilletes]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = sum(Envase_Efectivo.Piezas) 

FROM Envase_Efectivo
JOIN Envase
ON Envase.EnvaseID =Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID

  WHERE    YEAR(cartaporte.Fechacerrado) = @Ano
	AND    MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	and    Envase_Efectivo.EfectivoID in('BF5','BF2','BF23','BF22','BF21','BF20')
	AND    Biblia.Tipo IN('banco','comercial','cartera','vabt','apoyo')
	AND	   cartaporte.LoginCerrado = @Login
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalPiezasCajeroByMesVABT]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[getTotalPiezasCajeroByMesVABT]
(@Ano varchar(4),
@Mes varchar(2),
@Login varchar(50))
RETURNS INT	
AS 
BEGIN 
DECLARE @Resultado INT

SELECT @Resultado = sum(Envase_Efectivo.Piezas) 

FROM Envase_Efectivo
JOIN Envase
ON Envase.EnvaseID =Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID

WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND    MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	AND    Biblia.Tipo IN('vabt')
and cartaporte.LoginCerrado = @Login
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalPiezasCajeroIdealByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
SET  @RutaID=591
SET @PuntoID = 188*/

create FUNCTION [dbo].[getTotalPiezasCajeroIdealByMes]
(@Ano varchar(4),
@Mes varchar(2))
RETURNS decimal	
AS 
BEGIN 
DECLARE @Resultado decimal

SELECT @Resultado = sum(Envase_Efectivo.Piezas) 

FROM Envase_Efectivo
JOIN Envase
ON Envase.EnvaseID =Envase_Efectivo.EnvaseID
JOIN Cartaporte
ON Cartaporte.CartaporteID = Envase.CartaporteID
JOIN Ruta_Cartaporte
ON Ruta_Cartaporte.CartaporteID = Cartaporte.CartaporteID
JOIN Ruta
ON  Ruta.RutaID = Ruta_Cartaporte.RutaID
JOIN Cartaporte_Punto
ON   Cartaporte_Punto.CartaporteID = Cartaporte.CartaporteID
JOIN   Punto 
ON     CartaPorte_Punto.PuntoID = Punto.PuntoId 
JOIN  Biblia
ON    Biblia.PuntoID = Punto.PuntoID

WHERE  YEAR(cartaporte.Fechacerrado) = @Ano
	AND    MONTH(cartaporte.Fechacerrado) = @Mes
	AND    cartaporte.Porsistema = 'false'
	AND    CartaPorte_Punto.Tipo = 1
	AND    Biblia.Tipo IN('banco','comercial','cartera','vabt','apoyo')
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalPiezasMonedas]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getTotalPiezasMonedas]
(@CartaporteID VARCHAR(13))
RETURNS decimal(18,3)	
AS 
BEGIN 
DECLARE @Resultado decimal(18,3)


		   SELECT @Resultado = SUM(b.Piezas) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
			JOIN Cartaporte
			ON   Cartaporte.CartaporteID = c.CartaporteID
			JOIN  Efectivo
			ON   Efectivo.EfectivoID = b.EfectivoID
		   WHERE  Efectivo.EfectivoTipoID in (1,2)
			AND  Cartaporte.CartaporteID = @CartaporteID
           AND    c.estaabierto = 1

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getTotalViajes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getTotalViajes]
(@Fecha VARCHAR(10),@PuntoID INT)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

IF EXISTS (SELECT  *
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))
	

OR EXISTS(SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
			AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))
	

OR EXISTS(SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
           AND    c.NroPlomo = 'DEV'
		  AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))

OR EXISTS(SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))


OR EXISTS(SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF5'
AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))
  
	
OR EXISTS (SELECT *
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF2'
AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))


OR EXISTS  (SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF23'
AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))

		   
OR EXISTS (SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF22'
AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))

		  
OR EXISTS  (SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF21'
AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))


OR EXISTS  (SELECT *
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'BF20'
AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))

		   
OR EXISTS (SELECT *
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))


 OR EXISTS (SELECT *
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))

OR EXISTS  (SELECT *
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF2'
		   AND    c.NroPlomo = 'DEV'
		  AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))
OR EXISTS (SELECT *
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF23'
			AND    c.NroPlomo = 'DEV'
		  AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))
OR EXISTS (SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
			AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))

		   
OR EXISTS (SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
			AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))


 OR EXISTS(SELECT * 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF20'
		   AND    c.NroPlomo = 'DEV'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta R
						  ON     d.RutaID = R.RutaID
						  JOIN  Cartaporte_Punto p
						  ON    p.CartaporteID = vwc.CartaporteID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
                          AND    p.PuntoID = @PuntoID
						  AND    d.TIPO = 2
					      AND    R.Fecha = @Fecha))

		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getTotalViajesByMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getTotalViajesByMes]
(@Mes VARCHAR(10),@Ano INT)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

select @VALOR = sum(distinct(Ruta.rutaid))
		FROM   Ruta 
		WHERE  MONTH(Fecha) = @Mes
		AND    YEAR(Fecha) = @Ano
		AND    EXISTS(SELECT * 
					  FROM   Ruta_CartaPorte
					  JOIN   vw_cartaporte
					  ON    vw_cartaporte.CartaPorteID = Ruta_CartaPorte.CartaPorteID 
					JOIN     ENVASE e
					ON       e.CartaporteID = vw_cartaporte.CartaPorteID
					  WHERE  vw_cartaporte.CuentaID = 35
--					 AND    vw_cartaporte.Consignadorid = Consignador.PuntoID
					  AND    Ruta_CartaPorte.Tipo in (2,3)
					  AND    Ruta_CartaPorte.RutaID = Ruta.RutaID AND e.NroPlomo = 'DEV')
		group by ruta.Fecha
	

RETURN @VALOR	   

END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getTotalViajesByMesByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getTotalViajesByMesByRuta]
(@Mes VARCHAR(2),@Ano varchar(4), @RutaID int)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

select @VALOR = sum(distinct(Ruta.rutaid))
		FROM   Ruta 
		WHERE  MONTH(Fecha) = @Mes
		AND    YEAR(Fecha) = @Ano
		AND    EXISTS(SELECT * 
					  FROM   Ruta_CartaPorte
					  JOIN   vw_cartaporte
					  ON    vw_cartaporte.CartaPorteID = Ruta_CartaPorte.CartaPorteID 
					JOIN     ENVASE e
					ON       e.CartaporteID = vw_cartaporte.CartaPorteID
					  WHERE   Ruta_CartaPorte.rutaid= @RutaID
					  AND    Ruta_CartaPorte.Tipo in (2,3)
					  AND    Ruta_CartaPorte.RutaID = Ruta.RutaID AND e.NroPlomo = 'DEV')
		group by ruta.Fecha
	

RETURN @VALOR	   

END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaAcopioEntradaDom]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaAcopioEntradaDom]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
--	and biblia.puntoid <> 454
	--AND Biblia.tipo in(@Biblias)
	and Cartaporte.Cerrado = 'true'
	and Cartaporte.rubroID in(@rubro)
	AND DATEPART(weekday,@Fecha) in(7)
	and cuenta.cuentaid in (@cuentas)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaAcopioEntradaLunVier]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaAcopioEntradaLunVier]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
--	and biblia.puntoid <> 454
	--AND Biblia.tipo in(@Biblias)
	and Cartaporte.Cerrado = 'true'
	and Cartaporte.rubroID in(@rubro)
	AND DATEPART(weekday,@Fecha) in(1,2,3,4,5)
	and cuenta.cuentaid in (@cuentas)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaAcopioEntradaSab]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaAcopioEntradaSab]
(@rubro int ,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(2,3)
--	and biblia.puntoid <> 454
	--AND Biblia.tipo in(@Biblias)
	and Cartaporte.Cerrado = 'true'
	and Cartaporte.rubroID in(@rubro)
	AND DATEPART(weekday,@Fecha) in(6)
	and cuenta.cuentaid in (@cuentas)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaAcopioSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaAcopioSalida]
(@rubro int,@Biblias VARCHAR(50) ,@Fecha VARCHAR(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(CartaPorte.CartaporteID) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and biblia.puntoid <> 454
	AND Biblia.tipo in(@Biblias)
	and Cartaporte.rubroID in(@rubro)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaAcopioSalidaDom]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaAcopioSalidaDom]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignatarioR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.CartaporteID LIKE '%TVV%'
--	and biblia.puntoid <> 454
	--AND Biblia.tipo in(@Biblias)
	and Cartaporte.Cerrado = 'true'
	and Cartaporte.rubroID in(@rubro)
	AND DATEPART(weekday,@Fecha) in(7)
	and cuenta.cuentaid in (@cuentas)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaAcopioSalidaLunVier]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaAcopioSalidaLunVier]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignatarioR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.CartaporteID LIKE '%TVV%'
--	and biblia.puntoid <> 454
	--AND Biblia.tipo in(@Biblias)
	and Cartaporte.Cerrado = 'true'
	and Cartaporte.rubroID in(@rubro)
	AND DATEPART(weekday,@Fecha) in(1,2,3,4,5)
	and cuenta.cuentaid in (@cuentas)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaAcopioSalidaSab]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaAcopioSalidaSab]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignatarioR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.CartaporteID LIKE '%TVV%'
--	and biblia.puntoid <> 454
	--AND Biblia.tipo in(@Biblias)
	and Cartaporte.Cerrado = 'true'
	and Cartaporte.rubroID in(@rubro)
	AND DATEPART(weekday,@Fecha) in(6)
	and cuenta.cuentaid in (@cuentas)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMEntradaLunVier]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesByRutaATMEntradaLunVier]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(2,3)

	AND DATEPART(weekday,@Fecha) in(1,2,3,4,5)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
  			AND CONSIGNADOR.PuntoID = @PuntoID
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMEntradaLunVierSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesByRutaATMEntradaLunVierSalida]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(1,2,3,4)

	AND DATEPART(weekday,@Fecha) in(1,2,3,4,5)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
  			AND CONSIGNADOR.PuntoID = @PuntoID
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMEntradaLunVierSalidaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesByRutaATMEntradaLunVierSalidaSalida]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignatarioR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(1,2,3,4)

	AND DATEPART(weekday,@Fecha) in(1,2,3,4,5)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
  			AND CONSIGNATARIO.PuntoID = @PuntoID
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMEntradaSab]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaATMEntradaSab]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(2,3)

	AND DATEPART(weekday,@Fecha) in(6)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
  			and consignador.PuntoID = @PuntoID
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMEntradaSabDom]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesByRutaATMEntradaSabDom]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(2,3)

	AND DATEPART(weekday,@Fecha) in(6,7)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
  			and consignador.PuntoID = @PuntoID
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMEntradaSabDomSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesByRutaATMEntradaSabDomSalida]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(1,2,3,4)

	AND DATEPART(weekday,@Fecha) in(6,7)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
  			and consignador.PuntoID = @PuntoID
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMEntradaSabDomSalidaSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesByRutaATMEntradaSabDomSalidaSalida]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignatarioR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(1,2,3,4)

	AND DATEPART(weekday,@Fecha) in(6,7)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
  			and consignatario.PuntoID = @PuntoID
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMEntradaSabSalida]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesByRutaATMEntradaSabSalida]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(1,2,3,4)

	AND DATEPART(weekday,@Fecha) in(6)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
  			and consignador.PuntoID = @PuntoID
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMSalidaLunVier]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaATMSalidaLunVier]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID INT)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignatarioR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.CartaporteID LIKE '%TVV%'
--	and biblia.puntoid <> 454
	--AND Biblia.tipo in(@Biblias)
	and Cartaporte.Cerrado = 'true'
	and Cartaporte.rubroID in(@rubro)
	AND DATEPART(weekday,@Fecha) in(1,2,3,4,5)
	and Consignatario.PuntoID = @PuntoID
	and cuenta.cuentaid in (@cuentas)
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaATMSalidaSabDom]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaATMSalidaSabDom]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50),@PuntoID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignatarioR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	AND    Ruta.Fecha = @Fecha
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.CartaporteID LIKE '%TVV%'
--	and biblia.puntoid <> 454
	--AND Biblia.tipo in(@Biblias)
	and Cartaporte.Cerrado = 'true'
	and Cartaporte.rubroID in(@rubro)
	AND DATEPART(weekday,@Fecha) in(6,7)
	and cuenta.cuentaid in (@cuentas)
	and Consignatario.PuntoID = @PuntoID
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaBancoEntradaDom]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaBancoEntradaDom]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(2,3)

	AND DATEPART(weekday,@Fecha) in(7)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaBancoEntradaLunVier]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaBancoEntradaLunVier]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(2,3)

	AND DATEPART(weekday,@Fecha) in(1,2,3,4,5)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesByRutaBancoEntradaSab]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesByRutaBancoEntradaSab]
(@rubro int,@Fecha VARCHAR(10),@Cuentas VARCHAR(50))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = count(distinct(ConsignadorR.PuntoID)) 
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where Ruta_CartaPorte.Tipo in(2,3)

	AND DATEPART(weekday,@Fecha) in(6)
	and  Cartaporte.FechaCerrado = @Fecha
           AND    Cartaporte.Cerrado = 'true'  
			and CartaPorte.CuentaID in (@Cuentas)
  			and Cartaporte.rubroid = @rubro
			AND    cartaporte.Porsistema = 'false'
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesDomByFecha]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesDomByFecha]
(@Fecha datetime)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

			SELECT @VALOR =  count(c.cartaporteid)
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  
		    rc.tipo in (1,2)
		     AND   CONVERT(CHAR(10), r.Fecha, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(7)

	return @VALOR

END;
GO
/****** Object:  UserDefinedFunction [dbo].[getViajesDomin]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesDomin]
(@Fecha datetime,@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

IF EXISTS (SELECT  c.cartaporteid
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  c.CartaporteID = @CartaporteID
		   and rc.tipo = 2

		   AND   CONVERT(CHAR(10), c.FechaCreado, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(7))

		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesDominBy]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

create FUNCTION [dbo].[getViajesDominBy]
(@Fecha datetime)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

IF EXISTS (SELECT  c.cartaporteid
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE 
		   -- c.CartaporteID = @CartaporteID
		   rc.tipo = 2

		   --AND   CONVERT(CHAR(10), c.FechaCreado, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(7))

		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesDominByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getViajesDominByRuta]
(@Fecha datetime,@RutaID INT)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT


IF EXISTS (SELECT  c.cartaporteid
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  r.rutaID =  @RutaID
 		   and rc.tipo in(1,2)
		   AND   CONVERT(CHAR(10), r.Fecha, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(7))

		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesDomingoPorPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesDomingoPorPunto]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignatario int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = Count(DISTINCT(Cartaporte.Cartaporteid))
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN Envase_Efectivo
	ON     Envase.envaseid = Envase_Efectivo.Envaseid
	JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignatarioR.Fecha) = @Mes
	        and YEAR(ConsignatarioR.Fecha) = @Ano
	        AND DATEPART(weekday,ConsignatarioR.Fecha) in(6,7)
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.Cartaporteid like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	--AND Efectivo.EfectivoTipoID in(1,2)
	and Cartaporte.rubroID in(@rubro)
	and consignatario.PuntoID = @Consignatario
	and consignatarioR.tipo=2
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesDomingoPorPuntoEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesDomingoPorPuntoEntrada]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignador int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = Count(DISTINCT(Cartaporte.Cartaporteid))
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN Envase_Efectivo
	ON     Envase.envaseid = Envase_Efectivo.Envaseid
	JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignadorR.Fecha) = @Mes
	        and YEAR(ConsignadorR.Fecha) = @Ano
	        AND DATEPART(weekday,ConsignadorR.Fecha) in(6,7)
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cartaporteid not like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	--AND Efectivo.EfectivoTipoID in(1,2)
	and Cartaporte.rubroID in(@rubro)
	and consignador.PuntoID = @Consignador
	and consignadorR.tipo=1
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesDomingoPorPuntoServicios]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesDomingoPorPuntoServicios]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignatario int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = Count(DISTINCT(Solicitud.Solicitudid))
		   

	FROM    Solicitud
JOIN    Solicitud_Servicio
	ON     Solicitud_Servicio.SolicitudID = Solicitud.SolicitudID
	
	JOIN   Cuenta
	ON     Solicitud.CuentaID = Cuenta.CuentaID
	JOIN   Punto Consignador
	ON     Solicitud.ConsignadorID = Consignador.PuntoId --Consignador
	
	JOIN   Punto Consignatario
	ON     Solicitud.ConsignatarioID = Consignatario.PuntoId --Consignatario
         
	
	WHERE  Solicitud.rubroid in(1,2,3,4,5,6)
	and solicitud_servicio.ServicioID <> 8
AND    YEAR(Solicitud.FechaCreado) = @Ano
	AND    MONTH(Solicitud.FechaCreado) = @Mes
	
AND DATEPART(weekday,Solicitud.FechaCreado) in(6,7)
	
	and Solicitud.ConsignatarioID = @Consignatario
	
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesDominMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getViajesDominMes]
(@Ano varchar(4), @Mes varchar(2),@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 

DECLARE @Resultado INT

SELECT @Resultado = count(*) 

		   FROM   Cartaporte c
		   WHERE  c.CartaporteID = @CartaporteID
		   AND	   YEAR(c.FechaCerrado) = CONVERT(CHAR(10), @Ano, 103)
		   AND    MONTH(c.FechaCerrado)= CONVERT(CHAR(10), @Mes, 103)
		   AND DATEPART(weekday,c.FechaCerrado) in(7)


RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesDominMesRVE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getViajesDominMesRVE]
(@Ano varchar(4), @Mes varchar(2),@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 

DECLARE @Resultado INT

SELECT @Resultado = count(*) 

		   FROM   Cartaporte c
		   WHERE  c.CartaporteID = @CartaporteID
		   AND	   YEAR(c.FechaCerrado) = CONVERT(CHAR(10), @Ano, 103)
		   AND    MONTH(c.FechaCerrado)= CONVERT(CHAR(10), @Mes, 103)
		   AND DATEPART(weekday,c.FechaCerrado) in(7)


RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesEntradaMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesEntradaMC]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = COUNT(Distinct (Envase.EnvaseID))
  FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 2
	AND    CartaPorte.CartaPorteID LIKE '%TVV%'
	AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
	AND    DATEPART(weekday,Ruta.Fecha) NOT in(7)
and biblia.puntoid = 187
                   AND Biblia.tipo in('metro','metromtb')
	
		

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getViajesEntradaTotal]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesEntradaTotal]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = count(*)
		FROM   Ruta
		join   Ruta_CartaPorte
		on     Ruta_CartaPorte.RutaID = Ruta.RutaID
		WHERE CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
		and  Ruta_CartaPorte.TIPO in(2,3)
		AND    DATEPART(weekday,Ruta.Fecha) NOT in(7)
		and    Ruta.Nombre in('mc 1','mc 2','mc 3','mc 4','mc 5')

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getViajesLunVie]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesLunVie]
(@Fecha datetime,@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

IF EXISTS (SELECT  c.cartaporteid
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  c.CartaporteID = @CartaporteID
		   and rc.tipo = 2

		   --AND   CONVERT(CHAR(10), r.FechaCerrada, 103) = CONVERT(CHAR(10),@Fecha, 103)
		   and  CONVERT(CHAR(10), r.FechaCreado, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(1,2,3,4,5))




		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesLunVieBy]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

create FUNCTION [dbo].[getViajesLunVieBy]
(@Fecha datetime)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

IF EXISTS (SELECT  c.cartaporteid
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  
		   --c.CartaporteID = @CartaporteID
		    rc.tipo = 2

		   --AND   CONVERT(CHAR(10), r.FechaCerrada, 103) = CONVERT(CHAR(10),@Fecha, 103)
		   --and  CONVERT(CHAR(10), r.FechaCreado, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(1,2,3,4,5))




		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesLunVieByFecha]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesLunVieByFecha]
(@Fecha datetime)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

			SELECT @VALOR =  count(c.cartaporteid)
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  
		    rc.tipo in (1,2)
		     AND   CONVERT(CHAR(10), r.Fecha, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(1,2,3,4,5)

	return @VALOR

END;
GO
/****** Object:  UserDefinedFunction [dbo].[getViajesLunVieByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getViajesLunVieByRuta]
(@Fecha datetime,@RutaID INT)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT


IF EXISTS (SELECT  c.cartaporteid
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  r.rutaID =  @RutaID
 		   and rc.tipo in(1,2)
		   AND   CONVERT(CHAR(10), r.Fecha, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(1,2,3,4,5))

		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesLunVieMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesLunVieMes]
(@Ano varchar(4), @Mes varchar(2),@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 

DECLARE @Resultado INT

SELECT @Resultado = count(*) 

	   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  c.CartaporteID = @CartaporteID
		   and rc.tipo = 2
		   AND	   YEAR(r.FechaCerrada) = CONVERT(CHAR(10), @Ano, 103)
		   AND    MONTH(r.FechaCerrada)= CONVERT(CHAR(10), @Mes, 103)
	       AND DATEPART(weekday,c.FechaCerrado) in(1,2,3,4,5)

RETURN @Resultado
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesLunVieMesRVE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesLunVieMesRVE]
(@Ano varchar(4), @Mes varchar(2),@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 

DECLARE @Resultado INT

SELECT @Resultado = count(*) 

	   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  c.CartaporteID = @CartaporteID
		   --and rc.tipo = 2
		   AND	   YEAR(r.FechaCerrada) = CONVERT(CHAR(10), @Ano, 103)
		   AND    MONTH(r.FechaCerrada)= CONVERT(CHAR(10), @Mes, 103)
	       AND DATEPART(weekday,c.FechaCerrado) in(1,2,3,4,5)

RETURN @Resultado
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesMC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesMC]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = (select COUNT(*)
		FROM   Ruta
		WHERE CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
		AND    DATEPART(weekday,Ruta.Fecha) NOT in(7)
		AND    EXISTS(SELECT * 
					  FROM   Ruta_CartaPorte
					  JOIN   vw_cartaporte
					  ON    vw_cartaporte.CartaPorteID = Ruta_CartaPorte.CartaPorteID 
					JOIN     ENVASE e
					ON       e.CartaporteID = vw_cartaporte.CartaPorteID
					  WHERE  vw_cartaporte.CuentaID = 35
					 AND    vw_cartaporte.Consignadorid = Biblia.PuntoID
					  AND    Ruta_CartaPorte.Tipo in (2)
					  AND    Ruta_CartaPorte.RutaID = Ruta.RutaID AND e.NroPlomo = 'DEV'))
		 
	FROM   Biblia 
	JOIN   Punto
	ON     Punto.PuntoID = Biblia.PuntoID
    WHERE  Biblia.tipo in('metro','metromtb')
		   and biblia.puntoid <> 187
	GROUP  BY 
		   Biblia.PuntoId,
		   Biblia.PuntoId,
	       Biblia.Secuencia,
	       Biblia.PuntoID,
		   Punto.Nombre

	
	ORDER  BY Secuencia

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSabado]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesSabado]
(@Fecha datetime,@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

IF EXISTS (SELECT  c.cartaporteid
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  c.CartaporteID = @CartaporteID
		   and rc.tipo = 2
		   AND   CONVERT(CHAR(10), c.FechaCreado, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(6))

		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSabadoBy]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

create FUNCTION [dbo].[getViajesSabadoBy]
(@Fecha datetime)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

IF EXISTS (SELECT  c.cartaporteid
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  
		   --c.CartaporteID = @CartaporteID
		    rc.tipo = 2
		   --AND   CONVERT(CHAR(10), c.FechaCreado, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(6))

		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSabadoByRuta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[getViajesSabadoByRuta]
(@Fecha datetime,@RutaID INT)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT


IF EXISTS (SELECT  c.cartaporteid
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  r.rutaID =  @RutaID
 		   and rc.tipo in(1,2)
		   AND   CONVERT(CHAR(10), r.Fecha, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(6))

		   
BEGIN 
	SET @VALOR = 1
	return @VALOR
	 
	
END
ELSE
	SET @VALOR = 0
	return @VALOR	
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSabadoMes]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesSabadoMes]
(@Ano varchar(4), @Mes varchar(2),@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 

DECLARE @Resultado INT

SELECT @Resultado = count(*) 

		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  c.CartaporteID = @CartaporteID
		   --and rc.tipo = 2
		   AND	   YEAR(r.FechaCerrada) = CONVERT(CHAR(10), @Ano, 103)
		   AND    MONTH(r.FechaCerrada)= CONVERT(CHAR(10), @Mes, 103)
	       AND DATEPART(weekday,r.FechaCerrada) = 6

RETURN @Resultado
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSabadoMesRVE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesSabadoMesRVE]
(@Ano varchar(4), @Mes varchar(2),@CartaporteID VARCHAR(13))
RETURNS INT
AS 
BEGIN 

DECLARE @Resultado INT

SELECT @Resultado = count(*) 

		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  c.CartaporteID = @CartaporteID
		  -- and rc.tipo = 2
		   AND	   YEAR(r.FechaCerrada) = CONVERT(CHAR(10), @Ano, 103)
		   AND    MONTH(r.FechaCerrada)= CONVERT(CHAR(10), @Mes, 103)
	       AND DATEPART(weekday,r.FechaCerrada) = 7

RETURN @Resultado
END;
	   
	
	
	


GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSabByFecha]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

           
    

CREATE FUNCTION [dbo].[getViajesSabByFecha]
(@Fecha datetime)
RETURNS INT
AS 
BEGIN 


DECLARE  @VALOR INT

			SELECT @VALOR =  count(c.cartaporteid)
		   FROM   Cartaporte c
			join ruta_cartaporte rc
			on rc.cartaporteid = c.cartaporteid 
			join  ruta r
			on rc.rutaid = r.rutaid
		   WHERE  
		    rc.tipo in (1,2)
		     AND   CONVERT(CHAR(10), r.Fecha, 103) = CONVERT(CHAR(10),@Fecha, 103)
	       AND DATEPART(weekday,@Fecha) in(6)

	return @VALOR

END;
GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSalidaAcopio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesSalidaAcopio]
(@rubro int,@Biblia varchar(50),@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = COUNT(Distinct (Envase.EnvaseID))
  FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	JOIN   Envase
	ON     CartaPorte.CartaPorteID = Envase.CartaPorteID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignador.PuntoId = Biblia.PuntoID 
	JOIN   Ruta
	ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	WHERE  Ruta_CartaPorte.TIPO = 1
	AND Cartaporte.rubroID in(@rubro)
	AND    CartaPorte.CartaPorteID LIKE '%TVV%'
	AND    CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
	AND    DATEPART(weekday,Ruta.Fecha) NOT in(7)
and biblia.puntoid = 454
                   AND Biblia.tipo in(@Biblia)
	
		

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSalidaTotal]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesSalidaTotal]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


 
  SELECT @Resultado = count(*)
		FROM   Ruta
		join   Ruta_CartaPorte
		on     Ruta_CartaPorte.RutaID = Ruta.RutaID
		WHERE CONVERT(VARCHAR,Ruta.Fecha,105) = @Fecha
		and  Ruta_CartaPorte.TIPO in(1,4)
		AND    DATEPART(weekday,Ruta.Fecha) NOT in(7)
		and    Ruta.Nombre in('mc 1','mc 2','mc 3','mc 4','mc 5')

RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSemanaPorPunto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesSemanaPorPunto]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignatario int)
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = Count(DISTINCT(CartaPorte.CartaPorteID))
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN Envase_Efectivo
	ON     Envase.envaseid = Envase_Efectivo.Envaseid
	JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignatarioR.Fecha) = @Mes
	        and YEAR(ConsignatarioR.Fecha) = @Ano
	        AND DATEPART(weekday,ConsignatarioR.Fecha) in(1,2,3,4,5)
	AND    Ruta_CartaPorte.Tipo in(1,4)
	and Cartaporte.Cartaporteid like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	--AND Efectivo.EfectivoTipoID in(1,2)
	and Cartaporte.rubroID in(@rubro)
	and consignatario.PuntoID = @Consignatario
	and consignatarioR.tipo=2
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSemanaPorPuntoEntrada]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[getViajesSemanaPorPuntoEntrada]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignador int)
RETURNS INT
AS 
BEGIN 
DECLARE @Resultado INT


select @Resultado = Count(DISTINCT(CartaPorte.CartaPorteID))
		   

	FROM   Ruta_CartaPorte
	JOIN   CartaPorte	
	ON     Ruta_CartaPorte.CartaPorteID = CartaPorte.CartaPorteID
	
	JOIN Envase
	ON     Cartaporte.Cartaporteid = Envase.Cartaporteid
	JOIN Envase_Efectivo
	ON     Envase.envaseid = Envase_Efectivo.Envaseid
	JOIN Efectivo
		ON Efectivo.EfectivoID =Envase_Efectivo.EfectivoID
	JOIN   Cuenta
	ON	   CartaPorte.CuentaID = Cuenta.CuentaID
	JOIN   CartaPorte_Punto ConsignadorR
	ON	   CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID
	AND    ConsignadorR.Tipo = 1 --ConsignadorR
	JOIN   Punto Consignador
	ON     ConsignadorR.PuntoID = Consignador.PuntoId --Consignador3
	JOIN   CartaPorte_Punto ConsignatarioR
	ON	   CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID
	AND    ConsignatarioR.Tipo = 2 --Consignatario
	JOIN   Punto Consignatario
	ON     ConsignatarioR.PuntoID = Consignatario.PuntoId --Consignatario3
    JOIN   Biblia 
	ON     Consignatario.PuntoId = Biblia.PuntoID 
	
	--JOIN   Ruta
	--ON     Ruta_CartaPorte.RutaID = Ruta.RutaID
	
	where   MONTH(ConsignadorR.Fecha) = @Mes
	        and YEAR(ConsignadorR.Fecha) = @Ano
	        AND DATEPART(weekday,ConsignadorR.Fecha) in(1,2,3,4,5)
	AND    Ruta_CartaPorte.Tipo in(2,3)
	and Cartaporte.Cartaporteid not like '%TVV%'
	--AND Biblia.tipo in(@Biblias)
	--AND Efectivo.EfectivoTipoID in(1,2)
	and Cartaporte.rubroID in(@rubro)
	and consignador.PuntoID = @Consignador
	and consignadorR.tipo=1
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesSemanaPorPuntoServicios]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesSemanaPorPuntoServicios]
(@Rubro INT,@Ano VARCHAR(4),@Mes VARCHAR(2),@Consignatario int,@ServicioID int)
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int


select @Resultado = Count(DISTINCT(Solicitud.Solicitudid))
		   

	FROM    Solicitud
JOIN    Solicitud_Servicio
	ON     Solicitud_Servicio.SolicitudID = Solicitud.SolicitudID
	JOIN    Servicio
	ON     Solicitud_Servicio.ServicioID = Servicio.ServicioID
	JOIN   Cuenta
	ON     Solicitud.CuentaID = Cuenta.CuentaID
	JOIN   Punto Consignador
	ON     Solicitud.ConsignadorID = Consignador.PuntoId --Consignador
	
	JOIN   Punto Consignatario
	ON     Solicitud.ConsignatarioID = Consignatario.PuntoId --Consignatario
         
	
	WHERE  Solicitud.rubroid in(1,2,3,4,5,6)
	and solicitud_servicio.ServicioID <> 8
AND    YEAR(Solicitud.FechaCreado) = @Ano
	AND    MONTH(Solicitud.FechaCreado) = @Mes
	
AND DATEPART(weekday,Solicitud.FechaCreado) in(1,2,3,4,5,6,7)
	and Servicio.servicioID = @ServicioID
	and Solicitud.ConsignatarioID = @Consignatario
	
	
	RETURN @Resultado
END;

GO
/****** Object:  UserDefinedFunction [dbo].[getViajesTotales]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[getViajesTotales]
(@Fecha varchar(10))
RETURNS int
AS 
BEGIN 
DECLARE @Resultado int

  select @Resultado  =((SELECT COUNT(*)
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF26'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
			and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10') 
						  AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4) )) * 5 ) +
		   ((SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF25'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10') 
						   AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4) )) * 10)+
		   ((SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF22'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
						  and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10') 
						   AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4) )) * 20) +
		   ((SELECT COUNT(*) 
		   FROM   Envase_Efectivo b
		   JOIN   Envase c
		   ON     b.EnvaseID = c.EnvaseID
		   WHERE  b.EfectivoID = 'MF21'
		   AND    EXISTS (SELECT *
						  FROM   Ruta_CartaPorte d
						  JOIN   vw_Cartaporte vwc
						  ON	 d.CartaPorteID = vwc.CartaPorteID
						  JOIN   Ruta f
						  ON     f.RutaID = d.RutaID
						  WHERE  vwc.CartaPorteID = c.CartaPorteID
			and   f.Nombre in ('mc 1','mc 2','mc 3','mc 4','mc 5','mc 6','mc 7','mc 8','mc 9','mc 10') 
						   AND    CONVERT(VARCHAR,f.Fecha,105) = @Fecha
						  AND    d.TIPO in(1,4)  )) * 40 )                 
	
			
			
RETURN @Resultado
END;
GO
/****** Object:  UserDefinedFunction [dbo].[list_to_car]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE FUNCTION [dbo].[list_to_car] (@list nvarchar(MAX))
   RETURNS @tbl TABLE (valor VARCHAR(250) NOT NULL) AS
BEGIN
   DECLARE @pos        int,
           @nextpos    int,
           @valuelen   int

   SELECT @pos = 0, @nextpos = 1

   WHILE @nextpos > 0
   BEGIN
      SELECT @nextpos = charindex(',', @list, @pos + 1)
      SELECT @valuelen = CASE WHEN @nextpos > 0
                              THEN @nextpos
                              ELSE len(@list) + 1
                         END - @pos - 1
      
      SELECT @pos = @nextpos
   END
   RETURN
END




GO
/****** Object:  UserDefinedFunction [dbo].[list_to_tbl]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[list_to_tbl] (@list nvarchar(MAX))
   RETURNS @tbl TABLE (valor VARCHAR(250) NOT NULL) AS
BEGIN
   DECLARE @pos        int,
           @nextpos    int,
           @valuelen   int

   SELECT @pos = 0, @nextpos = 1

   WHILE @nextpos > 0
   BEGIN
      SELECT @nextpos = charindex(',', @list, @pos + 1)
      SELECT @valuelen = CASE WHEN @nextpos > 0
                              THEN @nextpos
                              ELSE len(@list) + 1
                         END - @pos - 1
      INSERT @tbl (valor)
         VALUES (substring(@list, @pos + 1, @valuelen))
      SELECT @pos = @nextpos
   END
   RETURN
END


GO
/****** Object:  UserDefinedFunction [dbo].[Numeroenletra]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[Numeroenletra](@NumeroAProcesar AS VARCHAR(30)) 
RETURNS VARCHAR(500) 
AS 
  BEGIN 
      DECLARE @Numero BIGINT 
      DECLARE @Decimal VARCHAR(30) 
      DECLARE @Texto VARCHAR(500) 
      DECLARE @EstiloMillares BIT 

      SELECT @Texto = '' 

      /* Obtenemos parte entera */ 
      IF Patindex('%.%', @NumeroAProcesar) > 0 
        BEGIN 
            SELECT @Numero = LEFT(@NumeroAProcesar, 
                             Patindex('%.%', @NumeroAProcesar) 
                             - 1) 
        END 
      ELSE 
        BEGIN 
            SELECT @Numero = CONVERT(BIGINT, @NumeroAProcesar) 
        END 

      SELECT @EstiloMillares = CONVERT(BIT, Len(@Numero)-7) 

      /* Proceso número negativos */ 
      IF @Numero < 0 
        BEGIN 
            SELECT @Texto = 'menos ' 

            SELECT @Numero = Abs(@Numero) 
        END 

      /* Proceso parte entera */ 
      SELECT @Texto = @Texto + CASE 
                                 WHEN @Numero = 1000000 THEN 'UN MILLON' 

                                 WHEN @Numero = 1000000 THEN 'MILLON' 
                                 WHEN @Numero > 1000000 AND @Numero < 1999999 THEN 
                                 dbo.F_millares(LEFT(CONVERT(VARCHAR, @Numero), 
                                                Len(@Numero) - 6), 
                                 @EstiloMillares) + ' MILLON ' + 
                                 dbo.F_millares( 
                                 RIGHT( 
                                 CONVERT(VARCHAR, @Numero), 6), 1) 

 
                                 WHEN @Numero > 1999999 

                                      AND @Numero < 1000000000000 THEN 
                                 dbo.F_millares(LEFT(CONVERT(VARCHAR, @Numero), 
                                                Len(@Numero) - 6), 
                                 @EstiloMillares) + ' MILLONES ' + 
                                 dbo.F_millares( 
                                 RIGHT( 
                                 CONVERT(VARCHAR, @Numero), 6), 1) 
                                 WHEN @Numero < 10 THEN dbo.F_unidades(@Numero, 
                                                        0) 
                                 WHEN @Numero < 100 THEN 
                                 dbo.F_decenas(@Numero, 1) 
                                 WHEN @Numero < 1000 THEN 
                                 dbo.F_centenas(@Numero, 1) 
                                 WHEN @Numero < 1000000 THEN 
                                 dbo.F_millares(@Numero, 1) 
                               END 

      /* Proceso parte decimal */ 
      IF Patindex('%.%', @NumeroAProcesar) > 0 
        BEGIN 
            SELECT @Decimal = RIGHT(@NumeroAProcesar, Len(@NumeroAProcesar) - 
                              Patindex('%.%', @NumeroAProcesar 
                                         )) 

            SELECT @Numero = @Decimal 

            SELECT @Texto = @Texto + ' CON ' + CASE 
                                                WHEN @Numero = 1000000 THEN 
                                                'MILLON' 
                                                WHEN @Numero > 1000000 
                                                     AND @Numero < 1000000000000 
                                              THEN 
                                                dbo.F_millares(LEFT( 
                                                CONVERT(VARCHAR, @Numero 
                                                ), 
                                                               Len(@Numero) - 6) 
                                                , 
                                                @EstiloMillares) + ' MILLONES ' 
                                                + 
                                                dbo.F_millares( 
                                                RIGHT( 
                                                CONVERT(VARCHAR, @Numero), 6), 1 
                                                ) 
                                                WHEN @Numero < 10 THEN 
                                                dbo.F_unidades(@Numero, 0) 
                                                WHEN @Numero < 100 THEN 
                                                dbo.F_decenas(@Numero, 1) 
                                                WHEN @Numero < 1000 THEN 
                                                dbo.F_centenas(@Numero, 1) 
                                                WHEN @Numero < 1000000 THEN 
                                                dbo.F_millares(@Numero, 1) 
                                              END 

            SELECT @Texto = @Texto + CASE 
                                       WHEN Len(@Decimal) = 1 THEN 
                                       ' CENTIMOS' 
                                       WHEN Len(@Decimal) = 2 THEN 
                                       ' CENTIMOS' 
                                       WHEN Len(@Decimal) = 3 THEN 
                                       ' CENTIMOS' 
                                     END 
        END 

      RETURN @Texto 
  END 




GO
/****** Object:  Table [dbo].[Acta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Acta](
	[ActaID] [int] IDENTITY(1,1) NOT NULL,
	[RazonID] [int] NOT NULL,
	[OrigenID] [int] NOT NULL,
	[Usuario] [varchar](50) NOT NULL,
	[BovedaID] [int] NOT NULL,
	[Observacion] [varchar](max) NOT NULL,
	[NumeroCartaporte] [varchar](13) NULL,
	[MontoCartaporte] [decimal](18, 3) NULL,
	[FechaCartaporte] [datetime] NULL,
	[NumeroPlomo] [varchar](50) NULL,
	[FechaRuta] [datetime] NULL,
	[LoginCreado] [varchar](50) NOT NULL,
	[FechaSuceso] [datetime] NOT NULL,
 CONSTRAINT [PK_Acta] PRIMARY KEY CLUSTERED 
(
	[ActaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Acta_Cartaporte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Acta_Cartaporte](
	[ActaID] [int] NOT NULL,
	[CartaporteID] [varchar](13) NOT NULL,
 CONSTRAINT [PK_Acta_Cartaporte] PRIMARY KEY CLUSTERED 
(
	[ActaID] ASC,
	[CartaporteID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Acta_Envase]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Acta_Envase](
	[EnvaseID] [int] IDENTITY(1,1) NOT NULL,
	[NroPlomo] [varchar](20) NULL,
	[EstaAbierto] [bit] NOT NULL,
	[FechaAbierto] [datetime] NULL,
	[LoginAbierto] [varchar](30) NULL,
	[CartaPorteID] [varchar](13) NOT NULL,
	[Defectuoso] [bit] NOT NULL,
	[Observacion] [varchar](500) NULL,
	[Monto] [decimal](18, 3) NULL,
	[ActaID] [int] NOT NULL,
 CONSTRAINT [PK_Acta_Envase] PRIMARY KEY CLUSTERED 
(
	[EnvaseID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Acta_Envase_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Acta_Envase_Efectivo](
	[EnvaseID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Acta_Envase_Efectivo] PRIMARY KEY CLUSTERED 
(
	[EnvaseID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Acta_Ruta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Acta_Ruta](
	[ActaID] [int] NOT NULL,
	[RutaID] [int] NOT NULL,
 CONSTRAINT [PK_Acta_Ruta] PRIMARY KEY CLUSTERED 
(
	[ActaID] ASC,
	[RutaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Arqueo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Arqueo](
	[ArqueoID] [varchar](13) NOT NULL,
	[CuentaID] [int] NOT NULL,
	[BovedaID] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[FechaCreado] [datetime] NOT NULL,
	[LoginCreado] [varchar](30) NOT NULL,
	[StatusID] [int] NULL,
	[FechaCerrado] [datetime] NULL,
	[LoginCerrado] [varchar](30) NULL,
	[Cerrado] [bit] NOT NULL,
	[PorSistema] [bit] NOT NULL,
	[BolsaID] [varchar](13) NULL,
	[RubroID] [int] NULL,
	[BovedaIDCreado] [int] NULL,
	[EnvaseCantidad] [int] NULL,
	[plomo] [varchar](50) NULL,
 CONSTRAINT [PK_Arqueo] PRIMARY KEY CLUSTERED 
(
	[ArqueoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Arqueo_Punto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Arqueo_Punto](
	[ArqueoID] [varchar](13) NOT NULL,
	[PuntoID] [int] NOT NULL,
	[Tipo] [int] NOT NULL,
	[Fecha] [datetime] NOT NULL,
 CONSTRAINT [PK_Arqueo_Punto] PRIMARY KEY CLUSTERED 
(
	[ArqueoID] ASC,
	[PuntoID] ASC,
	[Tipo] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Banco]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Banco](
	[BancoID] [int] IDENTITY(1,1) NOT NULL,
	[Descripcion] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Banco] PRIMARY KEY CLUSTERED 
(
	[BancoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Biblia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Biblia](
	[PuntoID] [int] NOT NULL,
	[LUN_0_10] [int] NOT NULL,
	[LUN_0_50] [int] NOT NULL,
	[LUN_1] [int] NOT NULL,
	[MAR_0_10] [int] NOT NULL,
	[MAR_0_50] [int] NOT NULL,
	[MAR_1] [int] NOT NULL,
	[MIE_0_10] [int] NOT NULL,
	[MIE_0_50] [int] NOT NULL,
	[MIE_1] [int] NOT NULL,
	[JUE_0_10] [int] NOT NULL,
	[JUE_0_50] [int] NOT NULL,
	[JUE_1] [int] NOT NULL,
	[VIE_0_10] [int] NOT NULL,
	[VIE_0_50] [int] NOT NULL,
	[VIE_1] [int] NOT NULL,
	[SAB_0_10] [int] NOT NULL,
	[SAB_0_50] [int] NOT NULL,
	[SAB_1] [int] NOT NULL,
	[DOM_0_10] [int] NOT NULL,
	[DOM_0_50] [int] NOT NULL,
	[DOM_1] [int] NOT NULL,
	[Ruta] [varchar](15) NOT NULL,
	[Tipo] [varchar](10) NOT NULL,
	[Secuencia] [int] NULL,
	[LUN_5] [int] NOT NULL,
	[LUN_2] [int] NOT NULL,
	[MAR_5] [int] NOT NULL,
	[MAR_2] [int] NOT NULL,
	[MIE_5] [int] NOT NULL,
	[MIE_2] [int] NOT NULL,
	[JUE_5] [int] NOT NULL,
	[JUE_2] [int] NOT NULL,
	[VIE_5] [int] NOT NULL,
	[VIE_2] [int] NOT NULL,
	[SAB_5] [int] NOT NULL,
	[SAB_2] [int] NOT NULL,
	[DOM_5] [int] NOT NULL,
	[DOM_2] [int] NOT NULL,
	[CONO_ANTERIOR] [nvarchar](50) NOT NULL,
	[LUN_10] [int] NOT NULL,
	[LUN_50] [int] NOT NULL,
	[LUN_100] [int] NOT NULL,
	[MAR_10] [int] NOT NULL,
	[MAR_50] [int] NOT NULL,
	[MAR_100] [int] NOT NULL,
	[MIE_10] [int] NOT NULL,
	[MIE_50] [int] NOT NULL,
	[MIE_100] [int] NOT NULL,
	[JUE_10] [int] NOT NULL,
	[JUE_50] [int] NOT NULL,
	[JUE_100] [int] NOT NULL,
	[VIE_10] [int] NOT NULL,
	[VIE_50] [int] NOT NULL,
	[VIE_100] [int] NOT NULL,
	[SAB_10] [int] NOT NULL,
	[SAB_50] [int] NOT NULL,
	[SAB_100] [int] NOT NULL,
	[DOM_10] [int] NOT NULL,
	[DOM_50] [int] NOT NULL,
	[DOM_100] [int] NOT NULL,
	[LUN_500] [int] NOT NULL,
	[LUN_1000] [int] NOT NULL,
	[LUN_2000] [int] NOT NULL,
	[LUN_5000] [int] NOT NULL,
	[LUN_10000] [int] NOT NULL,
	[LUN_20000] [int] NOT NULL,
	[MAR_500] [int] NOT NULL,
	[MAR_1000] [int] NOT NULL,
	[MAR_2000] [int] NOT NULL,
	[MAR_5000] [int] NOT NULL,
	[MAR_10000] [int] NOT NULL,
	[MAR_20000] [int] NOT NULL,
	[MIE_500] [int] NOT NULL,
	[MIE_1000] [int] NOT NULL,
	[MIE_2000] [int] NOT NULL,
	[MIE_5000] [int] NOT NULL,
	[MIE_10000] [int] NOT NULL,
	[MIE_20000] [int] NOT NULL,
	[JUE_500] [int] NOT NULL,
	[JUE_1000] [int] NOT NULL,
	[JUE_2000] [int] NOT NULL,
	[JUE_5000] [int] NOT NULL,
	[JUE_10000] [int] NOT NULL,
	[JUE_20000] [int] NOT NULL,
	[VIE_500] [int] NOT NULL,
	[VIE_1000] [int] NOT NULL,
	[VIE_2000] [int] NOT NULL,
	[VIE_5000] [int] NOT NULL,
	[VIE_10000] [int] NOT NULL,
	[VIE_20000] [int] NOT NULL,
	[SAB_500] [int] NOT NULL,
	[SAB_1000] [int] NOT NULL,
	[SAB_2000] [int] NOT NULL,
	[SAB_5000] [int] NOT NULL,
	[SAB_10000] [int] NOT NULL,
	[SAB_20000] [int] NOT NULL,
	[DOM_500] [int] NOT NULL,
	[DOM_1000] [int] NOT NULL,
	[DOM_2000] [int] NOT NULL,
	[DOM_5000] [int] NOT NULL,
	[DOM_10000] [int] NOT NULL,
	[DOM_20000] [int] NOT NULL,
 CONSTRAINT [PK_Biblia_1] PRIMARY KEY CLUSTERED 
(
	[PuntoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Bloque]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Bloque](
	[BloqueID] [varchar](50) NOT NULL,
	[BovedaID] [varchar](50) NOT NULL,
	[EstaAbierto] [bit] NOT NULL,
	[LoginAbierto] [varchar](50) NULL,
	[FechaCreado] [datetime] NOT NULL,
	[LoginCreado] [varchar](50) NOT NULL,
	[CartaporteID] [varchar](13) NULL,
 CONSTRAINT [PK_Bloque] PRIMARY KEY CLUSTERED 
(
	[BloqueID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Bloque_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Bloque_Efectivo](
	[BloqueID] [varchar](50) NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Bloque_Efectivo] PRIMARY KEY CLUSTERED 
(
	[BloqueID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Boveda]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Boveda](
	[BovedaID] [int] IDENTITY(1,1) NOT NULL,
	[Nombre] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Boveda] PRIMARY KEY CLUSTERED 
(
	[BovedaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Boveda_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Boveda_Efectivo](
	[BovedaID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Boveda_Efectivo] PRIMARY KEY CLUSTERED 
(
	[BovedaID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Boveda_Efectivo_Pendiente]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Boveda_Efectivo_Pendiente](
	[BovedaID] [int] NOT NULL,
	[MontoPendiente] [decimal](18, 3) NOT NULL,
	[FechaUltima] [datetime] NOT NULL,
	[Descripcion] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Boveda_Efectivo_Pendiente] PRIMARY KEY CLUSTERED 
(
	[BovedaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Boveda_Historial]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Boveda_Historial](
	[BovedaID] [int] NOT NULL,
	[Fecha] [datetime] NOT NULL,
	[FechaAbierto] [datetime] NOT NULL,
	[LoginAbierto] [varchar](30) NOT NULL,
	[FechaCerrado] [datetime] NULL,
	[LoginCerrado] [varchar](30) NULL,
	[EfectivoInicial] [decimal](18, 3) NOT NULL,
	[EfectivoEnTransito] [decimal](18, 3) NULL,
	[EfectivoSinProcesar] [decimal](18, 3) NULL,
	[DeudaEstaciones] [decimal](18, 3) NULL,
	[Observacion] [varchar](max) NULL,
	[Deuda] [decimal](18, 3) NULL,
	[PorPagar] [decimal](18, 3) NULL,
 CONSTRAINT [PK_Boveda_Historial_1] PRIMARY KEY CLUSTERED 
(
	[BovedaID] ASC,
	[Fecha] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Boveda_Historial_Cuenta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Boveda_Historial_Cuenta](
	[BovedaID] [int] NOT NULL,
	[Fecha] [datetime] NOT NULL,
	[Descripcion] [varchar](100) NOT NULL,
	[Tipo] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Boveda_Historial_Cuenta] PRIMARY KEY CLUSTERED 
(
	[BovedaID] ASC,
	[Fecha] ASC,
	[Descripcion] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Boveda_Historial_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Boveda_Historial_Efectivo](
	[BovedaID] [int] NOT NULL,
	[Fecha] [datetime] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Boveda_Historial_Efectivo] PRIMARY KEY CLUSTERED 
(
	[BovedaID] ASC,
	[Fecha] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Boveda_Historial_Transito]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Boveda_Historial_Transito](
	[BovedaID] [int] NOT NULL,
	[Fecha] [datetime] NOT NULL,
	[Descripcion] [varchar](100) NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Boveda_Historial_Transito_1] PRIMARY KEY CLUSTERED 
(
	[BovedaID] ASC,
	[Fecha] ASC,
	[Descripcion] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Caja]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Caja](
	[CajaID] [int] IDENTITY(1,1) NOT NULL,
	[Nombre] [varchar](50) NOT NULL,
	[Tipo] [int] NULL,
 CONSTRAINT [PK_Caja] PRIMARY KEY CLUSTERED 
(
	[CajaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Caja_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Caja_Efectivo](
	[CajaID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Caja_Efectivo] PRIMARY KEY CLUSTERED 
(
	[CajaID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Caja_Historial]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Caja_Historial](
	[CajaID] [int] NOT NULL,
	[Fecha] [datetime] NOT NULL,
	[FechaAbierto] [datetime] NOT NULL,
	[LoginAbierto] [varchar](30) NOT NULL,
	[FechaCerrado] [datetime] NULL,
	[LoginCerrado] [varchar](30) NULL,
	[EfectivoInicial] [decimal](18, 3) NOT NULL,
	[EfectivoEnTransito] [decimal](18, 3) NULL,
	[EfectivoSinProcesar] [decimal](18, 3) NULL,
	[Observacion] [varchar](max) NULL,
 CONSTRAINT [PK_Caja_Historial] PRIMARY KEY CLUSTERED 
(
	[CajaID] ASC,
	[Fecha] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Cajetin]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Cajetin](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Descripcion] [varchar](15) NOT NULL,
 CONSTRAINT [PK_Cajetin] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[CartaPorte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[CartaPorte](
	[CartaPorteID] [varchar](13) NOT NULL,
	[CuentaID] [int] NOT NULL,
	[BovedaID] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[FechaCreado] [datetime] NOT NULL,
	[LoginCreado] [varchar](30) NOT NULL,
	[StatusID] [int] NULL,
	[FechaCerrado] [datetime] NULL,
	[LoginCerrado] [varchar](30) NULL,
	[Cerrado] [bit] NOT NULL,
	[PorSistema] [bit] NOT NULL,
	[BolsaID] [varchar](13) NULL,
	[RubroID] [int] NULL,
	[BovedaIDCreado] [int] NULL,
	[EnvaseCantidad] [int] NULL,
	[plomo] [varchar](50) NULL,
 CONSTRAINT [PK_CartaPorte] PRIMARY KEY CLUSTERED 
(
	[CartaPorteID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[CartaPorte_Punto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[CartaPorte_Punto](
	[CartaPorteID] [varchar](13) NOT NULL,
	[PuntoID] [int] NOT NULL,
	[Tipo] [int] NOT NULL,
	[Fecha] [datetime] NOT NULL,
 CONSTRAINT [PK_CartaPorte_Punto] PRIMARY KEY CLUSTERED 
(
	[CartaPorteID] ASC,
	[PuntoID] ASC,
	[Tipo] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Cliente]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Cliente](
	[ClienteID] [int] IDENTITY(1,1) NOT NULL,
	[Descripcion] [varchar](100) NOT NULL,
	[Direccion] [varchar](500) NULL,
	[Telefono] [varchar](30) NULL,
	[Email] [varchar](60) NULL,
	[RIF] [varchar](50) NULL,
 CONSTRAINT [PK_Cliente] PRIMARY KEY CLUSTERED 
(
	[ClienteID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Concepto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Concepto](
	[ConceptoID] [int] IDENTITY(1,1) NOT NULL,
	[Nombre] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Concepto] PRIMARY KEY CLUSTERED 
(
	[ConceptoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Cuenta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Cuenta](
	[CuentaID] [int] IDENTITY(1,1) NOT NULL,
	[co_cli] [char](10) NOT NULL,
	[Saldo] [decimal](18, 3) NOT NULL,
	[FechaCreado] [datetime] NOT NULL,
	[LoginCreado] [varchar](30) NOT NULL,
	[UltimaTransaccionID] [int] NOT NULL,
	[BovedaID] [int] NOT NULL,
	[Nombre] [varchar](50) NOT NULL,
	[Activo] [bit] NOT NULL,
	[Numero] [varchar](50) NULL,
	[tipo] [varchar](50) NULL,
 CONSTRAINT [PK_Cuenta] PRIMARY KEY CLUSTERED 
(
	[CuentaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Cuenta_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Cuenta_Efectivo](
	[CuentaID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Cuenta_Efectivo] PRIMARY KEY CLUSTERED 
(
	[CuentaID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Cuenta_Numero]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Cuenta_Numero](
	[CNumeroID] [int] IDENTITY(1,1) NOT NULL,
	[Numero] [varchar](50) NOT NULL,
	[BancoID] [int] NOT NULL,
 CONSTRAINT [PK_Cuenta_Numero] PRIMARY KEY CLUSTERED 
(
	[CNumeroID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Cuenta_Usuario]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Cuenta_Usuario](
	[Usuario] [varchar](500) NOT NULL,
	[CuentaID] [int] NOT NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Deposito]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Deposito](
	[DepositoID] [int] IDENTITY(1,1) NOT NULL,
	[Fecha] [datetime] NOT NULL,
	[FechaCreado] [datetime] NOT NULL,
	[Contacto] [varchar](50) NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[Numero] [varchar](50) NULL,
	[LoginCreado] [varchar](30) NULL,
	[ConceptoID] [int] NULL,
	[CuentaID] [int] NOT NULL,
	[CNumeroID] [int] NULL,
	[BancoID] [int] NULL,
	[TraspasoID] [int] NULL,
 CONSTRAINT [PK_Deposito] PRIMARY KEY CLUSTERED 
(
	[DepositoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Deposito_Fecha]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Deposito_Fecha](
	[DepositoID] [int] NOT NULL,
	[FechaCreado] [datetime] NOT NULL,
 CONSTRAINT [PK_Deposito_Fecha] PRIMARY KEY CLUSTERED 
(
	[DepositoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Deuda]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Deuda](
	[DeudaID] [int] IDENTITY(1,1) NOT NULL,
	[Fecha] [datetime] NOT NULL,
	[PuntoID] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[MontoTransaccion] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Deuda] PRIMARY KEY CLUSTERED 
(
	[DeudaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Deuda_Transito]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Deuda_Transito](
	[DeudaTransitoID] [int] IDENTITY(1,1) NOT NULL,
	[Ano] [varchar](4) NOT NULL,
	[Mes] [varchar](2) NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[BovedaID] [int] NULL,
 CONSTRAINT [PK_Deuda_Transito] PRIMARY KEY CLUSTERED 
(
	[DeudaTransitoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Diferencia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Diferencia](
	[DiferenciaID] [int] IDENTITY(1,1) NOT NULL,
	[Fecha] [datetime] NOT NULL,
	[PuntoID] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[MontoTransaccion] [decimal](18, 3) NOT NULL,
	[Descripcion] [varchar](max) NOT NULL,
 CONSTRAINT [PK_Diferencia] PRIMARY KEY CLUSTERED 
(
	[DiferenciaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[DiferenciaC]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[DiferenciaC](
	[DiferenciaID] [int] IDENTITY(1,1) NOT NULL,
	[MontoDeclarado] [decimal](18, 3) NULL,
	[Monto] [decimal](18, 3) NULL,
	[Carnet] [varchar](50) NULL,
	[LoginCreado] [varchar](50) NULL,
	[Relacionadas] [varchar](50) NULL,
	[Remision] [varchar](50) NULL,
	[Supervisor] [varchar](50) NULL,
	[FechaCreado] [datetime] NOT NULL,
	[CartaporteID] [varchar](13) NOT NULL,
	[Sobrante] [decimal](18, 3) NULL,
	[Faltante] [decimal](18, 3) NULL,
	[Activo] [int] NOT NULL,
	[Observacion] [varchar](max) NULL,
	[PuntoID] [int] NULL,
	[BovedaID] [int] NULL,
	[Cartaportes] [varchar](max) NULL,
	[FechaCartaporte] [datetime] NULL,
 CONSTRAINT [PK_DiferenciaC] PRIMARY KEY CLUSTERED 
(
	[DiferenciaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[DiferenciaE]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[DiferenciaE](
	[DiferenciaID] [int] NULL,
	[Fecha] [datetime] NULL,
	[PuntoID] [int] NULL,
	[Monto] [decimal](18, 3) NULL,
	[MontoTransaccion] [decimal](18, 3) NULL,
	[Descripcion] [varchar](max) NULL,
	[Usuario] [varchar](30) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Efectivo](
	[EfectivoID] [varchar](5) NOT NULL,
	[EfectivoTipoID] [int] NOT NULL,
	[Denominacion] [decimal](18, 3) NOT NULL,
	[ImagePath] [varchar](100) NOT NULL,
	[EstaActivo] [bit] NOT NULL,
 CONSTRAINT [PK_Efectivo] PRIMARY KEY CLUSTERED 
(
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[EfectivoTipo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[EfectivoTipo](
	[EfectivoTipoID] [int] NOT NULL,
	[Descripcion] [varchar](50) NOT NULL,
 CONSTRAINT [PK_EfectivoTipo] PRIMARY KEY CLUSTERED 
(
	[EfectivoTipoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Envase]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Envase](
	[EnvaseID] [int] IDENTITY(1,1) NOT NULL,
	[NroPlomo] [varchar](20) NULL,
	[EstaAbierto] [bit] NOT NULL,
	[FechaAbierto] [datetime] NULL,
	[LoginAbierto] [varchar](30) NULL,
	[CartaPorteID] [varchar](13) NOT NULL,
	[Defectuoso] [bit] NOT NULL,
	[Observacion] [varchar](500) NULL,
	[Monto] [decimal](18, 3) NULL,
 CONSTRAINT [PK_Envase] PRIMARY KEY CLUSTERED 
(
	[EnvaseID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Envase_Arqueo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Envase_Arqueo](
	[Envase_ArqueoID] [int] IDENTITY(1,1) NOT NULL,
	[NroPlomo] [varchar](20) NULL,
	[EstaAbierto] [bit] NOT NULL,
	[FechaAbierto] [datetime] NULL,
	[LoginAbierto] [varchar](30) NULL,
	[ArqueoID] [varchar](13) NOT NULL,
	[Defectuoso] [bit] NOT NULL,
	[Observacion] [varchar](500) NULL,
	[Monto] [decimal](18, 3) NULL,
 CONSTRAINT [PK_Envase_Arqueo] PRIMARY KEY CLUSTERED 
(
	[Envase_ArqueoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Envase_Arqueo_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Envase_Arqueo_Efectivo](
	[Envase_ArqueoID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[CajetinID] [int] NOT NULL,
	[ModuloID] [int] NOT NULL,
 CONSTRAINT [PK_Envase_Arqueo_Efectivo] PRIMARY KEY CLUSTERED 
(
	[Envase_ArqueoID] ASC,
	[EfectivoID] ASC,
	[CajetinID] ASC,
	[ModuloID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Envase_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Envase_Efectivo](
	[EnvaseID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Envase_Efectivo] PRIMARY KEY CLUSTERED 
(
	[EnvaseID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Fondo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Fondo](
	[BovedaID] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Fondo] PRIMARY KEY CLUSTERED 
(
	[BovedaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Modulo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Modulo](
	[ID] [int] NOT NULL,
	[Descripcion] [varchar](15) NULL,
 CONSTRAINT [PK_Modulo] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Oficial]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Oficial](
	[OficialID] [int] NOT NULL,
	[Nombre] [varchar](50) NOT NULL,
	[CI] [varchar](12) NULL,
 CONSTRAINT [PK_Oficial] PRIMARY KEY CLUSTERED 
(
	[OficialID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Operacion]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Operacion](
	[OperacionID] [int] NOT NULL,
	[Descripcion] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Operacion] PRIMARY KEY CLUSTERED 
(
	[OperacionID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Origen]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Origen](
	[OrigenID] [int] IDENTITY(1,1) NOT NULL,
	[Descripcion] [varchar](max) NOT NULL,
 CONSTRAINT [PK_Origen] PRIMARY KEY CLUSTERED 
(
	[OrigenID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Placa]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Placa](
	[PlacaID] [int] IDENTITY(1,1) NOT NULL,
	[Descripcion] [varchar](500) NOT NULL,
 CONSTRAINT [PK_Placa] PRIMARY KEY CLUSTERED 
(
	[PlacaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Plomo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Plomo](
	[PlomoID] [varchar](50) NOT NULL,
	[DiferenciaID] [int] NOT NULL,
	[D0010] [int] NULL,
	[D0050] [int] NULL,
	[D0100] [int] NULL,
	[D0125] [int] NULL,
	[D0250] [int] NULL,
	[D0500] [int] NULL,
	[D10] [int] NULL,
	[D100] [int] NULL,
	[D1000] [int] NULL,
	[D2] [int] NULL,
	[D20] [int] NULL,
	[D5] [int] NULL,
	[D50] [int] NULL,
	[F0010] [int] NULL,
	[F0050] [int] NULL,
	[F0100] [int] NULL,
	[F0125] [int] NULL,
	[F0250] [int] NULL,
	[F0500] [int] NULL,
	[F10] [int] NULL,
	[F100] [int] NULL,
	[F1000] [int] NULL,
	[F2] [int] NULL,
	[F20] [int] NULL,
	[F5] [int] NULL,
	[F50] [int] NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Plomo_Diferencia]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Plomo_Diferencia](
	[PlomoID] [varchar](50) NOT NULL,
	[CartaporteID] [varchar](13) NULL,
	[D0010] [int] NULL,
	[D0050] [int] NULL,
	[D0100] [int] NULL,
	[D0125] [int] NULL,
	[D0250] [int] NULL,
	[D0500] [int] NULL,
	[D10] [int] NULL,
	[D100] [int] NULL,
	[D1000] [int] NULL,
	[D2] [int] NULL,
	[D20] [int] NULL,
	[D5] [int] NULL,
	[D50] [int] NULL,
	[F0010] [int] NULL,
	[F0050] [int] NULL,
	[F0100] [int] NULL,
	[F0125] [int] NULL,
	[F0250] [int] NULL,
	[F0500] [int] NULL,
	[F10] [int] NULL,
	[F100] [int] NULL,
	[F1000] [int] NULL,
	[F2] [int] NULL,
	[F20] [int] NULL,
	[F5] [int] NULL,
	[F50] [int] NULL,
	[Supervisor] [varchar](50) NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Precinto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Precinto](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Descripcion] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Precinto] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Punto]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Punto](
	[PuntoID] [int] IDENTITY(1,1) NOT NULL,
	[Numero] [int] NULL,
	[Nombre] [varchar](250) NOT NULL,
	[Direccion] [text] NOT NULL,
	[Telefono1] [numeric](18, 0) NULL,
	[Telefono2] [numeric](18, 0) NULL,
	[Telefono3] [numeric](18, 0) NULL,
	[Contacto] [varchar](250) NULL,
	[CuentaID] [int] NOT NULL,
	[RubroID] [int] NULL,
	[Ordenamiento] [int] NULL,
	[Cajero] [varchar](50) NULL,
 CONSTRAINT [PK_Punto] PRIMARY KEY CLUSTERED 
(
	[PuntoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Punto_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Punto_Efectivo](
	[PuntoID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[LoginCreado] [varchar](50) NOT NULL,
	[FechaContado] [datetime] NOT NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Razon]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Razon](
	[RazonID] [int] IDENTITY(1,1) NOT NULL,
	[Descripcion] [varchar](max) NOT NULL,
 CONSTRAINT [PK_Razon] PRIMARY KEY CLUSTERED 
(
	[RazonID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Rubro]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Rubro](
	[RubroID] [int] IDENTITY(1,1) NOT NULL,
	[Definicion] [varchar](250) NOT NULL,
 CONSTRAINT [PK_Rubro] PRIMARY KEY CLUSTERED 
(
	[RubroID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Ruta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Ruta](
	[RutaID] [int] IDENTITY(1,1) NOT NULL,
	[Fecha] [datetime] NOT NULL,
	[Nombre] [varchar](50) NOT NULL,
	[Turno] [char](2) NOT NULL,
	[LoginCreado] [varchar](30) NOT NULL,
	[FechaCreado] [datetime] NOT NULL,
	[OficialValores] [varchar](50) NULL,
	[AuxiliarValores] [varchar](50) NULL,
	[GuardiaCustoCaj] [varchar](50) NULL,
	[OficialValoresID] [int] NULL,
	[AuxiliarValoresID] [int] NULL,
	[GuardiaCustoCajID] [int] NULL,
	[OtroOficial] [varchar](50) NULL,
	[OtroOficialID] [int] NULL,
	[UnidadPlaca] [varchar](50) NULL,
	[TotalCarteras] [int] NULL,
	[TotalCambio] [int] NULL,
	[KilometrosSalida] [decimal](18, 2) NULL,
	[KilometrosLlegada] [decimal](18, 2) NULL,
	[TotalKilometros] [decimal](18, 2) NULL,
	[Cerrada] [bit] NULL,
	[Despachada] [bit] NULL,
	[Recibida] [bit] NULL,
	[LoginCerrada] [varchar](30) NULL,
	[FechaCerrada] [datetime] NULL,
	[LoginDespachada] [varchar](30) NULL,
	[FechaDespachada] [datetime] NULL,
	[LoginRecibida] [varchar](30) NULL,
	[FechaRecibida] [datetime] NULL,
 CONSTRAINT [PK_Ruta] PRIMARY KEY CLUSTERED 
(
	[RutaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Ruta_CartaPorte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Ruta_CartaPorte](
	[RutaID] [int] NOT NULL,
	[CartaPorteID] [varchar](13) NOT NULL,
	[Tipo] [int] NOT NULL,
 CONSTRAINT [PK_Ruta_CartaPorte] PRIMARY KEY CLUSTERED 
(
	[RutaID] ASC,
	[CartaPorteID] ASC,
	[Tipo] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Servicio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Servicio](
	[ServicioID] [int] NOT NULL,
	[Descripcion] [varchar](100) NOT NULL,
 CONSTRAINT [PK_Servicio] PRIMARY KEY CLUSTERED 
(
	[ServicioID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Solicitud]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Solicitud](
	[SolicitudID] [int] IDENTITY(1,1) NOT NULL,
	[SolicitudTipoID] [int] NOT NULL,
	[CuentaID] [int] NOT NULL,
	[ClienteID] [int] NOT NULL,
	[ConsignadorID] [int] NOT NULL,
	[ConsignatarioID] [int] NOT NULL,
	[LoginCreado] [varchar](30) NOT NULL,
	[FechaCreado] [datetime] NOT NULL,
	[StatusSolicitudID] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[OperacionID] [int] NULL,
	[Aprobado] [int] NULL,
	[BovedaID] [int] NULL,
	[RubroID] [int] NULL,
	[Tipo] [varchar](50) NULL,
 CONSTRAINT [PK_Solicitud] PRIMARY KEY CLUSTERED 
(
	[SolicitudID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Solicitud_Accion]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Solicitud_Accion](
	[SolicitudID] [int] NULL,
	[Tipo] [int] NULL,
	[Secuencia] [int] NULL,
	[LoginCerrado] [varchar](50) NULL,
	[FechaCerrado] [datetime] NULL,
	[Observacion] [varchar](500) NULL,
	[BovedaID] [int] NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Solicitud_CartaPorte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Solicitud_CartaPorte](
	[SolicitudID] [int] NOT NULL,
	[CartaPorteID] [varchar](13) NOT NULL,
 CONSTRAINT [PK_Solicitud_CartaPorte] PRIMARY KEY CLUSTERED 
(
	[SolicitudID] ASC,
	[CartaPorteID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Solicitud_Deposito]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Solicitud_Deposito](
	[SolicitudID] [int] NOT NULL,
	[DepositoID] [int] NOT NULL
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Solicitud_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Solicitud_Efectivo](
	[SolicitudID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Solicitud_Efectivo] PRIMARY KEY CLUSTERED 
(
	[SolicitudID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Solicitud_Envase]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Solicitud_Envase](
	[EnvaseID] [int] IDENTITY(1,1) NOT NULL,
	[SolicitudID] [int] NOT NULL,
 CONSTRAINT [PK_Solicitud_Envase] PRIMARY KEY CLUSTERED 
(
	[EnvaseID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Solicitud_Envase_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Solicitud_Envase_Efectivo](
	[EnvaseID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Piezas] [int] NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_Solicitud_Envase_Efectivo] PRIMARY KEY CLUSTERED 
(
	[EnvaseID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Solicitud_Envases]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Solicitud_Envases](
	[Cantidad] [int] NOT NULL,
	[SolicitudID] [nchar](10) NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Solicitud_Operacion]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Solicitud_Operacion](
	[OperacionID] [int] NOT NULL,
	[SolicitudID] [int] NOT NULL,
 CONSTRAINT [PK_Solicitud_Operacion] PRIMARY KEY CLUSTERED 
(
	[OperacionID] ASC,
	[SolicitudID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Solicitud_Ruta]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Solicitud_Ruta](
	[SolicitudID] [int] NOT NULL,
	[rutaID] [int] NOT NULL,
 CONSTRAINT [PK_Solicitud_Ruta] PRIMARY KEY CLUSTERED 
(
	[SolicitudID] ASC,
	[rutaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Solicitud_Servicio]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Solicitud_Servicio](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Descripcion] [varchar](50) NOT NULL,
	[ServicioID] [int] NOT NULL,
	[SolicitudID] [int] NOT NULL,
	[OperadorID] [int] NULL,
	[Operador] [varchar](50) NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Solicitud_Traspaso]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Solicitud_Traspaso](
	[SolicitudID] [int] NOT NULL,
	[TraspasoID] [int] NOT NULL,
 CONSTRAINT [PK_Solicitud_Traspaso] PRIMARY KEY CLUSTERED 
(
	[SolicitudID] ASC,
	[TraspasoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[SolicitudTipo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[SolicitudTipo](
	[SolicitudTipoID] [int] NOT NULL,
	[Descripcion] [varchar](50) NOT NULL,
 CONSTRAINT [PK_SolicitudTipo] PRIMARY KEY CLUSTERED 
(
	[SolicitudTipoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Status]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Status](
	[StatusID] [int] NOT NULL,
	[Descripcion] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Status] PRIMARY KEY CLUSTERED 
(
	[StatusID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[StatusSolicitud]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[StatusSolicitud](
	[StatusSolicitudID] [int] IDENTITY(1,1) NOT NULL,
	[Descripcion] [varchar](50) NOT NULL,
 CONSTRAINT [PK_StatusSolicitud] PRIMARY KEY CLUSTERED 
(
	[StatusSolicitudID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Supervisor]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Supervisor](
	[SupervisorID] [int] IDENTITY(1,1) NOT NULL,
	[Pass] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Supervisor] PRIMARY KEY CLUSTERED 
(
	[SupervisorID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Tipo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Tipo](
	[Entidad] [varchar](50) NOT NULL,
	[Valor] [int] NOT NULL,
	[Definicion] [varchar](250) NOT NULL,
 CONSTRAINT [PK_Tipo] PRIMARY KEY CLUSTERED 
(
	[Entidad] ASC,
	[Valor] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Traspaso]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Traspaso](
	[TraspasoID] [int] IDENTITY(1,1) NOT NULL,
	[BovedaEmisorID] [int] NOT NULL,
	[BovedaReceptorID] [int] NOT NULL,
	[LoginEmisor] [varchar](30) NOT NULL,
	[FechaEmisor] [datetime] NOT NULL,
	[LoginReceptor] [varchar](30) NULL,
	[FechaReceptor] [datetime] NULL,
	[Recibido] [bit] NOT NULL,
	[Observacion] [varchar](max) NULL,
	[Deposito] [int] NULL,
	[Tipo] [int] NULL,
 CONSTRAINT [PK_Traspaso] PRIMARY KEY CLUSTERED 
(
	[TraspasoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Traspaso_Bloque]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Traspaso_Bloque](
	[TraspasoID] [int] NOT NULL,
	[BloqueID] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Traspaso_Bloque] PRIMARY KEY CLUSTERED 
(
	[TraspasoID] ASC,
	[BloqueID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Traspaso_Bolsa]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Traspaso_Bolsa](
	[TraspasoID] [int] NOT NULL,
	[BolsaID] [varchar](50) NOT NULL,
 CONSTRAINT [PK_Traspaso_Bolsa] PRIMARY KEY CLUSTERED 
(
	[TraspasoID] ASC,
	[BolsaID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Traspaso_Caja]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Traspaso_Caja](
	[TraspasoID] [int] IDENTITY(1,1) NOT NULL,
	[CajaEmisorID] [int] NOT NULL,
	[BovedaReceptorID] [int] NOT NULL,
	[LoginEmisor] [varchar](30) NOT NULL,
	[FechaEmisor] [datetime] NOT NULL,
	[LoginReceptor] [varchar](30) NULL,
	[FechaReceptor] [datetime] NULL,
	[Recibido] [bit] NOT NULL,
	[Observacion] [varchar](max) NULL,
 CONSTRAINT [PK_Traspaso_Caja] PRIMARY KEY CLUSTERED 
(
	[TraspasoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Traspaso_CartaPorte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Traspaso_CartaPorte](
	[TraspasoID] [int] NOT NULL,
	[CartaPorteID] [varchar](13) NOT NULL,
 CONSTRAINT [PK_Traspaso_CartaPorte] PRIMARY KEY CLUSTERED 
(
	[TraspasoID] ASC,
	[CartaPorteID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Traspaso_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Traspaso_Efectivo](
	[TraspasoID] [int] NOT NULL,
	[EfectivoID] [nvarchar](5) NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[Piezas] [int] NOT NULL,
 CONSTRAINT [PK_Traspaso_Efectivo] PRIMARY KEY CLUSTERED 
(
	[TraspasoID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[Traspaso_Efectivo_Caja]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Traspaso_Efectivo_Caja](
	[TraspasoID] [int] NOT NULL,
	[EfectivoID] [varchar](5) NOT NULL,
	[Monto] [decimal](18, 3) NOT NULL,
	[Piezas] [int] NOT NULL,
 CONSTRAINT [PK_Traspaso_Efectivo_Caja] PRIMARY KEY CLUSTERED 
(
	[TraspasoID] ASC,
	[EfectivoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  View [dbo].[vw_CartaPorte]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*Consignatario3*/
CREATE VIEW [dbo].[vw_CartaPorte]
AS
SELECT     dbo.CartaPorte.BovedaID, dbo.CartaPorte.RubroID, dbo.Rubro.Definicion, dbo.Cuenta.Nombre AS Cuenta, dbo.Cuenta.CuentaID, 
                      dbo.Cuenta.Nombre AS CuentaNombre, dbo.CartaPorte.CartaPorteID, ConsignadorR.PuntoID AS ConsignadorID, Consignador.Nombre AS Consignador, 
                      ConsignadorR.Fecha AS ConsignadorFecha, ConsignatarioR.PuntoID AS ConsignatarioID, Consignatario.Nombre AS Consignatario, 
                      ConsignatarioR.Fecha AS ConsignatarioFecha, dbo.CartaPorte.Monto, dbo.CartaPorte.LoginCreado, dbo.CartaPorte.LoginCerrado, 
                      dbo.CartaPorte.FechaCreado, dbo.CartaPorte.FechaCerrado, dbo.CartaPorte.Cerrado, dbo.CartaPorte.EnvaseCantidad, dbo.CartaPorte.plomo AS plomo,
                          (SELECT     COUNT(DISTINCT EnvaseID) AS Expr1
                            FROM          dbo.Envase
                            WHERE      (CartaPorteID = dbo.CartaPorte.CartaPorteID)) AS Envases,
                          (SELECT     TOP (1) NroPlomo
                            FROM          dbo.Envase AS Envase_2
                            WHERE      (CartaPorteID = dbo.CartaPorte.CartaPorteID)) AS NroPlomo,
                          (SELECT     SUM(dbo.Envase_Efectivo.Monto) AS Expr1
                            FROM          dbo.Envase_Efectivo INNER JOIN
                                                   dbo.Envase AS Envase_1 ON dbo.Envase_Efectivo.EnvaseID = Envase_1.EnvaseID
                            WHERE      (Envase_1.CartaPorteID = dbo.CartaPorte.CartaPorteID)) AS MontoReal
FROM         dbo.CartaPorte INNER JOIN
                      dbo.Rubro ON dbo.Rubro.RubroID = dbo.CartaPorte.RubroID INNER JOIN
                      dbo.Cuenta ON dbo.CartaPorte.CuentaID = dbo.Cuenta.CuentaID INNER JOIN
                      dbo.CartaPorte_Punto AS ConsignadorR ON dbo.CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID AND ConsignadorR.Tipo = 1 INNER JOIN
                      dbo.Punto AS Consignador ON ConsignadorR.PuntoID = Consignador.PuntoID INNER JOIN
                      dbo.CartaPorte_Punto AS ConsignatarioR ON dbo.CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID AND ConsignatarioR.Tipo = 2 INNER JOIN
                      dbo.Punto AS Consignatario ON ConsignatarioR.PuntoID = Consignatario.PuntoID

GO
/****** Object:  View [dbo].[vw_Cartaporte_Bloque]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_Cartaporte_Bloque]
AS
SELECT     dbo.CartaPorte.BovedaID, dbo.CartaPorte.RubroID, dbo.Rubro.Definicion, dbo.Cuenta.Nombre AS Cuenta, dbo.Cuenta.CuentaID, 
                      dbo.Cuenta.Nombre AS CuentaNombre, dbo.CartaPorte.CartaPorteID, ConsignadorR.PuntoID AS ConsignadorID, Consignador.Nombre AS Consignador, 
                      ConsignadorR.Fecha AS ConsignadorFecha, ConsignatarioR.PuntoID AS ConsignatarioID, Consignatario.Nombre AS Consignatario, 
                      ConsignatarioR.Fecha AS ConsignatarioFecha, dbo.CartaPorte.Monto, dbo.CartaPorte.LoginCreado, dbo.CartaPorte.LoginCerrado, 
                      dbo.CartaPorte.FechaCreado, dbo.CartaPorte.FechaCerrado, dbo.CartaPorte.Cerrado,
                          (SELECT     COUNT(DISTINCT BloqueID) AS ExprB
                            FROM          dbo.Bloque
                            WHERE      (CartaporteID = dbo.CartaPorte.CartaPorteID)) AS Bloques,
                          (SELECT     COUNT(DISTINCT EnvaseID) AS Expr1
                            FROM          dbo.Envase
                            WHERE      (CartaPorteID = dbo.CartaPorte.CartaPorteID)) AS Envases,
                          (SELECT     TOP (1) NroPlomo
                            FROM          dbo.Envase AS Envase_2
                            WHERE      (CartaPorteID = dbo.CartaPorte.CartaPorteID)) AS NroPlomo,
                          (SELECT     SUM(dbo.Envase_Efectivo.Monto) AS Expr1
                            FROM          dbo.Envase_Efectivo INNER JOIN
                                                   dbo.Envase AS Envase_1 ON dbo.Envase_Efectivo.EnvaseID = Envase_1.EnvaseID
                            WHERE      (Envase_1.CartaPorteID = dbo.CartaPorte.CartaPorteID)) AS MontoReal
FROM         dbo.CartaPorte INNER JOIN
                      dbo.Bloque AS Bloque_1 ON Bloque_1.CartaporteID = dbo.CartaPorte.CartaPorteID INNER JOIN
                      dbo.Rubro ON dbo.Rubro.RubroID = dbo.CartaPorte.RubroID INNER JOIN
                      dbo.Cuenta ON dbo.CartaPorte.CuentaID = dbo.Cuenta.CuentaID INNER JOIN
                      dbo.CartaPorte_Punto AS ConsignadorR ON dbo.CartaPorte.CartaPorteID = ConsignadorR.CartaPorteID AND ConsignadorR.Tipo = 1 INNER JOIN
                      dbo.Punto AS Consignador ON ConsignadorR.PuntoID = Consignador.PuntoID INNER JOIN
                      dbo.CartaPorte_Punto AS ConsignatarioR ON dbo.CartaPorte.CartaPorteID = ConsignatarioR.CartaPorteID AND ConsignatarioR.Tipo = 2 INNER JOIN
                      dbo.Punto AS Consignatario ON ConsignatarioR.PuntoID = Consignatario.PuntoID

GO
/****** Object:  View [dbo].[vw_Differencias]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[vw_Differencias]
AS
SELECT Punto.Nombre AS Estacion,
	   (SELECT TOP 1 Monto
	   FROM   Diferencia
	   WHERE  Diferencia.PuntoID = Punto.PuntoID
	   ORDER BY DiferenciaID DESC) AS Monto,
	   Punto.PuntoID
FROM   Biblia
JOIN   Punto
ON     Biblia.PuntoID = Punto.PuntoID
GROUP  BY Punto.Nombre,
	   Punto.PuntoID

GO
/****** Object:  View [dbo].[vw_Efectivo]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[vw_Efectivo]
AS
SELECT Boveda_Efectivo.BovedaID, 
	   Boveda_Efectivo.EfectivoID, 
	   Boveda_Efectivo.Piezas AS PiezasTotal, 
	   Boveda_Efectivo.Monto AS MontoTotal,
	   Efectivo.EfectivoTipoID, 
	   Efectivo.Denominacion, 
	   Efectivo.ImagePath, 
	   Efectivo.EstaActivo,
	   SUM(ISNULL(Traspaso_Efectivo.Piezas,0)) AS PiezasComprometidas,
	   SUM(ISNULL(Traspaso_Efectivo.Monto,0)) AS MontoComprometido,
	   Boveda_Efectivo.Piezas  -  SUM(ISNULL(Traspaso_Efectivo.Piezas,0)) AS PiezasDisponibles, 
	   Boveda_Efectivo.Monto - SUM(ISNULL(Traspaso_Efectivo.Monto,0))AS MontoDisponible
FROM   Boveda_Efectivo
JOIN   Efectivo
ON     Boveda_Efectivo.EfectivoID	= Efectivo.EfectivoID	
LEFT   JOIN Traspaso
ON     Boveda_Efectivo.BovedaID = Traspaso.BovedaEmisorID 
AND    Traspaso.Recibido = 0
LEFT   JOIN   Traspaso_Efectivo
ON     Traspaso_Efectivo.EfectivoID = Boveda_Efectivo.EfectivoID
AND    Traspaso.TraspasoID = Traspaso_Efectivo.TraspasoID
GROUP  BY Boveda_Efectivo.BovedaID, 
	      Boveda_Efectivo.EfectivoID, 
	      Boveda_Efectivo.Piezas, 
	      Boveda_Efectivo.Monto,
	      Efectivo.EfectivoTipoID, 
	      Efectivo.Denominacion, 
	      Efectivo.ImagePath, 
	      Efectivo.EstaActivo

GO
/****** Object:  View [dbo].[vw_EfectivoCaja]    Script Date: 07/02/2019 9:05:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_EfectivoCaja]
AS
SELECT     dbo.Caja_Efectivo.CajaID, dbo.Caja_Efectivo.EfectivoID, dbo.Caja_Efectivo.Piezas AS PiezasTotal, dbo.Caja_Efectivo.Monto AS MontoTotal, 
                      dbo.Efectivo.EfectivoTipoID, dbo.Efectivo.Denominacion, dbo.Efectivo.ImagePath, dbo.Efectivo.EstaActivo, SUM(ISNULL(dbo.Traspaso_Efectivo_Caja.Piezas, 0)) 
                      AS PiezasComprometidas, SUM(ISNULL(dbo.Traspaso_Efectivo_Caja.Monto, 0)) AS MontoComprometido, 
                      dbo.Caja_Efectivo.Piezas - SUM(ISNULL(dbo.Traspaso_Efectivo_Caja.Piezas, 0)) AS PiezasDisponibles, 
                      dbo.Caja_Efectivo.Monto - SUM(ISNULL(dbo.Traspaso_Efectivo_Caja.Monto, 0)) AS MontoDisponible
FROM         dbo.Caja_Efectivo INNER JOIN
                      dbo.Efectivo ON dbo.Caja_Efectivo.EfectivoID = dbo.Efectivo.EfectivoID LEFT OUTER JOIN
                      dbo.Traspaso_Caja ON dbo.Caja_Efectivo.CajaID = dbo.Traspaso_Caja.CajaEmisorID AND dbo.Traspaso_Caja.Recibido = 0 LEFT OUTER JOIN
                      dbo.Traspaso_Efectivo_Caja ON dbo.Traspaso_Efectivo_Caja.EfectivoID = dbo.Caja_Efectivo.EfectivoID AND 
                      dbo.Traspaso_Caja.TraspasoID = dbo.Traspaso_Efectivo_Caja.TraspasoID
GROUP BY dbo.Caja_Efectivo.CajaID, dbo.Caja_Efectivo.EfectivoID, dbo.Caja_Efectivo.Piezas, dbo.Caja_Efectivo.Monto, dbo.Efectivo.EfectivoTipoID, 
                      dbo.Efectivo.Denominacion, dbo.Efectivo.ImagePath, dbo.Efectivo.EstaActivo

GO
ALTER TABLE [dbo].[Acta_Envase] ADD  CONSTRAINT [DF_Acta_Envase_NroPlomo]  DEFAULT ('N/A') FOR [NroPlomo]
GO
ALTER TABLE [dbo].[Acta_Envase] ADD  CONSTRAINT [DF_Acta_Envase_EstaAbierto]  DEFAULT ((0)) FOR [EstaAbierto]
GO
ALTER TABLE [dbo].[Acta_Envase] ADD  CONSTRAINT [DF_Acta_Envase_Defectuoso]  DEFAULT ((0)) FOR [Defectuoso]
GO
ALTER TABLE [dbo].[Arqueo] ADD  CONSTRAINT [DF_Arqueo_Cerrado]  DEFAULT ((0)) FOR [Cerrado]
GO
ALTER TABLE [dbo].[Arqueo] ADD  CONSTRAINT [DF_Arqueo_PorSistema]  DEFAULT ((0)) FOR [PorSistema]
GO
ALTER TABLE [dbo].[Arqueo] ADD  CONSTRAINT [DF_Arqueo_RubroID]  DEFAULT ((1)) FOR [RubroID]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_0_10]  DEFAULT ((0)) FOR [LUN_0_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_0_50]  DEFAULT ((0)) FOR [LUN_0_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_1]  DEFAULT ((0)) FOR [LUN_1]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_0_101]  DEFAULT ((0)) FOR [MAR_0_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_0_501]  DEFAULT ((0)) FOR [MAR_0_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_11]  DEFAULT ((0)) FOR [MAR_1]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_0_101]  DEFAULT ((0)) FOR [MIE_0_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_0_501]  DEFAULT ((0)) FOR [MIE_0_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_11]  DEFAULT ((0)) FOR [MIE_1]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_0_101]  DEFAULT ((0)) FOR [JUE_0_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_0_501]  DEFAULT ((0)) FOR [JUE_0_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_11]  DEFAULT ((0)) FOR [JUE_1]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_0_101]  DEFAULT ((0)) FOR [VIE_0_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_0_501]  DEFAULT ((0)) FOR [VIE_0_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_11]  DEFAULT ((0)) FOR [VIE_1]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_0_101]  DEFAULT ((0)) FOR [SAB_0_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_0_501]  DEFAULT ((0)) FOR [SAB_0_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_11]  DEFAULT ((0)) FOR [SAB_1]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_0_102]  DEFAULT ((0)) FOR [DOM_0_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_0_502]  DEFAULT ((0)) FOR [DOM_0_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_12]  DEFAULT ((0)) FOR [DOM_1]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_Tipo]  DEFAULT ('Metro') FOR [Tipo]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_Lun_5]  DEFAULT ((0)) FOR [LUN_5]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_2]  DEFAULT ((0)) FOR [LUN_2]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_5]  DEFAULT ((0)) FOR [MAR_5]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_2]  DEFAULT ((0)) FOR [MAR_2]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_5]  DEFAULT ((0)) FOR [MIE_5]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_2]  DEFAULT ((0)) FOR [MIE_2]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_5]  DEFAULT ((0)) FOR [JUE_5]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_2]  DEFAULT ((0)) FOR [JUE_2]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_5]  DEFAULT ((0)) FOR [VIE_5]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_2]  DEFAULT ((0)) FOR [VIE_2]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_5]  DEFAULT ((0)) FOR [SAB_5]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_2]  DEFAULT ((0)) FOR [SAB_2]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_5]  DEFAULT ((0)) FOR [DOM_5]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_2]  DEFAULT ((0)) FOR [DOM_2]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_CONO_ANTERIOR]  DEFAULT ((1)) FOR [CONO_ANTERIOR]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_10]  DEFAULT ((0)) FOR [LUN_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_50]  DEFAULT ((0)) FOR [LUN_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_100]  DEFAULT ((0)) FOR [LUN_100]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_10]  DEFAULT ((0)) FOR [MAR_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_50]  DEFAULT ((0)) FOR [MAR_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_100]  DEFAULT ((0)) FOR [MAR_100]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_10]  DEFAULT ((0)) FOR [MIE_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_50]  DEFAULT ((0)) FOR [MIE_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_100]  DEFAULT ((0)) FOR [MIE_100]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_10]  DEFAULT ((0)) FOR [JUE_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_50]  DEFAULT ((0)) FOR [JUE_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_100]  DEFAULT ((0)) FOR [JUE_100]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_10]  DEFAULT ((0)) FOR [VIE_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_50]  DEFAULT ((0)) FOR [VIE_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_100]  DEFAULT ((0)) FOR [VIE_100]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_10]  DEFAULT ((0)) FOR [SAB_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_50]  DEFAULT ((0)) FOR [SAB_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_100]  DEFAULT ((0)) FOR [SAB_100]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_10]  DEFAULT ((0)) FOR [DOM_10]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_50]  DEFAULT ((0)) FOR [DOM_50]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_100]  DEFAULT ((0)) FOR [DOM_100]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_500]  DEFAULT ((0)) FOR [LUN_500]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_1000]  DEFAULT ((0)) FOR [LUN_1000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_2000]  DEFAULT ((0)) FOR [LUN_2000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_5000]  DEFAULT ((0)) FOR [LUN_5000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_10000]  DEFAULT ((0)) FOR [LUN_10000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_LUN_20000]  DEFAULT ((0)) FOR [LUN_20000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_500]  DEFAULT ((0)) FOR [MAR_500]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_1000]  DEFAULT ((0)) FOR [MAR_1000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_2000]  DEFAULT ((0)) FOR [MAR_2000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_5000]  DEFAULT ((0)) FOR [MAR_5000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_10000]  DEFAULT ((0)) FOR [MAR_10000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MAR_20000]  DEFAULT ((0)) FOR [MAR_20000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_500]  DEFAULT ((0)) FOR [MIE_500]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_1000]  DEFAULT ((0)) FOR [MIE_1000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_2000]  DEFAULT ((0)) FOR [MIE_2000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_5000]  DEFAULT ((0)) FOR [MIE_5000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_10000]  DEFAULT ((0)) FOR [MIE_10000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_MIE_20000]  DEFAULT ((0)) FOR [MIE_20000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_500]  DEFAULT ((0)) FOR [JUE_500]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_1000]  DEFAULT ((0)) FOR [JUE_1000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_2000]  DEFAULT ((0)) FOR [JUE_2000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_5000]  DEFAULT ((0)) FOR [JUE_5000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_10000]  DEFAULT ((0)) FOR [JUE_10000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_JUE_20000]  DEFAULT ((0)) FOR [JUE_20000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_500]  DEFAULT ((0)) FOR [VIE_500]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_1000]  DEFAULT ((0)) FOR [VIE_1000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_2000]  DEFAULT ((0)) FOR [VIE_2000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_5000]  DEFAULT ((0)) FOR [VIE_5000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_10000]  DEFAULT ((0)) FOR [VIE_10000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_VIE_20000]  DEFAULT ((0)) FOR [VIE_20000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_500]  DEFAULT ((0)) FOR [SAB_500]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_1000]  DEFAULT ((0)) FOR [SAB_1000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_2000]  DEFAULT ((0)) FOR [SAB_2000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_5000]  DEFAULT ((0)) FOR [SAB_5000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_10000]  DEFAULT ((0)) FOR [SAB_10000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_SAB_20000]  DEFAULT ((0)) FOR [SAB_20000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_500]  DEFAULT ((0)) FOR [DOM_500]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_1000]  DEFAULT ((0)) FOR [DOM_1000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_2000]  DEFAULT ((0)) FOR [DOM_2000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_5000]  DEFAULT ((0)) FOR [DOM_5000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_10000]  DEFAULT ((0)) FOR [DOM_10000]
GO
ALTER TABLE [dbo].[Biblia] ADD  CONSTRAINT [DF_Biblia_DOM_20000]  DEFAULT ((0)) FOR [DOM_20000]
GO
ALTER TABLE [dbo].[Bloque] ADD  CONSTRAINT [DF_Bloque_EstaAbierto]  DEFAULT ((0)) FOR [EstaAbierto]
GO
ALTER TABLE [dbo].[Boveda_Efectivo_Pendiente] ADD  CONSTRAINT [DF_Boveda_Efectivo_Pendiente_FechaUltima]  DEFAULT (getdate()) FOR [FechaUltima]
GO
ALTER TABLE [dbo].[Boveda_Historial] ADD  CONSTRAINT [DF_Boveda_Historial_Deuda]  DEFAULT ((0)) FOR [Deuda]
GO
ALTER TABLE [dbo].[Boveda_Historial] ADD  CONSTRAINT [DF_Boveda_Historial_PorPagar]  DEFAULT ((0)) FOR [PorPagar]
GO
ALTER TABLE [dbo].[CartaPorte] ADD  CONSTRAINT [DF_CartaPorte_Cerrado]  DEFAULT ((0)) FOR [Cerrado]
GO
ALTER TABLE [dbo].[CartaPorte] ADD  CONSTRAINT [DF_CartaPorte_PorSistema]  DEFAULT ((0)) FOR [PorSistema]
GO
ALTER TABLE [dbo].[CartaPorte] ADD  CONSTRAINT [DF_CartaPorte_RubroID]  DEFAULT ((1)) FOR [RubroID]
GO
ALTER TABLE [dbo].[Cuenta] ADD  CONSTRAINT [DF_Cuenta_Activo]  DEFAULT ((0)) FOR [Activo]
GO
ALTER TABLE [dbo].[Deposito] ADD  CONSTRAINT [DF_Deposito_CNumeroID]  DEFAULT ((1)) FOR [CNumeroID]
GO
ALTER TABLE [dbo].[Deposito] ADD  CONSTRAINT [DF_Deposito_BancoID]  DEFAULT ((1)) FOR [BancoID]
GO
ALTER TABLE [dbo].[DiferenciaC] ADD  CONSTRAINT [DF_DiferenciaC_Activo]  DEFAULT ((0)) FOR [Activo]
GO
ALTER TABLE [dbo].[Efectivo] ADD  CONSTRAINT [DF_Efectivo_EstaActivo]  DEFAULT ((1)) FOR [EstaActivo]
GO
ALTER TABLE [dbo].[Envase] ADD  CONSTRAINT [DF_Envase_NroPlomo]  DEFAULT ('N/A') FOR [NroPlomo]
GO
ALTER TABLE [dbo].[Envase] ADD  CONSTRAINT [DF_Envase_EstaAbierto]  DEFAULT ((0)) FOR [EstaAbierto]
GO
ALTER TABLE [dbo].[Envase] ADD  CONSTRAINT [DF_Envase_Defectuoso]  DEFAULT ((0)) FOR [Defectuoso]
GO
ALTER TABLE [dbo].[Envase_Arqueo] ADD  CONSTRAINT [DF_Envase_Arqueo_EstaAbierto]  DEFAULT ((0)) FOR [EstaAbierto]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D0010]  DEFAULT ((0)) FOR [D0010]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D0050]  DEFAULT ((0)) FOR [D0050]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D0100]  DEFAULT ((0)) FOR [D0100]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D0125]  DEFAULT ((0)) FOR [D0125]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D0250]  DEFAULT ((0)) FOR [D0250]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D0500]  DEFAULT ((0)) FOR [D0500]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D10]  DEFAULT ((0)) FOR [D10]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D100]  DEFAULT ((0)) FOR [D100]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D1000]  DEFAULT ((0)) FOR [D1000]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D2]  DEFAULT ((0)) FOR [D2]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D20]  DEFAULT ((0)) FOR [D20]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D5]  DEFAULT ((0)) FOR [D5]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_D50]  DEFAULT ((0)) FOR [D50]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F0010]  DEFAULT ((0)) FOR [F0010]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F0050]  DEFAULT ((0)) FOR [F0050]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F0100]  DEFAULT ((0)) FOR [F0100]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F0125]  DEFAULT ((0)) FOR [F0125]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F0250]  DEFAULT ((0)) FOR [F0250]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F0500]  DEFAULT ((0)) FOR [F0500]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F10]  DEFAULT ((0)) FOR [F10]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F100]  DEFAULT ((0)) FOR [F100]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F1000]  DEFAULT ((0)) FOR [F1000]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F2]  DEFAULT ((0)) FOR [F2]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F20]  DEFAULT ((0)) FOR [F20]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F5]  DEFAULT ((0)) FOR [F5]
GO
ALTER TABLE [dbo].[Plomo] ADD  CONSTRAINT [DF_Plomo_F50]  DEFAULT ((0)) FOR [F50]
GO
ALTER TABLE [dbo].[Ruta] ADD  CONSTRAINT [DF_Ruta_Cerrado]  DEFAULT ((0)) FOR [Cerrada]
GO
ALTER TABLE [dbo].[Ruta] ADD  CONSTRAINT [DF_Ruta_Despachada]  DEFAULT ((0)) FOR [Despachada]
GO
ALTER TABLE [dbo].[Ruta] ADD  CONSTRAINT [DF_Ruta_Recibida]  DEFAULT ((0)) FOR [Recibida]
GO
ALTER TABLE [dbo].[Traspaso] ADD  CONSTRAINT [DF_Traspaso_Recibido]  DEFAULT ((0)) FOR [Recibido]
GO
ALTER TABLE [dbo].[Traspaso] ADD  CONSTRAINT [DF_Traspaso_Tipo]  DEFAULT ((0)) FOR [Tipo]
GO
ALTER TABLE [dbo].[Traspaso_Caja] ADD  CONSTRAINT [DF_Traspaso_Caja_Recibido]  DEFAULT ((0)) FOR [Recibido]
GO
ALTER TABLE [dbo].[Arqueo_Punto]  WITH CHECK ADD  CONSTRAINT [FK_Arqueo_Punto_Arqueo] FOREIGN KEY([ArqueoID])
REFERENCES [dbo].[Arqueo] ([ArqueoID])
ON UPDATE CASCADE
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Arqueo_Punto] CHECK CONSTRAINT [FK_Arqueo_Punto_Arqueo]
GO
ALTER TABLE [dbo].[Arqueo_Punto]  WITH CHECK ADD  CONSTRAINT [FK_Arqueo_Punto_Punto] FOREIGN KEY([PuntoID])
REFERENCES [dbo].[Punto] ([PuntoID])
GO
ALTER TABLE [dbo].[Arqueo_Punto] CHECK CONSTRAINT [FK_Arqueo_Punto_Punto]
GO
ALTER TABLE [dbo].[Bloque_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Bloque_Efectivo_Bloque] FOREIGN KEY([BloqueID])
REFERENCES [dbo].[Bloque] ([BloqueID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Bloque_Efectivo] CHECK CONSTRAINT [FK_Bloque_Efectivo_Bloque]
GO
ALTER TABLE [dbo].[Bloque_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Bloque_Efectivo_Efectivo] FOREIGN KEY([EfectivoID])
REFERENCES [dbo].[Efectivo] ([EfectivoID])
GO
ALTER TABLE [dbo].[Bloque_Efectivo] CHECK CONSTRAINT [FK_Bloque_Efectivo_Efectivo]
GO
ALTER TABLE [dbo].[Boveda_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Boveda_Efectivo_Boveda] FOREIGN KEY([BovedaID])
REFERENCES [dbo].[Boveda] ([BovedaID])
GO
ALTER TABLE [dbo].[Boveda_Efectivo] CHECK CONSTRAINT [FK_Boveda_Efectivo_Boveda]
GO
ALTER TABLE [dbo].[Boveda_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Boveda_Efectivo_Efectivo] FOREIGN KEY([EfectivoID])
REFERENCES [dbo].[Efectivo] ([EfectivoID])
GO
ALTER TABLE [dbo].[Boveda_Efectivo] CHECK CONSTRAINT [FK_Boveda_Efectivo_Efectivo]
GO
ALTER TABLE [dbo].[Caja_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Caja_Efectivo_Caja] FOREIGN KEY([CajaID])
REFERENCES [dbo].[Caja] ([CajaID])
GO
ALTER TABLE [dbo].[Caja_Efectivo] CHECK CONSTRAINT [FK_Caja_Efectivo_Caja]
GO
ALTER TABLE [dbo].[Caja_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Caja_Efectivo_Efectivo] FOREIGN KEY([EfectivoID])
REFERENCES [dbo].[Efectivo] ([EfectivoID])
GO
ALTER TABLE [dbo].[Caja_Efectivo] CHECK CONSTRAINT [FK_Caja_Efectivo_Efectivo]
GO
ALTER TABLE [dbo].[Caja_Historial]  WITH CHECK ADD  CONSTRAINT [FK_Caja_Historial_Caja] FOREIGN KEY([CajaID])
REFERENCES [dbo].[Caja] ([CajaID])
GO
ALTER TABLE [dbo].[Caja_Historial] CHECK CONSTRAINT [FK_Caja_Historial_Caja]
GO
ALTER TABLE [dbo].[CartaPorte_Punto]  WITH CHECK ADD  CONSTRAINT [FK_CartaPorte_Punto_CartaPorte] FOREIGN KEY([CartaPorteID])
REFERENCES [dbo].[CartaPorte] ([CartaPorteID])
ON UPDATE CASCADE
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[CartaPorte_Punto] CHECK CONSTRAINT [FK_CartaPorte_Punto_CartaPorte]
GO
ALTER TABLE [dbo].[CartaPorte_Punto]  WITH CHECK ADD  CONSTRAINT [FK_CartaPorte_Punto_Punto] FOREIGN KEY([PuntoID])
REFERENCES [dbo].[Punto] ([PuntoID])
GO
ALTER TABLE [dbo].[CartaPorte_Punto] CHECK CONSTRAINT [FK_CartaPorte_Punto_Punto]
GO
ALTER TABLE [dbo].[Cuenta]  WITH CHECK ADD  CONSTRAINT [FK_Cuenta_Boveda] FOREIGN KEY([BovedaID])
REFERENCES [dbo].[Boveda] ([BovedaID])
GO
ALTER TABLE [dbo].[Cuenta] CHECK CONSTRAINT [FK_Cuenta_Boveda]
GO
ALTER TABLE [dbo].[Cuenta_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Cuenta_Efectivo_Cuenta] FOREIGN KEY([CuentaID])
REFERENCES [dbo].[Cuenta] ([CuentaID])
ON UPDATE CASCADE
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Cuenta_Efectivo] CHECK CONSTRAINT [FK_Cuenta_Efectivo_Cuenta]
GO
ALTER TABLE [dbo].[Cuenta_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Cuenta_Efectivo_Efectivo] FOREIGN KEY([EfectivoID])
REFERENCES [dbo].[Efectivo] ([EfectivoID])
GO
ALTER TABLE [dbo].[Cuenta_Efectivo] CHECK CONSTRAINT [FK_Cuenta_Efectivo_Efectivo]
GO
ALTER TABLE [dbo].[Deuda]  WITH CHECK ADD  CONSTRAINT [FK_Deuda_Punto] FOREIGN KEY([PuntoID])
REFERENCES [dbo].[Punto] ([PuntoID])
GO
ALTER TABLE [dbo].[Deuda] CHECK CONSTRAINT [FK_Deuda_Punto]
GO
ALTER TABLE [dbo].[Diferencia]  WITH CHECK ADD  CONSTRAINT [FK_Diferencia_Punto] FOREIGN KEY([PuntoID])
REFERENCES [dbo].[Punto] ([PuntoID])
GO
ALTER TABLE [dbo].[Diferencia] CHECK CONSTRAINT [FK_Diferencia_Punto]
GO
ALTER TABLE [dbo].[Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Efectivo_EfectivoTipo] FOREIGN KEY([EfectivoTipoID])
REFERENCES [dbo].[EfectivoTipo] ([EfectivoTipoID])
GO
ALTER TABLE [dbo].[Efectivo] CHECK CONSTRAINT [FK_Efectivo_EfectivoTipo]
GO
ALTER TABLE [dbo].[Envase]  WITH CHECK ADD  CONSTRAINT [FK_Envase_CartaPorte] FOREIGN KEY([CartaPorteID])
REFERENCES [dbo].[CartaPorte] ([CartaPorteID])
ON UPDATE CASCADE
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Envase] CHECK CONSTRAINT [FK_Envase_CartaPorte]
GO
ALTER TABLE [dbo].[Envase_Arqueo_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Envase_Arqueo_Efectivo_Cajetin] FOREIGN KEY([CajetinID])
REFERENCES [dbo].[Cajetin] ([ID])
GO
ALTER TABLE [dbo].[Envase_Arqueo_Efectivo] CHECK CONSTRAINT [FK_Envase_Arqueo_Efectivo_Cajetin]
GO
ALTER TABLE [dbo].[Envase_Arqueo_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Envase_Arqueo_Efectivo_Efectivo] FOREIGN KEY([EfectivoID])
REFERENCES [dbo].[Efectivo] ([EfectivoID])
GO
ALTER TABLE [dbo].[Envase_Arqueo_Efectivo] CHECK CONSTRAINT [FK_Envase_Arqueo_Efectivo_Efectivo]
GO
ALTER TABLE [dbo].[Envase_Arqueo_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Envase_Arqueo_Efectivo_Envase] FOREIGN KEY([Envase_ArqueoID])
REFERENCES [dbo].[Envase_Arqueo] ([Envase_ArqueoID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Envase_Arqueo_Efectivo] CHECK CONSTRAINT [FK_Envase_Arqueo_Efectivo_Envase]
GO
ALTER TABLE [dbo].[Envase_Arqueo_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Envase_Arqueo_Efectivo_Modulo] FOREIGN KEY([ModuloID])
REFERENCES [dbo].[Modulo] ([ID])
GO
ALTER TABLE [dbo].[Envase_Arqueo_Efectivo] CHECK CONSTRAINT [FK_Envase_Arqueo_Efectivo_Modulo]
GO
ALTER TABLE [dbo].[Envase_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Envase_Efectivo_Efectivo] FOREIGN KEY([EfectivoID])
REFERENCES [dbo].[Efectivo] ([EfectivoID])
GO
ALTER TABLE [dbo].[Envase_Efectivo] CHECK CONSTRAINT [FK_Envase_Efectivo_Efectivo]
GO
ALTER TABLE [dbo].[Envase_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Envase_Efectivo_Envase] FOREIGN KEY([EnvaseID])
REFERENCES [dbo].[Envase] ([EnvaseID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Envase_Efectivo] CHECK CONSTRAINT [FK_Envase_Efectivo_Envase]
GO
ALTER TABLE [dbo].[Plomo]  WITH CHECK ADD  CONSTRAINT [FK_Plomo_DiferenciaC] FOREIGN KEY([DiferenciaID])
REFERENCES [dbo].[DiferenciaC] ([DiferenciaID])
GO
ALTER TABLE [dbo].[Plomo] CHECK CONSTRAINT [FK_Plomo_DiferenciaC]
GO
ALTER TABLE [dbo].[Ruta_CartaPorte]  WITH CHECK ADD  CONSTRAINT [FK_Ruta_CartaPorte_CartaPorte] FOREIGN KEY([CartaPorteID])
REFERENCES [dbo].[CartaPorte] ([CartaPorteID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Ruta_CartaPorte] CHECK CONSTRAINT [FK_Ruta_CartaPorte_CartaPorte]
GO
ALTER TABLE [dbo].[Ruta_CartaPorte]  WITH CHECK ADD  CONSTRAINT [FK_Ruta_CartaPorte_Ruta] FOREIGN KEY([RutaID])
REFERENCES [dbo].[Ruta] ([RutaID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Ruta_CartaPorte] CHECK CONSTRAINT [FK_Ruta_CartaPorte_Ruta]
GO
ALTER TABLE [dbo].[Solicitud]  WITH CHECK ADD  CONSTRAINT [FK_Solicitud_Boveda] FOREIGN KEY([BovedaID])
REFERENCES [dbo].[Boveda] ([BovedaID])
GO
ALTER TABLE [dbo].[Solicitud] CHECK CONSTRAINT [FK_Solicitud_Boveda]
GO
ALTER TABLE [dbo].[Solicitud_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Solicitud_Efectivo_Efectivo] FOREIGN KEY([EfectivoID])
REFERENCES [dbo].[Efectivo] ([EfectivoID])
GO
ALTER TABLE [dbo].[Solicitud_Efectivo] CHECK CONSTRAINT [FK_Solicitud_Efectivo_Efectivo]
GO
ALTER TABLE [dbo].[Solicitud_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Solicitud_Efectivo_Solicitud] FOREIGN KEY([SolicitudID])
REFERENCES [dbo].[Solicitud] ([SolicitudID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Solicitud_Efectivo] CHECK CONSTRAINT [FK_Solicitud_Efectivo_Solicitud]
GO
ALTER TABLE [dbo].[Solicitud_Envase]  WITH CHECK ADD  CONSTRAINT [FK_Solicitud_Envase_Solicitud] FOREIGN KEY([SolicitudID])
REFERENCES [dbo].[Solicitud] ([SolicitudID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Solicitud_Envase] CHECK CONSTRAINT [FK_Solicitud_Envase_Solicitud]
GO
ALTER TABLE [dbo].[Solicitud_Envase_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Solicitud_Envase_Efectivo_Efectivo] FOREIGN KEY([EfectivoID])
REFERENCES [dbo].[Efectivo] ([EfectivoID])
GO
ALTER TABLE [dbo].[Solicitud_Envase_Efectivo] CHECK CONSTRAINT [FK_Solicitud_Envase_Efectivo_Efectivo]
GO
ALTER TABLE [dbo].[Solicitud_Envase_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Solicitud_Envase_Efectivo_Solicitud_Envase] FOREIGN KEY([EnvaseID])
REFERENCES [dbo].[Solicitud_Envase] ([EnvaseID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Solicitud_Envase_Efectivo] CHECK CONSTRAINT [FK_Solicitud_Envase_Efectivo_Solicitud_Envase]
GO
ALTER TABLE [dbo].[Solicitud_Operacion]  WITH CHECK ADD  CONSTRAINT [FK_Solicitud_Operacion_Operacion] FOREIGN KEY([OperacionID])
REFERENCES [dbo].[Operacion] ([OperacionID])
GO
ALTER TABLE [dbo].[Solicitud_Operacion] CHECK CONSTRAINT [FK_Solicitud_Operacion_Operacion]
GO
ALTER TABLE [dbo].[Solicitud_Operacion]  WITH CHECK ADD  CONSTRAINT [FK_Solicitud_Operacion_Solicitud] FOREIGN KEY([SolicitudID])
REFERENCES [dbo].[Solicitud] ([SolicitudID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Solicitud_Operacion] CHECK CONSTRAINT [FK_Solicitud_Operacion_Solicitud]
GO
ALTER TABLE [dbo].[Traspaso_Bloque]  WITH CHECK ADD  CONSTRAINT [FK_Traspaso_Bloque_Bloque] FOREIGN KEY([BloqueID])
REFERENCES [dbo].[Bloque] ([BloqueID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Traspaso_Bloque] CHECK CONSTRAINT [FK_Traspaso_Bloque_Bloque]
GO
ALTER TABLE [dbo].[Traspaso_Bloque]  WITH CHECK ADD  CONSTRAINT [FK_Traspaso_Bloque_Traspaso] FOREIGN KEY([TraspasoID])
REFERENCES [dbo].[Traspaso] ([TraspasoID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Traspaso_Bloque] CHECK CONSTRAINT [FK_Traspaso_Bloque_Traspaso]
GO
ALTER TABLE [dbo].[Traspaso_Bolsa]  WITH CHECK ADD  CONSTRAINT [FK_Traspaso_Bolsa_Traspaso] FOREIGN KEY([TraspasoID])
REFERENCES [dbo].[Traspaso] ([TraspasoID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Traspaso_Bolsa] CHECK CONSTRAINT [FK_Traspaso_Bolsa_Traspaso]
GO
ALTER TABLE [dbo].[Traspaso_CartaPorte]  WITH CHECK ADD  CONSTRAINT [FK_Traspaso_CartaPorte_CartaPorte] FOREIGN KEY([CartaPorteID])
REFERENCES [dbo].[CartaPorte] ([CartaPorteID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Traspaso_CartaPorte] CHECK CONSTRAINT [FK_Traspaso_CartaPorte_CartaPorte]
GO
ALTER TABLE [dbo].[Traspaso_CartaPorte]  WITH CHECK ADD  CONSTRAINT [FK_Traspaso_CartaPorte_Traspaso] FOREIGN KEY([TraspasoID])
REFERENCES [dbo].[Traspaso] ([TraspasoID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Traspaso_CartaPorte] CHECK CONSTRAINT [FK_Traspaso_CartaPorte_Traspaso]
GO
ALTER TABLE [dbo].[Traspaso_Efectivo]  WITH CHECK ADD  CONSTRAINT [FK_Traspaso_Efectivo_Traspaso] FOREIGN KEY([TraspasoID])
REFERENCES [dbo].[Traspaso] ([TraspasoID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Traspaso_Efectivo] CHECK CONSTRAINT [FK_Traspaso_Efectivo_Traspaso]
GO
ALTER TABLE [dbo].[Traspaso_Efectivo_Caja]  WITH CHECK ADD  CONSTRAINT [FK_Traspaso_Efectivo_Caja_Efectivo] FOREIGN KEY([EfectivoID])
REFERENCES [dbo].[Efectivo] ([EfectivoID])
GO
ALTER TABLE [dbo].[Traspaso_Efectivo_Caja] CHECK CONSTRAINT [FK_Traspaso_Efectivo_Caja_Efectivo]
GO
ALTER TABLE [dbo].[Traspaso_Efectivo_Caja]  WITH CHECK ADD  CONSTRAINT [FK_Traspaso_Efectivo_Caja_Traspaso_Caja] FOREIGN KEY([TraspasoID])
REFERENCES [dbo].[Traspaso_Caja] ([TraspasoID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[Traspaso_Efectivo_Caja] CHECK CONSTRAINT [FK_Traspaso_Efectivo_Caja_Traspaso_Caja]
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = -384
         Left = 0
      End
      Begin Tables = 
         Begin Table = "CartaPorte"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 125
               Right = 198
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Rubro"
            Begin Extent = 
               Top = 390
               Left = 38
               Bottom = 475
               Right = 190
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Cuenta"
            Begin Extent = 
               Top = 6
               Left = 236
               Bottom = 125
               Right = 422
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "ConsignadorR"
            Begin Extent = 
               Top = 6
               Left = 460
               Bottom = 125
               Right = 620
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Consignador"
            Begin Extent = 
               Top = 6
               Left = 658
               Bottom = 125
               Right = 818
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "ConsignatarioR"
            Begin Extent = 
               Top = 126
               Left = 38
               Bottom = 245
               Right = 198
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Consignatario"
            Begin Extent = 
               Top = 126
               Left = 236
               Bottom = 245
               Right = 396
            End
          ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CartaPorte'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'  DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CartaPorte'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CartaPorte'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "CartaPorte"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 121
               Right = 190
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Bloque_1"
            Begin Extent = 
               Top = 6
               Left = 228
               Bottom = 121
               Right = 380
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Rubro"
            Begin Extent = 
               Top = 6
               Left = 418
               Bottom = 91
               Right = 570
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Cuenta"
            Begin Extent = 
               Top = 6
               Left = 608
               Bottom = 121
               Right = 786
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "ConsignadorR"
            Begin Extent = 
               Top = 96
               Left = 418
               Bottom = 211
               Right = 570
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Consignador"
            Begin Extent = 
               Top = 126
               Left = 38
               Bottom = 241
               Right = 190
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "ConsignatarioR"
            Begin Extent = 
               Top = 126
               Left = 228
               Bottom = 241
               Right = 380
            End
            Display' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Cartaporte_Bloque'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'Flags = 280
            TopColumn = 0
         End
         Begin Table = "Consignatario"
            Begin Extent = 
               Top = 126
               Left = 608
               Bottom = 241
               Right = 760
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Cartaporte_Bloque'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Cartaporte_Bloque'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "Caja_Efectivo"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 125
               Right = 214
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Efectivo"
            Begin Extent = 
               Top = 6
               Left = 252
               Bottom = 125
               Right = 428
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Traspaso_Caja"
            Begin Extent = 
               Top = 6
               Left = 466
               Bottom = 125
               Right = 662
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Traspaso_Efectivo_Caja"
            Begin Extent = 
               Top = 126
               Left = 38
               Bottom = 245
               Right = 214
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
       ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EfectivoCaja'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'  Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EfectivoCaja'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EfectivoCaja'
GO
